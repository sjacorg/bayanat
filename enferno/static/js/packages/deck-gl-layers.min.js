if("undefined"==typeof globalThis)var global=globalThis;var process;!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(global=void 0!==t?t:t||self).DeckLayers=e()}(this,function(){"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(e){var n=function(e,n){if("object"!=t(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,n);if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==t(n)?n:n+""}function n(t,n,i){return(n=e(n))in t?Object.defineProperty(t,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[n]=i,t}function i(t,e){if(!t)throw new Error(e||"loader assertion failed.")}const r=Boolean("[object process]"!==String(process)||!0),s=/v([0-9]*)/.exec("v16.0.0");s&&parseFloat(s[1]);function o(t,e){if(!t)throw new Error(e||"loaders.gl assertion failed.")}const a="[object process]"!==String(process)||!0,c="undefined"!=typeof window&&void 0!==window.orientation,l=/v([0-9]*)/.exec("v16.0.0");l&&parseFloat(l[1]);class u{constructor(t,e){n(this,"name",void 0),n(this,"workerThread",void 0),n(this,"isRunning",!0),n(this,"result",void 0),n(this,"_resolve",()=>{}),n(this,"_reject",()=>{}),this.name=t,this.workerThread=e,this.result=new Promise((t,e)=>{this._resolve=t,this._reject=e})}postMessage(t,e){this.workerThread.postMessage({source:"loaders.gl",type:t,payload:e})}done(t){o(this.isRunning),this.isRunning=!1,this._resolve(t)}error(t){o(this.isRunning),this.isRunning=!1,this._reject(t)}}let h=class{terminate(){}};const d=new Map;function f(t){o(t.source&&!t.url||!t.source&&t.url);let e=d.get(t.source||t.url);return e||(t.url&&(e=function(t){if(!t.startsWith("http"))return t;return g((e=t,"try {\n  importScripts('".concat(e,"');\n} catch (error) {\n  console.error(error);\n  throw error;\n}")));var e}(t.url),d.set(t.url,e)),t.source&&(e=g(t.source),d.set(t.source,e))),o(e),e}function g(t){const e=new Blob([t],{type:"application/javascript"});return URL.createObjectURL(e)}function p(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;const i=n||new Set;if(t){if(m(t))i.add(t);else if(m(t.buffer))i.add(t.buffer);else if(ArrayBuffer.isView(t));else if(e&&"object"==typeof t)for(const n in t)p(t[n],e,i)}else;return void 0===n?Array.from(i):[]}function m(t){return!!t&&(t instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&t instanceof MessagePort||("undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&t instanceof OffscreenCanvas)))}const v=()=>{};class y{static isSupported(){return"undefined"!=typeof Worker&&a||void 0!==h&&!a}constructor(t){n(this,"name",void 0),n(this,"source",void 0),n(this,"url",void 0),n(this,"terminated",!1),n(this,"worker",void 0),n(this,"onMessage",void 0),n(this,"onError",void 0),n(this,"_loadableURL","");const{name:e,source:i,url:r}=t;o(i||r),this.name=e,this.source=i,this.url=r,this.onMessage=v,this.onError=t=>console.log(t),this.worker=this._createBrowserWorker()}destroy(){this.onMessage=v,this.onError=v,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(t,e){e=e||p(t),this.worker.postMessage(t,e)}_getErrorFromErrorEvent(t){let e="Failed to load ";return e+="worker ".concat(this.name," from ").concat(this.url,". "),t.message&&(e+="".concat(t.message," in ")),t.lineno&&(e+=":".concat(t.lineno,":").concat(t.colno)),new Error(e)}_createBrowserWorker(){this._loadableURL=f({source:this.source,url:this.url});const t=new Worker(this._loadableURL,{name:this.name});return t.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},t.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},t.onmessageerror=t=>console.error(t),t}_createNodeWorker(){let t;if(this.url){const e=this.url.includes(":/")||this.url.startsWith("/")?this.url:"./".concat(this.url);t=new h(e,{eval:!1})}else{if(!this.source)throw new Error("no worker");t=new h(this.source,{eval:!0})}return t.on("message",t=>{this.onMessage(t)}),t.on("error",t=>{this.onError(t)}),t.on("exit",t=>{}),t}}class b{static isSupported(){return y.isSupported()}constructor(t){n(this,"name","unnamed"),n(this,"source",void 0),n(this,"url",void 0),n(this,"maxConcurrency",1),n(this,"maxMobileConcurrency",1),n(this,"onDebug",()=>{}),n(this,"reuseWorkers",!0),n(this,"props",{}),n(this,"jobQueue",[]),n(this,"idleQueue",[]),n(this,"count",0),n(this,"isDestroyed",!1),this.source=t.source,this.url=t.url,this.setProps(t)}destroy(){this.idleQueue.forEach(t=>t.destroy()),this.isDestroyed=!0}setProps(t){this.props={...this.props,...t},void 0!==t.name&&(this.name=t.name),void 0!==t.maxConcurrency&&(this.maxConcurrency=t.maxConcurrency),void 0!==t.maxMobileConcurrency&&(this.maxMobileConcurrency=t.maxMobileConcurrency),void 0!==t.reuseWorkers&&(this.reuseWorkers=t.reuseWorkers),void 0!==t.onDebug&&(this.onDebug=t.onDebug)}async startJob(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(t,e,n)=>t.done(n),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(t,e)=>t.error(e);const i=new Promise(i=>(this.jobQueue.push({name:t,onMessage:e,onError:n,onStart:i}),this));return this._startQueuedJob(),await i}async _startQueuedJob(){if(!this.jobQueue.length)return;const t=this._getAvailableWorker();if(!t)return;const e=this.jobQueue.shift();if(e){this.onDebug({message:"Starting job",name:e.name,workerThread:t,backlog:this.jobQueue.length});const n=new u(e.name,t);t.onMessage=t=>e.onMessage(n,t.type,t.payload),t.onError=t=>e.onError(n,t),e.onStart(n);try{await n.result}finally{this.returnWorkerToQueue(t)}}}returnWorkerToQueue(t){this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(t.destroy(),this.count--):this.idleQueue.push(t),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const t="".concat(this.name.toLowerCase()," (#").concat(this.count," of ").concat(this.maxConcurrency,")");return new y({name:t,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return c?this.maxMobileConcurrency:this.maxConcurrency}}const _={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class x{static isSupported(){return y.isSupported()}static getWorkerFarm(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return x._workerFarm=x._workerFarm||new x({}),x._workerFarm.setProps(t),x._workerFarm}constructor(t){n(this,"props",void 0),n(this,"workerPools",new Map),this.props={..._},this.setProps(t),this.workerPools=new Map}destroy(){for(const t of this.workerPools.values())t.destroy();this.workerPools=new Map}setProps(t){this.props={...this.props,...t};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(t){const{name:e,source:n,url:i}=t;let r=this.workerPools.get(e);return r||(r=new b({name:e,source:n,url:i}),r.setProps(this._getWorkerPoolProps()),this.workerPools.set(e,r)),r}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}n(x,"_workerFarm",void 0);async function P(t,e,n,i,r){const s=t.id,a=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=e[t.id]||{},i="".concat(t.id,"-worker.js");let r=n.workerUrl;if(r||"compression"!==t.id||(r=e.workerUrl),"test"===e._workerType&&(r="modules/".concat(t.module,"/dist/").concat(i)),!r){let e=t.version;"latest"===e&&(e="latest");const n=e?"@".concat(e):"";r="https://unpkg.com/@loaders.gl/".concat(t.module).concat(n,"/dist/").concat(i)}return o(r),r}(t,n),c=x.getWorkerFarm(n).getWorkerPool({name:s,url:a});n=JSON.parse(JSON.stringify(n)),i=JSON.parse(JSON.stringify(i||{}));const l=await c.startJob("process-on-worker",w.bind(null,r));l.postMessage("process",{input:e,options:n,context:i});const u=await l.result;return await u.result}async function w(t,e,n,i){switch(n){case"done":e.done(i);break;case"error":e.error(new Error(i.error));break;case"process":const{id:r,input:s,options:o}=i;try{const n=await t(s,o);e.postMessage("done",{id:r,result:n})}catch(t){const n=t instanceof Error?t.message:"unknown error";e.postMessage("error",{id:r,error:n})}break;default:console.warn("parse-with-worker unknown message ".concat(n))}}async function A(t){const e=[];for await(const n of t)e.push(n);return function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];const i=e.map(t=>t instanceof ArrayBuffer?new Uint8Array(t):t),r=i.reduce((t,e)=>t+e.byteLength,0),s=new Uint8Array(r);let o=0;for(const t of i)s.set(t,o),o+=t.byteLength;return s.buffer}(...e)}function S(){let t;if("undefined"!=typeof window&&window.performance)t=window.performance.now();else if(process.hrtime){const e=process.hrtime();t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}class T{constructor(t,e){n(this,"name",void 0),n(this,"type",void 0),n(this,"sampleSize",1),n(this,"time",void 0),n(this,"count",void 0),n(this,"samples",void 0),n(this,"lastTiming",void 0),n(this,"lastSampleTime",void 0),n(this,"lastSampleCount",void 0),n(this,"_count",0),n(this,"_time",0),n(this,"_samples",0),n(this,"_startTime",0),n(this,"_timerPending",!1),this.name=t,this.type=e,this.reset()}setSampleSize(t){return this.sampleSize=t,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(t){return this._count+=t,this._samples++,this._checkSampling(),this}subtractCount(t){return this._count-=t,this._samples++,this._checkSampling(),this}addTime(t){return this._time+=t,this.lastTiming=t,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=S(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(S()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class E{constructor(t){n(this,"id",void 0),n(this,"stats",{}),this.id=t.id,this.stats={},this._initializeStats(t.stats),Object.seal(this)}get(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"count";return this._getOrCreate({name:t,type:e})}get size(){return Object.keys(this.stats).length}reset(){for(const t in this.stats)this.stats[t].reset();return this}forEach(t){for(const e in this.stats)t(this.stats[e])}getTable(){const t={};return this.forEach(e=>{t[e.name]={time:e.time||0,count:e.count||0,average:e.getAverageTime()||0,hz:e.getHz()||0}}),t}_initializeStats(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach(t=>this._getOrCreate(t))}_getOrCreate(t){if(!t||!t.name)return null;const{name:e,type:n}=t;return this.stats[e]||(this.stats[e]=t instanceof T?t:new T(e,n)),this.stats[e]}}const C={};function L(t){if((e=t)&&"object"==typeof e&&e.isBuffer)return t;var e;if(t instanceof ArrayBuffer)return t;if(ArrayBuffer.isView(t))return 0===t.byteOffset&&t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);if("string"==typeof t){const e=t;return(new TextEncoder).encode(e).buffer}if(t&&"object"==typeof t&&t._toArrayBuffer)return t._toArrayBuffer();throw new Error("toArrayBuffer")}function M(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(e+1):""}const O=t=>"function"==typeof t,I=t=>null!==t&&"object"==typeof t,R=t=>I(t)&&t.constructor==={}.constructor,F=t=>"undefined"!=typeof Response&&t instanceof Response||t&&t.arrayBuffer&&t.text&&t.json,z=t=>"undefined"!=typeof Blob&&t instanceof Blob,k=t=>(t=>"undefined"!=typeof ReadableStream&&t instanceof ReadableStream||I(t)&&O(t.tee)&&O(t.cancel)&&O(t.getReader))(t)||(t=>I(t)&&O(t.read)&&O(t.pipe)&&(t=>"boolean"==typeof t)(t.readable))(t),j=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,B=/^([-\w.]+\/[-\w.+]+)/;function D(t){const e=j.exec(t);return e?e[1]:""}const N=/\?.*/;function U(t){return t.replace(N,"")}function V(t){if(F(t)){return t.url}if(z(t)){return t.name||""}return"string"==typeof t?t:""}function G(t){if(F(t)){const e=t,n=e.headers.get("content-type")||"",i=U(e.url);return function(t){const e=B.exec(t);return e?e[1]:t}(n)||D(i)}if(z(t)){return t.type||""}return"string"==typeof t?D(t):""}async function W(t){if(F(t))return t;const e={},n=function(t){if(F(t))return t.headers["content-length"]||-1;if(z(t))return t.size;return"string"==typeof t?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1}(t);n>=0&&(e["content-length"]=String(n));const i=V(t),r=G(t);r&&(e["content-type"]=r);const s=await async function(t){const e=5;if("string"==typeof t)return"data:,".concat(t.slice(0,e));if(t instanceof Blob){const e=t.slice(0,5);return await new Promise(t=>{const n=new FileReader;n.onload=e=>{var n;return t(null==e||null===(n=e.target)||void 0===n?void 0:n.result)},n.readAsDataURL(e)})}if(t instanceof ArrayBuffer){const n=function(t){let e="";const n=new Uint8Array(t);for(let t=0;t<n.byteLength;t++)e+=String.fromCharCode(n[t]);return btoa(e)}(t.slice(0,e));return"data:base64,".concat(n)}return null}(t);s&&(e["x-first-bytes"]=s),"string"==typeof t&&(t=(new TextEncoder).encode(t));const o=new Response(t,{headers:e});return Object.defineProperty(o,"url",{value:i}),o}async function H(t,e){if("string"==typeof t){t=function(t){for(const e in C)if(t.startsWith(e)){const n=C[e];t=t.replace(e,n)}return t.startsWith("http://")||t.startsWith("https://")||(t="".concat("").concat(t)),t}(t);let n=e;return null!=e&&e.fetch&&"function"!=typeof(null==e?void 0:e.fetch)&&(n=e.fetch),await fetch(t,n)}return await W(t)}function X(){return String(process),!0}const Z={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,globalThis:"undefined"!=typeof globalThis&&globalThis,process:process},Y=Z.window||Z.self||Z.globalThis,K=Z.process||{},q="undefined"!=typeof __VERSION__?__VERSION__:"untranspiled source";X();const J=globalThis;function Q(t){if(X(),function(){if("undefined"!=typeof window&&"object"==typeof window.process&&"renderer"===window.process.type)return!0;if(Boolean({}.electron))return!0;const t="object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}())return"Electron";const e=("undefined"!=typeof navigator?navigator:{}).userAgent||"";if(e.indexOf("Edge")>-1)return"Edge";const n=-1!==e.indexOf("MSIE "),i=-1!==e.indexOf("Trident/");return n||i?"IE":J.chrome?"Chrome":J.safari?"Safari":J.mozInnerScreenX?"Firefox":"Unknown"}class ${constructor(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"sessionStorage";n(this,"storage",void 0),n(this,"id",void 0),n(this,"config",void 0),this.storage=function(t){try{const e=window[t],n="__storage_test__";return e.setItem(n,n),e.removeItem(n),e}catch(t){return null}}(i),this.id=t,this.config=e,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(t){if(Object.assign(this.config,t),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let t={};if(this.storage){const e=this.storage.getItem(this.id);t=e?JSON.parse(e):{}}return Object.assign(this.config,t),this}}function tt(t,e,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:600;const r=t.src.replace(/\(/g,"%28").replace(/\)/g,"%29");t.width>i&&(n=Math.min(n,i/t.width));const s=t.width*n,o=t.height*n,a=["font-size:1px;","padding:".concat(Math.floor(o/2),"px ").concat(Math.floor(s/2),"px;"),"line-height:".concat(o,"px;"),"background:url(".concat(r,");"),"background-size:".concat(s,"px ").concat(o,"px;"),"color:transparent;"].join("");return["".concat(e," %c+"),a]}let et;function nt(t){return"string"==typeof t?et[t.toUpperCase()]||et.WHITE:t}function it(t,e){if(!t)throw new Error(e||"Assertion failed")}function rt(){let t;var e,n;if(X&&"performance"in Y)t=null==Y||null===(e=Y.performance)||void 0===e||null===(n=e.now)||void 0===n?void 0:n.call(e);else if("hrtime"in K){var i;const e=null==K||null===(i=K.hrtime)||void 0===i?void 0:i.call(K);t=1e3*e[0]+e[1]/1e6}else t=Date.now();return t}!function(t){t[t.BLACK=30]="BLACK",t[t.RED=31]="RED",t[t.GREEN=32]="GREEN",t[t.YELLOW=33]="YELLOW",t[t.BLUE=34]="BLUE",t[t.MAGENTA=35]="MAGENTA",t[t.CYAN=36]="CYAN",t[t.WHITE=37]="WHITE",t[t.BRIGHT_BLACK=90]="BRIGHT_BLACK",t[t.BRIGHT_RED=91]="BRIGHT_RED",t[t.BRIGHT_GREEN=92]="BRIGHT_GREEN",t[t.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",t[t.BRIGHT_BLUE=94]="BRIGHT_BLUE",t[t.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",t[t.BRIGHT_CYAN=96]="BRIGHT_CYAN",t[t.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(et||(et={}));const st={debug:X&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},ot={enabled:!0,level:0};function at(){}const ct={},lt={once:!0};class ut{constructor(){let{id:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:""};n(this,"id",void 0),n(this,"VERSION",q),n(this,"_startTs",rt()),n(this,"_deltaTs",rt()),n(this,"_storage",void 0),n(this,"userData",{}),n(this,"LOG_THROTTLE_TIMEOUT",0),this.id=t,this.userData={},this._storage=new $("__probe-".concat(this.id,"__"),ot),this.timeStamp("".concat(this.id," started")),function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["constructor"];const n=Object.getPrototypeOf(t),i=Object.getOwnPropertyNames(n);for(const n of i)"function"==typeof t[n]&&(e.find(t=>n===t)||(t[n]=t[n].bind(t)))}(this),Object.seal(this)}set level(t){this.setLevel(t)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((rt()-this._startTs).toPrecision(10))}getDelta(){return Number((rt()-this._deltaTs).toPrecision(10))}set priority(t){this.level=t}get priority(){return this.level}getPriority(){return this.level}enable(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._storage.setConfiguration({enabled:t}),this}setLevel(t){return this._storage.setConfiguration({level:t}),this}get(t){return this._storage.config[t]}set(t,e){this._storage.setConfiguration({[t]:e})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(t,e){it(t,e)}warn(t){return this._getLogFunction(0,t,st.warn,arguments,lt)}error(t){return this._getLogFunction(0,t,st.error,arguments)}deprecated(t,e){return this.warn("`".concat(t,"` is deprecated and will be removed in a later version. Use `").concat(e,"` instead"))}removed(t,e){return this.error("`".concat(t,"` has been removed. Use `").concat(e,"` instead"))}probe(t,e){return this._getLogFunction(t,e,st.log,arguments,{time:!0,once:!0})}log(t,e){return this._getLogFunction(t,e,st.debug,arguments)}info(t,e){return this._getLogFunction(t,e,console.info,arguments)}once(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this._getLogFunction(t,e,st.debug||st.info,arguments,lt)}table(t,e,n){return e?this._getLogFunction(t,e,console.table||at,n&&[n],{tag:ft(e)}):at}image(t){let{logLevel:e,priority:n,image:i,message:r="",scale:s=1}=t;return this._shouldLog(e||n)?X?function(t){let{image:e,message:n="",scale:i=1}=t;if("string"==typeof e){const t=new Image;return t.onload=()=>{const e=tt(t,n,i);console.log(...e)},t.src=e,at}const r=e.nodeName||"";if("img"===r.toLowerCase())return console.log(...tt(e,n,i)),at;if("canvas"===r.toLowerCase()){const t=new Image;return t.onload=()=>console.log(...tt(t,n,i)),t.src=e.toDataURL(),at}return at}({image:i,message:r,scale:s}):(console.warn("removed"),at):at}time(t,e){return this._getLogFunction(t,e,console.time?console.time:console.info)}timeEnd(t,e){return this._getLogFunction(t,e,console.timeEnd?console.timeEnd:console.info)}timeStamp(t,e){return this._getLogFunction(t,e,console.timeStamp||at)}group(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{collapsed:!1};const i=dt({logLevel:t,message:e,opts:n}),{collapsed:r}=n;return i.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(i)}groupCollapsed(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.group(t,e,Object.assign({},n,{collapsed:!0}))}groupEnd(t){return this._getLogFunction(t,"",console.groupEnd||at)}withGroup(t,e,n){this.group(t,e)();try{n()}finally{this.groupEnd(t)()}}trace(){console.trace&&console.trace()}_shouldLog(t){return this.isEnabled()&&this.getLevel()>=ht(t)}_getLogFunction(t,e,n,i,r){if(this._shouldLog(t)){r=dt({logLevel:t,message:e,args:i,opts:r}),it(n=n||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=rt();const s=r.tag||r.message;if(r.once){if(ct[s])return at;ct[s]=rt()}return e=function(t,e,n){if("string"==typeof e){const o=n.time?function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;const n=Math.max(e-t.length,0);return"".concat(" ".repeat(n)).concat(t)}(function(t){let e;return e=t<10?"".concat(t.toFixed(2),"ms"):t<100?"".concat(t.toFixed(1),"ms"):t<1e3?"".concat(t.toFixed(0),"ms"):"".concat((t/1e3).toFixed(2),"s"),e}(n.total)):"";e=n.time?"".concat(t,": ").concat(o,"  ").concat(e):"".concat(t,": ").concat(e),i=e,r=n.color,s=n.background,X||"string"!=typeof i||(r&&(r=nt(r),i="[".concat(r,"m").concat(i,"[39m")),s&&(r=nt(s),i="[".concat(s+10,"m").concat(i,"[49m"))),e=i}var i,r,s;return e}(this.id,r.message,r),n.bind(console,e,...r.args)}return at}}function ht(t){if(!t)return 0;let e;switch(typeof t){case"number":e=t;break;case"object":e=t.logLevel||t.priority||0;break;default:return 0}return it(Number.isFinite(e)&&e>=0),e}function dt(t){const{logLevel:e,message:n}=t;t.logLevel=ht(e);const i=t.args?Array.from(t.args):[];for(;i.length&&i.shift()!==n;);switch(typeof e){case"string":case"function":void 0!==n&&i.unshift(n),t.message=e;break;case"object":Object.assign(t,e)}"function"==typeof t.message&&(t.message=t.message());const r=typeof t.message;return it("string"===r||"object"===r),Object.assign(t,{args:i},t.opts)}function ft(t){for(const e in t)for(const n in t[e])return n||"untitled";return"empty"}n(ut,"VERSION",q);const gt=new ut({id:"loaders.gl"});class pt{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const mt={fetch:null,mimeType:void 0,nothrow:!1,log:new class{constructor(){n(this,"console",void 0),this.console=console}log(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.console.log.bind(this.console,...e)}info(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.console.info.bind(this.console,...e)}warn(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.console.warn.bind(this.console,...e)}error(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.console.error.bind(this.console,...e)}},CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:r,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},vt={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function yt(){globalThis.loaders=globalThis.loaders||{};const{loaders:t}=globalThis;return t._state=t._state||{},t._state}const bt=()=>{const t=yt();return t.globalOptions=t.globalOptions||{...mt},t.globalOptions};function _t(t,e,n,i){return n=n||[],function(t,e){xt(t,null,mt,vt,e);for(const n of e){const i=t&&t[n.id]||{},r=n.options&&n.options[n.id]||{},s=n.deprecatedOptions&&n.deprecatedOptions[n.id]||{};xt(i,n.id,r,s,e)}}(t,n=Array.isArray(n)?n:[n]),function(t,e,n){const i=t.options||{},r={...i};(function(t,e){e&&!("baseUri"in t)&&(t.baseUri=e)})(r,n),null===r.log&&(r.log=new pt);return wt(r,bt()),wt(r,e),r}(e,t,i)}function xt(t,e,n,i,r){const s=e||"Top level",o=e?"".concat(e,"."):"";for(const a in t){const c=!e&&I(t[a]);if(!(a in n)&&!("baseUri"===a&&!e)&&!("workerUrl"===a&&e))if(a in i)gt.warn("".concat(s," loader option '").concat(o).concat(a,"' no longer supported, use '").concat(i[a],"'"))();else if(!c){const t=Pt(a,r);gt.warn("".concat(s," loader option '").concat(o).concat(a,"' not recognized. ").concat(t))()}}}function Pt(t,e){const n=t.toLowerCase();let i="";for(const r of e)for(const e in r.options){if(t===e)return"Did you mean '".concat(r.id,".").concat(e,"'?");const s=e.toLowerCase();(n.startsWith(s)||s.startsWith(n))&&(i=i||"Did you mean '".concat(r.id,".").concat(e,"'?"))}return i}function wt(t,e){for(const n in e)if(n in e){const i=e[n];R(i)&&R(t[n])?t[n]={...t[n],...e[n]}:t[n]=e[n]}}function At(t){var e;if(!t)return!1;Array.isArray(t)&&(t=t[0]);return Array.isArray(null===(e=t)||void 0===e?void 0:e.extensions)}function St(t){var e,n;let r;return i(t,"null loader"),i(At(t),"invalid loader"),Array.isArray(t)&&(r=t[1],t=t[0],t={...t,options:{...t.options,...r}}),(null!==(e=t)&&void 0!==e&&e.parseTextSync||null!==(n=t)&&void 0!==n&&n.parseText)&&(t.text=!0),t.text||(t.binary=!0),t}function Tt(){return(()=>{const t=yt();return t.loaderRegistry=t.loaderRegistry||[],t.loaderRegistry})()}const Et=new ut({id:"loaders.gl"}),Ct=/\.([^.]+)$/;function Lt(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0;if(!Mt(t))return null;if(e&&!Array.isArray(e))return St(e);let r=[];e&&(r=r.concat(e)),null!=n&&n.ignoreRegisteredLoaders||r.push(...Tt()),function(t){for(const e of t)St(e)}(r);const s=function(t,e,n,i){const r=V(t),s=G(t),o=U(r)||(null==i?void 0:i.url);let a=null,c="";null!=n&&n.mimeType&&(a=It(e,null==n?void 0:n.mimeType),c="match forced by supplied MIME type ".concat(null==n?void 0:n.mimeType));var l;a=a||function(t,e){const n=e&&Ct.exec(e),i=n&&n[1];return i?function(t,e){e=e.toLowerCase();for(const n of t)for(const t of n.extensions)if(t.toLowerCase()===e)return n;return null}(t,i):null}(e,o),c=c||(a?"matched url ".concat(o):""),a=a||It(e,s),c=c||(a?"matched MIME type ".concat(s):""),a=a||function(t,e){if(!e)return null;for(const n of t)if("string"==typeof e){if(Rt(e,n))return n}else if(ArrayBuffer.isView(e)){if(Ft(e.buffer,e.byteOffset,n))return n}else if(e instanceof ArrayBuffer){if(Ft(e,0,n))return n}return null}(e,t),c=c||(a?"matched initial data ".concat(zt(t)):""),a=a||It(e,null==n?void 0:n.fallbackMimeType),c=c||(a?"matched fallback MIME type ".concat(s):""),c&&Et.log(1,"selectLoader selected ".concat(null===(l=a)||void 0===l?void 0:l.name,": ").concat(c,"."));return a}(t,r,n,i);if(!(s||null!=n&&n.nothrow))throw new Error(Ot(t));return s}function Mt(t){return!(t instanceof Response&&204===t.status)}function Ot(t){const e=V(t),n=G(t);let i="No valid loader found (";i+=e?"".concat(M(e),", "):"no url provided, ",i+="MIME type: ".concat(n?'"'.concat(n,'"'):"not provided",", ");const r=t?zt(t):"";return i+=r?' first bytes: "'.concat(r,'"'):"first bytes: not available",i+=")",i}function It(t,e){for(const n of t){if(n.mimeTypes&&n.mimeTypes.includes(e))return n;if(e==="application/x.".concat(n.id))return n}return null}function Rt(t,e){if(e.testText)return e.testText(t);return(Array.isArray(e.tests)?e.tests:[e.tests]).some(e=>t.startsWith(e))}function Ft(t,e,n){return(Array.isArray(n.tests)?n.tests:[n.tests]).some(i=>function(t,e,n,i){if(i instanceof ArrayBuffer)return function(t,e,n){if(n=n||t.byteLength,t.byteLength<n||e.byteLength<n)return!1;const i=new Uint8Array(t),r=new Uint8Array(e);for(let t=0;t<i.length;++t)if(i[t]!==r[t])return!1;return!0}(i,t,i.byteLength);switch(typeof i){case"function":return i(t,n);case"string":return i===kt(t,e,i.length);default:return!1}}(t,e,n,i))}function zt(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;if("string"==typeof t)return t.slice(0,e);if(ArrayBuffer.isView(t))return kt(t.buffer,t.byteOffset,e);if(t instanceof ArrayBuffer){return kt(t,0,e)}return""}function kt(t,e,n){if(t.byteLength<e+n)return"";const i=new DataView(t);let r="";for(let t=0;t<n;t++)r+=String.fromCharCode(i.getUint8(e+t));return r}const jt=262144;function Bt(t,e){return r?async function*(t,e){const n=t.getReader();let i;try{for(;;){const t=i||n.read();null!=e&&e._streamReadAhead&&(i=n.read());const{done:r,value:s}=await t;if(r)return;yield L(s)}}catch(t){n.releaseLock()}}(t,e):async function*(t){for await(const e of t)yield L(e)}(t)}function Dt(t,e){if("string"==typeof t)return function*(t,e){const n=(null==e?void 0:e.chunkSize)||262144;let i=0;const r=new TextEncoder;for(;i<t.length;){const e=Math.min(t.length-i,n),s=t.slice(i,i+e);i+=e,yield r.encode(s)}}(t,e);if(t instanceof ArrayBuffer)return function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function*(){const{chunkSize:n=jt}=e;let i=0;for(;i<t.byteLength;){const e=Math.min(t.byteLength-i,n),r=new ArrayBuffer(e),s=new Uint8Array(t,i,e);new Uint8Array(r).set(s),i+=e,yield r}}()}(t,e);if(z(t))return async function*(t,e){const n=(null==e?void 0:e.chunkSize)||1048576;let i=0;for(;i<t.size;){const e=i+n,r=await t.slice(i,e).arrayBuffer();i=e,yield r}}(t,e);if(k(t))return Bt(t,e);if(F(t)){return Bt(t.body,e)}throw new Error("makeIterator")}const Nt="Cannot convert supplied data type";async function Ut(t,e,n){const i=t instanceof ArrayBuffer||ArrayBuffer.isView(t);if("string"==typeof t||i)return function(t,e){if(e.text&&"string"==typeof t)return t;var n;if((n=t)&&"object"==typeof n&&n.isBuffer&&(t=t.buffer),t instanceof ArrayBuffer){const n=t;return e.text&&!e.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(t)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(t);let n=t.buffer;const i=t.byteLength||t.length;return 0===t.byteOffset&&i===n.byteLength||(n=n.slice(t.byteOffset,t.byteOffset+i)),n}throw new Error(Nt)}(t,e);if(z(t)&&(t=await W(t)),F(t)){const n=t;return await async function(t){if(!t.ok){const e=await async function(t){let e="Failed to fetch resource ".concat(t.url," (").concat(t.status,"): ");try{const n=t.headers.get("Content-Type");let i=t.statusText;n.includes("application/json")&&(i+=" ".concat(await t.text())),e+=i,e=e.length>60?"".concat(e.slice(0,60),"..."):e}catch(t){}return e}(t);throw new Error(e)}}(n),e.binary?await n.arrayBuffer():await n.text()}if(k(t)&&(t=Dt(t,n)),(r=t)&&"function"==typeof r[Symbol.iterator]||(t=>t&&"function"==typeof t[Symbol.asyncIterator])(t))return A(t);var r;throw new Error(Nt)}function Vt(t,e){const n=bt(),i=t||n;return"function"==typeof i.fetch?i.fetch:I(i.fetch)?t=>H(t,i):null!=e&&e.fetch?null==e?void 0:e.fetch:H}function Gt(t,e,n){if(n)return n;const i={fetch:Vt(e,t),...t};if(i.url){const t=U(i.url);i.baseUrl=t,i.queryString=function(t){const e=t.match(N);return e&&e[0]}(i.url),i.filename=M(t),i.baseUrl=function(t){const e=t?t.lastIndexOf("/"):-1;return e>=0?t.substr(0,e):""}(t)}return Array.isArray(i.loaders)||(i.loaders=null),i}async function Wt(t,e,n,i){o(!i||"object"==typeof i),!e||Array.isArray(e)||At(e)||(i=void 0,n=e,e=void 0),n=n||{};const r=V(t=await t),s=function(t,e){if(!e&&t&&!Array.isArray(t))return t;let n;if(t&&(n=Array.isArray(t)?t:[t]),e&&e.loaders){const t=Array.isArray(e.loaders)?e.loaders:[e.loaders];n=n?[...n,...t]:t}return n&&n.length?n:null}(e,i),a=await async function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0;if(!Mt(t))return null;let r=Lt(t,e,{...n,nothrow:!0},i);if(r)return r;if(z(t)&&(r=Lt(t=await t.slice(0,10).arrayBuffer(),e,n,i)),!(r||null!=n&&n.nothrow))throw new Error(Ot(t));return r}(t,s,n);return a?(i=Gt({url:r,parse:Wt,loaders:s},n=_t(n,a,s,r),i||null),await async function(t,e,n,i){if(function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"3.4.15";o(t,"no worker provided");const n=t.version}(t),F(e)){const t=e,{ok:n,redirected:r,status:s,statusText:o,type:a,url:c}=t,l=Object.fromEntries(t.headers.entries());i.response={headers:l,ok:n,redirected:r,status:s,statusText:o,type:a,url:c}}if(e=await Ut(e,t,n),t.parseTextSync&&"string"==typeof e)return n.dataType="text",t.parseTextSync(e,n,i,t);if(function(t,e){return!!x.isSupported()&&t.worker&&(null==e?void 0:e.worker)}(t,n))return await P(t,e,n,i,Wt);if(t.parseText&&"string"==typeof e)return await t.parseText(e,n,i,t);if(t.parse)return await t.parse(e,n,i,t);throw o(!t.parseSync),new Error("".concat(t.id," loader - no parser found and worker is disabled"))}(a,t,n,i)):null}async function Ht(t,e,n,i){Array.isArray(e)||At(e)||(n=e,e=void 0);const r=Vt(n);let s=t;return"string"==typeof t&&(s=await r(t)),z(t)&&(s=await r(t)),await Wt(s,e,n)}var Xt=new ut({id:"deck"});let Zt={};function Yt(t,e,n,i){Xt.level>0&&Zt[t]&&Zt[t].call(null,e,n,i)}const Kt={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(Kt,"IDENTITY",{get:()=>(Xt.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const qt={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Jt={common:0,meters:1,pixels:2},Qt=new ut({id:"luma.gl"});function $t(t,e){if(!t)throw new Error(e||"luma.gl: assertion failed.")}function te(t){return"undefined"!=typeof WebGLRenderingContext&&t instanceof WebGLRenderingContext||("undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||Boolean(t&&Number.isFinite(t._version)))}function ee(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||Boolean(t&&2===t._version)}function ne(t){return $t(te(t),"Invalid WebGLRenderingContext"),t}function ie(t){return $t(ee(t),"Requires WebGL2"),t}const re={};function se(t,e){var n;re[t]=!0,n=e,globalThis.console&&globalThis.console.error&&globalThis.console.error(n)}const oe=function t(e){const n=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(let e=0;e<this.attribs.length;e++){const i=new t.VertexAttrib(n);this.attribs[e]=i}this.maxAttrib=0};(oe.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=5126,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};const ae=function(t){const e=this;this.gl=t,function(t){const e=t.getError;t.getError=function(){let n;do{n=e.apply(t),0!==n&&(re[n]=!0)}while(0!==n);for(n in re)if(re[n])return delete re[n],parseInt(n,10);return 0}}(t);const n=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(t){return t===e.VERTEX_ARRAY_BINDING_OES?e.currentVertexArrayObject===e.defaultVertexArrayObject?null:e.currentVertexArrayObject:n.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(t){const i=e.currentVertexArrayObject;i.maxAttrib=Math.max(i.maxAttrib,t);return i.attribs[t].enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(t){const i=e.currentVertexArrayObject;i.maxAttrib=Math.max(i.maxAttrib,t);return i.attribs[t].enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(t,i){switch(t){case 34962:e.currentArrayBuffer=i;break;case 34963:e.currentVertexArrayObject.elementArrayBuffer=i}return n.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(t,i){const r=e.currentVertexArrayObject.attribs[t];switch(i){case 34975:return r.buffer;case 34338:return r.enabled;case 34339:return r.size;case 34340:return r.stride;case 34341:return r.type;case 34922:return r.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(t,i,r,s,o,a){const c=e.currentVertexArrayObject;c.maxAttrib=Math.max(c.maxAttrib,t);const l=c.attribs[t];return l.buffer=e.currentArrayBuffer,l.size=i,l.type=r,l.normalized=s,l.stride=o,l.offset=a,l.recache(),n.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas&&t.canvas.addEventListener("webglcontextrestored",()=>{var t;t="OESVertexArrayObject emulation library context restored",globalThis.console&&globalThis.console.log&&globalThis.console.log(t),e.reset_()},!0),this.reset_()};ae.prototype.VERTEX_ARRAY_BINDING_OES=34229,ae.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(let t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;const t=this.gl;this.maxVertexAttribs=t.getParameter(34921),this.defaultVertexArrayObject=new oe(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},ae.prototype.createVertexArrayOES=function(){const t=new oe(this);return this.vertexArrayObjects.push(t),t},ae.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject===t&&this.bindVertexArrayOES(null)},ae.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof oe&&t.hasBeenBound&&t.ext===this)},ae.prototype.bindVertexArrayOES=function(t){const e=this.gl;if(t&&!t.isAlive)return void se(1282,"bindVertexArrayOES: attempt to bind deleted arrayObject");const n=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=t||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;const r=this.currentVertexArrayObject;if(i===r)return;i&&r.elementArrayBuffer===i.elementArrayBuffer||n.bindBuffer.call(e,34963,r.elementArrayBuffer);let s=this.currentArrayBuffer;const o=Math.max(i?i.maxAttrib:0,r.maxAttrib);for(let t=0;t<=o;t++){const o=r.attribs[t],a=i?i.attribs[t]:null;if(i&&o.enabled===a.enabled||(o.enabled?n.enableVertexAttribArray.call(e,t):n.disableVertexAttribArray.call(e,t)),o.enabled){let r=!1;i&&o.buffer===a.buffer||(s!==o.buffer&&(n.bindBuffer.call(e,34962,o.buffer),s=o.buffer),r=!0),(r||o.cached!==a.cached)&&n.vertexAttribPointer.call(e,t,o.size,o.type,o.normalized,o.stride,o.offset)}}this.currentArrayBuffer!==s&&n.bindBuffer.call(e,34962,this.currentArrayBuffer)};const ce="OES_element_index",le="WEBGL_draw_buffers",ue="WEBGL_debug_renderer_info",he=35723,de=36795,fe=34047,ge=37445,pe=37446,me=t=>ee(t)?void 0:0,ve={3074:t=>ee(t)?void 0:36064,[he]:t=>ee(t)?void 0:4352,35977:me,32937:me,[de]:(t,e)=>{const n=ee(t)?t.getExtension("EXT_disjoint_timer_query_webgl2"):t.getExtension("EXT_disjoint_timer_query");return n&&n.GPU_DISJOINT_EXT?e(n.GPU_DISJOINT_EXT):0},[ge]:(t,e)=>{const n=t.getExtension(ue);return e(n&&n.UNMASKED_VENDOR_WEBGL||7936)},[pe]:(t,e)=>{const n=t.getExtension(ue);return e(n&&n.UNMASKED_RENDERER_WEBGL||7937)},[fe]:(t,e)=>{const n=t.luma.extensions.EXT_texture_filter_anisotropic;return n?e(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1},32883:me,35071:me,37447:me,36063:(t,e)=>{if(!ee(t)){const n=t.getExtension(le);return n?e(n.MAX_COLOR_ATTACHMENTS_WEBGL):0}},35379:me,35374:me,35377:me,34852:t=>{if(!ee(t)){const e=t.getExtension(le);return e?e.MAX_DRAW_BUFFERS_WEBGL:0}},36203:t=>t.getExtension(ce)?2147483647:65535,33001:t=>t.getExtension(ce)?16777216:65535,33e3:t=>16777216,37157:me,35373:me,35657:me,36183:me,37137:me,34045:me,35978:me,35979:me,35968:me,35376:me,35375:me,35659:me,37154:me,35371:me,35658:me,35076:me,35077:me,35380:me};const ye="OES_vertex_array_object",be="ANGLE_instanced_arrays",_e="WEBGL_draw_buffers",xe="EXT_disjoint_timer_query";const Pe={[ye]:{meta:{suffix:"OES"},createVertexArray:()=>{$t(!1,"VertexArray requires WebGL2 or OES_vertex_array_object extension")},deleteVertexArray:()=>{},bindVertexArray:()=>{},isVertexArray:()=>!1},[be]:{meta:{suffix:"ANGLE"},vertexAttribDivisor(t,e){$t(0===e,"WebGL instanced rendering not supported")},drawElementsInstanced:()=>{},drawArraysInstanced:()=>{}},[_e]:{meta:{suffix:"WEBGL"},drawBuffers:()=>{$t(!1)}},[xe]:{meta:{suffix:"EXT"},createQuery:()=>{$t(!1)},deleteQuery:()=>{$t(!1)},beginQuery:()=>{$t(!1)},endQuery:()=>{},getQuery(t,e){return this.getQueryObject(t,e)},getQueryParameter(t,e){return this.getQueryObject(t,e)},getQueryObject:()=>{}}},we={readBuffer:(t,e,n)=>{ee(t)&&e(n)},getVertexAttrib:(t,e,n,i)=>{const{webgl2:r,ext:s}=function(t,e){return{webgl2:ee(t),ext:t.getExtension(e)}}(t,be);let o;switch(i){case 35069:o=!!r&&void 0;break;case 35070:o=r||s?void 0:0}return void 0!==o?o:e(n,i)},getProgramParameter:(t,e,n,i)=>{if(!ee(t))switch(i){case 35967:return 35981;case 35971:case 35382:return 0}return e(n,i)},getInternalformatParameter:(t,e,n,i,r)=>ee(t)||32937!==r?t.getInternalformatParameter(n,i,r):new Int32Array([0]),getTexParameter(t,e,n,i){if(34046===i){const{extensions:e}=t.luma,n=e.EXT_texture_filter_anisotropic;i=n&&n.TEXTURE_MAX_ANISOTROPY_EXT||34046}return e(n,i)},getParameter:function(t,e,n){const i=ve[n],r="function"==typeof i?i(t,e,n):i;return void 0!==r?r:e(n)},hint:(t,e,n,i)=>e(n,i)};function Ae(t,e){let{extension:n,target:i,target2:r}=e;const s=Pe[n];$t(s);const{meta:o={}}=s,{suffix:a=""}=o,c=t.getExtension(n);for(const e of Object.keys(s)){const n="".concat(e).concat(a);let o=null;"meta"===e||"function"==typeof t[e]||(c&&"function"==typeof c[n]?o=function(){return c[n](...arguments)}:"function"==typeof s[e]&&(o=s[e].bind(i))),o&&(i[e]=o,r[e]=o)}}globalThis.polyfillContext=function(t){t.luma=t.luma||{};const{luma:e}=t;return e.polyfilled||(!function(t){if("function"==typeof t.createVertexArray)return;const e=t.getSupportedExtensions;t.getSupportedExtensions=function(){const t=e.call(this)||[];return t.indexOf("OES_vertex_array_object")<0&&t.push("OES_vertex_array_object"),t};const n=t.getExtension;t.getExtension=function(e){return n.call(this,e)||("OES_vertex_array_object"!==e?null:(t.__OESVertexArrayObject||(this.__OESVertexArrayObject=new ae(this)),this.__OESVertexArrayObject))}}(t),function(t){t.luma.extensions={};const e=t.getSupportedExtensions()||[];for(const n of e)t.luma[n]=t.getExtension(n)}(t),function(t,e){for(const n of Object.getOwnPropertyNames(e))"overrides"!==n&&Ae(t,{extension:n,target:t.luma,target2:t})}(t,Pe),function(t,e){let{target:n,target2:i}=e;Object.keys(we).forEach(e=>{if("function"==typeof we[e]){const r=t[e]?t[e].bind(t):()=>{},s=we[e].bind(null,t,r);n[e]=s,i[e]=s}})}(t,{target:e,target2:t}),e.polyfilled=!0),t};const Se={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,36006:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],3333:4,3317:4,37440:!1,37441:!1,37443:37444,35723:4352,36010:null,35977:!1,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},Te=(t,e,n)=>e?t.enable(n):t.disable(n),Ee=(t,e,n)=>t.hint(n,e),Ce=(t,e,n)=>t.pixelStorei(n,e);function Le(t){return Array.isArray(t)||ArrayBuffer.isView(t)}const Me={3042:Te,32773:(t,e)=>t.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(t,e)=>t.clearColor(...e),3107:(t,e)=>t.colorMask(...e),2884:Te,2885:(t,e)=>t.cullFace(e),2929:Te,2931:(t,e)=>t.clearDepth(e),2932:(t,e)=>t.depthFunc(e),2928:(t,e)=>t.depthRange(...e),2930:(t,e)=>t.depthMask(e),3024:Te,35723:Ee,36006:(t,e)=>{const n=ee(t)?36009:36160;return t.bindFramebuffer(n,e)},2886:(t,e)=>t.frontFace(e),33170:Ee,2849:(t,e)=>t.lineWidth(e),32823:Te,32824:"polygonOffset",10752:"polygonOffset",35977:Te,32938:"sampleCoverage",32939:"sampleCoverage",3089:Te,3088:(t,e)=>t.scissor(...e),2960:Te,2961:(t,e)=>t.clearStencil(e),2968:(t,e)=>t.stencilMaskSeparate(1028,e),36005:(t,e)=>t.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(t,e)=>t.viewport(...e),3333:Ce,3317:Ce,37440:Ce,37441:Ce,37443:Ce,3330:Ce,3332:Ce,3331:Ce,36010:(t,e)=>t.bindFramebuffer(36008,e),3314:Ce,32878:Ce,3316:Ce,3315:Ce,32877:Ce,framebuffer:(t,e)=>{const n=e&&"handle"in e?e.handle:e;return t.bindFramebuffer(36160,n)},blend:(t,e)=>e?t.enable(3042):t.disable(3042),blendColor:(t,e)=>t.blendColor(...e),blendEquation:(t,e)=>{e=Le(e)?e:[e,e],t.blendEquationSeparate(...e)},blendFunc:(t,e)=>{e=Le(e)&&2===e.length?[...e,...e]:e,t.blendFuncSeparate(...e)},clearColor:(t,e)=>t.clearColor(...e),clearDepth:(t,e)=>t.clearDepth(e),clearStencil:(t,e)=>t.clearStencil(e),colorMask:(t,e)=>t.colorMask(...e),cull:(t,e)=>e?t.enable(2884):t.disable(2884),cullFace:(t,e)=>t.cullFace(e),depthTest:(t,e)=>e?t.enable(2929):t.disable(2929),depthFunc:(t,e)=>t.depthFunc(e),depthMask:(t,e)=>t.depthMask(e),depthRange:(t,e)=>t.depthRange(...e),dither:(t,e)=>e?t.enable(3024):t.disable(3024),derivativeHint:(t,e)=>{t.hint(35723,e)},frontFace:(t,e)=>t.frontFace(e),mipmapHint:(t,e)=>t.hint(33170,e),lineWidth:(t,e)=>t.lineWidth(e),polygonOffsetFill:(t,e)=>e?t.enable(32823):t.disable(32823),polygonOffset:(t,e)=>t.polygonOffset(...e),sampleCoverage:(t,e)=>t.sampleCoverage(...e),scissorTest:(t,e)=>e?t.enable(3089):t.disable(3089),scissor:(t,e)=>t.scissor(...e),stencilTest:(t,e)=>e?t.enable(2960):t.disable(2960),stencilMask:(t,e)=>{e=Le(e)?e:[e,e];const[n,i]=e;t.stencilMaskSeparate(1028,n),t.stencilMaskSeparate(1029,i)},stencilFunc:(t,e)=>{e=Le(e)&&3===e.length?[...e,...e]:e;const[n,i,r,s,o,a]=e;t.stencilFuncSeparate(1028,n,i,r),t.stencilFuncSeparate(1029,s,o,a)},stencilOp:(t,e)=>{e=Le(e)&&3===e.length?[...e,...e]:e;const[n,i,r,s,o,a]=e;t.stencilOpSeparate(1028,n,i,r),t.stencilOpSeparate(1029,s,o,a)},viewport:(t,e)=>t.viewport(...e)};function Oe(t,e,n){return void 0!==e[t]?e[t]:n[t]}const Ie={blendEquation:(t,e,n)=>t.blendEquationSeparate(Oe(32777,e,n),Oe(34877,e,n)),blendFunc:(t,e,n)=>t.blendFuncSeparate(Oe(32969,e,n),Oe(32968,e,n),Oe(32971,e,n),Oe(32970,e,n)),polygonOffset:(t,e,n)=>t.polygonOffset(Oe(32824,e,n),Oe(10752,e,n)),sampleCoverage:(t,e,n)=>t.sampleCoverage(Oe(32938,e,n),Oe(32939,e,n)),stencilFuncFront:(t,e,n)=>t.stencilFuncSeparate(1028,Oe(2962,e,n),Oe(2967,e,n),Oe(2963,e,n)),stencilFuncBack:(t,e,n)=>t.stencilFuncSeparate(1029,Oe(34816,e,n),Oe(36003,e,n),Oe(36004,e,n)),stencilOpFront:(t,e,n)=>t.stencilOpSeparate(1028,Oe(2964,e,n),Oe(2965,e,n),Oe(2966,e,n)),stencilOpBack:(t,e,n)=>t.stencilOpSeparate(1029,Oe(34817,e,n),Oe(34818,e,n),Oe(34819,e,n))},Re={enable:(t,e)=>t({[e]:!0}),disable:(t,e)=>t({[e]:!1}),pixelStorei:(t,e,n)=>t({[e]:n}),hint:(t,e,n)=>t({[e]:n}),bindFramebuffer:(t,e,n)=>{switch(e){case 36160:return t({36006:n,36010:n});case 36009:return t({36006:n});case 36008:return t({36010:n});default:return null}},blendColor:(t,e,n,i,r)=>t({32773:new Float32Array([e,n,i,r])}),blendEquation:(t,e)=>t({32777:e,34877:e}),blendEquationSeparate:(t,e,n)=>t({32777:e,34877:n}),blendFunc:(t,e,n)=>t({32969:e,32968:n,32971:e,32970:n}),blendFuncSeparate:(t,e,n,i,r)=>t({32969:e,32968:n,32971:i,32970:r}),clearColor:(t,e,n,i,r)=>t({3106:new Float32Array([e,n,i,r])}),clearDepth:(t,e)=>t({2931:e}),clearStencil:(t,e)=>t({2961:e}),colorMask:(t,e,n,i,r)=>t({3107:[e,n,i,r]}),cullFace:(t,e)=>t({2885:e}),depthFunc:(t,e)=>t({2932:e}),depthRange:(t,e,n)=>t({2928:new Float32Array([e,n])}),depthMask:(t,e)=>t({2930:e}),frontFace:(t,e)=>t({2886:e}),lineWidth:(t,e)=>t({2849:e}),polygonOffset:(t,e,n)=>t({32824:e,10752:n}),sampleCoverage:(t,e,n)=>t({32938:e,32939:n}),scissor:(t,e,n,i,r)=>t({3088:new Int32Array([e,n,i,r])}),stencilMask:(t,e)=>t({2968:e,36005:e}),stencilMaskSeparate:(t,e,n)=>t({[1028===e?2968:36005]:n}),stencilFunc:(t,e,n,i)=>t({2962:e,2967:n,2963:i,34816:e,36003:n,36004:i}),stencilFuncSeparate:(t,e,n,i,r)=>t({[1028===e?2962:34816]:n,[1028===e?2967:36003]:i,[1028===e?2963:36004]:r}),stencilOp:(t,e,n,i)=>t({2964:e,2965:n,2966:i,34817:e,34818:n,34819:i}),stencilOpSeparate:(t,e,n,i,r)=>t({[1028===e?2964:34817]:n,[1028===e?2965:34818]:i,[1028===e?2966:34819]:r}),viewport:(t,e,n,i,r)=>t({2978:[e,n,i,r]})},Fe=(t,e)=>t.isEnabled(e),ze={3042:Fe,2884:Fe,2929:Fe,3024:Fe,32823:Fe,32926:Fe,32928:Fe,3089:Fe,2960:Fe,35977:Fe};function ke(t){for(const e in t)return!1;return!0}function je(t,e){if(t===e)return!0;const n=Array.isArray(t)||ArrayBuffer.isView(t),i=Array.isArray(e)||ArrayBuffer.isView(e);if(n&&i&&t.length===e.length){for(let n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}return!1}function Be(t,e){const n=t[e].bind(t);t[e]=function(){const e=arguments.length<=0?void 0:arguments[0];return e in t.state.cache&&t.state.enable?t.state.cache[e]:n(...arguments)},Object.defineProperty(t[e],"name",{value:"".concat(e,"-from-cache"),configurable:!1})}function De(t,e,n){const i=t[e].bind(t);t[e]=function(){for(var e=arguments.length,r=new Array(e),s=0;s<e;s++)r[s]=arguments[s];const{valueChanged:o,oldValue:a}=n(t.state._updateCache,...r);return o&&i(...r),a},Object.defineProperty(t[e],"name",{value:"".concat(e,"-to-cache"),configurable:!1})}class Ne{constructor(t){let{copyState:e=!1,log:n=()=>{}}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.program=null,this.stateStack=[],this.enable=!0,this.cache=e?function(t,e){if("number"==typeof(e=e||Se)){const n=e,i=ze[n];return i?i(t,n):t.getParameter(n)}const n=Array.isArray(e)?e:Object.keys(e),i={};for(const e of n){const n=ze[e];i[e]=n?n(t,Number(e)):t.getParameter(Number(e))}return i}(t):Object.assign({},Se),this.log=n,this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(){this.stateStack.push({})}pop(){$t(this.stateStack.length>0);const t=this.stateStack[this.stateStack.length-1];Ge(this.gl,t),this.stateStack.pop()}_updateCache(t){let e,n=!1;const i=this.stateStack.length>0&&this.stateStack[this.stateStack.length-1];for(const r in t){$t(void 0!==r);const s=t[r],o=this.cache[r];je(s,o)||(n=!0,e=o,i&&!(r in i)&&(i[r]=o),this.cache[r]=s)}return{valueChanged:n,oldValue:e}}}function Ue(t){t.state||function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{enable:n=!0,copyState:i}=e;if($t(void 0!==i),!t.state){const{polyfillContext:e}=globalThis;e&&e(t),t.state=new Ne(t,{copyState:i}),function(t){const e=t.useProgram.bind(t);t.useProgram=function(n){t.state.program!==n&&(e(n),t.state.program=n)}}(t);for(const e in Re)De(t,e,Re[e]);Be(t,"getParameter"),Be(t,"isEnabled")}t.state.enable=n}(t,{copyState:!1}),t.state.push()}function Ve(t){$t(t.state),t.state.pop()}function Ge(t,e){if($t(te(t),"setParameters requires a WebGL context"),ke(e))return;const n={};for(const i in e){const r=Number(i),s=Me[i];s&&("string"==typeof s?n[s]=!0:s(t,e[i],r))}const i=t.state&&t.state.cache;if(i)for(const r in n){(0,Ie[r])(t,e,i)}}function We(t,e,n){if(ke(e))return n(t);const{nocatch:i=!0}=e;let r;if(Ue(t),Ge(t,e),i)r=n(t),Ve(t);else try{r=n(t)}finally{Ve(t)}return r}X();const He="8.5.21";const Xe=new class{constructor(){this.stats=new Map}get(t){return this.stats.has(t)||this.stats.set(t,new E({id:t})),this.stats.get(t)}};if(globalThis.luma&&globalThis.luma.VERSION!==He)throw new Error("luma.gl - multiple VERSIONs detected: ".concat(globalThis.luma.VERSION," vs ").concat(He));function Ze(t,e){if(!t)throw new Error(e||"luma.gl: assertion failed.")}function Ye(t,e){if("string"!=typeof e)return e;const n=Number(e);if(!isNaN(n))return n;const i=t[e=e.replace(/^.*\./,"")];return Ze(void 0!==i,"Accessing undefined constant GL.".concat(e)),i}function Ke(t,e){e=Number(e);for(const n in t)if(t[n]===e)return"GL.".concat(n);return String(e)}globalThis.luma||(X()&&Qt.log(1,"luma.gl ".concat(He," - ").concat("set luma.log.level=1 (or higher) to trace rendering"))(),globalThis.luma=globalThis.luma||{VERSION:He,version:He,log:Qt,stats:Xe,globals:{modules:{},nodeIO:{}}});const qe={};function Je(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"id";qe[t]=qe[t]||1;const e=qe[t]++;return"".concat(t,"-").concat(e)}function Qe(t){return Ze("number"==typeof t,"Input must be a number"),t&&!(t&t-1)}function $e(t){let e=!0;for(const n in t){e=!1;break}return e}function tn(t,e,n,i){const r="See luma.gl ".concat(n," Upgrade Guide at https://luma.gl/docs/upgrade-guide"),s=Object.getPrototypeOf(t);i.forEach(t=>{s.methodName||(s[t]=()=>{throw Qt.removed("Calling removed method ".concat(e,".").concat(t,": "),r)(),new Error(t)})})}const en="Resource subclass must define virtual methods";class nn{get[Symbol.toStringTag](){return"Resource"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};ne(t);const{id:n,userData:i={}}=e;this.gl=t,this.gl2=t,this.id=n||Je(this[Symbol.toStringTag]),this.userData=i,this._bound=!1,this._handle=e.handle,void 0===this._handle&&(this._handle=this._createHandle()),this.byteLength=0,this._addStats()}toString(){return"".concat(this[Symbol.toStringTag]||this.constructor.name,"(").concat(this.id,")")}get handle(){return this._handle}delete(){let{deleteChildren:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._handle&&this._deleteHandle(this._handle);return this._handle&&this._removeStats(),this._handle=null,e&&t&&e.filter(Boolean).forEach(t=>t.delete()),this}bind(){let t,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.handle;return"function"!=typeof e?(this._bindHandle(e),this):(this._bound?t=e():(this._bindHandle(this.handle),this._bound=!0,t=e(),this._bound=!1,this._bindHandle(null)),t)}unbind(){this.bind(null)}getParameter(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Ze(t=Ye(this.gl,t));const n=(this.constructor.PARAMETERS||{})[t];if(n){const t=ee(this.gl);if(!((!("webgl2"in n)||t)&&(!("extension"in n)||this.gl.getExtension(n.extension)))){const e=n.webgl1,i="webgl2"in n?n.webgl2:n.webgl1;return t?i:e}}return this._getParameter(t,e)}getParameters(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{parameters:e,keys:n}=t,i=this.constructor.PARAMETERS||{},r=ee(this.gl),s={},o=e||Object.keys(i);for(const e of o){const o=i[e];if(o&&(!("webgl2"in o)||r)&&(!("extension"in o)||this.gl.getExtension(o.extension))){const i=n?Ke(this.gl,e):e;s[i]=this.getParameter(e,t),n&&"GLenum"===o.type&&(s[i]=Ke(this.gl,s[i]))}}return s}setParameter(t,e){Ze(t=Ye(this.gl,t));const n=(this.constructor.PARAMETERS||{})[t];if(n){const t=ee(this.gl);if(!((!("webgl2"in n)||t)&&(!("extension"in n)||this.gl.getExtension(n.extension))))throw new Error("Parameter not available on this platform");"GLenum"===n.type&&(e=Ye(e))}return this._setParameter(t,e),this}setParameters(t){for(const e in t)this.setParameter(e,t[e]);return this}stubRemovedMethods(t,e,n){return tn(this,t,e,n)}initialize(t){}_createHandle(){throw new Error(en)}_deleteHandle(){throw new Error(en)}_bindHandle(t){throw new Error(en)}_getOptsFromHandle(){throw new Error(en)}_getParameter(t,e){throw new Error(en)}_setParameter(t,e){throw new Error(en)}_context(){return this.gl.luma=this.gl.luma||{},this.gl.luma}_addStats(){const t=this[Symbol.toStringTag],e=Xe.get("Resource Counts");e.get("Resources Created").incrementCount(),e.get("".concat(t,"s Created")).incrementCount(),e.get("".concat(t,"s Active")).incrementCount()}_removeStats(){const t=this[Symbol.toStringTag];Xe.get("Resource Counts").get("".concat(t,"s Active")).decrementCount()}_trackAllocatedMemory(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this[Symbol.toStringTag];this._trackAllocatedMemoryForContext(t,e),this._trackAllocatedMemoryForContext(t,e,this.gl.canvas&&this.gl.canvas.id),this.byteLength=t}_trackAllocatedMemoryForContext(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this[Symbol.toStringTag],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const i=Xe.get("Memory Usage".concat(n));i.get("GPU Memory").addCount(t),i.get("".concat(e," Memory")).addCount(t)}_trackDeallocatedMemory(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this[Symbol.toStringTag];this._trackDeallocatedMemoryForContext(t),this._trackDeallocatedMemoryForContext(t,this.gl.canvas&&this.gl.canvas.id),this.byteLength=0}_trackDeallocatedMemoryForContext(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this[Symbol.toStringTag],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const n=Xe.get("Memory Usage".concat(e));n.get("GPU Memory").subtractCount(this.byteLength),n.get("".concat(t," Memory")).subtractCount(this.byteLength)}}function rn(t){switch(ArrayBuffer.isView(t)?t.constructor:t){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error("Failed to deduce GL constant from typed array")}}function sn(t){let{clamped:e=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(t){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return e?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function on(t){let{data:e,width:n,height:i}=t;const r=Math.round(n/2),s=Math.round(i/2),o=new Uint8Array(r*s*4);for(let t=0;t<s;t++)for(let i=0;i<r;i++)for(let s=0;s<4;s++)o[4*(t*r+i)+s]=e[4*(2*t*n+2*i)+s];return{data:o,width:r,height:s}}function an(t,e,n){const{removedProps:i={},deprecatedProps:r={},replacedProps:s={}}=n;for(const n in i)if(n in e){const e=i[n]?"".concat(t,".").concat(i[n]):"N/A";Qt.removed("".concat(t,".").concat(n),e)()}for(const n in r)if(n in e){const e=r[n];Qt.deprecated("".concat(t,".").concat(n),"".concat(t,".").concat(e))()}let o=null;for(const n in s)if(n in e){const i=s[n];Qt.deprecated("".concat(t,".").concat(n),"".concat(t,".").concat(i))(),o=o||Object.assign({},e),o[i]=e[n],delete o[n]}return o||e}const cn={offset:0,stride:0,type:5126,size:1,divisor:0,normalized:!1,integer:!1},ln={deprecatedProps:{instanced:"divisor",isInstanced:"divisor"}};class un{static getBytesPerElement(t){return sn(t.type||5126).BYTES_PER_ELEMENT}static getBytesPerVertex(t){Ze(t.size);return sn(t.type||5126).BYTES_PER_ELEMENT*t.size}static resolve(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return new un(...[cn,...e])}constructor(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];e.forEach(t=>this._assign(t)),Object.freeze(this)}toString(){return JSON.stringify(this)}get BYTES_PER_ELEMENT(){return un.getBytesPerElement(this)}get BYTES_PER_VERTEX(){return un.getBytesPerVertex(this)}_assign(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=an("Accessor",t,ln),void 0!==t.type&&(this.type=t.type,5124!==t.type&&5125!==t.type||(this.integer=!0)),void 0!==t.size&&(this.size=t.size),void 0!==t.offset&&(this.offset=t.offset),void 0!==t.stride&&(this.stride=t.stride),void 0!==t.normalized&&(this.normalized=t.normalized),void 0!==t.integer&&(this.integer=t.integer),void 0!==t.divisor&&(this.divisor=t.divisor),void 0!==t.buffer&&(this.buffer=t.buffer),void 0!==t.index&&("boolean"==typeof t.index?this.index=t.index?1:0:this.index=t.index),void 0!==t.instanced&&(this.divisor=t.instanced?1:0),void 0!==t.isInstanced&&(this.divisor=t.isInstanced?1:0),this}}const hn={offset:"accessor.offset",stride:"accessor.stride",type:"accessor.type",size:"accessor.size",divisor:"accessor.divisor",normalized:"accessor.normalized",integer:"accessor.integer",instanced:"accessor.divisor",isInstanced:"accessor.divisor"},dn={removedProps:{},replacedProps:{bytes:"byteLength"},deprecatedProps:hn},fn={removedProps:hn};class gn extends nn{get[Symbol.toStringTag](){return"Buffer"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.stubRemovedMethods("Buffer","v6.0",["layout","setLayout","getIndexedParameter"]),this.target=e.target||(this.gl.webgl2?36662:34962),this.initialize(e),Object.seal(this)}getElementCount(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.accessor;return Math.round(this.byteLength/un.getBytesPerElement(t))}getVertexCount(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.accessor;return Math.round(this.byteLength/un.getBytesPerVertex(t))}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return ArrayBuffer.isView(t)&&(t={data:t}),Number.isFinite(t)&&(t={byteLength:t}),t=an("Buffer",t,dn),this.usage=t.usage||35044,this.debugData=null,this.setAccessor(Object.assign({},t,t.accessor)),t.data?this._setData(t.data,t.offset,t.byteLength):this._setByteLength(t.byteLength||0),this}setProps(t){return"accessor"in(t=an("Buffer",t,fn))&&this.setAccessor(t.accessor),this}setAccessor(t){return delete(t=Object.assign({},t)).buffer,this.accessor=new un(t),this}reallocate(t){return t>this.byteLength?(this._setByteLength(t),!0):(this.bytesUsed=t,!1)}setData(t){return this.initialize(t)}subData(t){ArrayBuffer.isView(t)&&(t={data:t});const{data:e,offset:n=0,srcOffset:i=0}=t,r=t.byteLength||t.length;Ze(e);const s=this.gl.webgl2?36663:this.target;return this.gl.bindBuffer(s,this.handle),0!==i||void 0!==r?(ie(this.gl),this.gl.bufferSubData(this.target,n,e,i,r)):this.gl.bufferSubData(s,n,e),this.gl.bindBuffer(s,null),this.debugData=null,this._inferType(e),this}copyData(t){let{sourceBuffer:e,readOffset:n=0,writeOffset:i=0,size:r}=t;const{gl:s}=this;return ie(s),s.bindBuffer(36662,e.handle),s.bindBuffer(36663,this.handle),s.copyBufferSubData(36662,36663,n,i,r),s.bindBuffer(36662,null),s.bindBuffer(36663,null),this.debugData=null,this}getData(){let{dstData:t=null,srcByteOffset:e=0,dstOffset:n=0,length:i=0}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};ie(this.gl);const r=sn(this.accessor.type||5126,{clamped:!1}),s=this._getAvailableElementCount(e),o=n;let a,c;t?(c=t.length,a=c-o):(a=Math.min(s,i||s),c=o+a);const l=Math.min(s,a);return i=i||l,Ze(i<=l),t=t||new r(c),this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,t,n,i),this.gl.bindBuffer(36662,null),t}bind(){let{target:t=this.target,index:e=this.accessor&&this.accessor.index,offset:n=0,size:i}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return 35345===t||35982===t?void 0!==i?this.gl.bindBufferRange(t,e,this.handle,n,i):(Ze(0===n),this.gl.bindBufferBase(t,e,this.handle)):this.gl.bindBuffer(t,this.handle),this}unbind(){let{target:t=this.target,index:e=this.accessor&&this.accessor.index}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return 35345===t||35982===t?this.gl.bindBufferBase(t,e,null):this.gl.bindBuffer(t,null),this}getDebugData(){return this.debugData?{data:this.debugData,changed:!1}:(this.debugData=this.getData({length:Math.min(10,this.byteLength)}),{data:this.debugData,changed:!0})}invalidateDebugData(){this.debugData=null}_setData(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.byteLength+e;Ze(ArrayBuffer.isView(t)),this._trackDeallocatedMemory();const i=this._getTarget();this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,n,this.usage),this.gl.bufferSubData(i,e,t),this.gl.bindBuffer(i,null),this.debugData=t.slice(0,10),this.bytesUsed=n,this._trackAllocatedMemory(n);const r=rn(t);return Ze(r),this.setAccessor(new un(this.accessor,{type:r})),this}_setByteLength(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.usage;Ze(t>=0),this._trackDeallocatedMemory();let n=t;0===t&&(n=new Float32Array(0));const i=this._getTarget();return this.gl.bindBuffer(i,this.handle),this.gl.bufferData(i,n,e),this.gl.bindBuffer(i,null),this.usage=e,this.debugData=null,this.bytesUsed=t,this._trackAllocatedMemory(t),this}_getTarget(){return this.gl.webgl2?36663:this.target}_getAvailableElementCount(t){const e=t/sn(this.accessor.type||5126,{clamped:!1}).BYTES_PER_ELEMENT;return this.getElementCount()-e}_inferType(t){this.accessor.type||this.setAccessor(new un(this.accessor,{type:rn(t)}))}_createHandle(){return this.gl.createBuffer()}_deleteHandle(){this.gl.deleteBuffer(this.handle),this._trackDeallocatedMemory()}_getParameter(t){this.gl.bindBuffer(this.target,this.handle);const e=this.gl.getBufferParameter(this.target,t);return this.gl.bindBuffer(this.target,null),e}get type(){return Qt.deprecated("Buffer.type","Buffer.accessor.type")(),this.accessor.type}get bytes(){return Qt.deprecated("Buffer.bytes","Buffer.byteLength")(),this.byteLength}setByteLength(t){return Qt.deprecated("setByteLength","reallocate")(),this.reallocate(t)}updateAccessor(t){return Qt.deprecated("updateAccessor(...)","setAccessor(new Accessor(buffer.accessor, ...)")(),this.accessor=new un(this.accessor,t),this}}const pn={6407:{dataFormat:6407,types:[5121,33635]},6408:{dataFormat:6408,types:[5121,32819,32820]},6406:{dataFormat:6406,types:[5121]},6409:{dataFormat:6409,types:[5121]},6410:{dataFormat:6410,types:[5121]},33326:{dataFormat:6403,types:[5126],gl2:!0},33328:{dataFormat:33319,types:[5126],gl2:!0},34837:{dataFormat:6407,types:[5126],gl2:!0},34836:{dataFormat:6408,types:[5126],gl2:!0}},mn={6403:1,36244:1,33319:2,33320:2,6407:3,36248:3,6408:4,36249:4,6402:1,34041:1,6406:1,6409:1,6410:2},vn={5126:4,5125:4,5124:4,5123:2,5122:2,5131:2,5120:1,5121:1};const yn=[9729,9728],bn=globalThis.WebGLBuffer||function(){};class _n extends nn{get[Symbol.toStringTag](){return"Texture"}static isSupported(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{format:n,linearFiltering:i}=e;let r=!0;return n&&(r=r&&function(t,e){const n=pn[e];if(!n)return!1;if(void 0===n.gl1&&void 0===n.gl2)return!0;const i=ee(t)&&n.gl2||n.gl1;return"string"==typeof i?t.getExtension(i):i}(t,n),r=r&&(!i||function(t,e){const n=pn[e];switch(n&&n.types[0]){case 5126:return t.getExtension("OES_texture_float_linear");case 5131:return t.getExtension("OES_texture_half_float_linear");default:return!0}}(t,n))),r}constructor(t,e){const{id:n=Je("texture"),handle:i,target:r}=e;super(t,{id:n,handle:i}),this.target=r,this.textureUnit=void 0,this.loaded=!1,this.width=void 0,this.height=void 0,this.depth=void 0,this.format=void 0,this.type=void 0,this.dataFormat=void 0,this.border=void 0,this.textureUnit=void 0,this.mipmaps=void 0}toString(){return"Texture(".concat(this.id,",").concat(this.width,"x").concat(this.height,")")}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.data;if(e instanceof Promise)return e.then(e=>this.initialize(Object.assign({},t,{pixels:e,data:e}))),this;const n="undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement;if(n&&e.readyState<HTMLVideoElement.HAVE_METADATA)return this._video=null,e.addEventListener("loadeddata",()=>this.initialize(t)),this;const{pixels:i=null,format:r=6408,border:s=0,recreate:o=!1,parameters:a={},pixelStore:c={},textureUnit:l}=t;e||(e=i);let{width:u,height:h,dataFormat:d,type:f,compressed:g=!1,mipmaps:p=!0}=t;const{depth:m=0}=t;return({width:u,height:h,compressed:g,dataFormat:d,type:f}=this._deduceParameters({format:r,type:f,dataFormat:d,compressed:g,data:e,width:u,height:h})),this.width=u,this.height=h,this.depth=m,this.format=r,this.type=f,this.dataFormat=d,this.border=s,this.textureUnit=l,Number.isFinite(this.textureUnit)&&(this.gl.activeTexture(33984+this.textureUnit),this.gl.bindTexture(this.target,this.handle)),p&&this._isNPOT()&&(Qt.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),p=!1,this._updateForNPOT(a)),this.mipmaps=p,this.setImageData({data:e,width:u,height:h,depth:m,format:r,type:f,dataFormat:d,border:s,mipmaps:p,parameters:c,compressed:g}),p&&this.generateMipmap(),this.setParameters(a),o&&(this.data=e),n&&(this._video={video:e,parameters:a,lastTime:e.readyState>=HTMLVideoElement.HAVE_CURRENT_DATA?e.currentTime:-1}),this}update(){if(this._video){const{video:t,parameters:e,lastTime:n}=this._video;if(n===t.currentTime||t.readyState<HTMLVideoElement.HAVE_CURRENT_DATA)return;this.setSubImageData({data:t,parameters:e}),this.mipmaps&&this.generateMipmap(),this._video.lastTime=t.currentTime}}resize(t){let{height:e,width:n,mipmaps:i=!1}=t;return n!==this.width||e!==this.height?this.initialize({width:n,height:e,format:this.format,type:this.type,dataFormat:this.dataFormat,border:this.border,mipmaps:i}):this}generateMipmap(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._isNPOT()?(Qt.warn("texture: ".concat(this," is Non-Power-Of-Two, disabling mipmaping"))(),this):(this.mipmaps=!0,this.gl.bindTexture(this.target,this.handle),We(this.gl,t,()=>{this.gl.generateMipmap(this.target)}),this.gl.bindTexture(this.target,null),this)}setImageData(t){this._trackDeallocatedMemory("Texture");const{target:e=this.target,pixels:n=null,level:i=0,format:r=this.format,border:s=this.border,offset:o=0,parameters:a={}}=t;let{data:c=null,type:l=this.type,width:u=this.width,height:h=this.height,dataFormat:d=this.dataFormat,compressed:f=!1}=t;c||(c=n),({type:l,dataFormat:d,compressed:f,width:u,height:h}=this._deduceParameters({format:r,type:l,dataFormat:d,compressed:f,data:c,width:u,height:h}));const{gl:g}=this;g.bindTexture(this.target,this.handle);let p,m=null;({data:c,dataType:m}=this._getDataType({data:c,compressed:f}));let v=0;if(We(this.gl,a,()=>{switch(m){case"null":g.texImage2D(e,i,r,u,h,s,d,l,c);break;case"typed-array":g.texImage2D(e,i,r,u,h,s,d,l,c,o);break;case"buffer":p=ie(g),p.bindBuffer(35052,c.handle||c),p.texImage2D(e,i,r,u,h,s,d,l,o),p.bindBuffer(35052,null);break;case"browser-object":ee(g)?g.texImage2D(e,i,r,u,h,s,d,l,c):g.texImage2D(e,i,r,d,l,c);break;case"compressed":for(const[t,n]of c.entries())g.compressedTexImage2D(e,t,n.format,n.width,n.height,s,n.data),v+=n.levelSize;break;default:Ze(!1,"Unknown image data type")}}),"compressed"===m)this._trackAllocatedMemory(v,"Texture");else if(c&&c.byteLength)this._trackAllocatedMemory(c.byteLength,"Texture");else{const t=mn[this.dataFormat]||4,e=vn[this.type]||1;this._trackAllocatedMemory(this.width*this.height*t*e,"Texture")}return this.loaded=!0,this}setSubImageData(t){let{target:e=this.target,pixels:n=null,data:i=null,x:r=0,y:s=0,width:o=this.width,height:a=this.height,level:c=0,format:l=this.format,type:u=this.type,dataFormat:h=this.dataFormat,compressed:d=!1,offset:f=0,border:g=this.border,parameters:p={}}=t;if(({type:u,dataFormat:h,compressed:d,width:o,height:a}=this._deduceParameters({format:l,type:u,dataFormat:h,compressed:d,data:i,width:o,height:a})),Ze(0===this.depth,"texSubImage not supported for 3D textures"),i||(i=n),i&&i.data){const t=i;i=t.data,o=t.shape[0],a=t.shape[1]}i instanceof gn&&(i=i.handle),this.gl.bindTexture(this.target,this.handle),We(this.gl,p,()=>{if(d)this.gl.compressedTexSubImage2D(e,c,r,s,o,a,l,i);else if(null===i)this.gl.texSubImage2D(e,c,r,s,o,a,h,u,null);else if(ArrayBuffer.isView(i))this.gl.texSubImage2D(e,c,r,s,o,a,h,u,i,f);else if(i instanceof bn){const t=ie(this.gl);t.bindBuffer(35052,i),t.texSubImage2D(e,c,r,s,o,a,h,u,f),t.bindBuffer(35052,null)}else if(ee(this.gl)){ie(this.gl).texSubImage2D(e,c,r,s,o,a,h,u,i)}else this.gl.texSubImage2D(e,c,r,s,h,u,i)}),this.gl.bindTexture(this.target,null)}copyFramebuffer(){return Qt.error("Texture.copyFramebuffer({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.textureUnit;const{gl:e}=this;return void 0!==t&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,this.handle),t}unbind(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.textureUnit;const{gl:e}=this;return void 0!==t&&(this.textureUnit=t,e.activeTexture(33984+t)),e.bindTexture(this.target,null),t}_getDataType(t){let{data:e,compressed:n=!1}=t;return n?{data:e,dataType:"compressed"}:null===e?{data:e,dataType:"null"}:ArrayBuffer.isView(e)?{data:e,dataType:"typed-array"}:e instanceof gn?{data:e.handle,dataType:"buffer"}:e instanceof bn?{data:e,dataType:"buffer"}:{data:e,dataType:"browser-object"}}_deduceParameters(t){const{format:e,data:n}=t;let{width:i,height:r,dataFormat:s,type:o,compressed:a}=t;const c=pn[e];return s=s||c&&c.dataFormat,o=o||c&&c.types[0],a=a||c&&c.compressed,({width:i,height:r}=this._deduceImageSize(n,i,r)),{dataFormat:s,type:o,compressed:a,width:i,height:r,format:e,data:n}}_deduceImageSize(t,e,n){let i;return i="undefined"!=typeof ImageData&&t instanceof ImageData?{width:t.width,height:t.height}:"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement?{width:t.naturalWidth,height:t.naturalHeight}:"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?{width:t.width,height:t.height}:"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t?{width:e,height:n}:{width:e>=0?e:1,height:n>=0?n:1},Ze(i,"Could not deduced texture size"),Ze(void 0===e||i.width===e,"Deduced texture width does not match supplied width"),Ze(void 0===n||i.height===n,"Deduced texture height does not match supplied height"),i}_createHandle(){return this.gl.createTexture()}_deleteHandle(){this.gl.deleteTexture(this.handle),this._trackDeallocatedMemory("Texture")}_getParameter(t){switch(t){case 4096:return this.width;case 4097:return this.height;default:this.gl.bindTexture(this.target,this.handle);const e=this.gl.getTexParameter(this.target,t);return this.gl.bindTexture(this.target,null),e}}_setParameter(t,e){switch(this.gl.bindTexture(this.target,this.handle),e=this._getNPOTParam(t,e),t){case 33082:case 33083:this.gl.texParameterf(this.handle,t,e);break;case 4096:case 4097:Ze(!1);break;default:this.gl.texParameteri(this.target,t,e)}return this.gl.bindTexture(this.target,null),this}_isNPOT(){return!ee(this.gl)&&(!(!this.width||!this.height)&&(!Qe(this.width)||!Qe(this.height)))}_updateForNPOT(t){void 0===t[this.gl.TEXTURE_MIN_FILTER]&&(t[this.gl.TEXTURE_MIN_FILTER]=this.gl.LINEAR),void 0===t[this.gl.TEXTURE_WRAP_S]&&(t[this.gl.TEXTURE_WRAP_S]=this.gl.CLAMP_TO_EDGE),void 0===t[this.gl.TEXTURE_WRAP_T]&&(t[this.gl.TEXTURE_WRAP_T]=this.gl.CLAMP_TO_EDGE)}_getNPOTParam(t,e){if(this._isNPOT())switch(t){case 10241:-1===yn.indexOf(e)&&(e=9729);break;case 10242:case 10243:33071!==e&&(e=33071)}return e}}class xn extends _n{get[Symbol.toStringTag](){return"Texture2D"}static isSupported(t,e){return _n.isSupported(t,e)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n,i;ne(t),(e instanceof Promise||"string"==typeof e)&&(e={data:e}),"string"==typeof e.data&&(e=Object.assign({},e,{data:(n=e.data,Ze("string"==typeof n),n=""+n,new Promise((t,e)=>{try{const r=new Image;r.onload=()=>t(r),r.onerror=()=>e(new Error("Could not load image ".concat(n,"."))),r.crossOrigin=i&&i.crossOrigin||"anonymous",r.src=n}catch(t){e(t)}}))})),super(t,Object.assign({},e,{target:3553})),this.initialize(e),Object.seal(this)}}const Pn=[34069,34070,34071,34072,34073,34074];class wn extends _n{get[Symbol.toStringTag](){return"TextureCube"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};ne(t),super(t,Object.assign({},e,{target:34067})),this.initialize(e),Object.seal(this)}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{mipmaps:e=!0,parameters:n={}}=t;return this.opts=t,this.setCubeMapImageData(t).then(()=>{this.loaded=!0,e&&this.generateMipmap(t),this.setParameters(n)}),this}subImage(t){let{face:e,data:n,x:i=0,y:r=0,mipmapLevel:s=0}=t;return this._subImage({target:e,data:n,x:i,y:r,mipmapLevel:s})}async setCubeMapImageData(t){let{width:e,height:n,pixels:i,data:r,border:s=0,format:o=6408,type:a=5121}=t;const{gl:c}=this,l=i||r,u=await Promise.all(Pn.map(t=>{const e=l[t];return Promise.all(Array.isArray(e)?e:[e])}));this.bind(),Pn.forEach((t,i)=>{u[i].length>1&&!1!==this.opts.mipmaps&&Qt.warn("".concat(this.id," has mipmap and multiple LODs."))(),u[i].forEach((i,r)=>{e&&n?c.texImage2D(t,r,o,e,n,s,o,a,i):c.texImage2D(t,r,o,o,a,i)})}),this.unbind()}setImageDataForFace(t){const{face:e,width:n,height:i,pixels:r,data:s,border:o=0,format:a=6408,type:c=5121}=t,{gl:l}=this,u=r||s;return this.bind(),u instanceof Promise?u.then(n=>this.setImageDataForFace(Object.assign({},t,{face:e,data:n,pixels:n}))):this.width||this.height?l.texImage2D(e,0,a,n,i,o,a,c,u):l.texImage2D(e,0,a,a,c,u),this}}wn.FACES=Pn;class An extends _n{get[Symbol.toStringTag](){return"Texture3D"}static isSupported(t){return ee(t)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};ie(t),e=Object.assign({depth:1},e,{target:32879,unpackFlipY:!1}),super(t,e),this.initialize(e),Object.seal(this)}setImageData(t){let{level:e=0,dataFormat:n=6408,width:i,height:r,depth:s=1,border:o=0,format:a,type:c=5121,offset:l=0,data:u,parameters:h={}}=t;if(this._trackDeallocatedMemory("Texture"),this.gl.bindTexture(this.target,this.handle),We(this.gl,h,()=>{ArrayBuffer.isView(u)&&this.gl.texImage3D(this.target,e,n,i,r,s,o,a,c,u),u instanceof gn&&(this.gl.bindBuffer(35052,u.handle),this.gl.texImage3D(this.target,e,n,i,r,s,o,a,c,l))}),u&&u.byteLength)this._trackAllocatedMemory(u.byteLength,"Texture");else{const t=mn[this.dataFormat]||4,e=vn[this.type]||1;this._trackAllocatedMemory(this.width*this.height*this.depth*t*e,"Texture")}return this.loaded=!0,this}}const Sn="EXT_color_buffer_float";var Tn={33189:{bpp:2},33190:{gl2:!0,bpp:3},36012:{gl2:!0,bpp:4},36168:{bpp:1},34041:{bpp:4},35056:{gl2:!0,bpp:4},36013:{gl2:!0,bpp:5},32854:{bpp:2},36194:{bpp:2},32855:{bpp:2},33321:{gl2:!0,bpp:1},33330:{gl2:!0,bpp:1},33329:{gl2:!0,bpp:1},33332:{gl2:!0,bpp:2},33331:{gl2:!0,bpp:2},33334:{gl2:!0,bpp:4},33333:{gl2:!0,bpp:4},33323:{gl2:!0,bpp:2},33336:{gl2:!0,bpp:2},33335:{gl2:!0,bpp:2},33338:{gl2:!0,bpp:4},33337:{gl2:!0,bpp:4},33340:{gl2:!0,bpp:8},33339:{gl2:!0,bpp:8},32849:{gl2:!0,bpp:3},32856:{gl2:!0,bpp:4},32857:{gl2:!0,bpp:4},36220:{gl2:!0,bpp:4},36238:{gl2:!0,bpp:4},36975:{gl2:!0,bpp:4},36214:{gl2:!0,bpp:8},36232:{gl2:!0,bpp:8},36226:{gl2:!0,bpp:16},36208:{gl2:!0,bpp:16},33325:{gl2:Sn,bpp:2},33327:{gl2:Sn,bpp:4},34842:{gl2:Sn,bpp:8},33326:{gl2:Sn,bpp:4},33328:{gl2:Sn,bpp:8},34836:{gl2:Sn,bpp:16},35898:{gl2:Sn,bpp:4}};class En extends nn{get[Symbol.toStringTag](){return"Renderbuffer"}static isSupported(t){let{format:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{format:null};return!e||function(t,e,n){const i=n[e];if(!i)return!1;const r=ee(t)&&i.gl2||i.gl1;return"string"==typeof r?t.getExtension(r):r}(t,e,Tn)}static getSamplesForFormat(t,e){let{format:n}=e;return t.getInternalformatParameter(36161,n,32937)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.initialize(e),Object.seal(this)}initialize(t){let{format:e,width:n=1,height:i=1,samples:r=0}=t;return Ze(e,"Needs format"),this._trackDeallocatedMemory(),this.gl.bindRenderbuffer(36161,this.handle),0!==r&&ee(this.gl)?this.gl.renderbufferStorageMultisample(36161,r,e,n,i):this.gl.renderbufferStorage(36161,e,n,i),this.format=e,this.width=n,this.height=i,this.samples=r,this._trackAllocatedMemory(this.width*this.height*(this.samples||1)*Tn[this.format].bpp),this}resize(t){let{width:e,height:n}=t;return e!==this.width||n!==this.height?this.initialize({width:e,height:n,format:this.format,samples:this.samples}):this}_createHandle(){return this.gl.createRenderbuffer()}_deleteHandle(){this.gl.deleteRenderbuffer(this.handle),this._trackDeallocatedMemory()}_bindHandle(t){this.gl.bindRenderbuffer(36161,t)}_syncHandle(t){this.format=this.getParameter(36164),this.width=this.getParameter(36162),this.height=this.getParameter(36163),this.samples=this.getParameter(36011)}_getParameter(t){this.gl.bindRenderbuffer(36161,this.handle);return this.gl.getRenderbufferParameter(36161,t)}}const Cn=6144,Ln="clear: bad arguments";function Mn(t){let{framebuffer:e=null,color:n=null,depth:i=null,stencil:r=null}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const s={};e&&(s.framebuffer=e);let o=0;n&&(o|=16384,!0!==n&&(s.clearColor=n)),i&&(o|=256,!0!==i&&(s.clearDepth=i)),r&&(o|=1024,!0!==i&&(s.clearStencil=i)),Ze(0!==o,Ln),We(t,s,()=>{t.clear(o)})}function On(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{sourceX:n=0,sourceY:i=0,sourceFormat:r=6408}=e;let{sourceAttachment:s=36064,target:o=null,sourceWidth:a,sourceHeight:c,sourceType:l}=e;const{framebuffer:u,deleteFramebuffer:h}=Rn(t);Ze(u);const{gl:d,handle:f,attachments:g}=u;a=a||u.width,c=c||u.height,36064===s&&null===f&&(s=1028),Ze(g[s]),l=l||g[s].type,o=function(t,e,n,i,r){if(t)return t;const s=sn(e=e||5121,{clamped:!1}),o=function(t){switch(t){case 6406:case 33326:case 6403:return 1;case 33328:case 33319:return 2;case 6407:case 34837:return 3;case 6408:case 34836:return 4;default:return Ze(!1),0}}(n);return new s(i*r*o)}(o,l,r,a,c),l=l||rn(o);const p=d.bindFramebuffer(36160,f);return d.readPixels(n,i,a,c,r,l,o),d.bindFramebuffer(36160,p||null),h&&u.delete(),o}function In(t){let{sourceAttachment:e=36064,targetMaxHeight:n=Number.MAX_SAFE_INTEGER}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=On(t,{sourceAttachment:e}),{width:r,height:s}=t;for(;s>n;)({data:i,width:r,height:s}=on({data:i,width:r,height:s}));!function(t){let{data:e,width:n,height:i,bytesPerPixel:r=4,temp:s}=t;const o=n*r;s=s||new Uint8Array(o);for(let t=0;t<i/2;++t){const n=t*o,r=(i-t-1)*o;s.set(e.subarray(n,n+o)),e.copyWithin(n,r,r+o),e.set(s,r)}}({data:i,width:r,height:s});const o=document.createElement("canvas");o.width=r,o.height=s;const a=o.getContext("2d"),c=a.createImageData(r,s);return c.data.set(i),a.putImageData(c,0,0),o.toDataURL()}function Rn(t){return t instanceof ai?{framebuffer:t,deleteFramebuffer:!1}:{framebuffer:ci(t),deleteFramebuffer:!0}}const Fn="WEBGL2",zn="VERTEX_ARRAY_OBJECT",kn="TIMER_QUERY",jn="INSTANCED_RENDERING",Bn="MULTIPLE_RENDER_TARGETS",Dn="ELEMENT_INDEX_UINT32",Nn="BLEND_EQUATION_MINMAX",Un="FLOAT_BLEND",Vn="COLOR_ENCODING_SRGB",Gn="TEXTURE_DEPTH",Wn="TEXTURE_FLOAT",Hn="TEXTURE_HALF_FLOAT",Xn="TEXTURE_FILTER_LINEAR_FLOAT",Zn="TEXTURE_FILTER_LINEAR_HALF_FLOAT",Yn="TEXTURE_FILTER_ANISOTROPIC",Kn="COLOR_ATTACHMENT_RGBA32F",qn="COLOR_ATTACHMENT_FLOAT",Jn="COLOR_ATTACHMENT_HALF_FLOAT",Qn="GLSL_FRAG_DATA",$n="GLSL_FRAG_DEPTH",ti="GLSL_DERIVATIVES",ei="GLSL_TEXTURE_LOD";var ni={[Fn]:[!1,!0],[zn]:["OES_vertex_array_object",!0],[kn]:["EXT_disjoint_timer_query","EXT_disjoint_timer_query_webgl2"],[jn]:["ANGLE_instanced_arrays",!0],[Bn]:["WEBGL_draw_buffers",!0],[Dn]:["OES_element_index_uint",!0],[Nn]:["EXT_blend_minmax",!0],[Un]:["EXT_float_blend"],[Vn]:["EXT_sRGB",!0],[Gn]:["WEBGL_depth_texture",!0],[Wn]:["OES_texture_float",!0],[Hn]:["OES_texture_half_float",!0],[Xn]:["OES_texture_float_linear"],[Zn]:["OES_texture_half_float_linear"],[Yn]:["EXT_texture_filter_anisotropic"],[Kn]:[function(t){const e=new xn(t,{format:6408,type:5126,dataFormat:6408}),n=new ai(t,{id:"test-framebuffer",check:!1,attachments:{36064:e}}),i=n.getStatus();return e.delete(),n.delete(),36053===i},"EXT_color_buffer_float"],[qn]:[!1,"EXT_color_buffer_float"],[Jn]:["EXT_color_buffer_half_float"],[Qn]:["WEBGL_draw_buffers",!0],[$n]:["EXT_frag_depth",!0],[ti]:["OES_standard_derivatives",!0],[ei]:["EXT_shader_texture_lod",!0]};function ii(t,e){return ri(t,e)}function ri(t,e){return(e=Array.isArray(e)?e:[e]).every(e=>si(t,e))}function si(t,e){return t.luma=t.luma||{},t.luma.caps=t.luma.caps||{},void 0===t.luma.caps[e]&&(t.luma.caps[e]=function(t,e){const n=ni[e];let i;Ze(n,e);const r=ee(t)&&n[1]||n[0];if("function"==typeof r)i=r(t);else if(Array.isArray(r)){i=!0;for(const e of r)i=i&&Boolean(t.getExtension(e))}else"string"==typeof r?i=Boolean(t.getExtension(r)):"boolean"==typeof r?i=r:Ze(!1);return i}(t,e)),t.luma.caps[e]||Qt.log(2,"Feature: ".concat(e," not supported"))(),t.luma.caps[e]}const oi="Multiple render targets not supported";class ai extends nn{get[Symbol.toStringTag](){return"Framebuffer"}static isSupported(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{colorBufferFloat:n,colorBufferHalfFloat:i}=e;let r=!0;return n&&(r=Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("WEBGL_color_buffer_float")||t.getExtension("OES_texture_float"))),i&&(r=r&&Boolean(t.getExtension("EXT_color_buffer_float")||t.getExtension("EXT_color_buffer_half_float"))),r}static getDefaultFramebuffer(t){return t.luma=t.luma||{},t.luma.defaultFramebuffer=t.luma.defaultFramebuffer||new ai(t,{id:"default-framebuffer",handle:null,attachments:{}}),t.luma.defaultFramebuffer}get MAX_COLOR_ATTACHMENTS(){const t=ie(this.gl);return t.getParameter(t.MAX_COLOR_ATTACHMENTS)}get MAX_DRAW_BUFFERS(){const t=ie(this.gl);return t.getParameter(t.MAX_DRAW_BUFFERS)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.width=null,this.height=null,this.attachments={},this.readBuffer=36064,this.drawBuffers=[36064],this.ownResources=[],this.initialize(e),Object.seal(this)}get color(){return this.attachments[36064]||null}get texture(){return this.attachments[36064]||null}get depth(){return this.attachments[36096]||this.attachments[33306]||null}get stencil(){return this.attachments[36128]||this.attachments[33306]||null}initialize(t){let{width:e=1,height:n=1,attachments:i=null,color:r=!0,depth:s=!0,stencil:o=!1,check:a=!0,readBuffer:c,drawBuffers:l}=t;if(Ze(e>=0&&n>=0,"Width and height need to be integers"),this.width=e,this.height=n,i)for(const t in i){const r=i[t];(Array.isArray(r)?r[0]:r).resize({width:e,height:n})}else i=this._createDefaultAttachments(r,s,o,e,n);this.update({clearAttachments:!0,attachments:i,readBuffer:c,drawBuffers:l}),i&&a&&this.checkStatus()}delete(){for(const t of this.ownResources)t.delete();return super.delete(),this}update(t){let{attachments:e={},readBuffer:n,drawBuffers:i,clearAttachments:r=!1,resizeAttachments:s=!0}=t;this.attach(e,{clearAttachments:r,resizeAttachments:s});const{gl:o}=this,a=o.bindFramebuffer(36160,this.handle);return n&&this._setReadBuffer(n),i&&this._setDrawBuffers(i),o.bindFramebuffer(36160,a||null),this}resize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{width:e,height:n}=t;if(null===this.handle)return Ze(void 0===e&&void 0===n),this.width=this.gl.drawingBufferWidth,this.height=this.gl.drawingBufferHeight,this;void 0===e&&(e=this.gl.drawingBufferWidth),void 0===n&&(n=this.gl.drawingBufferHeight),e!==this.width&&n!==this.height&&Qt.log(2,"Resizing framebuffer ".concat(this.id," to ").concat(e,"x").concat(n))();for(const t in this.attachments)this.attachments[t].resize({width:e,height:n});return this.width=e,this.height=n,this}attach(t){let{clearAttachments:e=!1,resizeAttachments:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i={};e&&Object.keys(this.attachments).forEach(t=>{i[t]=null}),Object.assign(i,t);const r=this.gl.bindFramebuffer(36160,this.handle);for(const t in i){Ze(void 0!==t,"Misspelled framebuffer binding point?");const e=Number(t),r=i[e];let s=r;if(s)if(s instanceof En)this._attachRenderbuffer({attachment:e,renderbuffer:s});else if(Array.isArray(r)){const[t,n=0,i=0]=r;s=t,this._attachTexture({attachment:e,texture:t,layer:n,level:i})}else this._attachTexture({attachment:e,texture:s,layer:0,level:0});else this._unattach(e);n&&s&&s.resize({width:this.width,height:this.height})}this.gl.bindFramebuffer(36160,r||null),Object.assign(this.attachments,t),Object.keys(this.attachments).filter(t=>!this.attachments[t]).forEach(t=>{delete this.attachments[t]})}checkStatus(){const{gl:t}=this,e=this.getStatus();if(36053!==e)throw new Error(function(t){return(ai.STATUS||{})[t]||"Framebuffer error ".concat(t)}(e));return this}getStatus(){const{gl:t}=this,e=t.bindFramebuffer(36160,this.handle),n=t.checkFramebufferStatus(36160);return t.bindFramebuffer(36160,e||null),n}clear(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{color:e,depth:n,stencil:i,drawBuffers:r=[]}=t,s=this.gl.bindFramebuffer(36160,this.handle);return(e||n||i)&&Mn(this.gl,{color:e,depth:n,stencil:i}),r.forEach((t,e)=>{!function(t){let{framebuffer:e=null,buffer:n=Cn,drawBuffer:i=0,value:r=[0,0,0,0]}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};ie(t),We(t,{framebuffer:e},()=>{switch(n){case Cn:switch(r.constructor){case Int32Array:t.clearBufferiv(n,i,r);break;case Uint32Array:t.clearBufferuiv(n,i,r);break;case Float32Array:default:t.clearBufferfv(n,i,r)}break;case 6145:t.clearBufferfv(6145,0,[r]);break;case 6146:t.clearBufferiv(6146,0,[r]);break;case 34041:const[e,s]=r;t.clearBufferfi(34041,0,e,s);break;default:Ze(!1,Ln)}})}(this.gl,{drawBuffer:e,value:t})}),this.gl.bindFramebuffer(36160,s||null),this}readPixels(){return Qt.error("Framebuffer.readPixels() is no logner supported, use readPixelsToArray(framebuffer)")(),null}readPixelsToBuffer(){return Qt.error("Framebuffer.readPixelsToBuffer()is no logner supported, use readPixelsToBuffer(framebuffer)")(),null}copyToDataUrl(){return Qt.error("Framebuffer.copyToDataUrl() is no logner supported, use copyToDataUrl(framebuffer)")(),null}copyToImage(){return Qt.error("Framebuffer.copyToImage() is no logner supported, use copyToImage(framebuffer)")(),null}copyToTexture(){return Qt.error("Framebuffer.copyToTexture({...}) is no logner supported, use copyToTexture(source, target, opts})")(),null}blit(){return Qt.error("Framebuffer.blit({...}) is no logner supported, use blit(source, target, opts)")(),null}invalidate(t){let{attachments:e=[],x:n=0,y:i=0,width:r,height:s}=t;const o=ie(this.gl),a=o.bindFramebuffer(36008,this.handle);return 0===n&&0===i&&void 0===r&&void 0===s?o.invalidateFramebuffer(36008,e):o.invalidateFramebuffer(36008,e,n,i,r,s),o.bindFramebuffer(36008,a),this}getAttachmentParameter(t,e,n){let i=this._getAttachmentParameterFallback(e);return null===i&&(this.gl.bindFramebuffer(36160,this.handle),i=this.gl.getFramebufferAttachmentParameter(36160,t,e),this.gl.bindFramebuffer(36160,null)),n&&i>1e3&&(i=Ke(this.gl,i)),i}getAttachmentParameters(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:36064,e=arguments.length>1?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.constructor.ATTACHMENT_PARAMETERS||[];const i={};for(const r of n){i[e?Ke(this.gl,r):r]=this.getAttachmentParameter(t,r,e)}return i}getParameters(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];const e=Object.keys(this.attachments),n={};for(const i of e){const e=Number(i);n[t?Ke(this.gl,e):e]=this.getAttachmentParameters(e,t)}return n}show(){return"undefined"!=typeof window&&window.open(In(this),"luma-debug-texture"),this}log(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(t>Qt.level||"undefined"==typeof window)return this;e=e||"Framebuffer ".concat(this.id);const n=In(this,{targetMaxHeight:100});return Qt.image({logLevel:t,message:e,image:n},e)(),this}bind(){let{target:t=36160}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.gl.bindFramebuffer(t,this.handle),this}unbind(){let{target:t=36160}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.gl.bindFramebuffer(t,null),this}_createDefaultAttachments(t,e,n,i,r){let s=null;return t&&(s=s||{},s[36064]=new xn(this.gl,{id:"".concat(this.id,"-color0"),pixels:null,format:6408,type:5121,width:i,height:r,mipmaps:!1,parameters:{10241:9729,10240:9729,10242:33071,10243:33071}}),this.ownResources.push(s[36064])),e&&n?(s=s||{},s[33306]=new En(this.gl,{id:"".concat(this.id,"-depth-stencil"),format:35056,width:i,height:111}),this.ownResources.push(s[33306])):e?(s=s||{},s[36096]=new En(this.gl,{id:"".concat(this.id,"-depth"),format:33189,width:i,height:r}),this.ownResources.push(s[36096])):n&&Ze(!1),s}_unattach(t){const e=this.attachments[t];e&&(e instanceof En?this.gl.framebufferRenderbuffer(36160,t,36161,null):this.gl.framebufferTexture2D(36160,t,3553,null,0),delete this.attachments[t])}_attachRenderbuffer(t){let{attachment:e=36064,renderbuffer:n}=t;const{gl:i}=this;i.framebufferRenderbuffer(36160,e,36161,n.handle),this.attachments[e]=n}_attachTexture(t){let{attachment:e=36064,texture:n,layer:i,level:r}=t;const{gl:s}=this;switch(s.bindTexture(n.target,n.handle),n.target){case 35866:case 32879:ie(s).framebufferTextureLayer(36160,e,n.target,r,i);break;case 34067:const t=function(t){return t<34069?t+34069:t}(i);s.framebufferTexture2D(36160,e,t,n.handle,r);break;case 3553:s.framebufferTexture2D(36160,e,3553,n.handle,r);break;default:Ze(!1,"Illegal texture type")}s.bindTexture(n.target,null),this.attachments[e]=n}_setReadBuffer(t){const e=ee(n=this.gl)?n:null;var n;e?e.readBuffer(t):Ze(36064===t||1029===t,oi),this.readBuffer=t}_setDrawBuffers(t){const{gl:e}=this,n=ie(e);if(n)n.drawBuffers(t);else{const n=e.getExtension("WEBGL_draw_buffers");n?n.drawBuffersWEBGL(t):Ze(1===t.length&&(36064===t[0]||1029===t[0]),oi)}this.drawBuffers=t}_getAttachmentParameterFallback(t){const e=function(t){t.luma=t.luma||{},t.luma.caps=t.luma.caps||{};for(const e in ni)void 0===t.luma.caps[e]&&(t.luma.caps[e]=si(t,e));return t.luma.caps}(this.gl);switch(t){case 36052:return e.WEBGL2?null:0;case 33298:case 33299:case 33300:case 33301:case 33302:case 33303:return e.WEBGL2?null:8;case 33297:return e.WEBGL2?null:5125;case 33296:return e.WEBGL2||e.EXT_sRGB?null:9729;default:return null}}_createHandle(){return this.gl.createFramebuffer()}_deleteHandle(){this.gl.deleteFramebuffer(this.handle)}_bindHandle(t){return this.gl.bindFramebuffer(36160,t)}}function ci(t,e){const{gl:n,width:i,height:r,id:s}=t;return new ai(n,Object.assign({},e,{id:"framebuffer-for-".concat(s),width:i,height:r,attachments:{36064:t}}))}function li(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"unnamed";const n=t.match(/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/);return n?n[1]:e}ai.ATTACHMENT_PARAMETERS=[36049,36048,33296,33298,33299,33300,33301,33302,33303];function ui(t,e,n,i){const r=t.split(/\r?\n/),s={},o={},a=i||li(e)||"(unnamed)",c="".concat(function(t){switch(t){case 35632:return"fragment";case 35633:return"vertex";default:return"unknown type"}}(n)," shader ").concat(a);for(let e=0;e<r.length;e++){const n=r[e];if(n.length<=1)continue;const i=n.split(":"),a=i[0],l=parseInt(i[2],10);if(isNaN(l))throw new Error("GLSL compilation error in ".concat(c,": ").concat(t));"WARNING"!==a?s[l]=n:o[l]=n}const l=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:": ";const i=t.split(/\r?\n/),r=String(i.length+e-1).length;return i.map((t,i)=>{const s=String(i+e),o=s.length;return di(s,r-o)+n+t})}(e);return{shaderName:c,errors:hi(s,l),warnings:hi(o,l)}}function hi(t,e){let n="";for(let i=0;i<e.length;i++){const r=e[i];if((t[i+3]||t[i+2]||t[i+1])&&(n+="".concat(r,"\n"),t[i+1])){const e=t[i+1],r=e.split(":",3),s=r[0],o=parseInt(r[1],10)||0,a=e.substring(r.join(":").length+1).trim();n+=di("^^^ ".concat(s,": ").concat(a,"\n\n"),o)}}return n}function di(t,e){let n="";for(let t=0;t<e;++t)n+=" ";return"".concat(n).concat(t)}function fi(t){let e=100;const n=t.match(/[^\s]+/g);if(n.length>=2&&"#version"===n[0]){const t=parseInt(n[1],10);Number.isFinite(t)&&(e=t)}return e}class gi extends nn{get[Symbol.toStringTag](){return"Shader"}static getTypeName(t){switch(t){case 35633:return"vertex-shader";case 35632:return"fragment-shader";default:return Ze(!1),"unknown"}}constructor(t,e){ne(t),Ze("string"==typeof e.source,"Shader: GLSL source code must be a JavaScript string");super(t,{id:li(e.source,null)||e.id||Je("unnamed ".concat(gi.getTypeName(e.shaderType)))}),this.shaderType=e.shaderType,this.source=e.source,this.initialize(e)}initialize(t){let{source:e}=t;const n=li(e,null);n&&(this.id=Je(n)),this._compile(e)}getParameter(t){return this.gl.getShaderParameter(this.handle,t)}toString(){return"".concat(gi.getTypeName(this.shaderType),":").concat(this.id)}getName(){return li(this.source)||"unnamed-shader"}getSource(){return this.gl.getShaderSource(this.handle)}getTranslatedSource(){const t=this.gl.getExtension("WEBGL_debug_shaders");return t?t.getTranslatedShaderSource(this.handle):"No translated source available. WEBGL_debug_shaders not implemented"}_compile(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.source;t.startsWith("#version ")||(t="#version 100\n".concat(t)),this.source=t,this.gl.shaderSource(this.handle,this.source),this.gl.compileShader(this.handle);if(!this.getParameter(35713)){const t=this.gl.getShaderInfoLog(this.handle),{shaderName:e,errors:n,warnings:i}=ui(t,this.source,this.shaderType,this.id);throw Qt.error("GLSL compilation errors in ".concat(e,"\n").concat(n))(),Qt.warn("GLSL compilation warnings in ".concat(e,"\n").concat(i))(),new Error("GLSL compilation errors in ".concat(e))}}_deleteHandle(){this.gl.deleteShader(this.handle)}_getOptsFromHandle(){return{type:this.getParameter(35663),source:this.getSource()}}}class pi extends gi{get[Symbol.toStringTag](){return"VertexShader"}constructor(t,e){"string"==typeof e&&(e={source:e}),super(t,Object.assign({},e,{shaderType:35633}))}_createHandle(){return this.gl.createShader(35633)}}class mi extends gi{get[Symbol.toStringTag](){return"FragmentShader"}constructor(t,e){"string"==typeof e&&(e={source:e}),super(t,Object.assign({},e,{shaderType:35632}))}_createHandle(){return this.gl.createShader(35632)}}const vi={5126:Oi.bind(null,"uniform1fv",wi,1,Ii),35664:Oi.bind(null,"uniform2fv",wi,2,Ii),35665:Oi.bind(null,"uniform3fv",wi,3,Ii),35666:Oi.bind(null,"uniform4fv",wi,4,Ii),5124:Oi.bind(null,"uniform1iv",Ai,1,Ii),35667:Oi.bind(null,"uniform2iv",Ai,2,Ii),35668:Oi.bind(null,"uniform3iv",Ai,3,Ii),35669:Oi.bind(null,"uniform4iv",Ai,4,Ii),35670:Oi.bind(null,"uniform1iv",Ai,1,Ii),35671:Oi.bind(null,"uniform2iv",Ai,2,Ii),35672:Oi.bind(null,"uniform3iv",Ai,3,Ii),35673:Oi.bind(null,"uniform4iv",Ai,4,Ii),35674:Oi.bind(null,"uniformMatrix2fv",wi,4,Ri),35675:Oi.bind(null,"uniformMatrix3fv",wi,9,Ri),35676:Oi.bind(null,"uniformMatrix4fv",wi,16,Ri),35678:Mi,35680:Mi,5125:Oi.bind(null,"uniform1uiv",Si,1,Ii),36294:Oi.bind(null,"uniform2uiv",Si,2,Ii),36295:Oi.bind(null,"uniform3uiv",Si,3,Ii),36296:Oi.bind(null,"uniform4uiv",Si,4,Ii),35685:Oi.bind(null,"uniformMatrix2x3fv",wi,6,Ri),35686:Oi.bind(null,"uniformMatrix2x4fv",wi,8,Ri),35687:Oi.bind(null,"uniformMatrix3x2fv",wi,6,Ri),35688:Oi.bind(null,"uniformMatrix3x4fv",wi,12,Ri),35689:Oi.bind(null,"uniformMatrix4x2fv",wi,8,Ri),35690:Oi.bind(null,"uniformMatrix4x3fv",wi,12,Ri),35678:Mi,35680:Mi,35679:Mi,35682:Mi,36289:Mi,36292:Mi,36293:Mi,36298:Mi,36299:Mi,36300:Mi,36303:Mi,36306:Mi,36307:Mi,36308:Mi,36311:Mi},yi={},bi={},_i={},xi=[0];function Pi(t,e,n,i){1===e&&"boolean"==typeof t&&(t=t?1:0),Number.isFinite(t)&&(xi[0]=t,t=xi);const r=t.length;if(r%e&&Qt.warn("Uniform size should be multiples of ".concat(e),t)(),t instanceof n)return t;let s=i[r];s||(s=new n(r),i[r]=s);for(let e=0;e<r;e++)s[e]=t[e];return s}function wi(t,e){return Pi(t,e,Float32Array,yi)}function Ai(t,e){return Pi(t,e,Int32Array,bi)}function Si(t,e){return Pi(t,e,Uint32Array,_i)}function Ti(t,e,n){const i=vi[n.type];if(!i)throw new Error("Unknown GLSL uniform type ".concat(n.type));return i().bind(null,t,e)}function Ei(t){if("]"!==t[t.length-1])return{name:t,length:1,isArray:!1};const e=t.match(/([^[]*)(\[[0-9]+\])?/);if(!e||e.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(t));return{name:e[1],length:e[2]||1,isArray:Boolean(e[2])}}function Ci(t){return Array.isArray(t)||ArrayBuffer.isView(t)?function(t){if(0===t.length)return!1;const e=Math.min(t.length,16);for(let n=0;n<e;++n)if(!Number.isFinite(t[n]))return!1;return!0}(t):!!isFinite(t)||(!0===t||!1===t||(t instanceof _n||(t instanceof En||t instanceof ai&&Boolean(t.texture))))}function Li(t,e,n){if(Array.isArray(n)||ArrayBuffer.isView(n))if(t[e]){const i=t[e];for(let t=0,e=n.length;t<e;++t)i[t]=n[t]}else t[e]=n.slice();else t[e]=n}function Mi(){let t=null;return(e,n,i)=>{const r=t!==i;return r&&(e.uniform1i(n,i),t=i),r}}function Oi(t,e,n,i){let r=null,s=null;return(o,a,c)=>{const l=e(c,n),u=l.length;let h=!1;if(null===r)r=new Float32Array(u),s=u,h=!0;else{Ze(s===u,"Uniform length cannot change.");for(let t=0;t<u;++t)if(l[t]!==r[t]){h=!0;break}}return h&&(i(o,t,a,l),r.set(l)),h}}function Ii(t,e,n,i){t[e](n,i)}function Ri(t,e,n,i){t[e](n,!1,i)}const Fi=5126,zi=35664,ki=35665,ji=35666,Bi=5124,Di=35667,Ni=35668,Ui=35669,Vi=5125,Gi=36294,Wi=36295,Hi=36296,Xi=35670,Zi=35671,Yi=35672,Ki=35673,qi=35674,Ji=35675,Qi=35676,$i=35685,tr=35686,er=35687,nr=35688,ir=35689,rr=35690,sr={[Fi]:[Fi,1,"float"],[zi]:[Fi,2,"vec2"],[ki]:[Fi,3,"vec3"],[ji]:[Fi,4,"vec4"],[Bi]:[Bi,1,"int"],[Di]:[Bi,2,"ivec2"],[Ni]:[Bi,3,"ivec3"],[Ui]:[Bi,4,"ivec4"],[Vi]:[Vi,1,"uint"],[Gi]:[Vi,2,"uvec2"],[Wi]:[Vi,3,"uvec3"],[Hi]:[Vi,4,"uvec4"],[Xi]:[Fi,1,"bool"],[Zi]:[Fi,2,"bvec2"],[Yi]:[Fi,3,"bvec3"],[Ki]:[Fi,4,"bvec4"],[qi]:[Fi,8,"mat2"],[$i]:[Fi,8,"mat2x3"],[tr]:[Fi,8,"mat2x4"],[Ji]:[Fi,12,"mat3"],[er]:[Fi,12,"mat3x2"],[nr]:[Fi,12,"mat3x4"],[Qi]:[Fi,16,"mat4"],[ir]:[Fi,16,"mat4x2"],[rr]:[Fi,16,"mat4x3"]};function or(t){const e=sr[t];if(!e)return null;const[n,i]=e;return{type:n,components:i}}function ar(t,e){switch(t){case 5120:case 5121:case 5122:case 5123:t=Fi}for(const n in sr){const[i,r,s]=sr[n];if(i===t&&r===e)return{glType:n,name:s}}return null}class cr{constructor(t){this.id=t.id,this.attributeInfos=[],this.attributeInfosByName={},this.attributeInfosByLocation=[],this.varyingInfos=[],this.varyingInfosByName={},Object.seal(this),this._readAttributesFromProgram(t),this._readVaryingsFromProgram(t)}getAttributeInfo(t){const e=Number(t);return Number.isFinite(e)?this.attributeInfosByLocation[e]:this.attributeInfosByName[t]||null}getAttributeLocation(t){const e=this.getAttributeInfo(t);return e?e.location:-1}getAttributeAccessor(t){const e=this.getAttributeInfo(t);return e?e.accessor:null}getVaryingInfo(t){const e=Number(t);return Number.isFinite(e)?this.varyingInfos[e]:this.varyingInfosByName[t]||null}getVaryingIndex(t){const e=this.getVaryingInfo();return e?e.location:-1}getVaryingAccessor(t){const e=this.getVaryingInfo();return e?e.accessor:null}_readAttributesFromProgram(t){const{gl:e}=t,n=e.getProgramParameter(t.handle,35721);for(let i=0;i<n;i++){const{name:n,type:r,size:s}=e.getActiveAttrib(t.handle,i),o=e.getAttribLocation(t.handle,n);o>=0&&this._addAttribute(o,n,r,s)}this.attributeInfos.sort((t,e)=>t.location-e.location)}_readVaryingsFromProgram(t){const{gl:e}=t;if(!ee(e))return;const n=e.getProgramParameter(t.handle,35971);for(let i=0;i<n;i++){const{name:n,type:r,size:s}=e.getTransformFeedbackVarying(t.handle,i);this._addVarying(i,n,r,s)}this.varyingInfos.sort((t,e)=>t.location-e.location)}_addAttribute(t,e,n,i){const{type:r,components:s}=or(n),o={type:r,size:i*s};this._inferProperties(t,e,o);const a={location:t,name:e,accessor:new un(o)};this.attributeInfos.push(a),this.attributeInfosByLocation[t]=a,this.attributeInfosByName[a.name]=a}_inferProperties(t,e,n){/instance/i.test(e)&&(n.divisor=1)}_addVarying(t,e,n,i){const{type:r,components:s}=or(n),o={location:t,name:e,accessor:new un({type:r,size:i*s})};this.varyingInfos.push(o),this.varyingInfosByName[o.name]=o}}const lr=35981,ur=["setVertexArray","setAttributes","setBuffers","unsetBuffers","use","getUniformCount","getUniformInfo","getUniformLocation","getUniformValue","getVarying","getFragDataLocation","getAttachedShaders","getAttributeCount","getAttributeLocation","getAttributeInfo"];class hr extends nn{get[Symbol.toStringTag](){return"Program"}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(t,e),this.stubRemovedMethods("Program","v6.0",ur),this._isCached=!1,this.initialize(e),Object.seal(this),this._setId(e.id)}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{hash:e,vs:n,fs:i,varyings:r,bufferMode:s=lr}=t;return this.hash=e||"",this.vs="string"==typeof n?new pi(this.gl,{id:"".concat(t.id,"-vs"),source:n}):n,this.fs="string"==typeof i?new mi(this.gl,{id:"".concat(t.id,"-fs"),source:i}):i,Ze(this.vs instanceof pi),Ze(this.fs instanceof mi),this.uniforms={},this._textureUniforms={},r&&r.length>0&&(ie(this.gl),this.varyings=r,this.gl2.transformFeedbackVaryings(this.handle,r,s)),this._compileAndLink(),this._readUniformLocationsFromLinkedProgram(),this.configuration=new cr(this),this.setProps(t)}delete(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this._isCached?this:super.delete(t)}setProps(t){return"uniforms"in t&&this.setUniforms(t.uniforms),this}draw(t){let{logPriority:e,drawMode:n=4,vertexCount:i,offset:r=0,start:s,end:o,isIndexed:a=!1,indexType:c=5123,instanceCount:l=0,isInstanced:u=l>0,vertexArray:h=null,transformFeedback:d,framebuffer:f,parameters:g={},uniforms:p,samplers:m}=t;if((p||m)&&(Qt.deprecated("Program.draw({uniforms})","Program.setUniforms(uniforms)")(),this.setUniforms(p||{})),Qt.priority>=e){const t=f?f.id:"default",r="mode=".concat(Ke(this.gl,n)," verts=").concat(i," ")+"instances=".concat(l," indexType=").concat(Ke(this.gl,c)," ")+"isInstanced=".concat(u," isIndexed=").concat(a," ")+"Framebuffer=".concat(t);Qt.log(e,r)()}return Ze(h),this.gl.useProgram(this.handle),!(!this._areTexturesRenderable()||0===i||u&&0===l)&&(h.bindForDraw(i,l,()=>{if(void 0!==f&&(g=Object.assign({},g,{framebuffer:f})),d){const t=function(t){switch(t){case 0:return 0;case 1:case 3:case 2:return 1;case 4:case 5:case 6:return 4;default:return Ze(!1),0}}(n);d.begin(t)}this._bindTextures(),We(this.gl,g,()=>{a&&u?this.gl2.drawElementsInstanced(n,i,c,r,l):a&&ee(this.gl)&&!isNaN(s)&&!isNaN(o)?this.gl2.drawRangeElements(n,s,o,i,c,r):a?this.gl.drawElements(n,i,c,r):u?this.gl2.drawArraysInstanced(n,r,i,l):this.gl.drawArrays(n,r,i)}),d&&d.end()}),!0)}setUniforms(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Qt.priority>=2&&function(t,e,n){for(const i in t){const r=t[i];if((!n||Boolean(n[i]))&&!Ci(r))throw e=e?"".concat(e," "):"",console.error("".concat(e," Bad uniform ").concat(i),r),new Error("".concat(e," Bad uniform ").concat(i))}}(t,this.id,this._uniformSetters),this.gl.useProgram(this.handle);for(const e in t){const n=t[e],i=this._uniformSetters[e];if(i){let t=n,r=!1;if(t instanceof ai&&(t=t.texture),t instanceof _n)if(r=this.uniforms[e]!==n,r){void 0===i.textureIndex&&(i.textureIndex=this._textureIndexCounter++);const n=t,{textureIndex:r}=i;n.bind(r),t=r,this._textureUniforms[e]=n}else t=i.textureIndex;else this._textureUniforms[e]&&delete this._textureUniforms[e];(i(t)||r)&&Li(this.uniforms,e,n)}}return this}_areTexturesRenderable(){let t=!0;for(const e in this._textureUniforms){const n=this._textureUniforms[e];n.update(),t=t&&n.loaded}return t}_bindTextures(){for(const t in this._textureUniforms){const e=this._uniformSetters[t].textureIndex;this._textureUniforms[t].bind(e)}}_createHandle(){return this.gl.createProgram()}_deleteHandle(){this.gl.deleteProgram(this.handle)}_getOptionsFromHandle(t){const e=this.gl.getAttachedShaders(t),n={};for(const t of e){switch(this.gl.getShaderParameter(this.handle,35663)){case 35633:n.vs=new pi({handle:t});break;case 35632:n.fs=new mi({handle:t})}}return n}_getParameter(t){return this.gl.getProgramParameter(this.handle,t)}_setId(t){if(!t){const t=this._getName();this.id=Je(t)}}_getName(){let t=this.vs.getName()||this.fs.getName();return t=t.replace(/shader/i,""),t=t?"".concat(t,"-program"):"program",t}_compileAndLink(){const{gl:t}=this;if(t.attachShader(this.handle,this.vs.handle),t.attachShader(this.handle,this.fs.handle),Qt.time(4,"linkProgram for ".concat(this._getName()))(),t.linkProgram(this.handle),Qt.timeEnd(4,"linkProgram for ".concat(this._getName()))(),t.debug||Qt.level>0){if(!t.getProgramParameter(this.handle,35714))throw new Error("Error linking: ".concat(t.getProgramInfoLog(this.handle)));t.validateProgram(this.handle);if(!t.getProgramParameter(this.handle,35715))throw new Error("Error validating: ".concat(t.getProgramInfoLog(this.handle)))}}_readUniformLocationsFromLinkedProgram(){const{gl:t}=this;this._uniformSetters={},this._uniformCount=this._getParameter(35718);for(let e=0;e<this._uniformCount;e++){const n=this.gl.getActiveUniform(this.handle,e),{name:i}=Ei(n.name);let r=t.getUniformLocation(this.handle,i);if(this._uniformSetters[i]=Ti(t,r,n),n.size>1)for(let e=0;e<n.size;e++)r=t.getUniformLocation(this.handle,"".concat(i,"[").concat(e,"]")),this._uniformSetters["".concat(i,"[").concat(e,"]")]=Ti(t,r,n)}this._textureIndexCounter=0}getActiveUniforms(t,e){return this.gl2.getActiveUniforms(this.handle,t,e)}getUniformBlockIndex(t){return this.gl2.getUniformBlockIndex(this.handle,t)}getActiveUniformBlockParameter(t,e){return this.gl2.getActiveUniformBlockParameter(this.handle,t,e)}uniformBlockBinding(t,e){this.gl2.uniformBlockBinding(this.handle,t,e)}}class dr extends nn{get[Symbol.toStringTag](){return"TransformFeedback"}static isSupported(t){return ee(t)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};ie(t),super(t,e),this.initialize(e),this.stubRemovedMethods("TransformFeedback","v6.0",["pause","resume"]),Object.seal(this)}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.buffers={},this.unused={},this.configuration=null,this.bindOnUse=!0,$e(this.buffers)||this.bind(()=>this._unbindBuffers()),this.setProps(t),this}setProps(t){"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"bindOnUse"in t&&(t=t.bindOnUse),"buffers"in t&&this.setBuffers(t.buffers)}setBuffers(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.bind(()=>{for(const e in t)this.setBuffer(e,t[e])}),this}setBuffer(t,e){const n=this._getVaryingIndex(t),{buffer:i,byteSize:r,byteOffset:s}=this._getBufferParams(e);return n<0?(this.unused[t]=i,Qt.warn("".concat(this.id," unused varying buffer ").concat(t))(),this):(this.buffers[n]=e,this.bindOnUse||this._bindBuffer(n,i,s,r),this)}begin(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.gl.bindTransformFeedback(36386,this.handle),this._bindBuffers(),this.gl.beginTransformFeedback(t),this}end(){return this.gl.endTransformFeedback(),this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null),this}_getBufferParams(t){let e,n,i;return t instanceof gn==!1?(i=t.buffer,n=t.byteSize,e=t.byteOffset):i=t,void 0===e&&void 0===n||(e=e||0,n=n||i.byteLength-e),{buffer:i,byteOffset:e,byteSize:n}}_getVaryingInfo(t){return this.configuration&&this.configuration.getVaryingInfo(t)}_getVaryingIndex(t){if(this.configuration)return this.configuration.getVaryingInfo(t).location;const e=Number(t);return Number.isFinite(e)?e:-1}_bindBuffers(){if(this.bindOnUse)for(const t in this.buffers){const{buffer:e,byteSize:n,byteOffset:i}=this._getBufferParams(this.buffers[t]);this._bindBuffer(t,e,i,n)}}_unbindBuffers(){if(this.bindOnUse)for(const t in this.buffers)this._bindBuffer(t,null)}_bindBuffer(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0;const r=e&&e.handle;return r&&void 0!==i?this.gl.bindBufferRange(35982,t,r,n,i):this.gl.bindBufferBase(35982,t,r),this}_createHandle(){return this.gl.createTransformFeedback()}_deleteHandle(){this.gl.deleteTransformFeedback(this.handle)}_bindHandle(t){this.gl.bindTransformFeedback(36386,this.handle)}}let fr=null;function gr(t,e){var n;return new t((n=t.BYTES_PER_ELEMENT*e,(!fr||fr.byteLength<n)&&(fr=new ArrayBuffer(n)),fr),0,e)}class pr extends nn{get[Symbol.toStringTag](){return"VertexArrayObject"}static isSupported(t){return!(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).constantAttributeZero||(ee(t)||"Chrome"===Q())}static getDefaultArray(t){return t.luma=t.luma||{},t.luma.defaultVertexArray||(t.luma.defaultVertexArray=new pr(t,{handle:null,isDefaultArray:!0})),t.luma.defaultVertexArray}static getMaxAttributes(t){return pr.MAX_ATTRIBUTES=pr.MAX_ATTRIBUTES||t.getParameter(34921),pr.MAX_ATTRIBUTES}static setConstant(t,e,n){switch(n.constructor){case Float32Array:pr._setConstantFloatArray(t,e,n);break;case Int32Array:pr._setConstantIntArray(t,e,n);break;case Uint32Array:pr._setConstantUintArray(t,e,n);break;default:Ze(!1)}}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=e.id||e.program&&e.program.id;super(t,Object.assign({},e,{id:n})),this.buffer=null,this.bufferValue=null,this.isDefaultArray=e.isDefaultArray||!1,this.gl2=t,this.initialize(e),Object.seal(this)}delete(){return super.delete(),this.buffer&&this.buffer.delete(),this}get MAX_ATTRIBUTES(){return pr.getMaxAttributes(this.gl)}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.setProps(t)}setProps(t){return this}setElementBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return Ze(!t||34963===t.target,"elements must be GL.ELEMENT_ARRAY_BUFFER"),this.bind(()=>{this.gl.bindBuffer(34963,t?t.handle:null)}),this}setBuffer(t,e,n){if(34963===e.target)return this.setElementBuffer(e,n);const{size:i,type:r,stride:s,offset:o,normalized:a,integer:c,divisor:l}=n,{gl:u,gl2:h}=this;return t=Number(t),this.bind(()=>{u.bindBuffer(34962,e.handle),c?(Ze(ee(u)),h.vertexAttribIPointer(t,i,r,s,o)):u.vertexAttribPointer(t,i,r,a,s,o),u.enableVertexAttribArray(t),h.vertexAttribDivisor(t,l||0)}),this}enable(t){let e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return!e&&0===t&&!pr.isSupported(this.gl,{constantAttributeZero:!0})||(t=Number(t),this.bind(()=>e?this.gl.enableVertexAttribArray(t):this.gl.disableVertexAttribArray(t))),this}getConstantBuffer(t,e){const n=this._normalizeConstantArrayValue(e),i=n.byteLength*t,r=n.length*t;let s=!this.buffer;if(this.buffer=this.buffer||new gn(this.gl,i),s=s||this.buffer.reallocate(i),s=s||!this._compareConstantArrayValues(n,this.bufferValue),s){const t=gr(e.constructor,r);!function(t){let{target:e,source:n,start:i=0,count:r=1}=t;const s=n.length,o=r*s;let a=0;for(let t=i;a<s;a++)e[t++]=n[a];for(;a<o;)a<o-a?(e.copyWithin(i+a,i,i+a),a*=2):(e.copyWithin(i+a,i,i+o-a),a=o)}({target:t,source:n,start:0,count:r}),this.buffer.subData(t),this.bufferValue=e}return this.buffer}_normalizeConstantArrayValue(t){return Array.isArray(t)?new Float32Array(t):t}_compareConstantArrayValues(t,e){if(!t||!e||t.length!==e.length||t.constructor!==e.constructor)return!1;for(let n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}static _setConstantFloatArray(t,e,n){switch(n.length){case 1:t.vertexAttrib1fv(e,n);break;case 2:t.vertexAttrib2fv(e,n);break;case 3:t.vertexAttrib3fv(e,n);break;case 4:t.vertexAttrib4fv(e,n);break;default:Ze(!1)}}static _setConstantIntArray(t,e,n){switch(Ze(ee(t)),n.length){case 1:t.vertexAttribI1iv(e,n);break;case 2:t.vertexAttribI2iv(e,n);break;case 3:t.vertexAttribI3iv(e,n);break;case 4:t.vertexAttribI4iv(e,n);break;default:Ze(!1)}}static _setConstantUintArray(t,e,n){switch(Ze(ee(t)),n.length){case 1:t.vertexAttribI1uiv(e,n);break;case 2:t.vertexAttribI2uiv(e,n);break;case 3:t.vertexAttribI3uiv(e,n);break;case 4:t.vertexAttribI4uiv(e,n);break;default:Ze(!1)}}_createHandle(){return this.gl.createVertexArray()}_deleteHandle(t){return this.gl2.deleteVertexArray(t),[this.elements]}_bindHandle(t){this.gl2.bindVertexArray(t)}_getParameter(t,e){let{location:n}=e;return Ze(Number.isFinite(n)),this.bind(()=>34373===t?this.gl.getVertexAttribOffset(n,t):this.gl.getVertexAttrib(n,t))}}const mr=/^(.+)__LOCATION_([0-9]+)$/,vr=["setBuffers","setGeneric","clearBindings","setLocations","setGenericValues","setDivisor","enable","disable"];class yr{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=e.id||e.program&&e.program.id;this.id=n,this.gl=t,this.configuration=null,this.elements=null,this.elementsAccessor=null,this.values=null,this.accessors=null,this.unused=null,this.drawParams=null,this.buffer=null,this.attributes={},this.vertexArrayObject=new pr(t),tn(this,"VertexArray","v6.0",vr),this.initialize(e),Object.seal(this)}delete(){this.buffer&&this.buffer.delete(),this.vertexArrayObject.delete()}initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.reset(),this.configuration=null,this.bindOnUse=!1,this.setProps(t)}reset(){this.elements=null,this.elementsAccessor=null;const{MAX_ATTRIBUTES:t}=this.vertexArrayObject;return this.values=new Array(t).fill(null),this.accessors=new Array(t).fill(null),this.unused={},this.drawParams=null,this}setProps(t){return"program"in t&&(this.configuration=t.program&&t.program.configuration),"configuration"in t&&(this.configuration=t.configuration),"attributes"in t&&this.setAttributes(t.attributes),"elements"in t&&this.setElementBuffer(t.elements),"bindOnUse"in t&&(t=t.bindOnUse),this}clearDrawParams(){this.drawParams=null}getDrawParams(){return this.drawParams=this.drawParams||this._updateDrawParams(),this.drawParams}setAttributes(t){return Object.assign(this.attributes,t),this.vertexArrayObject.bind(()=>{for(const e in t){const n=t[e];this._setAttribute(e,n)}this.gl.bindBuffer(34962,null)}),this}setElementBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.elements=t,this.elementsAccessor=e,this.clearDrawParams(),this.vertexArrayObject.setElementBuffer(t,e),this}setBuffer(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(34963===e.target)return this.setElementBuffer(e,n);const{location:i,accessor:r}=this._resolveLocationAndAccessor(t,e,e.accessor,n);return i>=0&&(this.values[i]=e,this.accessors[i]=r,this.clearDrawParams(),this.vertexArrayObject.setBuffer(i,e,r)),this}setConstant(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{location:i,accessor:r}=this._resolveLocationAndAccessor(t,e,Object.assign({size:e.length},n));return i>=0&&(e=this.vertexArrayObject._normalizeConstantArrayValue(e),this.values[i]=e,this.accessors[i]=r,this.clearDrawParams(),this.vertexArrayObject.enable(i,!1)),this}unbindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.vertexArrayObject.setElementBuffer(null),this.buffer=this.buffer||new gn(this.gl,{accessor:{size:4}});for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)this.values[t]instanceof gn&&(this.gl.disableVertexAttribArray(t),this.gl.bindBuffer(34962,this.buffer.handle),this.gl.vertexAttribPointer(t,1,5126,!1,0,0))}),this}bindBuffers(){return this.vertexArrayObject.bind(()=>{this.elements&&this.setElementBuffer(this.elements);for(let t=0;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++){const e=this.values[t];e instanceof gn&&this.setBuffer(t,e)}}),this}bindForDraw(t,e,n){let i;return this.vertexArrayObject.bind(()=>{this._setConstantAttributes(t,e),i=n()}),i}_resolveLocationAndAccessor(t,e,n,i){const r={location:-1,accessor:null},{location:s,name:o}=this._getAttributeIndex(t);if(!Number.isFinite(s)||s<0)return this.unused[t]=e,Qt.once(3,()=>"unused value ".concat(t," in ").concat(this.id))(),r;const a=this._getAttributeInfo(o||s);if(!a)return r;const c=this.accessors[s]||{},l=un.resolve(a.accessor,c,n,i),{size:u,type:h}=l;return Ze(Number.isFinite(u)&&Number.isFinite(h)),{location:s,accessor:l}}_getAttributeInfo(t){return this.configuration&&this.configuration.getAttributeInfo(t)}_getAttributeIndex(t){const e=Number(t);if(Number.isFinite(e))return{location:e};const n=mr.exec(t),i=n?n[1]:t,r=n?Number(n[2]):0;return this.configuration?{location:this.configuration.getAttributeLocation(i)+r,name:i}:{location:-1}}_setAttribute(t,e){if(e instanceof gn)this.setBuffer(t,e);else if(Array.isArray(e)&&e.length&&e[0]instanceof gn){const n=e[0],i=e[1];this.setBuffer(t,n,i)}else if(ArrayBuffer.isView(e)||Array.isArray(e)){const n=e;this.setConstant(t,n)}else{if(!(e.buffer instanceof gn))throw new Error("VertexArray: attributes must be Buffers or constants (i.e. typed array)");{const n=e;this.setBuffer(t,n.buffer,n)}}}_setConstantAttributes(t,e){const n=Math.max(0|t,0|e);let i=this.values[0];ArrayBuffer.isView(i)&&this._setConstantAttributeZero(i,n);for(let t=1;t<this.vertexArrayObject.MAX_ATTRIBUTES;t++)i=this.values[t],ArrayBuffer.isView(i)&&this._setConstantAttribute(t,i)}_setConstantAttributeZero(t,e){if(pr.isSupported(this.gl,{constantAttributeZero:!0}))return void this._setConstantAttribute(0,t);const n=this.vertexArrayObject.getConstantBuffer(e,t);this.vertexArrayObject.setBuffer(0,n,this.accessors[0])}_setConstantAttribute(t,e){pr.setConstant(this.gl,t,e)}_updateDrawParams(){const t={isIndexed:!1,isInstanced:!1,indexCount:1/0,vertexCount:1/0,instanceCount:1/0};for(let e=0;e<this.vertexArrayObject.MAX_ATTRIBUTES;e++)this._updateDrawParamsForLocation(t,e);return this.elements&&(t.elementCount=this.elements.getElementCount(this.elements.accessor),t.isIndexed=!0,t.indexType=this.elementsAccessor.type||this.elements.accessor.type,t.indexOffset=this.elementsAccessor.offset||0),t.indexCount===1/0&&(t.indexCount=0),t.vertexCount===1/0&&(t.vertexCount=0),t.instanceCount===1/0&&(t.instanceCount=0),t}_updateDrawParamsForLocation(t,e){const n=this.values[e],i=this.accessors[e];if(!n)return;const{divisor:r}=i,s=r>0;if(t.isInstanced=t.isInstanced||s,n instanceof gn){const e=n;if(s){const n=e.getVertexCount(i);t.instanceCount=Math.min(t.instanceCount,n)}else{const n=e.getVertexCount(i);t.vertexCount=Math.min(t.vertexCount,n)}}}setElements(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Qt.deprecated("setElements","setElementBuffer")(),this.setElementBuffer(t,e)}}function br(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{isInteger:n=!1}=e;if(Array.isArray(t)||ArrayBuffer.isView(t))return function(t,e){const{maxElts:n=16,size:i=1}=e;let r="[";for(let s=0;s<t.length&&s<n;++s)s>0&&(r+=",".concat(s%i===0?" ":"")),r+=br(t[s],e);const s=t.length>n?"...":"]";return"".concat(r).concat(s)}(t,e);if(!Number.isFinite(t))return String(t);if(Math.abs(t)<1e-16)return n?"0":"0.";if(n)return t.toFixed(0);if(Math.abs(t)>100&&Math.abs(t)<1e4)return t.toFixed(0);const i=t.toPrecision(2);return i.indexOf(".0")===i.length-2?i.slice(0,-1):i}function _r(t){let{header:e="Uniforms",program:n,uniforms:i,undefinedOnly:r=!1}=t;Ze(n);const s=".*Matrix",o=n._uniformSetters,a={},c=Object.keys(o).sort();let l=0;for(const t of c)t.match(".*_.*")||t.match(s)||xr({table:a,header:e,uniforms:i,uniformName:t,undefinedOnly:r})&&l++;for(const t of c)t.match(s)&&xr({table:a,header:e,uniforms:i,uniformName:t,undefinedOnly:r})&&l++;for(const t of c)a[t]||xr({table:a,header:e,uniforms:i,uniformName:t,undefinedOnly:r})&&l++;let u=0;const h={};if(!r)for(const t in i){const n=i[t];a[t]||(u++,h[t]={Type:"NOT USED: ".concat(n),[e]:br(n)})}return{table:a,count:l,unusedTable:h,unusedCount:u}}function xr(t){let{table:e,header:n,uniforms:i,uniformName:r,undefinedOnly:s}=t;const o=i[r],a=function(t){return null!=t}(o);return(!s||!a)&&(e[r]={[n]:a?br(o):"N/A","Uniform Type":a?o:"NOT PROVIDED"},!0)}function Pr(t,e,n,i){const{gl:r}=t;if(!e)return{[i]:"null","Format ":"N/A"};let s,o,a,c="NOT PROVIDED",l=1,u=0,h=0;if(n&&(c=n.type,l=n.size,c=String(c).replace("Array",""),s=-1!==c.indexOf("nt")),e instanceof gn){const t=e,{data:d,changed:f}=t.getDebugData();let g;if(o=f?"*":"",a=d,h=t.byteLength,u=h/d.BYTES_PER_ELEMENT/l,n){const t=n.divisor>0;g="".concat(t?"I ":"P "," ").concat(u," (x").concat(l,"=").concat(h," bytes ").concat(Ke(r,c),")")}else s=!0,g="".concat(h," bytes");return{[i]:"".concat(o).concat(br(a,{size:l,isInteger:s})),"Format ":g}}return a=e,l=e.length,c=String(e.constructor.name).replace("Array",""),s=-1!==c.indexOf("nt"),{[i]:"".concat(br(a,{size:l,isInteger:s})," (constant)"),"Format ":"".concat(l,"x").concat(c," (constant)")}}function wr(t,e){const{type:n,size:i}=e,r=ar(n,i);return r?"".concat(t," (").concat(r.name,")"):t}function Ar(t){const{type:e,size:n}=t.accessor,i=ar(e,n);return i?"".concat(i.name," ").concat(t.name):t.name}const Sr="vs",Tr="fs";function Er(t,e){if(!t)throw new Error(e||"shadertools: assertion failed.")}const Cr={number:{validate:(t,e)=>Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)},array:{validate:(t,e)=>Array.isArray(t)||ArrayBuffer.isView(t)}};function Lr(t){let e=Mr(t);return"object"===e?t?"type"in t?Object.assign({},t,Cr[t.type]):"value"in t?(e=Mr(t.value),Object.assign({type:e},t,Cr[e])):{type:"object",value:t}:{type:"object",value:null}:Object.assign({type:e,value:t},Cr[e])}function Mr(t){return Array.isArray(t)||ArrayBuffer.isView(t)?"array":typeof t}class Or{constructor(t){let{name:e,vs:n,fs:i,dependencies:r=[],uniforms:s,getUniforms:o,deprecations:a=[],defines:c={},inject:l={},vertexShader:u,fragmentShader:h}=t;Er("string"==typeof e),this.name=e,this.vs=n||u,this.fs=i||h,this.getModuleUniforms=o,this.dependencies=r,this.deprecations=this._parseDeprecationDefinitions(a),this.defines=c,this.injections=function(t){const e={vs:{},fs:{}};for(const n in t){let i=t[n];"string"==typeof i&&(i={order:0,injection:i}),e[n.slice(0,2)][n]=i}return e}(l),s&&(this.uniforms=function(t){const e={};for(const n in t){const i=Lr(t[n]);e[n]=i}return e}(s))}getModuleSource(t){let e;switch(t){case"vs":e=this.vs||"";break;case"fs":e=this.fs||"";break;default:Er(!1)}return"#define MODULE_".concat(this.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),"\n").concat(e,"// END MODULE_").concat(this.name,"\n\n")}getUniforms(t,e){return this.getModuleUniforms?this.getModuleUniforms(t,e):this.uniforms?this._defaultGetUniforms(t):{}}getDefines(){return this.defines}checkDeprecations(t,e){this.deprecations.forEach(n=>{n.regex.test(t)&&(n.deprecated?e.deprecated(n.old,n.new)():e.removed(n.old,n.new)())})}_parseDeprecationDefinitions(t){return t.forEach(t=>{if("function"===t.type)t.regex=new RegExp("\\b".concat(t.old,"\\("));else t.regex=new RegExp("".concat(t.type," ").concat(t.old,";"))}),t}_defaultGetUniforms(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e={},n=this.uniforms;for(const i in n){const r=n[i];i in t&&!r.private?(r.validate&&Er(r.validate(t[i],r),"".concat(this.name,": invalid ").concat(i)),e[i]=t[i]):e[i]=r.value}return e}}function Ir(t){return function(t){const e={},n={};return Rr({modules:t,level:0,moduleMap:e,moduleDepth:n}),Object.keys(n).sort((t,e)=>n[e]-n[t]).map(t=>e[t])}(Fr(t))}function Rr(t){let{modules:e,level:n,moduleMap:i,moduleDepth:r}=t;if(n>=5)throw new Error("Possible loop in shader dependency graph");for(const t of e)i[t.name]=t,(void 0===r[t.name]||r[t.name]<n)&&(r[t.name]=n);for(const t of e)t.dependencies&&Rr({modules:t.dependencies,level:n+1,moduleMap:i,moduleDepth:r})}function Fr(t,e){return t.map(t=>(t instanceof Or||(Er("string"!=typeof t,"Shader module use by name is deprecated. Import shader module '".concat(t,"' and use it directly.")),Er(t.name,"shader module has no name"),(t=new Or(t)).dependencies=Fr(t.dependencies)),t))}const zr={GLSL_FRAG_DATA:["WEBGL_draw_buffers",!0],GLSL_FRAG_DEPTH:["EXT_frag_depth",!0],GLSL_DERIVATIVES:["OES_standard_derivatives",!0],GLSL_TEXTURE_LOD:["EXT_shader_texture_lod",!0]},kr={};Object.keys(zr).forEach(t=>{kr[t]=t});const jr={};function Br(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=zr[e];if(Er(i,e),!function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e="undefined"!=typeof window&&window.navigator||{},n=t.userAgent||e.userAgent||"",i=-1!==n.indexOf("MSIE "),r=-1!==n.indexOf("Trident/");return i||r}(n))return!0;if(e in jr)return jr[e];const r=i[0],s=n.behavior||"enable",o="#extension GL_".concat(r," : ").concat(s,"\nvoid main(void) {}"),a=t.createShader(35633);t.shaderSource(a,o),t.compileShader(a);const c=t.getShaderParameter(a,35713);return t.deleteShader(a),jr[e]=c,c}function Dr(t,e){const n=zr[e];Er(n,e);const i=function(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||Boolean(t&&2===t._version)}(t)&&n[1]||n[0],r="string"==typeof i?Boolean(t.getExtension(i)):i;return Er(!1===r||!0===r),r}function Nr(t,e){return(e=Array.isArray(e)?e:[e]).every(e=>Dr(t,e))}const Ur={[Sr]:"#ifdef MODULE_LOGDEPTH\n  logdepth_adjustPosition(gl_Position);\n#endif\n",[Tr]:"#ifdef MODULE_MATERIAL\n  gl_FragColor = material_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_LIGHTING\n  gl_FragColor = lighting_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_FOG\n  gl_FragColor = fog_filterColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_PICKING\n  gl_FragColor = picking_filterHighlightColor(gl_FragColor);\n  gl_FragColor = picking_filterPickingColor(gl_FragColor);\n#endif\n\n#ifdef MODULE_LOGDEPTH\n  logdepth_setFragDepth();\n#endif\n"},Vr="__LUMA_INJECT_DECLARATIONS__",Gr=/void\s+main\s*\([^)]*\)\s*\{\n?/,Wr=/}\n?[^{}]*$/,Hr=[];function Xr(t,e,n){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const r=e===Sr;for(const e in n){const i=n[e];i.sort((t,e)=>t.order-e.order),Hr.length=i.length;for(let t=0,e=i.length;t<e;++t)Hr[t]=i[t].injection;const s="".concat(Hr.join("\n"),"\n");switch(e){case"vs:#decl":r&&(t=t.replace(Vr,s));break;case"vs:#main-start":r&&(t=t.replace(Gr,t=>t+s));break;case"vs:#main-end":r&&(t=t.replace(Wr,t=>s+t));break;case"fs:#decl":r||(t=t.replace(Vr,s));break;case"fs:#main-start":r||(t=t.replace(Gr,t=>t+s));break;case"fs:#main-end":r||(t=t.replace(Wr,t=>s+t));break;default:t=t.replace(e,t=>t+s)}}return t=t.replace(Vr,""),i&&(t=t.replace(/\}\s*$/,t=>t+Ur[e])),t}function Zr(t){const e={};return Er(Array.isArray(t)&&t.length>1),t.forEach(t=>{for(const n in t)e[n]=e[n]?"".concat(e[n],"\n").concat(t[n]):t[n]}),e}function Yr(t){return new RegExp("\\b".concat(t,"[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)"),"g")}const Kr=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,"#version 300 es\n"],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],qr=[...Kr,[Yr("attribute"),"in $1"],[Yr("varying"),"out $1"]],Jr=[...Kr,[Yr("varying"),"in $1"]],Qr=[[/^#version[ \t]+300[ \t]+es/,"#version 100"],[/\btexture(2D|2DProj|Cube)Lod\(/g,"texture$1LodEXT("],[/\btexture\(/g,"texture2D("],[/\btextureLod\(/g,"texture2DLodEXT("]],$r=[...Qr,[Yr("in"),"attribute $1"],[Yr("out"),"varying $1"]],ts=[...Qr,[Yr("in"),"varying $1"]],es="gl_FragColor",ns=/\bout[ \t]+vec4[ \t]+(\w+)[ \t]*;\n?/,is=/void\s+main\s*\([^)]*\)\s*\{\n?/;function rs(t,e,n){switch(e){case 300:return n?ss(t,qr):function(t){t=ss(t,Jr);const e=t.match(ns);if(e){const n=e[1];t=t.replace(new RegExp("\\b".concat(es,"\\b"),"g"),n)}else{const e="fragmentColor";t=t.replace(is,t=>"out vec4 ".concat(e,";\n").concat(t)).replace(new RegExp("\\b".concat(es,"\\b"),"g"),e)}return t}(t);case 100:return n?ss(t,$r):function(t){t=ss(t,ts);const e=t.match(ns);if(e){const n=e[1];t=t.replace(ns,"").replace(new RegExp("\\b".concat(n,"\\b"),"g"),es)}return t}(t);default:throw new Error("unknown GLSL version ".concat(e))}}function ss(t,e){for(const[n,i]of e)t=t.replace(n,i);return t}const os="\n\n".concat(Vr,"\n\n"),as={[Sr]:"vertex",[Tr]:"fragment"};function cs(t,e){let{id:n,source:i,type:r,modules:s,defines:o={},hookFunctions:a=[],inject:c={},transpileToGLSL100:l=!1,prologue:u=!0,log:h}=e;Er("string"==typeof i,"shader source must be a string");const d=r===Sr,f=i.split("\n");let g=100,p="",m=i;0===f[0].indexOf("#version ")?(g=300,p=f[0],m=f.slice(1).join("\n")):p="#version ".concat(g);const v={};s.forEach(t=>{Object.assign(v,t.getDefines())}),Object.assign(v,o);let y=u?"".concat(p,"\n").concat(function(t){let{id:e,source:n,type:i}=t;const r=e&&"string"==typeof e&&-1===n.indexOf("SHADER_NAME");return r?"\n#define SHADER_NAME ".concat(e,"_").concat(as[i],"\n\n"):""}({id:n,source:i,type:r}),"\n").concat(function(t){let{type:e}=t;return"\n#define SHADER_TYPE_".concat(as[e].toUpperCase(),"\n")}({type:r}),"\n").concat(function(t){const e=function(t){const e=t.getExtension("WEBGL_debug_renderer_info"),n=t.getParameter(e&&e.UNMASKED_VENDOR_WEBGL||7936),i=t.getParameter(e&&e.UNMASKED_RENDERER_WEBGL||7937);return{gpuVendor:function(t,e){return t.match(/NVIDIA/i)||e.match(/NVIDIA/i)?"NVIDIA":t.match(/INTEL/i)||e.match(/INTEL/i)?"INTEL":t.match(/AMD/i)||e.match(/AMD/i)||t.match(/ATI/i)||e.match(/ATI/i)?"AMD":"UNKNOWN GPU"}(n,i),vendor:n,renderer:i,version:t.getParameter(7938),shadingLanguageVersion:t.getParameter(35724)}}(t);switch(e.gpuVendor.toLowerCase()){case"nvidia":return"#define NVIDIA_GPU\n// Nvidia optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n";case"intel":return"#define INTEL_GPU\n// Intel optimizes away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n";case"amd":return"#define AMD_GPU\n";default:return"#define DEFAULT_GPU\n// Prevent driver from optimizing away the calculation necessary for emulated fp64\n#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1\n// Intel's built-in 'tan' function doesn't have acceptable precision\n#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1\n// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow\n#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1\n"}}(t),"\n").concat(function(t){let e="#if (__VERSION__ > 120)\n\n# define FEATURE_GLSL_DERIVATIVES\n# define FEATURE_GLSL_DRAW_BUFFERS\n# define FEATURE_GLSL_FRAG_DEPTH\n# define FEATURE_GLSL_TEXTURE_LOD\n\n// DEPRECATED FLAGS, remove in v9\n# define FRAG_DEPTH\n# define DERIVATIVES\n# define DRAW_BUFFERS\n# define TEXTURE_LOD\n\n#endif // __VERSION\n";return Nr(t,kr.GLSL_FRAG_DEPTH)&&(e+="\n// FRAG_DEPTH => gl_FragDepth is available\n#ifdef GL_EXT_frag_depth\n#extension GL_EXT_frag_depth : enable\n# define FEATURE_GLSL_FRAG_DEPTH\n# define FRAG_DEPTH\n# define gl_FragDepth gl_FragDepthEXT\n#endif\n"),Nr(t,kr.GLSL_DERIVATIVES)&&Br(t,kr.GLSL_DERIVATIVES)&&(e+="\n// DERIVATIVES => dxdF, dxdY and fwidth are available\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n# define FEATURE_GLSL_DERIVATIVES\n# define DERIVATIVES\n#endif\n"),Nr(t,kr.GLSL_FRAG_DATA)&&Br(t,kr.GLSL_FRAG_DATA,{behavior:"require"})&&(e+="\n// DRAW_BUFFERS => gl_FragData[] is available\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers : require\n#define FEATURE_GLSL_DRAW_BUFFERS\n#define DRAW_BUFFERS\n#endif\n"),Nr(t,kr.GLSL_TEXTURE_LOD)&&(e+="// TEXTURE_LOD => texture2DLod etc are available\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n\n# define FEATURE_GLSL_TEXTURE_LOD\n# define TEXTURE_LOD\n\n#endif\n"),e}(t),"\n").concat(function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=0,n="";for(const i in t){0===e&&(n+="\n// APPLICATION DEFINES\n"),e++;const r=t[i];(r||Number.isFinite(r))&&(n+="#define ".concat(i.toUpperCase()," ").concat(t[i],"\n"))}0===e&&(n+="\n");return n}(v),"\n").concat(d?"":"precision highp float;\n\n","\n"):"".concat(p,"\n");const b=function(t){const e={vs:{},fs:{}};return t.forEach(t=>{let n;"string"!=typeof t?(n=t,t=n.hook):n={},t=t.trim();const[i,r]=t.split(":"),s=t.replace(/\(.+/,"");e[i][s]=Object.assign(n,{signature:r})}),e}(a),_={},x={},P={};for(const t in c){const e="string"==typeof c[t]?{injection:c[t],order:0}:c[t],n=t.match(/^(v|f)s:(#)?([\w-]+)$/);if(n){const i=n[2],r=n[3];i?"decl"===r?x[t]=[e]:P[t]=[e]:_[t]=[e]}else P[t]=[e]}for(const t of s){h&&t.checkDeprecations(m,h);y+=t.getModuleSource(r,g);const e=t.injections[r];for(const t in e){const n=t.match(/^(v|f)s:#([\w-]+)$/);if(n){const i="decl"===n[2]?x:P;i[t]=i[t]||[],i[t].push(e[t])}else _[t]=_[t]||[],_[t].push(e[t])}}return y+=os,y=Xr(y,r,x),y+=function(t,e){let n="";for(const i in t){const r=t[i];if(n+="void ".concat(r.signature," {\n"),r.header&&(n+="  ".concat(r.header)),e[i]){const t=e[i];t.sort((t,e)=>t.order-e.order);for(const e of t)n+="  ".concat(e.injection,"\n")}r.footer&&(n+="  ".concat(r.footer)),n+="}\n"}return n}(b[r],_),y+=m,y=Xr(y,r,P),y=rs(y,l?100:g,d),y}function ls(t){return function(e){const n={};for(const i of t){const t=i.getUniforms(e,n);Object.assign(n,t)}return n}}const us="out vec4 transform_output;\nvoid main() {\n  transform_output = vec4(0);\n}",hs="#version 300 es\n".concat(us);function ds(t,e){e=Array.isArray(e)?e:[e];const n=t.replace(/^\s+/,"").split(/\s+/),[i,r,s]=n;if(!e.includes(i)||!r||!s)return null;return{qualifier:i,type:r,name:s.split(";")[0]}}function fs(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{version:e=100,input:n,inputType:i,output:r}=t;if(!n)return 300===e?hs:e>300?"#version ".concat(e,"\n").concat(us):"void main() {gl_FragColor = vec4(0);}";const s=function(t,e){switch(e){case"float":return"vec4(".concat(t,", 0.0, 0.0, 1.0)");case"vec2":return"vec4(".concat(t,", 0.0, 1.0)");case"vec3":return"vec4(".concat(t,", 1.0)");case"vec4":return t;default:return Er(!1),null}}(n,i);return e>=300?"#version ".concat(e," ").concat(300===e?"es":"","\nin ").concat(i," ").concat(n,";\nout vec4 ").concat(r,";\nvoid main() {\n  ").concat(r," = ").concat(s,";\n}"):"varying ".concat(i," ").concat(n,";\nvoid main() {\n  gl_FragColor = ").concat(s,";\n}")}const gs={name:"fp32",vs:"#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\nconst float TWO_PI = 6.2831854820251465;\nconst float PI_2 = 1.5707963705062866;\nconst float PI_16 = 0.1963495463132858;\n\nconst float SIN_TABLE_0 = 0.19509032368659973;\nconst float SIN_TABLE_1 = 0.3826834261417389;\nconst float SIN_TABLE_2 = 0.5555702447891235;\nconst float SIN_TABLE_3 = 0.7071067690849304;\n\nconst float COS_TABLE_0 = 0.9807852506637573;\nconst float COS_TABLE_1 = 0.9238795042037964;\nconst float COS_TABLE_2 = 0.8314695954322815;\nconst float COS_TABLE_3 = 0.7071067690849304;\n\nconst float INVERSE_FACTORIAL_3 = 1.666666716337204e-01;\nconst float INVERSE_FACTORIAL_5 = 8.333333767950535e-03;\nconst float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04;\nconst float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06;\n\nfloat sin_taylor_fp32(float a) {\n  float r, s, t, x;\n\n  if (a == 0.0) {\n    return 0.0;\n  }\n\n  x = -a * a;\n  s = a;\n  r = a;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_3;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_5;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_7;\n  s = s + t;\n\n  r = r * x;\n  t = r * INVERSE_FACTORIAL_9;\n  s = s + t;\n\n  return s;\n}\n\nvoid sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {\n  if (a == 0.0) {\n    sin_t = 0.0;\n    cos_t = 1.0;\n  }\n  sin_t = sin_taylor_fp32(a);\n  cos_t = sqrt(1.0 - sin_t * sin_t);\n}\n\nfloat tan_taylor_fp32(float a) {\n    float sin_a;\n    float cos_a;\n\n    if (a == 0.0) {\n        return 0.0;\n    }\n    float z = floor(a / TWO_PI);\n    float r = a - TWO_PI * z;\n\n    float t;\n    float q = floor(r / PI_2 + 0.5);\n    int j = int(q);\n\n    if (j < -2 || j > 2) {\n        return 1.0 / 0.0;\n    }\n\n    t = r - PI_2 * q;\n\n    q = floor(t / PI_16 + 0.5);\n    int k = int(q);\n    int abs_k = int(abs(float(k)));\n\n    if (abs_k > 4) {\n        return 1.0 / 0.0;\n    } else {\n        t = t - PI_16 * q;\n    }\n\n    float u = 0.0;\n    float v = 0.0;\n\n    float sin_t, cos_t;\n    float s, c;\n    sincos_taylor_fp32(t, sin_t, cos_t);\n\n    if (k == 0) {\n        s = sin_t;\n        c = cos_t;\n    } else {\n        if (abs(float(abs_k) - 1.0) < 0.5) {\n            u = COS_TABLE_0;\n            v = SIN_TABLE_0;\n        } else if (abs(float(abs_k) - 2.0) < 0.5) {\n            u = COS_TABLE_1;\n            v = SIN_TABLE_1;\n        } else if (abs(float(abs_k) - 3.0) < 0.5) {\n            u = COS_TABLE_2;\n            v = SIN_TABLE_2;\n        } else if (abs(float(abs_k) - 4.0) < 0.5) {\n            u = COS_TABLE_3;\n            v = SIN_TABLE_3;\n        }\n        if (k > 0) {\n            s = u * sin_t + v * cos_t;\n            c = u * cos_t - v * sin_t;\n        } else {\n            s = u * sin_t - v * cos_t;\n            c = u * cos_t + v * sin_t;\n        }\n    }\n\n    if (j == 0) {\n        sin_a = s;\n        cos_a = c;\n    } else if (j == 1) {\n        sin_a = c;\n        cos_a = -s;\n    } else if (j == -1) {\n        sin_a = -c;\n        cos_a = s;\n    } else {\n        sin_a = -s;\n        cos_a = -c;\n    }\n    return sin_a / cos_a;\n}\n#endif\n\nfloat tan_fp32(float a) {\n#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND\n  return tan_taylor_fp32(a);\n#else\n  return tan(a);\n#endif\n}\n",fs:null};function ps(t,e){if(!t)throw new Error("math.gl assertion ".concat(e))}const ms={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0};function vs(t,{precision:e=ms.precision}={}){return t=function(t){return Math.round(t/ms.EPSILON)*ms.EPSILON}(t),"".concat(parseFloat(t.toPrecision(e)))}function ys(t){return Array.isArray(t)||ArrayBuffer.isView(t)&&!(t instanceof DataView)}function bs(t,e,n){return function(t,e,n){if(ys(t)){const i=t;n=n||function(t){return t.clone?t.clone():new Array(t.length)}(i);for(let r=0;r<n.length&&r<i.length;++r)n[r]=e(t[r],r,n);return n}return e(t)}(t,t=>Math.max(e,Math.min(n,t)))}function _s(t,e,n){return ys(t)?t.map((t,i)=>_s(t,e[i],n)):n*e+(1-n)*t}function xs(t,e,n){const i=ms.EPSILON;try{if(t===e)return!0;if(ys(t)&&ys(e)){if(t.length!==e.length)return!1;for(let n=0;n<t.length;++n)if(!xs(t[n],e[n]))return!1;return!0}return t&&t.equals?t.equals(e):e&&e.equals?e.equals(t):"number"==typeof t&&"number"==typeof e&&Math.abs(t-e)<=ms.EPSILON*Math.max(1,Math.abs(t),Math.abs(e))}finally{ms.EPSILON=i}}class Ps extends(function(t){function e(){var e=Reflect.construct(t,Array.from(arguments));return Object.setPrototypeOf(e,Object.getPrototypeOf(this)),e}return e.prototype=Object.create(t.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t,e}(Array)){clone(){return(new this.constructor).copy(this)}fromArray(t,e=0){for(let n=0;n<this.ELEMENTS;++n)this[n]=t[n+e];return this.check()}toArray(t=[],e=0){for(let n=0;n<this.ELEMENTS;++n)t[e+n]=this[n];return t}from(t){return Array.isArray(t)?this.copy(t):this.fromObject(t)}to(t){return t===this?this:ys(t)?this.toArray(t):this.toObject(t)}toTarget(t){return t?this.to(t):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ms)}formatString(t){let e="";for(let n=0;n<this.ELEMENTS;++n)e+=(n>0?", ":"")+vs(this[n],t);return"".concat(t.printTypes?this.constructor.name:"","[").concat(e,"]")}equals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(!xs(this[e],t[e]))return!1;return!0}exactEquals(t){if(!t||this.length!==t.length)return!1;for(let e=0;e<this.ELEMENTS;++e)if(this[e]!==t[e])return!1;return!0}negate(){for(let t=0;t<this.ELEMENTS;++t)this[t]=-this[t];return this.check()}lerp(t,e,n){if(void 0===n)return this.lerp(this,t,e);for(let i=0;i<this.ELEMENTS;++i){const r=t[i];this[i]=r+n*(e[i]-r)}return this.check()}min(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.min(t[e],this[e]);return this.check()}max(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=Math.max(t[e],this[e]);return this.check()}clamp(t,e){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],t[n]),e[n]);return this.check()}add(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]+=e[t];return this.check()}subtract(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]-=e[t];return this.check()}scale(t){if("number"==typeof t)for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;else for(let e=0;e<this.ELEMENTS&&e<t.length;++e)this[e]*=t[e];return this.check()}multiplyByScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}check(){if(ms.debug&&!this.validate())throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}validate(){let t=this.length===this.ELEMENTS;for(let e=0;e<this.ELEMENTS;++e)t=t&&Number.isFinite(this[e]);return t}sub(t){return this.subtract(t)}setScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]=t;return this.check()}addScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]+=t;return this.check()}subScalar(t){return this.addScalar(-t)}multiplyScalar(t){for(let e=0;e<this.ELEMENTS;++e)this[e]*=t;return this.check()}divideScalar(t){return this.multiplyByScalar(1/t)}clampScalar(t,e){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],t),e);return this.check()}get elements(){return this}}function ws(t){if(!Number.isFinite(t))throw new Error("Invalid number ".concat(t));return t}function As(t,e,n=""){if(ms.debug&&!function(t,e){if(t.length!==e)return!1;for(let e=0;e<t.length;++e)if(!Number.isFinite(t[e]))return!1;return!0}(t,e))throw new Error("math.gl: ".concat(n," some fields set to invalid numbers'"));return t}class Ss extends Ps{get x(){return this[0]}set x(t){this[0]=ws(t)}get y(){return this[1]}set y(t){this[1]=ws(t)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let t=0;for(let e=0;e<this.ELEMENTS;++e)t+=this[e]*this[e];return t}magnitudeSquared(){return this.lengthSquared()}distance(t){return Math.sqrt(this.distanceSquared(t))}distanceSquared(t){let e=0;for(let n=0;n<this.ELEMENTS;++n){const i=this[n]-t[n];e+=i*i}return ws(e)}dot(t){let e=0;for(let n=0;n<this.ELEMENTS;++n)e+=this[n]*t[n];return ws(e)}normalize(){const t=this.magnitude();if(0!==t)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t;return this.check()}multiply(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e[t];return this.check()}divide(...t){for(const e of t)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e[t];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(t){return this.distance(t)}distanceToSquared(t){return this.distanceSquared(t)}getComponent(t){return ps(t>=0&&t<this.ELEMENTS,"index is out of range"),ws(this[t])}setComponent(t,e){return ps(t>=0&&t<this.ELEMENTS,"index is out of range"),this[t]=e,this.check()}addVectors(t,e){return this.copy(t).add(e)}subVectors(t,e){return this.copy(t).subtract(e)}multiplyVectors(t,e){return this.copy(t).multiply(e)}addScaledVector(t,e){return this.add(new this.constructor(t).multiplyScalar(e))}}var Ts,Es=1e-6,Cs="undefined"!=typeof Float32Array?Float32Array:Array;function Ls(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function Ms(t,e,n,i){var r=e[0],s=e[1];return t[0]=r+i*(n[0]-r),t[1]=s+i*(n[1]-s),t}function Os(t,e,n){const i=e[0],r=e[1],s=e[2],o=n[3]*i+n[7]*r+n[11]*s||1;return t[0]=(n[0]*i+n[4]*r+n[8]*s)/o,t[1]=(n[1]*i+n[5]*r+n[9]*s)/o,t[2]=(n[2]*i+n[6]*r+n[10]*s)/o,t}function Is(t,e,n){var i=e[0],r=e[1],s=e[2],o=n[3]*i+n[7]*r+n[11]*s+n[15];return o=o||1,t[0]=(n[0]*i+n[4]*r+n[8]*s+n[12])/o,t[1]=(n[1]*i+n[5]*r+n[9]*s+n[13])/o,t[2]=(n[2]*i+n[6]*r+n[10]*s+n[14])/o,t}Ts=new Cs(2),Cs!=Float32Array&&(Ts[0]=0,Ts[1]=0);var Rs=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t};!function(){var t=function(){var t=new Cs(3);return Cs!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}()}();const Fs=[0,0,0];let zs;class ks extends Ss{static get ZERO(){return zs||(zs=new ks(0,0,0),Object.freeze(zs)),zs}constructor(t=0,e=0,n=0){super(-0,-0,-0),1===arguments.length&&ys(t)?this.copy(t):(ms.debug&&(ws(t),ws(e),ws(n)),this[0]=t,this[1]=e,this[2]=n)}set(t,e,n){return this[0]=t,this[1]=e,this[2]=n,this.check()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this.check()}fromObject(t){return ms.debug&&(ws(t.x),ws(t.y),ws(t.z)),this[0]=t.x,this[1]=t.y,this[2]=t.z,this.check()}toObject(t){return t.x=this[0],t.y=this[1],t.z=this[2],t}get ELEMENTS(){return 3}get z(){return this[2]}set z(t){this[2]=ws(t)}angle(t){return n=t,i=(e=this)[0],r=e[1],s=e[2],o=n[0],a=n[1],c=n[2],l=Math.sqrt((i*i+r*r+s*s)*(o*o+a*a+c*c)),u=l&&function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}(e,n)/l,Math.acos(Math.min(Math.max(u,-1),1));var e,n,i,r,s,o,a,c,l,u}cross(t){return function(t,e,n){var i=e[0],r=e[1],s=e[2],o=n[0],a=n[1],c=n[2];t[0]=r*c-s*a,t[1]=s*o-i*c,t[2]=i*a-r*o}(this,this,t),this.check()}rotateX({radians:t,origin:e=Fs}){return function(t,e,n,i){var r=[],s=[];r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],s[0]=r[0],s[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),s[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2]}(this,this,e,t),this.check()}rotateY({radians:t,origin:e=Fs}){return function(t,e,n,i){var r=[],s=[];r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],s[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),s[1]=r[1],s[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2]}(this,this,e,t),this.check()}rotateZ({radians:t,origin:e=Fs}){return function(t,e,n,i){var r=[],s=[];r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],s[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),s[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),s[2]=r[2],t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2]}(this,this,e,t),this.check()}transform(t){return this.transformAsPoint(t)}transformAsPoint(t){return Is(this,this,t),this.check()}transformAsVector(t){return Os(this,this,t),this.check()}transformByMatrix3(t){return function(t,e,n){var i=e[0],r=e[1],s=e[2];t[0]=i*n[0]+r*n[3]+s*n[6],t[1]=i*n[1]+r*n[4]+s*n[7],t[2]=i*n[2]+r*n[5]+s*n[8]}(this,this,t),this.check()}transformByMatrix2(t){return function(t,e,n){const i=e[0],r=e[1];t[0]=n[0]*i+n[2]*r,t[1]=n[1]*i+n[3]*r,t[2]=e[2]}(this,this,t),this.check()}transformByQuaternion(t){return function(t,e,n){var i=n[0],r=n[1],s=n[2],o=n[3],a=e[0],c=e[1],l=e[2],u=r*l-s*c,h=s*a-i*l,d=i*c-r*a;u+=u,h+=h,d+=d,t[0]=a+o*u+r*d-s*h,t[1]=c+o*h+s*u-i*d,t[2]=l+o*d+i*h-r*u}(this,this,t),this.check()}}class js extends Ps{toString(){let t="[";if(ms.printRowMajor){t+="row-major:";for(let e=0;e<this.RANK;++e)for(let n=0;n<this.RANK;++n)t+=" ".concat(this[n*this.RANK+e])}else{t+="column-major:";for(let e=0;e<this.ELEMENTS;++e)t+=" ".concat(this[e])}return t+="]",t}getElementIndex(t,e){return e*this.RANK+t}getElement(t,e){return this[e*this.RANK+t]}setElement(t,e,n){return this[e*this.RANK+t]=ws(n),this}getColumn(t,e=new Array(this.RANK).fill(-0)){const n=t*this.RANK;for(let t=0;t<this.RANK;++t)e[t]=this[n+t];return e}setColumn(t,e){const n=t*this.RANK;for(let t=0;t<this.RANK;++t)this[n+t]=e[t];return this}}function Bs(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],o=e[4],a=e[5],c=e[6],l=e[7],u=e[8],h=e[9],d=e[10],f=e[11],g=e[12],p=e[13],m=e[14],v=e[15],y=n*a-i*o,b=n*c-r*o,_=n*l-s*o,x=i*c-r*a,P=i*l-s*a,w=r*l-s*c,A=u*p-h*g,S=u*m-d*g,T=u*v-f*g,E=h*m-d*p,C=h*v-f*p,L=d*v-f*m,M=y*L-b*C+_*E+x*T-P*S+w*A;return M?(M=1/M,t[0]=(a*L-c*C+l*E)*M,t[1]=(r*C-i*L-s*E)*M,t[2]=(p*w-m*P+v*x)*M,t[3]=(d*P-h*w-f*x)*M,t[4]=(c*T-o*L-l*S)*M,t[5]=(n*L-r*T+s*S)*M,t[6]=(m*_-g*w-v*b)*M,t[7]=(u*w-d*_+f*b)*M,t[8]=(o*C-a*T+l*A)*M,t[9]=(i*T-n*C-s*A)*M,t[10]=(g*P-p*_+v*y)*M,t[11]=(h*_-u*P-f*y)*M,t[12]=(a*S-o*E-c*A)*M,t[13]=(n*E-i*S+r*A)*M,t[14]=(p*b-g*x-m*y)*M,t[15]=(u*x-h*b+d*y)*M,t):null}function Ds(t,e,n){var i=e[0],r=e[1],s=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8],d=e[9],f=e[10],g=e[11],p=e[12],m=e[13],v=e[14],y=e[15],b=n[0],_=n[1],x=n[2],P=n[3];return t[0]=b*i+_*a+x*h+P*p,t[1]=b*r+_*c+x*d+P*m,t[2]=b*s+_*l+x*f+P*v,t[3]=b*o+_*u+x*g+P*y,b=n[4],_=n[5],x=n[6],P=n[7],t[4]=b*i+_*a+x*h+P*p,t[5]=b*r+_*c+x*d+P*m,t[6]=b*s+_*l+x*f+P*v,t[7]=b*o+_*u+x*g+P*y,b=n[8],_=n[9],x=n[10],P=n[11],t[8]=b*i+_*a+x*h+P*p,t[9]=b*r+_*c+x*d+P*m,t[10]=b*s+_*l+x*f+P*v,t[11]=b*o+_*u+x*g+P*y,b=n[12],_=n[13],x=n[14],P=n[15],t[12]=b*i+_*a+x*h+P*p,t[13]=b*r+_*c+x*d+P*m,t[14]=b*s+_*l+x*f+P*v,t[15]=b*o+_*u+x*g+P*y,t}function Ns(t,e,n){var i,r,s,o,a,c,l,u,h,d,f,g,p=n[0],m=n[1],v=n[2];return e===t?(t[12]=e[0]*p+e[4]*m+e[8]*v+e[12],t[13]=e[1]*p+e[5]*m+e[9]*v+e[13],t[14]=e[2]*p+e[6]*m+e[10]*v+e[14],t[15]=e[3]*p+e[7]*m+e[11]*v+e[15]):(i=e[0],r=e[1],s=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8],d=e[9],f=e[10],g=e[11],t[0]=i,t[1]=r,t[2]=s,t[3]=o,t[4]=a,t[5]=c,t[6]=l,t[7]=u,t[8]=h,t[9]=d,t[10]=f,t[11]=g,t[12]=i*p+a*m+h*v+e[12],t[13]=r*p+c*m+d*v+e[13],t[14]=s*p+l*m+f*v+e[14],t[15]=o*p+u*m+g*v+e[15]),t}function Us(t,e,n){var i=n[0],r=n[1],s=n[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Vs(t,e,n){var i=Math.sin(n),r=Math.cos(n),s=e[4],o=e[5],a=e[6],c=e[7],l=e[8],u=e[9],h=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*r+l*i,t[5]=o*r+u*i,t[6]=a*r+h*i,t[7]=c*r+d*i,t[8]=l*r-s*i,t[9]=u*r-o*i,t[10]=h*r-a*i,t[11]=d*r-c*i,t}function Gs(t,e,n){var i=Math.sin(n),r=Math.cos(n),s=e[0],o=e[1],a=e[2],c=e[3],l=e[4],u=e[5],h=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r+l*i,t[1]=o*r+u*i,t[2]=a*r+h*i,t[3]=c*r+d*i,t[4]=l*r-s*i,t[5]=u*r-o*i,t[6]=h*r-a*i,t[7]=d*r-c*i,t}var Ws=function(t,e,n,i,r){var s=1/Math.tan(e/2);if(t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0){var o=1/(i-r);t[10]=(r+i)*o,t[14]=2*r*i*o}else t[10]=-1,t[14]=-2*i;return t};var Hs,Xs=function(t,e,n,i,r,s,o){var a=1/(e-n),c=1/(i-r),l=1/(s-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*c,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*l,t[11]=0,t[12]=(e+n)*a,t[13]=(r+i)*c,t[14]=(o+s)*l,t[15]=1,t};function Zs(t,e,n){var i=e[0],r=e[1],s=e[2],o=e[3];return t[0]=n[0]*i+n[4]*r+n[8]*s+n[12]*o,t[1]=n[1]*i+n[5]*r+n[9]*s+n[13]*o,t[2]=n[2]*i+n[6]*r+n[10]*s+n[14]*o,t[3]=n[3]*i+n[7]*r+n[11]*s+n[15]*o,t}!function(){var t=function(){var t=new Cs(4);return Cs!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}()}(),function(t){t[t.COL0ROW0=0]="COL0ROW0",t[t.COL0ROW1=1]="COL0ROW1",t[t.COL0ROW2=2]="COL0ROW2",t[t.COL0ROW3=3]="COL0ROW3",t[t.COL1ROW0=4]="COL1ROW0",t[t.COL1ROW1=5]="COL1ROW1",t[t.COL1ROW2=6]="COL1ROW2",t[t.COL1ROW3=7]="COL1ROW3",t[t.COL2ROW0=8]="COL2ROW0",t[t.COL2ROW1=9]="COL2ROW1",t[t.COL2ROW2=10]="COL2ROW2",t[t.COL2ROW3=11]="COL2ROW3",t[t.COL3ROW0=12]="COL3ROW0",t[t.COL3ROW1=13]="COL3ROW1",t[t.COL3ROW2=14]="COL3ROW2",t[t.COL3ROW3=15]="COL3ROW3"}(Hs||(Hs={}));const Ys=45*Math.PI/180,Ks=1,qs=.1,Js=500,Qs=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class $s extends js{static get IDENTITY(){return function(){eo||(eo=new $s,Object.freeze(eo));return eo}()}static get ZERO(){return function(){to||(to=new $s([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(to));return to}()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return Hs}constructor(t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(t)?this.copy(t):this.identity()}copy(t){return this[0]=t[0],this[1]=t[1],this[2]=t[2],this[3]=t[3],this[4]=t[4],this[5]=t[5],this[6]=t[6],this[7]=t[7],this[8]=t[8],this[9]=t[9],this[10]=t[10],this[11]=t[11],this[12]=t[12],this[13]=t[13],this[14]=t[14],this[15]=t[15],this.check()}set(t,e,n,i,r,s,o,a,c,l,u,h,d,f,g,p){return this[0]=t,this[1]=e,this[2]=n,this[3]=i,this[4]=r,this[5]=s,this[6]=o,this[7]=a,this[8]=c,this[9]=l,this[10]=u,this[11]=h,this[12]=d,this[13]=f,this[14]=g,this[15]=p,this.check()}setRowMajor(t,e,n,i,r,s,o,a,c,l,u,h,d,f,g,p){return this[0]=t,this[1]=r,this[2]=c,this[3]=d,this[4]=e,this[5]=s,this[6]=l,this[7]=f,this[8]=n,this[9]=o,this[10]=u,this[11]=g,this[12]=i,this[13]=a,this[14]=h,this[15]=p,this.check()}toRowMajor(t){return t[0]=this[0],t[1]=this[4],t[2]=this[8],t[3]=this[12],t[4]=this[1],t[5]=this[5],t[6]=this[9],t[7]=this[13],t[8]=this[2],t[9]=this[6],t[10]=this[10],t[11]=this[14],t[12]=this[3],t[13]=this[7],t[14]=this[11],t[15]=this[15],t}identity(){return this.copy(Qs)}fromObject(t){return this.check()}fromQuaternion(t){return function(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],o=n+n,a=i+i,c=r+r,l=n*o,u=i*o,h=i*a,d=r*o,f=r*a,g=r*c,p=s*o,m=s*a,v=s*c;t[0]=1-h-g,t[1]=u+v,t[2]=d-m,t[3]=0,t[4]=u-v,t[5]=1-l-g,t[6]=f+p,t[7]=0,t[8]=d+m,t[9]=f-p,t[10]=1-l-h,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(this,t),this.check()}frustum(t){const{left:e,right:n,bottom:i,top:r,near:s=qs,far:o=Js}=t;return o===1/0?function(t,e,n,i,r,s){const o=2*s/(n-e),a=2*s/(r-i),c=(n+e)/(n-e),l=(r+i)/(r-i),u=-1,h=-1,d=-2*s;t[0]=o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=c,t[9]=l,t[10]=u,t[11]=h,t[12]=0,t[13]=0,t[14]=d,t[15]=0}(this,e,n,i,r,s):function(t,e,n,i,r,s,o){var a=1/(n-e),c=1/(r-i),l=1/(s-o);t[0]=2*s*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*c,t[6]=0,t[7]=0,t[8]=(n+e)*a,t[9]=(r+i)*c,t[10]=(o+s)*l,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*s*2*l,t[15]=0}(this,e,n,i,r,s,o),this.check()}lookAt(t){const{eye:e,center:n=[0,0,0],up:i=[0,1,0]}=t;return function(t,e,n,i){var r,s,o,a,c,l,u,h,d,f,g=e[0],p=e[1],m=e[2],v=i[0],y=i[1],b=i[2],_=n[0],x=n[1],P=n[2];Math.abs(g-_)<Es&&Math.abs(p-x)<Es&&Math.abs(m-P)<Es?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(t):(u=g-_,h=p-x,d=m-P,r=y*(d*=f=1/Math.sqrt(u*u+h*h+d*d))-b*(h*=f),s=b*(u*=f)-v*d,o=v*h-y*u,(f=Math.sqrt(r*r+s*s+o*o))?(r*=f=1/f,s*=f,o*=f):(r=0,s=0,o=0),a=h*o-d*s,c=d*r-u*o,l=u*s-h*r,(f=Math.sqrt(a*a+c*c+l*l))?(a*=f=1/f,c*=f,l*=f):(a=0,c=0,l=0),t[0]=r,t[1]=a,t[2]=u,t[3]=0,t[4]=s,t[5]=c,t[6]=h,t[7]=0,t[8]=o,t[9]=l,t[10]=d,t[11]=0,t[12]=-(r*g+s*p+o*m),t[13]=-(a*g+c*p+l*m),t[14]=-(u*g+h*p+d*m),t[15]=1)}(this,e,n,i),this.check()}ortho(t){const{left:e,right:n,bottom:i,top:r,near:s=qs,far:o=Js}=t;return Xs(this,e,n,i,r,s,o),this.check()}orthographic(t){const{fovy:e=Ys,aspect:n=Ks,focalDistance:i=1,near:r=qs,far:s=Js}=t;no(e);const o=e/2,a=i*Math.tan(o),c=a*n;return this.ortho({left:-c,right:c,bottom:-a,top:a,near:r,far:s})}perspective(t){const{fovy:e=45*Math.PI/180,aspect:n=1,near:i=.1,far:r=500}=t;return no(e),Ws(this,e,n,i,r),this.check()}determinant(){return e=(t=this)[0],n=t[1],i=t[2],r=t[3],s=t[4],o=t[5],a=t[6],c=t[7],l=t[8],u=t[9],h=t[10],d=t[11],f=t[12],g=t[13],p=t[14],m=e*o-n*s,v=e*a-i*s,y=n*a-i*o,c*(e*(x=u*p-h*g)-n*(_=l*p-h*f)+i*(b=l*g-u*f))-r*(s*x-o*_+a*b)+t[15]*(l*y-u*v+h*m)-d*(f*y-g*v+p*m);var t,e,n,i,r,s,o,a,c,l,u,h,d,f,g,p,m,v,y,b,_,x}getScale(t=[-0,-0,-0]){return t[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),t[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),t[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),t}getTranslation(t=[-0,-0,-0]){return t[0]=this[12],t[1]=this[13],t[2]=this[14],t}getRotation(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];const n=this.getScale(e),i=1/n[0],r=1/n[1],s=1/n[2];return t[0]=this[0]*i,t[1]=this[1]*r,t[2]=this[2]*s,t[3]=0,t[4]=this[4]*i,t[5]=this[5]*r,t[6]=this[6]*s,t[7]=0,t[8]=this[8]*i,t[9]=this[9]*r,t[10]=this[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}getRotationMatrix3(t,e){t=t||[-0,-0,-0,-0,-0,-0,-0,-0,-0],e=e||[-0,-0,-0];const n=this.getScale(e),i=1/n[0],r=1/n[1],s=1/n[2];return t[0]=this[0]*i,t[1]=this[1]*r,t[2]=this[2]*s,t[3]=this[4]*i,t[4]=this[5]*r,t[5]=this[6]*s,t[6]=this[8]*i,t[7]=this[9]*r,t[8]=this[10]*s,t}transpose(){return function(t,e){if(t===e){var n=e[1],i=e[2],r=e[3],s=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=s,t[11]=e[14],t[12]=r,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]}(this,this),this.check()}invert(){return Bs(this,this),this.check()}multiplyLeft(t){return Ds(this,t,this),this.check()}multiplyRight(t){return Ds(this,this,t),this.check()}rotateX(t){return Vs(this,this,t),this.check()}rotateY(t){return function(t,e,n){var i=Math.sin(n),r=Math.cos(n),s=e[0],o=e[1],a=e[2],c=e[3],l=e[8],u=e[9],h=e[10],d=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r-l*i,t[1]=o*r-u*i,t[2]=a*r-h*i,t[3]=c*r-d*i,t[8]=s*i+l*r,t[9]=o*i+u*r,t[10]=a*i+h*r,t[11]=c*i+d*r}(this,this,t),this.check()}rotateZ(t){return Gs(this,this,t),this.check()}rotateXYZ(t){return this.rotateX(t[0]).rotateY(t[1]).rotateZ(t[2])}rotateAxis(t,e){return function(t,e,n,i){var r,s,o,a,c,l,u,h,d,f,g,p,m,v,y,b,_,x,P,w,A,S,T,E,C=i[0],L=i[1],M=i[2],O=Math.sqrt(C*C+L*L+M*M);O<Es||(C*=O=1/O,L*=O,M*=O,r=Math.sin(n),o=1-(s=Math.cos(n)),a=e[0],c=e[1],l=e[2],u=e[3],h=e[4],d=e[5],f=e[6],g=e[7],p=e[8],m=e[9],v=e[10],y=e[11],b=C*C*o+s,_=L*C*o+M*r,x=M*C*o-L*r,P=C*L*o-M*r,w=L*L*o+s,A=M*L*o+C*r,S=C*M*o+L*r,T=L*M*o-C*r,E=M*M*o+s,t[0]=a*b+h*_+p*x,t[1]=c*b+d*_+m*x,t[2]=l*b+f*_+v*x,t[3]=u*b+g*_+y*x,t[4]=a*P+h*w+p*A,t[5]=c*P+d*w+m*A,t[6]=l*P+f*w+v*A,t[7]=u*P+g*w+y*A,t[8]=a*S+h*T+p*E,t[9]=c*S+d*T+m*E,t[10]=l*S+f*T+v*E,t[11]=u*S+g*T+y*E,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(this,this,t,e),this.check()}scale(t){return Us(this,this,Array.isArray(t)?t:[t,t,t]),this.check()}translate(t){return Ns(this,this,t),this.check()}transform(t,e){return 4===t.length?(As(e=Zs(e||[-0,-0,-0,-0],t,this),4),e):this.transformAsPoint(t,e)}transformAsPoint(t,e){const{length:n}=t;let i;switch(n){case 2:i=function(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[4]*r+n[12],t[1]=n[1]*i+n[5]*r+n[13],t}(e||[-0,-0],t,this);break;case 3:i=Is(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return As(i,t.length),i}transformAsVector(t,e){let n;switch(t.length){case 2:n=function(t,e,n){const i=e[0],r=e[1],s=n[3]*i+n[7]*r||1;return t[0]=(n[0]*i+n[4]*r)/s,t[1]=(n[1]*i+n[5]*r)/s,t}(e||[-0,-0],t,this);break;case 3:n=Os(e||[-0,-0,-0],t,this);break;default:throw new Error("Illegal vector")}return As(n,t.length),n}transformPoint(t,e){return this.transformAsPoint(t,e)}transformVector(t,e){return this.transformAsPoint(t,e)}transformDirection(t,e){return this.transformAsVector(t,e)}makeRotationX(t){return this.identity().rotateX(t)}makeTranslation(t,e,n){return this.identity().translate([t,e,n])}}let to,eo;function no(t){if(t>2*Math.PI)throw Error("expected radians")}var io="#if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))\n\nstruct AmbientLight {\n vec3 color;\n};\n\nstruct PointLight {\n vec3 color;\n vec3 position;\n vec3 attenuation;\n};\n\nstruct DirectionalLight {\n  vec3 color;\n  vec3 direction;\n};\n\nuniform AmbientLight lighting_uAmbientLight;\nuniform PointLight lighting_uPointLight[MAX_LIGHTS];\nuniform DirectionalLight lighting_uDirectionalLight[MAX_LIGHTS];\nuniform int lighting_uPointLightCount;\nuniform int lighting_uDirectionalLightCount;\n\nuniform bool lighting_uEnabled;\n\nfloat getPointLightAttenuation(PointLight pointLight, float distance) {\n  return pointLight.attenuation.x\n       + pointLight.attenuation.y * distance\n       + pointLight.attenuation.z * distance * distance;\n}\n\n#endif\n";const ro={lightSources:{}};function so(){let{color:t=[0,0,0],intensity:e=1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.map(t=>t*e/255)}const oo={name:"lights",vs:io,fs:io,getUniforms:function t(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ro;if("lightSources"in e){const{ambientLight:t,pointLights:n,directionalLights:i}=e.lightSources||{};return t||n&&n.length>0||i&&i.length>0?Object.assign({},function(t){let{ambientLight:e,pointLights:n=[],directionalLights:i=[]}=t;const r={};return r["lighting_uAmbientLight.color"]=e?so(e):[0,0,0],n.forEach((t,e)=>{r["lighting_uPointLight[".concat(e,"].color")]=so(t),r["lighting_uPointLight[".concat(e,"].position")]=t.position,r["lighting_uPointLight[".concat(e,"].attenuation")]=t.attenuation||[1,0,0]}),r.lighting_uPointLightCount=n.length,i.forEach((t,e)=>{r["lighting_uDirectionalLight[".concat(e,"].color")]=so(t),r["lighting_uDirectionalLight[".concat(e,"].direction")]=t.direction}),r.lighting_uDirectionalLightCount=i.length,r}({ambientLight:t,pointLights:n,directionalLights:i}),{lighting_uEnabled:!0}):{lighting_uEnabled:!1}}if("lights"in e){const n={pointLights:[],directionalLights:[]};for(const t of e.lights||[])switch(t.type){case"ambient":n.ambientLight=t;break;case"directional":n.directionalLights.push(t);break;case"point":n.pointLights.push(t)}return t({lightSources:n})}return{}},defines:{MAX_LIGHTS:3}},ao={pickingSelectedColor:null,pickingHighlightColor:new Uint8Array([0,255,255,255]),pickingActive:!1,pickingAttribute:!1};const co={name:"picking",vs:"uniform bool picking_uActive;\nuniform bool picking_uAttribute;\nuniform vec3 picking_uSelectedColor;\nuniform bool picking_uSelectedColorValid;\n\nout vec4 picking_vRGBcolor_Avalid;\n\nconst float COLOR_SCALE = 1. / 255.;\n\nbool picking_isColorValid(vec3 color) {\n  return dot(color, vec3(1.0)) > 0.001;\n}\n\nbool isVertexPicked(vec3 vertexColor) {\n  return\n    picking_uSelectedColorValid &&\n    !picking_isColorValid(abs(vertexColor - picking_uSelectedColor));\n}\n\nvoid picking_setPickingColor(vec3 pickingColor) {\n  if (picking_uActive) {\n    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));\n\n    if (!picking_uAttribute) {\n      picking_vRGBcolor_Avalid.rgb = pickingColor * COLOR_SCALE;\n    }\n  } else {\n    picking_vRGBcolor_Avalid.a = float(isVertexPicked(pickingColor));\n  }\n}\n\nvoid picking_setPickingAttribute(float value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.r = value;\n  }\n}\nvoid picking_setPickingAttribute(vec2 value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.rg = value;\n  }\n}\nvoid picking_setPickingAttribute(vec3 value) {\n  if (picking_uAttribute) {\n    picking_vRGBcolor_Avalid.rgb = value;\n  }\n}\n",fs:"uniform bool picking_uActive;\nuniform vec3 picking_uSelectedColor;\nuniform vec4 picking_uHighlightColor;\n\nin vec4 picking_vRGBcolor_Avalid;\nvec4 picking_filterHighlightColor(vec4 color) {\n  if (picking_uActive) {\n    return color;\n  }\n  bool selected = bool(picking_vRGBcolor_Avalid.a);\n\n  if (selected) {\n    float highLightAlpha = picking_uHighlightColor.a;\n    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);\n    float highLightRatio = highLightAlpha / blendedAlpha;\n\n    vec3 blendedRGB = mix(color.rgb, picking_uHighlightColor.rgb, highLightRatio);\n    return vec4(blendedRGB, blendedAlpha);\n  } else {\n    return color;\n  }\n}\nvec4 picking_filterPickingColor(vec4 color) {\n  if (picking_uActive) {\n    if (picking_vRGBcolor_Avalid.a == 0.0) {\n      discard;\n    }\n    return picking_vRGBcolor_Avalid;\n  }\n  return color;\n}\nvec4 picking_filterColor(vec4 color) {\n  vec4 highightColor = picking_filterHighlightColor(color);\n  return picking_filterPickingColor(highightColor);\n}\n\n",getUniforms:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ao;const e={};if(void 0!==t.pickingSelectedColor)if(t.pickingSelectedColor){const n=t.pickingSelectedColor.slice(0,3);e.picking_uSelectedColorValid=1,e.picking_uSelectedColor=n}else e.picking_uSelectedColorValid=0;if(t.pickingHighlightColor){const n=Array.from(t.pickingHighlightColor,t=>t/255);Number.isFinite(n[3])||(n[3]=1),e.picking_uHighlightColor=n}return void 0!==t.pickingActive&&(e.picking_uActive=Boolean(t.pickingActive),e.picking_uAttribute=Boolean(t.pickingAttribute)),e}};var lo="\nuniform float lighting_uAmbient;\nuniform float lighting_uDiffuse;\nuniform float lighting_uShininess;\nuniform vec3  lighting_uSpecularColor;\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {\n    vec3 halfway_direction = normalize(light_direction + view_direction);\n    float lambertian = dot(light_direction, normal_worldspace);\n    float specular = 0.0;\n    if (lambertian > 0.0) {\n      float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);\n      specular = pow(specular_angle, lighting_uShininess);\n    }\n    lambertian = max(lambertian, 0.0);\n    return (lambertian * lighting_uDiffuse * surfaceColor + specular * lighting_uSpecularColor) * color;\n}\n\nvec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {\n  vec3 lightColor = surfaceColor;\n\n  if (lighting_uEnabled) {\n    vec3 view_direction = normalize(cameraPosition - position_worldspace);\n    lightColor = lighting_uAmbient * surfaceColor * lighting_uAmbientLight.color;\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uPointLightCount) {\n        break;\n      }\n      PointLight pointLight = lighting_uPointLight[i];\n      vec3 light_position_worldspace = pointLight.position;\n      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n    }\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uDirectionalLightCount) {\n        break;\n      }\n      DirectionalLight directionalLight = lighting_uDirectionalLight[i];\n      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n    }\n  }\n  return lightColor;\n}\n\nvec3 lighting_getSpecularLightColor(vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {\n  vec3 lightColor = vec3(0, 0, 0);\n  vec3 surfaceColor = vec3(0, 0, 0);\n\n  if (lighting_uEnabled) {\n    vec3 view_direction = normalize(cameraPosition - position_worldspace);\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uPointLightCount) {\n        break;\n      }\n      PointLight pointLight = lighting_uPointLight[i];\n      vec3 light_position_worldspace = pointLight.position;\n      vec3 light_direction = normalize(light_position_worldspace - position_worldspace);\n      lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);\n    }\n\n    for (int i = 0; i < MAX_LIGHTS; i++) {\n      if (i >= lighting_uDirectionalLightCount) {\n        break;\n      }\n      DirectionalLight directionalLight = lighting_uDirectionalLight[i];\n      lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);\n    }\n  }\n  return lightColor;\n}\n";const uo={};function ho(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:uo;if(!("material"in t))return{};const{material:e}=t;return e?function(t){const{ambient:e=.35,diffuse:n=.6,shininess:i=32,specularColor:r=[30,30,30]}=t;return{lighting_uAmbient:e,lighting_uDiffuse:n,lighting_uShininess:i,lighting_uSpecularColor:r.map(t=>t/255)}}(e):{lighting_uEnabled:!1}}const fo={name:"gouraud-lighting",dependencies:[oo],vs:lo,defines:{LIGHTING_VERTEX:1},getUniforms:ho},go={name:"phong-lighting",dependencies:[oo],fs:lo,defines:{LIGHTING_FRAGMENT:1},getUniforms:ho},po={name:"transform",vs:"attribute float transform_elementID;\nvec2 transform_getPixelSizeHalf(vec2 size) {\n  return vec2(1.) / (2. * size);\n}\n\nvec2 transform_getPixelIndices(vec2 texSize, vec2 pixelSizeHalf) {\n  float yIndex = floor((transform_elementID / texSize[0]) + pixelSizeHalf[1]);\n  float xIndex = transform_elementID - (yIndex * texSize[0]);\n  return vec2(xIndex, yIndex);\n}\nvec2 transform_getTexCoord(vec2 size) {\n  vec2 pixelSizeHalf = transform_getPixelSizeHalf(size);\n  vec2 indices = transform_getPixelIndices(size, pixelSizeHalf);\n  vec2 coord = indices / size + pixelSizeHalf;\n  return coord;\n}\nvec2 transform_getPos(vec2 size) {\n  vec2 texCoord = transform_getTexCoord(size);\n  vec2 pos = (texCoord * (2.0, 2.0)) - (1., 1.);\n  return pos;\n}\nvec4 transform_getInput(sampler2D texSampler, vec2 size) {\n  vec2 texCoord = transform_getTexCoord(size);\n  vec4 textureColor = texture2D(texSampler, texCoord);\n  return textureColor;\n}\n",fs:null};class mo{static getDefaultProgramManager(t){return t.luma=t.luma||{},t.luma.defaultProgramManager=t.luma.defaultProgramManager||new mo(t),t.luma.defaultProgramManager}constructor(t){this.gl=t,this._programCache={},this._getUniforms={},this._registeredModules={},this._hookFunctions=[],this._defaultModules=[],this._hashes={},this._hashCounter=0,this.stateHash=0,this._useCounts={}}addDefaultModule(t){this._defaultModules.find(e=>e.name===t.name)||this._defaultModules.push(t),this.stateHash++}removeDefaultModule(t){const e="string"==typeof t?t:t.name;this._defaultModules=this._defaultModules.filter(t=>t.name!==e),this.stateHash++}addShaderHook(t,e){e&&(t=Object.assign(e,{hook:t})),this._hookFunctions.push(t),this.stateHash++}get(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{vs:e="",fs:n="",defines:i={},inject:r={},varyings:s=[],bufferMode:o=35981,transpileToGLSL100:a=!1}=t,c=this._getModuleList(t.modules),l=this._getHash(e),u=this._getHash(n),h=c.map(t=>this._getHash(t.name)).sort(),d=s.map(t=>this._getHash(t)),f=Object.keys(i).sort(),g=Object.keys(r).sort(),p=[],m=[];for(const t of f)p.push(this._getHash(t)),p.push(this._getHash(i[t]));for(const t of g)m.push(this._getHash(t)),m.push(this._getHash(r[t]));const v="".concat(l,"/").concat(u,"D").concat(p.join("/"),"M").concat(h.join("/"),"I").concat(m.join("/"),"V").concat(d.join("/"),"H").concat(this.stateHash,"B").concat(o).concat(a?"T":"");if(!this._programCache[v]){const t=function(t,e){const{vs:n,fs:i}=e,r=Ir(e.modules||[]);return{gl:t,vs:cs(t,Object.assign({},e,{source:n,type:Sr,modules:r})),fs:cs(t,Object.assign({},e,{source:i,type:Tr,modules:r})),getUniforms:ls(r)}}(this.gl,{vs:e,fs:n,modules:c,inject:r,defines:i,hookFunctions:this._hookFunctions,transpileToGLSL100:a});this._programCache[v]=new hr(this.gl,{hash:v,vs:t.vs,fs:t.fs,varyings:s,bufferMode:o}),this._getUniforms[v]=t.getUniforms||(t=>{}),this._useCounts[v]=0}return this._useCounts[v]++,this._programCache[v]}getUniforms(t){return this._getUniforms[t.hash]||null}release(t){const e=t.hash;this._useCounts[e]--,0===this._useCounts[e]&&(this._programCache[e].delete(),delete this._programCache[e],delete this._getUniforms[e],delete this._useCounts[e])}_getHash(t){return void 0===this._hashes[t]&&(this._hashes[t]=this._hashCounter++),this._hashes[t]}_getModuleList(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const e=new Array(this._defaultModules.length+t.length),n={};let i=0;for(let t=0,r=this._defaultModules.length;t<r;++t){const r=this._defaultModules[t],s=r.name;e[i++]=r,n[s]=!0}for(let r=0,s=t.length;r<s;++r){const s=t[r],o=s.name;n[o]||(e[i++]=s,n[o]=!0)}return e.length=i,e}}const vo={POSITION:"positions",NORMAL:"normals",COLOR_0:"colors",TEXCOORD_0:"texCoords",TEXCOORD_1:"texCoords1",TEXCOORD_2:"texCoords2"};function yo(t,e){const{attributeMap:n=vo}={};return n&&n[t]||t}function bo(t,e){let n;switch(t){case"texCoords":case"texCoord1":case"texCoord2":case"texCoord3":n="uvs";break;case"vertices":case"positions":case"normals":case"pickingColors":n="vectors"}switch(n){case"vectors":e.size=e.size||3;break;case"uvs":e.size=e.size||2}Ze(Number.isFinite(e.size),"attribute ".concat(t," needs size"))}const _o=()=>{},xo={};class Po{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{id:n=Je("model")}=e;Ze(te(t)),this.id=n,this.gl=t,this.id=e.id||Je("Model"),this.lastLogTime=0,this.animated=!1,this.initialize(e)}initialize(t){this.props={},this.programManager=t.programManager||mo.getDefaultProgramManager(this.gl),this._programManagerState=-1,this._managedProgram=!1;const{program:e=null,vs:n,fs:i,modules:r,defines:s,inject:o,varyings:a,bufferMode:c,transpileToGLSL100:l}=t;this.programProps={program:e,vs:n,fs:i,modules:r,defines:s,inject:o,varyings:a,bufferMode:c,transpileToGLSL100:l},this.program=null,this.vertexArray=null,this._programDirty=!0,this.userData={},this.needsRedraw=!0,this._attributes={},this.attributes={},this.uniforms={},this.pickable=!0,this._checkProgram(),this.setUniforms(Object.assign({},this.getModuleUniforms(t.moduleSettings))),this.drawMode=void 0!==t.drawMode?t.drawMode:4,this.vertexCount=t.vertexCount||0,this.geometryBuffers={},this.isInstanced=t.isInstanced||t.instanced||t.instanceCount>0,this._setModelProps(t),this.geometry={},Ze(void 0!==this.drawMode&&Number.isFinite(this.vertexCount),"Model needs drawMode and vertexCount")}setProps(t){this._setModelProps(t)}delete(){for(const t in this._attributes)this._attributes[t]!==this.attributes[t]&&this._attributes[t].delete();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1),this.vertexArray.delete(),this._deleteGeometryBuffers()}getDrawMode(){return this.drawMode}getVertexCount(){return this.vertexCount}getInstanceCount(){return this.instanceCount}getAttributes(){return this.attributes}getProgram(){return this.program}setProgram(t){const{program:e,vs:n,fs:i,modules:r,defines:s,inject:o,varyings:a,bufferMode:c,transpileToGLSL100:l}=t;this.programProps={program:e,vs:n,fs:i,modules:r,defines:s,inject:o,varyings:a,bufferMode:c,transpileToGLSL100:l},this._programDirty=!0}getUniforms(){return this.uniforms}setDrawMode(t){return this.drawMode=t,this}setVertexCount(t){return Ze(Number.isFinite(t)),this.vertexCount=t,this}setInstanceCount(t){return Ze(Number.isFinite(t)),this.instanceCount=t,this}setGeometry(t){return this.drawMode=t.drawMode,this.vertexCount=t.getVertexCount(),this._deleteGeometryBuffers(),this.geometryBuffers=function(t,e){const n={};let i=e.indices;for(const r in e.attributes){const s=e.attributes[r],o=yo(r);if("indices"===r)i=s;else if(s.constant)n[o]=s.value;else{const e=s.value,i={...s};delete i.value,n[o]=[new gn(t,e),i],bo(r,i)}}if(i){const e=i.value||i;Ze(e instanceof Uint16Array||e instanceof Uint32Array,'attribute array for "indices" must be of integer type');const r={size:1,isIndexed:void 0===i.isIndexed||i.isIndexed};n.indices=[new gn(t,{data:e,target:34963}),r]}return n}(this.gl,t),this.vertexArray.setAttributes(this.geometryBuffers),this}setAttributes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if($e(t))return this;const e={};for(const n in t){const i=t[n];e[n]=i.getValue?i.getValue():i}return this.vertexArray.setAttributes(e),this}setUniforms(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign(this.uniforms,t),this}getModuleUniforms(t){this._checkProgram();const e=this.programManager.getUniforms(this.program);return e?e(t):{}}updateModuleSettings(t){const e=this.getModuleUniforms(t||{});return this.setUniforms(e)}clear(t){return Mn(this.program.gl,t),this}draw(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._checkProgram();const{moduleSettings:e=null,framebuffer:n,uniforms:i={},attributes:r={},transformFeedback:s=this.transformFeedback,parameters:o={},vertexArray:a=this.vertexArray}=t;let c;this.setAttributes(r),this.updateModuleSettings(e),this.setUniforms(i),Qt.priority>=2&&(c=this._logDrawCallStart(2));const l=this.vertexArray.getDrawParams(),{isIndexed:u=l.isIndexed,indexType:h=l.indexType,indexOffset:d=l.indexOffset,vertexArrayInstanced:f=l.isInstanced}=this.props;f&&!this.isInstanced&&Qt.warn("Found instanced attributes on non-instanced model",this.id)();const{isInstanced:g,instanceCount:p}=this,{onBeforeRender:m=_o,onAfterRender:v=_o}=this.props;m(),this.program.setUniforms(this.uniforms);const y=this.program.draw(Object.assign(xo,t,{logPriority:c,uniforms:null,framebuffer:n,parameters:o,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:a,transformFeedback:s,isIndexed:u,indexType:h,isInstanced:g,instanceCount:p,offset:u?d:0}));return v(),Qt.priority>=2&&this._logDrawCallEnd(c,a,n),y}transform(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{discard:e=!0,feedbackBuffers:n,unbindModels:i=[]}=t;let{parameters:r}=t;n&&this._setFeedbackBuffers(n),e&&(r=Object.assign({},r,{35977:e})),i.forEach(t=>t.vertexArray.unbindBuffers());try{this.draw(Object.assign({},t,{parameters:r}))}finally{i.forEach(t=>t.vertexArray.bindBuffers())}return this}render(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Qt.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")(),this.setUniforms(t).draw()}_setModelProps(t){Object.assign(this.props,t),"uniforms"in t&&this.setUniforms(t.uniforms),"pickable"in t&&(this.pickable=t.pickable),"instanceCount"in t&&(this.instanceCount=t.instanceCount),"geometry"in t&&this.setGeometry(t.geometry),"attributes"in t&&this.setAttributes(t.attributes),"_feedbackBuffers"in t&&this._setFeedbackBuffers(t._feedbackBuffers)}_checkProgram(){if(!(this._programDirty||this.programManager.stateHash!==this._programManagerState))return;let{program:t}=this.programProps;if(t)this._managedProgram=!1;else{const{vs:e,fs:n,modules:i,inject:r,defines:s,varyings:o,bufferMode:a,transpileToGLSL100:c}=this.programProps;t=this.programManager.get({vs:e,fs:n,modules:i,inject:r,defines:s,varyings:o,bufferMode:a,transpileToGLSL100:c}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0}Ze(t instanceof hr,"Model needs a program"),this._programDirty=!1,t!==this.program&&(this.program=t,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=new yr(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}_deleteGeometryBuffers(){for(const t in this.geometryBuffers){const e=this.geometryBuffers[t][0]||this.geometryBuffers[t];e instanceof gn&&e.delete()}}_setAnimationProps(t){this.animated&&Ze(t,"Model.draw(): animated uniforms but no animationProps")}_setFeedbackBuffers(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if($e(t))return this;const{gl:e}=this.program;return this.transformFeedback=this.transformFeedback||new dr(e,{program:this.program}),this.transformFeedback.setBuffers(t),this}_logDrawCallStart(t){const e=t>3?0:1e4;if(!(Date.now()-this.lastLogTime<e))return this.lastLogTime=Date.now(),Qt.group(2,">>> DRAWING MODEL ".concat(this.id),{collapsed:Qt.level<=2})(),t}_logDrawCallEnd(t,e,n,i){if(void 0===t)return;const r=function(t){let{vertexArray:e,header:n="Attributes"}=t;if(!e.configuration)return{};const i={};e.elements&&(i.ELEMENT_ARRAY_BUFFER=Pr(e,e.elements,null,n));const r=e.values;for(const t in r){const s=e._getAttributeInfo(t);if(s){let o="".concat(t,": ").concat(s.name);const a=e.accessors[s.location];a&&(o="".concat(t,": ").concat(wr(s.name,a))),i[o]=Pr(e,r[t],a,n)}}return i}({vertexArray:e,header:"".concat(this.id," attributes"),attributes:this._attributes}),{table:s,unusedTable:o,unusedCount:a}=_r({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,n)}),{table:c,count:l}=_r({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,n),undefinedOnly:!0});l>0&&Qt.log("MISSING UNIFORMS",Object.keys(c))(),a>0&&Qt.log("UNUSED UNIFORMS",Object.keys(o))();const u=function(t){const e={},n="Accessors for ".concat(t.id);for(const i of t.attributeInfos)if(i){const t=Ar(i);e["in ".concat(t)]={[n]:JSON.stringify(i.accessor)}}for(const i of t.varyingInfos)if(i){const t=Ar(i);e["out ".concat(t)]={[n]:JSON.stringify(i.accessor)}}return e}(this.vertexArray.configuration);Qt.table(t,r)(),Qt.table(t,s)(),Qt.table(t+1,u)(),i&&i.log({logLevel:2,message:"Rendered to ".concat(i.id)}),Qt.groupEnd(2)()}}class wo{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.currentIndex=0,this.feedbackMap={},this.varyings=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}setupResources(t){for(const e of this.bindings)this._setupTransformFeedback(e,t)}updateModelProps(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{varyings:e}=this;return e.length>0&&(t=Object.assign({},t,{varyings:e})),t}getDrawOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this.bindings[this.currentIndex],{sourceBuffers:n,transformFeedback:i}=e;return{attributes:Object.assign({},n,t.attributes),transformFeedback:i}}swap(){return!!this.feedbackMap&&(this.currentIndex=this._getNextIndex(),!0)}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setupBuffers(t)}getBuffer(t){const{feedbackBuffers:e}=this.bindings[this.currentIndex],n=t?e[t]:null;return n?n instanceof gn?n:n.buffer:null}getData(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{varyingName:e}=t,n=this.getBuffer(e);return n?n.getData():null}delete(){for(const t in this.resources)this.resources[t].delete()}_initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setupBuffers(t),this.varyings=t.varyings||Object.keys(this.bindings[this.currentIndex].feedbackBuffers),this.varyings.length>0&&Ze(ee(this.gl))}_getFeedbackBuffers(t){const{sourceBuffers:e={}}=t,n={};if(this.bindings[this.currentIndex]&&Object.assign(n,this.bindings[this.currentIndex].feedbackBuffers),this.feedbackMap)for(const t in this.feedbackMap){const i=this.feedbackMap[t];t in e&&(n[i]=t)}Object.assign(n,t.feedbackBuffers);for(const t in n){const i=n[t];if("string"==typeof i){const r=e[i],{byteLength:s,usage:o,accessor:a}=r;n[t]=this._createNewBuffer(t,{byteLength:s,usage:o,accessor:a})}}return n}_setupBuffers(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:e=null}=t;Object.assign(this.feedbackMap,t.feedbackMap);const n=this._getFeedbackBuffers(t);this._updateBindings({sourceBuffers:e,feedbackBuffers:n})}_setupTransformFeedback(t,e){let{model:n}=e;const{program:i}=n;t.transformFeedback=new dr(this.gl,{program:i,buffers:t.feedbackBuffers})}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this.feedbackMap){const{sourceBuffers:t,feedbackBuffers:e}=this._swapBuffers(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceBuffers:t,feedbackBuffers:e})}}_updateBinding(t,e){return t?(Object.assign(t.sourceBuffers,e.sourceBuffers),Object.assign(t.feedbackBuffers,e.feedbackBuffers),t.transformFeedback&&t.transformFeedback.setBuffers(t.feedbackBuffers),t):{sourceBuffers:Object.assign({},e.sourceBuffers),feedbackBuffers:Object.assign({},e.feedbackBuffers)}}_swapBuffers(t){if(!this.feedbackMap)return null;const e=Object.assign({},t.sourceBuffers),n=Object.assign({},t.feedbackBuffers);for(const i in this.feedbackMap){const r=this.feedbackMap[i];e[i]=t.feedbackBuffers[r],n[r]=t.sourceBuffers[i],Ze(n[r]instanceof gn)}return{sourceBuffers:e,feedbackBuffers:n}}_createNewBuffer(t,e){const n=new gn(this.gl,e);return this.resources[t]&&this.resources[t].delete(),this.resources[t]=n,n}_getNextIndex(){return(this.currentIndex+1)%2}}const Ao="transform_uSampler_",So="transform_uSize_",To="transform_position";function Eo(t){let{vs:e,sourceTextureMap:n,targetTextureVarying:i,targetTexture:r}=t;let s=Object.keys(n).length,o=null;const a={};let c=e,l={};if(s>0||i){const t=c.split("\n"),e=t.slice();if(t.forEach((t,r,c)=>{if(s>0){const i=function(t,e){const n={},i=function(t){return ds(t,["attribute","in"])}(t);if(!i)return null;const{type:r,name:s}=i;if(s&&e[s]){const e="// ".concat(t," => Replaced by Transform with a sampler"),{samplerName:i,sizeName:o,uniformDeclerations:a}=function(t){const e="".concat(Ao).concat(t),n="".concat(So).concat(t),i="  uniform sampler2D ".concat(e,";\n  uniform vec2 ").concat(n,";");return{samplerName:e,sizeName:n,uniformDeclerations:i}}(s),c=function(t){switch(t){case"float":return"x";case"vec2":return"xy";case"vec3":return"xyz";case"vec4":return"xyzw";default:return Er(!1),null}}(r),l="  ".concat(r," ").concat(s," = transform_getInput(").concat(i,", ").concat(o,").").concat(c,";\n");n[i]=s;return{updatedLine:e,inject:{"vs:#decl":a,"vs:#main-start":l},samplerTextureMap:n}}return null}(t,n);if(i){const{updatedLine:t,inject:n}=i;e[r]=t,l=Zr([l,n]),Object.assign(a,i.samplerTextureMap),s--}}i&&!o&&(o=function(t,e){const n=ds(t,["varying","out"]);if(!n)return null;return n.name===e?n.type:null}(t,i))}),i){Ze(r);const t="".concat(So).concat(i),e="uniform vec2 ".concat(t,";\n"),n="     vec2 ".concat(To," = transform_getPos(").concat(t,");\n     gl_Position = vec4(").concat(To,", 0, 1.);\n");l=Zr([l,{"vs:#decl":e,"vs:#main-start":n}])}c=e.join("\n")}return{vs:c,targetTextureType:o,inject:l,samplerTextureMap:a}}const Co={10241:9728,10240:9728,10242:33071,10243:33071};class Lo{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.id=this.currentIndex=0,this._swapTexture=null,this.targetTextureVarying=null,this.targetTextureType=null,this.samplerTextureMap=null,this.bindings=[],this.resources={},this._initialize(e),Object.seal(this)}updateModelProps(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=this._processVertexShader(t);return Object.assign({},t,e)}getDrawOptions(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:e,sourceTextures:n,framebuffer:i,targetTexture:r}=this.bindings[this.currentIndex],s=Object.assign({},e,t.attributes),o=Object.assign({},t.uniforms),a=Object.assign({},t.parameters);let c=t.discard;if(this.hasSourceTextures||this.hasTargetTexture){s.transform_elementID=this.elementIDBuffer;for(const t in this.samplerTextureMap){const e=this.samplerTextureMap[t];o[t]=n[e]}this._setSourceTextureParameters();const t=function(t){let{sourceTextureMap:e,targetTextureVarying:n,targetTexture:i}=t;const r={};let s,o;n&&(({width:s,height:o}=i),r["".concat(So).concat(n)]=[s,o]);for(const t in e)({width:s,height:o}=e[t]),r["".concat(So).concat(t)]=[s,o];return r}({sourceTextureMap:n,targetTextureVarying:this.targetTextureVarying,targetTexture:r});Object.assign(o,t)}return this.hasTargetTexture&&(c=!1,a.viewport=[0,0,i.width,i.height]),{attributes:s,framebuffer:i,uniforms:o,discard:c,parameters:a}}swap(){return!!this._swapTexture&&(this.currentIndex=this._getNextIndex(),!0)}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._setupTextures(t)}getTargetTexture(){const{targetTexture:t}=this.bindings[this.currentIndex];return t}getData(){let{packed:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{framebuffer:e}=this.bindings[this.currentIndex],n=On(e);if(!t)return n;const i=n.constructor,r=function(t){switch(t){case"float":return 1;case"vec2":return 2;case"vec3":return 3;case"vec4":return 4;default:return Er(!1),null}}(this.targetTextureType),s=new i(n.length*r/4);let o=0;for(let t=0;t<n.length;t+=4)for(let e=0;e<r;e++)s[o++]=n[t+e];return s}getFramebuffer(){return this.bindings[this.currentIndex].framebuffer}delete(){this.ownTexture&&this.ownTexture.delete(),this.elementIDBuffer&&this.elementIDBuffer.delete()}_initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{_targetTextureVarying:e,_swapTexture:n}=t;this._swapTexture=n,this.targetTextureVarying=e,this.hasTargetTexture=e,this._setupTextures(t)}_createTargetTexture(t){const{sourceTextures:e,textureOrReference:n}=t;if(n instanceof xn)return n;const i=e[n];return i?(this._targetRefTexName=n,this._createNewTexture(i)):null}_setupTextures(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceBuffers:e,_sourceTextures:n={},_targetTexture:i}=t,r=this._createTargetTexture({sourceTextures:n,textureOrReference:i});this.hasSourceTextures=this.hasSourceTextures||n&&Object.keys(n).length>0,this._updateBindings({sourceBuffers:e,sourceTextures:n,targetTexture:r}),"elementCount"in t&&this._updateElementIDBuffer(t.elementCount)}_updateElementIDBuffer(t){if("number"!=typeof t||this.elementCount>=t)return;const e=new Float32Array(t);e.forEach((t,e,n)=>{n[e]=e}),this.elementIDBuffer?this.elementIDBuffer.setData({data:e}):this.elementIDBuffer=new gn(this.gl,{data:e,accessor:{size:1}}),this.elementCount=t}_updateBindings(t){if(this.bindings[this.currentIndex]=this._updateBinding(this.bindings[this.currentIndex],t),this._swapTexture){const{sourceTextures:t,targetTexture:e}=this._swapTextures(this.bindings[this.currentIndex]),n=this._getNextIndex();this.bindings[n]=this._updateBinding(this.bindings[n],{sourceTextures:t,targetTexture:e})}}_updateBinding(t,e){const{sourceBuffers:n,sourceTextures:i,targetTexture:r}=e;if(t||(t={sourceBuffers:{},sourceTextures:{},targetTexture:null}),Object.assign(t.sourceTextures,i),Object.assign(t.sourceBuffers,n),r){t.targetTexture=r;const{width:e,height:n}=r,{framebuffer:i}=t;i?(i.update({attachments:{36064:r},resizeAttachments:!1}),i.resize({width:e,height:n})):t.framebuffer=new ai(this.gl,{id:"transform-framebuffer",width:e,height:n,attachments:{36064:r}})}return t}_setSourceTextureParameters(){const t=this.currentIndex,{sourceTextures:e}=this.bindings[t];for(const t in e)e[t].setParameters(Co)}_swapTextures(t){if(!this._swapTexture)return null;const e=Object.assign({},t.sourceTextures);e[this._swapTexture]=t.targetTexture;return{sourceTextures:e,targetTexture:t.sourceTextures[this._swapTexture]}}_createNewTexture(t){const e=function(t,e){Ze(t instanceof xn||t instanceof wn||t instanceof An);const n=t.constructor,{gl:i,width:r,height:s,format:o,type:a,dataFormat:c,border:l,mipmaps:u}=t;return new n(i,Object.assign({width:r,height:s,format:o,type:a,dataFormat:c,border:l,mipmaps:u},e))}(t,{parameters:{10241:9728,10240:9728,10242:33071,10243:33071},pixelStore:{37440:!1}});return this.ownTexture&&this.ownTexture.delete(),this.ownTexture=e,e}_getNextIndex(){return(this.currentIndex+1)%2}_processVertexShader(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{sourceTextures:e,targetTexture:n}=this.bindings[this.currentIndex],{vs:i,uniforms:r,targetTextureType:s,inject:o,samplerTextureMap:a}=Eo({vs:t.vs,sourceTextureMap:e,targetTextureVarying:this.targetTextureVarying,targetTexture:n}),c=Zr([t.inject||{},o]);this.targetTextureType=s,this.samplerTextureMap=a;return{vs:i,fs:t._fs||fs({version:fi(i),input:this.targetTextureVarying,inputType:s,output:"transform_output"}),modules:this.hasSourceTextures||this.targetTextureVarying?[po].concat(t.modules||[]):t.modules,uniforms:r,inject:c}}}class Mo{static isSupported(t){return ee(t)}constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.gl=t,this.model=null,this.elementCount=0,this.bufferTransform=null,this.textureTransform=null,this.elementIDBuffer=null,this._initialize(e),Object.seal(this)}delete(){const{model:t,bufferTransform:e,textureTransform:n}=this;t&&t.delete(),e&&e.delete(),n&&n.delete()}run(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{clearRenderTarget:e=!0}=t,n=this._updateDrawOptions(t);e&&n.framebuffer&&n.framebuffer.clear({color:!0}),this.model.transform(n)}swap(){let t=!1;const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const n of e)t=t||n.swap();Ze(t,"Nothing to swap")}getBuffer(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this.bufferTransform&&this.bufferTransform.getBuffer(t)}getData(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const n of e){const e=n.getData(t);if(e)return e}return null}getFramebuffer(){return this.textureTransform&&this.textureTransform.getFramebuffer()}update(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"elementCount"in t&&this.model.setVertexCount(t.elementCount);const e=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const n of e)n.update(t)}_initialize(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{gl:e}=this;this._buildResourceTransforms(e,t),t=this._updateModelProps(t),this.model=new Po(e,Object.assign({},t,{fs:t.fs||fs({version:fi(t.vs)}),id:t.id||"transform-model",drawMode:t.drawMode||0,vertexCount:t.elementCount})),this.bufferTransform&&this.bufferTransform.setupResources({model:this.model})}_updateModelProps(t){let e=Object.assign({},t);const n=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const t of n)e=t.updateModelProps(e);return e}_buildResourceTransforms(t,e){(function(t){if(!$e(t.feedbackBuffers)||!$e(t.feedbackMap)||t.varyings&&t.varyings.length>0)return!0;return!1})(e)&&(this.bufferTransform=new wo(t,e)),function(t){if(!$e(t._sourceTextures)||t._targetTexture||t._targetTextureVarying)return!0;return!1}(e)&&(this.textureTransform=new Lo(t,e)),Ze(this.bufferTransform||this.textureTransform,"must provide source/feedback buffers or source/target textures")}_updateDrawOptions(t){let e=Object.assign({},t);const n=[this.bufferTransform,this.textureTransform].filter(Boolean);for(const t of n)e=Object.assign(e,t.getDrawOptions(e));return e}}const Oo={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6};class Io{static get DRAW_MODE(){return Oo}constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{id:e=Je("geometry"),drawMode:n=Oo.TRIANGLES,attributes:i={},indices:r=null,vertexCount:s=null}=t;this.id=e,this.drawMode=0|n,this.attributes={},this.userData={},this._setAttributes(i,r),this.vertexCount=s||this._calculateVertexCount(this.attributes,this.indices)}get mode(){return this.drawMode}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(t){return"Geometry ".concat(this.id," attribute ").concat(t)}_setAttributes(t,e){e&&(this.indices=ArrayBuffer.isView(e)?{value:e,size:1}:e);for(const e in t){let n=t[e];n=ArrayBuffer.isView(n)?{value:n}:n,Ze(ArrayBuffer.isView(n.value),"".concat(this._print(e),": must be typed array or object with value as typed array")),"POSITION"!==e&&"positions"!==e||n.size||(n.size=3),"indices"===e?(Ze(!this.indices),this.indices=n):this.attributes[e]=n}return this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this}_calculateVertexCount(t,e){if(e)return e.value.length;let n=1/0;for(const e in t){const i=t[e],{value:r,size:s,constant:o}=i;!o&&r&&s>=1&&(n=Math.min(n,r.length/s))}return Ze(Number.isFinite(n)),n}}const Ro=new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),Fo=new Float32Array([-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1]),zo=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0]),ko=new Float32Array([0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1]),jo={POSITION:{size:3,value:new Float32Array(Fo)},NORMAL:{size:3,value:new Float32Array(zo)},TEXCOORD_0:{size:2,value:new Float32Array(ko)}};class Bo extends Io{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{id:e=Je("cube-geometry")}=t;super({...t,id:e,indices:{size:1,value:new Uint16Array(Ro)},attributes:{...jo,...t.attributes}})}}const Do="#define SMOOTH_EDGE_RADIUS 0.5";var No={name:"geometry",vs:"\n".concat(Do,"\n\nstruct VertexGeometry {\n  vec4 position;\n  vec3 worldPosition;\n  vec3 worldPositionAlt;\n  vec3 normal;\n  vec2 uv;\n  vec3 pickingColor;\n} geometry = VertexGeometry(\n  vec4(0.0, 0.0, 1.0, 0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec3(0.0),\n  vec2(0.0),\n  vec3(0.0)\n);\n"),fs:"\n".concat(Do,"\n\nstruct FragmentGeometry {\n  vec2 uv;\n} geometry;\n\nfloat smoothedge(float edge, float x) {\n  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);\n}\n")};const Uo=Object.keys(Kt).map(t=>"const int COORDINATE_SYSTEM_".concat(t," = ").concat(Kt[t],";")).join(""),Vo=Object.keys(qt).map(t=>"const int PROJECTION_MODE_".concat(t," = ").concat(qt[t],";")).join(""),Go=Object.keys(Jt).map(t=>"const int UNIT_".concat(t.toUpperCase()," = ").concat(Jt[t],";")).join("");var Wo="".concat(Uo,"\n").concat(Vo,"\n").concat(Go,"\n\nuniform int project_uCoordinateSystem;\nuniform int project_uProjectionMode;\nuniform float project_uScale;\nuniform bool project_uWrapLongitude;\nuniform vec3 project_uCommonUnitsPerMeter;\nuniform vec3 project_uCommonUnitsPerWorldUnit;\nuniform vec3 project_uCommonUnitsPerWorldUnit2;\nuniform vec4 project_uCenter;\nuniform mat4 project_uModelMatrix;\nuniform mat4 project_uViewProjectionMatrix;\nuniform vec2 project_uViewportSize;\nuniform float project_uDevicePixelRatio;\nuniform float project_uFocalDistance;\nuniform vec3 project_uCameraPosition;\nuniform vec3 project_uCoordinateOrigin;\nuniform vec3 project_uCommonOrigin;\nuniform bool project_uPseudoMeters;\n\nconst float TILE_SIZE = 512.0;\nconst float PI = 3.1415926536;\nconst float WORLD_SCALE = TILE_SIZE / (PI * 2.0);\nconst vec3 ZERO_64_LOW = vec3(0.0);\nconst float EARTH_RADIUS = 6370972.0;\nconst float GLOBE_RADIUS = 256.0;\nfloat project_size_at_latitude(float lat) {\n  float y = clamp(lat, -89.9, 89.9);\n  return 1.0 / cos(radians(y));\n}\n\nfloat project_size() {\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR &&\n    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT &&\n    project_uPseudoMeters == false) {\n    \n    if (geometry.position.w == 0.0) {\n      return project_size_at_latitude(geometry.worldPosition.y);\n    }\n  \n    float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;\n    float y2 = y * y;\n    float y4 = y2 * y2;\n    float y6 = y4 * y2;\n    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;\n  }\n  return 1.0;\n}\n\nfloat project_size_at_latitude(float meters, float lat) {\n  return meters * project_uCommonUnitsPerMeter.z * project_size_at_latitude(lat);\n}\nfloat project_size(float meters) {\n  return meters * project_uCommonUnitsPerMeter.z * project_size();\n}\n\nvec2 project_size(vec2 meters) {\n  return meters * project_uCommonUnitsPerMeter.xy * project_size();\n}\n\nvec3 project_size(vec3 meters) {\n  return meters * project_uCommonUnitsPerMeter * project_size();\n}\n\nvec4 project_size(vec4 meters) {\n  return vec4(meters.xyz * project_uCommonUnitsPerMeter, meters.w);\n}\nmat3 project_get_orientation_matrix(vec3 up) {\n  vec3 uz = normalize(up);\n  vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));\n  vec3 uy = cross(uz, ux);\n  return mat3(ux, uy, uz);\n}\n\nbool project_needs_rotation(vec3 commonPosition, out mat3 transform) {\n  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {\n    transform = project_get_orientation_matrix(commonPosition);\n    return true;\n  }\n  return false;\n}\nvec3 project_normal(vec3 vector) {\n  vec4 normal_modelspace = project_uModelMatrix * vec4(vector, 0.0);\n  vec3 n = normalize(normal_modelspace.xyz * project_uCommonUnitsPerMeter);\n  mat3 rotation;\n  if (project_needs_rotation(geometry.position.xyz, rotation)) {\n    n = rotation * n;\n  }\n  return n;\n}\n\nvec4 project_offset_(vec4 offset) {\n  float dy = offset.y;\n  vec3 commonUnitsPerWorldUnit = project_uCommonUnitsPerWorldUnit + project_uCommonUnitsPerWorldUnit2 * dy;\n  return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);\n}\nvec2 project_mercator_(vec2 lnglat) {\n  float x = lnglat.x;\n  if (project_uWrapLongitude) {\n    x = mod(x + 180., 360.0) - 180.;\n  }\n  float y = clamp(lnglat.y, -89.9, 89.9);\n  return vec2(\n    radians(x) + PI,\n    PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))\n  ) * WORLD_SCALE;\n}\n\nvec3 project_globe_(vec3 lnglatz) {\n  float lambda = radians(lnglatz.x);\n  float phi = radians(lnglatz.y);\n  float cosPhi = cos(phi);\n  float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;\n\n  return vec3(\n    sin(lambda) * cosPhi,\n    -cos(lambda) * cosPhi,\n    sin(phi)\n  ) * D;\n}\nvec4 project_position(vec4 position, vec3 position64Low) {\n  vec4 position_world = project_uModelMatrix * position;\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4(\n        project_mercator_(position_world.xy),\n        project_size_at_latitude(position_world.z, position_world.y),\n        position_world.w\n      );\n    }\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {\n      position_world.xyz += project_uCoordinateOrigin;\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_GLOBE) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      return vec4(\n        project_globe_(position_world.xyz),\n        position_world.w\n      );\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {\n    if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n      if (abs(position_world.y - project_uCoordinateOrigin.y) > 0.25) {\n        return vec4(\n          project_mercator_(position_world.xy) - project_uCommonOrigin.xy,\n          project_size(position_world.z),\n          position_world.w\n        );\n      }\n    }\n  }\n  if (project_uProjectionMode == PROJECTION_MODE_IDENTITY ||\n    (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&\n    (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\n     project_uCoordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {\n    position_world.xyz -= project_uCoordinateOrigin;\n  }\n  return project_offset_(position_world) + project_offset_(project_uModelMatrix * vec4(position64Low, 0.0));\n}\n\nvec4 project_position(vec4 position) {\n  return project_position(position, ZERO_64_LOW);\n}\n\nvec3 project_position(vec3 position, vec3 position64Low) {\n  vec4 projected_position = project_position(vec4(position, 1.0), position64Low);\n  return projected_position.xyz;\n}\n\nvec3 project_position(vec3 position) {\n  vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);\n  return projected_position.xyz;\n}\n\nvec2 project_position(vec2 position) {\n  vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);\n  return projected_position.xy;\n}\n\nvec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {\n  return viewProjectionMatrix * position + center;\n}\nvec4 project_common_position_to_clipspace(vec4 position) {\n  return project_common_position_to_clipspace(position, project_uViewProjectionMatrix, project_uCenter);\n}\nvec2 project_pixel_size_to_clipspace(vec2 pixels) {\n  vec2 offset = pixels / project_uViewportSize * project_uDevicePixelRatio * 2.0;\n  return offset * project_uFocalDistance;\n}\n\nfloat project_size_to_pixel(float meters) {\n  return project_size(meters) * project_uScale;\n}\nfloat project_size_to_pixel(float size, int unit) {\n  if (unit == UNIT_METERS) return project_size_to_pixel(size);\n  if (unit == UNIT_COMMON) return size * project_uScale;\n  return size;\n}\nfloat project_pixel_size(float pixels) {\n  return pixels / project_uScale;\n}\nvec2 project_pixel_size(vec2 pixels) {\n  return pixels / project_uScale;\n}\n");function Ho(t,e){if(t===e)return!0;if(Array.isArray(t)){const n=t.length;if(!e||e.length!==n)return!1;for(let i=0;i<n;i++)if(t[i]!==e[i])return!1;return!0}return!1}function Xo(t){let e,n={};return i=>{for(const r in i)if(!Ho(i[r],n[r])){e=t(i),n=i;break}return e}}const Zo=[0,0,0,0],Yo=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],Ko=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],qo=[0,0,0],Jo=[0,0,0],Qo=Xo(function({viewport:t,devicePixelRatio:e,coordinateSystem:n,coordinateOrigin:i}){const{projectionCenter:r,viewProjectionMatrix:s,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:c,geospatialOrigin:l}=function(t,e,n){const{viewMatrixUncentered:i,projectionMatrix:r}=t;let{viewMatrix:s,viewProjectionMatrix:o}=t,a=Zo,c=Zo,l=t.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:d}=$o(t,e,n);d&&(c=t.projectPosition(u||h),l=[l[0]-c[0],l[1]-c[1],l[2]-c[2]],c[3]=1,a=Zs([],c,o),s=i||s,o=Ds([],r,s),o=Ds([],o,Yo));return{viewMatrix:s,viewProjectionMatrix:o,projectionCenter:a,originCommon:c,cameraPosCommon:l,shaderCoordinateOrigin:h,geospatialOrigin:u}}(t,n,i),u=t.getDistanceScales(),h=[t.width*e,t.height*e],d=Zs([],[0,0,-t.focalDistance,1],t.projectionMatrix)[3]||1,f={project_uCoordinateSystem:n,project_uProjectionMode:t.projectionMode,project_uCoordinateOrigin:c,project_uCommonOrigin:o.slice(0,3),project_uCenter:r,project_uPseudoMeters:Boolean(t._pseudoMeters),project_uViewportSize:h,project_uDevicePixelRatio:e,project_uFocalDistance:d,project_uCommonUnitsPerMeter:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit:u.unitsPerMeter,project_uCommonUnitsPerWorldUnit2:qo,project_uScale:t.scale,project_uWrapLongitude:!1,project_uViewProjectionMatrix:s,project_uModelMatrix:Ko,project_uCameraPosition:a};if(l){const e=t.getDistanceScales(l);switch(n){case Kt.METER_OFFSETS:f.project_uCommonUnitsPerWorldUnit=e.unitsPerMeter,f.project_uCommonUnitsPerWorldUnit2=e.unitsPerMeter2;break;case Kt.LNGLAT:case Kt.LNGLAT_OFFSETS:t._pseudoMeters||(f.project_uCommonUnitsPerMeter=e.unitsPerMeter),f.project_uCommonUnitsPerWorldUnit=e.unitsPerDegree,f.project_uCommonUnitsPerWorldUnit2=e.unitsPerDegree2;break;case Kt.CARTESIAN:f.project_uCommonUnitsPerWorldUnit=[1,1,e.unitsPerMeter[2]],f.project_uCommonUnitsPerWorldUnit2=[0,0,e.unitsPerMeter2[2]]}}return f});function $o(t,e,n=Jo){n.length<3&&(n=[n[0],n[1],0]);let i,r=n,s=!0;switch(i=e===Kt.LNGLAT_OFFSETS||e===Kt.METER_OFFSETS?n:t.isGeospatial?[Math.fround(t.longitude),Math.fround(t.latitude),0]:null,t.projectionMode){case qt.WEB_MERCATOR:e!==Kt.LNGLAT&&e!==Kt.CARTESIAN||(i=[0,0,0],s=!1);break;case qt.WEB_MERCATOR_AUTO_OFFSET:e===Kt.LNGLAT?r=i:e===Kt.CARTESIAN&&(r=[Math.fround(t.center[0]),Math.fround(t.center[1]),0],i=t.unprojectPosition(r),r[0]-=n[0],r[1]-=n[1],r[2]-=n[2]);break;case qt.IDENTITY:r=t.position.map(Math.fround),r[2]=r[2]||0;break;case qt.GLOBE:s=!1,i=null;break;default:s=!1}return{geospatialOrigin:i,shaderCoordinateOrigin:r,offsetMode:s}}const ta={};var ea={name:"project",dependencies:[gs,No],vs:Wo,getUniforms:function(t=ta){return"viewport"in t?function({viewport:t,devicePixelRatio:e=1,modelMatrix:n=null,coordinateSystem:i=Kt.DEFAULT,coordinateOrigin:r=Jo,autoWrapLongitude:s=!1}){i===Kt.DEFAULT&&(i=t.isGeospatial?Kt.LNGLAT:Kt.CARTESIAN);const o=Qo({viewport:t,devicePixelRatio:e,coordinateSystem:i,coordinateOrigin:r});return o.project_uWrapLongitude=s,o.project_uModelMatrix=n||Ko,o}(t):{}}};function na(t,e){const n=Zs([],e,t);return function(t,e,n){t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n}(n,n,1/n[3]),n}function ia(t,e,n){return t<e?e:t>n?n:t}const ra=Math.log2||function(t){return Math.log(t)*Math.LOG2E};function sa(t,e){if(!t)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const oa=Math.PI,aa=oa/4,ca=oa/180,la=180/oa,ua=512,ha=4003e4,da=85.051129,fa=1.5;function ga(t){const[e,n]=t;sa(Number.isFinite(e)),sa(Number.isFinite(n)&&n>=-90&&n<=90,"invalid latitude");const i=n*ca;return[ua*(e*ca+oa)/(2*oa),ua*(oa+Math.log(Math.tan(aa+.5*i)))/(2*oa)]}function pa(t){const[e,n]=t,i=e/ua*(2*oa)-oa,r=2*(Math.atan(Math.exp(n/ua*(2*oa)-oa))-aa);return[i*la,r*la]}function ma(t){const{latitude:e}=t;sa(Number.isFinite(e));const n=Math.cos(e*ca);return function(t){return ra(t)}(ha*n)-9}function va(t){return 12790407194604047e-21/Math.cos(t*ca)}function ya(t){const{latitude:e,longitude:n,highPrecision:i=!1}=t;sa(Number.isFinite(e)&&Number.isFinite(n));const r=ua,s=Math.cos(e*ca),o=r/360,a=o/s,c=12790407194604047e-21/s,l={unitsPerMeter:[c,c,c],metersPerUnit:[1/c,1/c,1/c],unitsPerDegree:[o,a,c],degreesPerUnit:[.703125,1/a,1/c]};if(i){const t=ca*Math.tan(e*ca)/s,n=o*t/2,i=12790407194604047e-21*t,r=i/a*c;l.unitsPerDegree2=[0,n,i],l.unitsPerMeter2=[r,0,r]}return l}function ba(t,e){const[n,i,r]=t,[s,o,a]=e,{unitsPerMeter:c,unitsPerMeter2:l}=ya({longitude:n,latitude:i,highPrecision:!0}),u=ga(t);u[0]+=s*(c[0]+l[0]*o),u[1]+=o*(c[1]+l[1]*o);const h=pa(u),d=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[h[0],h[1],d]:h}function _a(t){return 2*Math.atan(.5/t)*la}function xa(t){return.5/Math.tan(.5*t*ca)}function Pa(t,e){const[n,i,r=0]=t;return sa(Number.isFinite(n)&&Number.isFinite(i)&&Number.isFinite(r)),na(e,[n,i,r,1])}function wa(t,e,n=0){const[i,r,s]=t;if(sa(Number.isFinite(i)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(s)){return na(e,[i,r,s,1])}const o=na(e,[i,r,0,1]),a=na(e,[i,r,1,1]),c=o[2],l=a[2];return Ms([],o,a,c===l?0:((n||0)-c)/(l-c))}function Aa(t){const{width:e,height:n,bounds:i,minExtent:r=0,maxZoom:s=24,offset:o=[0,0]}=t,[[a,c],[l,u]]=i,h=function(t=0){if("number"==typeof t)return{top:t,bottom:t,left:t,right:t};return sa(Number.isFinite(t.top)&&Number.isFinite(t.bottom)&&Number.isFinite(t.left)&&Number.isFinite(t.right)),t}(t.padding),d=ga([a,ia(u,-85.051129,da)]),f=ga([l,ia(c,-85.051129,da)]),g=[Math.max(Math.abs(f[0]-d[0]),r),Math.max(Math.abs(f[1]-d[1]),r)],p=[e-h.left-h.right-2*Math.abs(o[0]),n-h.top-h.bottom-2*Math.abs(o[1])];sa(p[0]>0&&p[1]>0);const m=p[0]/g[0],v=p[1]/g[1],y=(h.right-h.left)/2/m,b=(h.top-h.bottom)/2/v,_=pa([(f[0]+d[0])/2+y,(f[1]+d[1])/2+b]),x=Math.min(s,ra(Math.abs(Math.min(m,v))));return sa(Number.isFinite(x)),{longitude:_[0],latitude:_[1],zoom:x}}const Sa=Math.PI/180;function Ta(t,e,n){const{pixelUnprojectionMatrix:i}=t,r=na(i,[e,0,1,1]),s=na(i,[e,t.height,1,1]),o=pa(Ms([],r,s,(n*t.distanceScales.unitsPerMeter[2]-r[2])/(s[2]-r[2])));return o.push(n),o}var Ea=new class{constructor(t={}){n(this,"_pool",[]),n(this,"opts",{overAlloc:2,poolSize:100}),this.setOptions(t)}setOptions(t){Object.assign(this.opts,t)}allocate(t,e,{size:n=1,type:i,padding:r=0,copy:s=!1,initialize:o=!1,maxCount:a}){const c=i||t&&t.constructor||Float32Array,l=e*n+r;if(ArrayBuffer.isView(t)){if(l<=t.length)return t;if(l*t.BYTES_PER_ELEMENT<=t.buffer.byteLength)return new c(t.buffer,0,l)}let u=1/0;a&&(u=a*n+r);const h=this._allocate(c,l,o,u);return t&&s?h.set(t):o||h.fill(0,0,4),this._release(t),h}release(t){this._release(t)}_allocate(t,e,n,i){let r=Math.max(Math.ceil(e*this.opts.overAlloc),1);r>i&&(r=i);const s=this._pool,o=t.BYTES_PER_ELEMENT*r,a=s.findIndex(t=>t.byteLength>=o);if(a>=0){const e=new t(s.splice(a,1)[0],0,r);return n&&e.fill(0),e}return new t(r)}_release(t){if(!ArrayBuffer.isView(t))return;const e=this._pool,{buffer:n}=t,{byteLength:i}=n,r=e.findIndex(t=>t.byteLength>=i);r<0?e.push(n):(r>0||e.length<this.opts.poolSize)&&e.splice(r,0,n),e.length>this.opts.poolSize&&e.shift()}};const Ca=new ks;function La(t,e,n,i){Ca.set(t,e,n);const r=Ca.len();return{distance:i/r,normal:new ks(-t/r,-e/r,-n/r)}}function Ma(t){return t-Math.fround(t)}let Oa;function Ia(t,e){const{size:n=1,startIndex:i=0}=e,r=void 0!==e.endIndex?e.endIndex:t.length,s=(r-i)/n;Oa=Ea.allocate(Oa,s,{type:Float32Array,size:2*n});let o=i,a=0;for(;o<r;){for(let e=0;e<n;e++){const i=t[o++];Oa[a+e]=i,Oa[a+e+n]=Ma(i)}a+=2*n}return Oa.subarray(0,s*n*2)}function Ra(t){let e=null,n=!1;for(const i of t)i&&(e?(n||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],n=!0),e[0][0]=Math.min(e[0][0],i[0][0]),e[0][1]=Math.min(e[0][1],i[0][1]),e[1][0]=Math.max(e[1][0],i[1][0]),e[1][1]=Math.max(e[1][1],i[1][1])):e=i);return e}const Fa=Math.PI/180,za=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],ka=[0,0,0],ja={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};class Ba{constructor(t={}){n(this,"id",void 0),n(this,"x",void 0),n(this,"y",void 0),n(this,"width",void 0),n(this,"height",void 0),n(this,"padding",void 0),n(this,"isGeospatial",void 0),n(this,"zoom",void 0),n(this,"focalDistance",void 0),n(this,"position",void 0),n(this,"modelMatrix",void 0),n(this,"distanceScales",void 0),n(this,"scale",void 0),n(this,"center",void 0),n(this,"cameraPosition",void 0),n(this,"projectionMatrix",void 0),n(this,"viewMatrix",void 0),n(this,"viewMatrixUncentered",void 0),n(this,"viewMatrixInverse",void 0),n(this,"viewProjectionMatrix",void 0),n(this,"pixelProjectionMatrix",void 0),n(this,"pixelUnprojectionMatrix",void 0),n(this,"resolution",void 0),n(this,"_frustumPlanes",{}),this.id=t.id||this.constructor.displayName||"viewport",this.x=t.x||0,this.y=t.y||0,this.width=t.width||1,this.height=t.height||1,this.zoom=t.zoom||0,this.padding=t.padding,this.distanceScales=t.distanceScales||ja,this.focalDistance=t.focalDistance||1,this.position=t.position||ka,this.modelMatrix=t.modelMatrix||null;const{longitude:e,latitude:i}=t;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(e),this._initProps(t),this._initMatrices(t),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?qt.WEB_MERCATOR:qt.WEB_MERCATOR_AUTO_OFFSET:qt.IDENTITY}equals(t){return t instanceof Ba&&(this===t||t.width===this.width&&t.height===this.height&&t.scale===this.scale&&xs(t.projectionMatrix,this.projectionMatrix)&&xs(t.viewMatrix,this.viewMatrix))}project(t,{topLeft:e=!0}={}){const n=Pa(this.projectPosition(t),this.pixelProjectionMatrix),[i,r]=n,s=e?r:this.height-r;return 2===t.length?[i,s]:[i,s,n[2]]}unproject(t,{topLeft:e=!0,targetZ:n}={}){const[i,r,s]=t,o=e?r:this.height-r,a=n&&n*this.distanceScales.unitsPerMeter[2],c=wa([i,o,s],this.pixelUnprojectionMatrix,a),[l,u,h]=this.unprojectPosition(c);return Number.isFinite(s)?[l,u,h]:Number.isFinite(n)?[l,u,n]:[l,u]}projectPosition(t){const[e,n]=this.projectFlat(t);return[e,n,(t[2]||0)*this.distanceScales.unitsPerMeter[2]]}unprojectPosition(t){const[e,n]=this.unprojectFlat(t);return[e,n,(t[2]||0)*this.distanceScales.metersPerUnit[2]]}projectFlat(t){if(this.isGeospatial){const e=ga(t);return e[1]=bs(e[1],-318,830),e}return t}unprojectFlat(t){return this.isGeospatial?pa(t):t}getBounds(t={}){const e={targetZ:t.z||0},n=this.unproject([0,0],e),i=this.unproject([this.width,0],e),r=this.unproject([0,this.height],e),s=this.unproject([this.width,this.height],e);return[Math.min(n[0],i[0],r[0],s[0]),Math.min(n[1],i[1],r[1],s[1]),Math.max(n[0],i[0],r[0],s[0]),Math.max(n[1],i[1],r[1],s[1])]}getDistanceScales(t){return t?ya({longitude:t[0],latitude:t[1],highPrecision:!0}):this.distanceScales}containsPixel({x:t,y:e,width:n=1,height:i=1}){return t<this.x+this.width&&this.x<t+n&&e<this.y+this.height&&this.y<e+i}getFrustumPlanes(){return this._frustumPlanes.near||Object.assign(this._frustumPlanes,{left:La((t=this.viewProjectionMatrix)[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]),right:La(t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]),bottom:La(t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]),top:La(t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]),near:La(t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]),far:La(t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14])}),this._frustumPlanes;var t}panByPosition(t,e){return null}_initProps(t){const e=t.longitude,n=t.latitude;this.isGeospatial&&(Number.isFinite(t.zoom)||(this.zoom=ma({latitude:n})+Math.log2(this.focalDistance)),this.distanceScales=t.distanceScales||ya({latitude:n,longitude:e}));const i=Math.pow(2,this.zoom);this.scale=i;const{position:r,modelMatrix:s}=t;let o=ka;if(r&&(o=s?new $s(s).transformAsVector(r,[]):r),this.isGeospatial){const t=this.projectPosition([e,n,0]);this.center=new ks(o).scale(this.distanceScales.unitsPerMeter).add(t)}else this.center=this.projectPosition(o)}_initMatrices(t){const{viewMatrix:e=za,projectionMatrix:n=null,orthographic:i=!1,fovyRadians:r,fovy:s=75,near:o=.1,far:a=1e3,padding:c=null,focalDistance:l=1}=t;this.viewMatrixUncentered=e,this.viewMatrix=(new $s).multiplyRight(e).translate(new ks(this.center).negate()),this.projectionMatrix=n||function({width:t,height:e,orthographic:n,fovyRadians:i,focalDistance:r,padding:s,near:o,far:a}){const c=t/e,l=n?(new $s).orthographic({fovy:i,aspect:c,focalDistance:r,near:o,far:a}):(new $s).perspective({fovy:i,aspect:c,near:o,far:a});if(s){const{left:n=0,right:i=0,top:r=0,bottom:o=0}=s,a=bs((n+t-i)/2,0,t)-t/2,c=bs((r+e-o)/2,0,e)-e/2;l[8]-=2*a/t,l[9]+=2*c/e}return l}({width:this.width,height:this.height,orthographic:i,fovyRadians:r||s*Fa,focalDistance:l,padding:c,near:o,far:a});const u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var h;Ds(u,u,this.projectionMatrix),Ds(u,u,this.viewMatrix),this.viewProjectionMatrix=u,this.viewMatrixInverse=Bs([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=[(h=this.viewMatrixInverse)[12],h[13],h[14]];const d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];Us(d,d,[this.width/2,-this.height/2,1]),Ns(d,d,[1,-1,0]),Ds(f,d,this.viewProjectionMatrix),this.pixelProjectionMatrix=f,this.pixelUnprojectionMatrix=Bs([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||Xt.warn("Pixel project matrix not invertible")()}}n(Ba,"displayName","Viewport");class Da extends Ba{constructor(t={}){const{latitude:e=0,longitude:i=0,zoom:r=0,pitch:s=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:c=1.01,nearZ:l,farZ:u,orthographic:h=!1,projectionMatrix:d,repeat:f=!1,worldOffset:g=0,position:p,padding:m,legacyMeterSizes:v=!1}=t;let{width:y,height:b,altitude:_=1.5}=t;const x=Math.pow(2,r);let P;y=y||1,b=b||1;let w=null;if(d)_=d[5]/2,P=_a(_);else{let n;if(t.fovy?(P=t.fovy,_=xa(P)):P=_a(_),m){const{top:t=0,bottom:e=0}=m;n=[0,bs((t+b-e)/2,0,b)-b/2]}w=function(t){const{width:e,height:n,altitude:i,pitch:r=0,offset:s,center:o,scale:a,nearZMultiplier:c=1,farZMultiplier:l=1}=t;let{fovy:u=_a(fa)}=t;void 0!==i&&(u=_a(i));const h=u*ca,d=r*ca,f=xa(u);let g=f;o&&(g+=o[2]*a/Math.cos(d)/n);const p=h*(.5+(s?s[1]:0)/n),m=Math.sin(p)*g/Math.sin(ia(Math.PI/2-d-p,.01,Math.PI-.01)),v=Math.sin(d)*m+g,y=10*g;return{fov:h,aspect:e/n,focalDistance:f,near:c,far:Math.min(v*l,y)}}({width:y,height:b,scale:x,center:p&&[0,0,p[2]*va(e)],offset:n,pitch:s,fovy:P,nearZMultiplier:a,farZMultiplier:c}),Number.isFinite(l)&&(w.near=l),Number.isFinite(u)&&(w.far=u)}let A=function(t){const{height:e,pitch:n,bearing:i,altitude:r,scale:s,center:o}=t,a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];Ns(a,a,[0,0,-r]),Vs(a,a,-n*ca),Gs(a,a,i*ca);const c=s/e;return Us(a,a,[c,c,c]),o&&Ns(a,a,function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}([],o)),a}({height:b,pitch:s,bearing:o,scale:x,altitude:_});if(g){A=(new $s).translate([512*g,0,0]).multiplyLeft(A)}super({...t,width:y,height:b,viewMatrix:A,longitude:i,latitude:e,zoom:r,...w,fovy:P,focalDistance:_}),n(this,"longitude",void 0),n(this,"latitude",void 0),n(this,"pitch",void 0),n(this,"bearing",void 0),n(this,"altitude",void 0),n(this,"fovy",void 0),n(this,"orthographic",void 0),n(this,"_subViewports",void 0),n(this,"_pseudoMeters",void 0),this.latitude=e,this.longitude=i,this.zoom=r,this.pitch=s,this.bearing=o,this.altitude=_,this.fovy=P,this.orthographic=h,this._subViewports=f?[]:null,this._pseudoMeters=v,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const t=this.getBounds(),e=Math.floor((t[0]+180)/360),n=Math.ceil((t[2]-180)/360);for(let t=e;t<=n;t++){const e=t?new Da({...this,worldOffset:t}):this;this._subViewports.push(e)}}return this._subViewports}projectPosition(t){if(this._pseudoMeters)return super.projectPosition(t);const[e,n]=this.projectFlat(t);return[e,n,(t[2]||0)*va(t[1])]}unprojectPosition(t){if(this._pseudoMeters)return super.unprojectPosition(t);const[e,n]=this.unprojectFlat(t);return[e,n,(t[2]||0)/va(n)]}addMetersToLngLat(t,e){return ba(t,e)}panByPosition(t,e){const n=wa(e,this.pixelUnprojectionMatrix),i=Ls([],this.projectFlat(t),function(t,e){return t[0]=-e[0],t[1]=-e[1],t}([],n)),r=Ls([],this.center,i),[s,o]=this.unprojectFlat(r);return{longitude:s,latitude:o}}getBounds(t={}){const e=function(t,e=0){const{width:n,height:i,unproject:r}=t,s={targetZ:e},o=r([0,i],s),a=r([n,i],s);let c,l;return(t.fovy?.5*t.fovy*Sa:Math.atan(.5/t.altitude))>(90-t.pitch)*Sa-.01?(c=Ta(t,0,e),l=Ta(t,n,e)):(c=r([0,0],s),l=r([n,0],s)),[o,a,l,c]}(this,t.z||0);return[Math.min(e[0][0],e[1][0],e[2][0],e[3][0]),Math.min(e[0][1],e[1][1],e[2][1],e[3][1]),Math.max(e[0][0],e[1][0],e[2][0],e[3][0]),Math.max(e[0][1],e[1][1],e[2][1],e[3][1])]}fitBounds(t,e={}){const{width:n,height:i}=this,{longitude:r,latitude:s,zoom:o}=Aa({width:n,height:i,bounds:t,...e});return new Da({width:n,height:i,longitude:r,latitude:s,zoom:o})}}n(Da,"displayName","WebMercatorViewport");const Na=[0,0,0];function Ua(t,e,n=!1){const i=e.projectPosition(t);if(n&&e instanceof Da){const[n,r,s=0]=t,o=e.getDistanceScales([n,r]);i[2]=s*o.unitsPerMeter[2]}return i}function Va(t,{viewport:e,modelMatrix:n,coordinateSystem:i,coordinateOrigin:r,offsetMode:s}){let[o,a,c=0]=t;switch(n&&([o,a,c]=Zs([],[o,a,c,1],n)),i){case Kt.LNGLAT:return Ua([o,a,c],e,s);case Kt.LNGLAT_OFFSETS:return Ua([o+r[0],a+r[1],c+(r[2]||0)],e,s);case Kt.METER_OFFSETS:return Ua(ba(r,[o,a,c]),e,s);default:return e.isGeospatial?[o+r[0],a+r[1],c+r[2]]:e.projectPosition([o,a,c])}}function Ga(t,e){const{viewport:n,coordinateSystem:i,coordinateOrigin:r,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}=function(t){const{viewport:e,modelMatrix:n,coordinateOrigin:i}=t;let{coordinateSystem:r,fromCoordinateSystem:s,fromCoordinateOrigin:o}=t;return r===Kt.DEFAULT&&(r=e.isGeospatial?Kt.LNGLAT:Kt.CARTESIAN),void 0===s&&(s=r),void 0===o&&(o=i),{viewport:e,coordinateSystem:r,coordinateOrigin:i,modelMatrix:n,fromCoordinateSystem:s,fromCoordinateOrigin:o}}(e),{autoOffset:c=!0}=e,{geospatialOrigin:l=Na,shaderCoordinateOrigin:u=Na,offsetMode:h=!1}=c?$o(n,i,r):{},d=Va(t,{viewport:n,modelMatrix:s,coordinateSystem:o,coordinateOrigin:a,offsetMode:h});if(h){const t=n.projectPosition(l||u);Rs(d,d,t)}return d}const Wa="Awaiting state",Ha=Symbol.for("component"),Xa=Symbol.for("propTypes"),Za=Symbol.for("deprecatedProps"),Ya=Symbol.for("asyncPropDefaults"),Ka=Symbol.for("asyncPropOriginal"),qa=Symbol.for("asyncPropResolved");function Ja(t,e=()=>!0){return Array.isArray(t)?Qa(t,e,[]):e(t)?[t]:[]}function Qa(t,e,n){let i=-1;for(;++i<t.length;){const r=t[i];Array.isArray(r)?Qa(r,e,n):e(r)&&n.push(r)}return n}function $a({target:t,source:e,start:n=0,count:i=1}){const r=e.length,s=i*r;let o=0;for(let i=n;o<r;o++)t[i++]=e[o];for(;o<s;)o<s-o?(t.copyWithin(n+o,n,n+o),o*=2):(t.copyWithin(n+o,n,n+s-o),o=s);return t}var tc={name:"project32",dependencies:[ea],vs:"\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition\n) {\n  vec3 projectedPosition = project_position(position, position64Low);\n  mat3 rotation;\n  if (project_needs_rotation(projectedPosition, rotation)) {\n    // offset is specified as ENU\n    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe\n    offset = rotation * offset;\n  }\n  commonPosition = vec4(projectedPosition + offset, 1.0);\n  return project_common_position_to_clipspace(commonPosition);\n}\n\nvec4 project_position_to_clipspace(\n  vec3 position, vec3 position64Low, vec3 offset\n) {\n  vec4 commonPosition;\n  return project_position_to_clipspace(position, position64Low, offset, commonPosition);\n}\n"},ec={inject:{"vs:DECKGL_FILTER_GL_POSITION":"\n    // for picking depth values\n    picking_setPickingAttribute(position.z / position.w);\n  ","vs:DECKGL_FILTER_COLOR":"\n  picking_setPickingColor(geometry.pickingColor);\n  ","fs:#decl":"\nuniform bool picking_uAttribute;\n  ","fs:DECKGL_FILTER_COLOR":{order:99,injection:"\n  // use highlight color if this fragment belongs to the selected object.\n  color = picking_filterHighlightColor(color);\n\n  // use picking color if rendering to picking FBO.\n  color = picking_filterPickingColor(color);\n    "}},...co};function nc(t,e,n){if(t===e)return!0;if(!n||!t||!e)return!1;if(Array.isArray(t)){if(!Array.isArray(e)||t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!nc(t[i],e[i],n-1))return!1;return!0}if(Array.isArray(e))return!1;if("object"==typeof t&&"object"==typeof e){const i=Object.keys(t),r=Object.keys(e);if(i.length!==r.length)return!1;for(const r of i){if(!e.hasOwnProperty(r))return!1;if(!nc(t[r],e[r],n-1))return!1}return!0}return!1}function ic(t,e){if(!t)throw new Error(e||"deck.gl: assertion failed.")}class rc{constructor(t){n(this,"_inProgress",void 0),n(this,"_handle",void 0),n(this,"_timeline",void 0),n(this,"time",void 0),n(this,"settings",void 0),this._inProgress=!1,this._handle=null,this._timeline=t,this.time=0,this.settings={duration:0}}get inProgress(){return this._inProgress}start(t){var e,n;this.cancel(),this.settings=t,this._inProgress=!0,null===(e=(n=this.settings).onStart)||void 0===e||e.call(n,this)}end(){var t,e;this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,null===(t=(e=this.settings).onEnd)||void 0===t||t.call(e,this))}cancel(){var t,e;this._inProgress&&(null===(t=(e=this.settings).onInterrupt)||void 0===t||t.call(e,this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){var t,e;if(!this._inProgress)return!1;if(null===this._handle){const{_timeline:t,settings:e}=this;this._handle=t.addChannel({delay:t.getTime(),duration:e.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),null===(t=(e=this.settings).onUpdate)||void 0===t||t.call(e,this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}function sc(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}class oc{constructor(t,e){n(this,"opts",void 0),n(this,"source",void 0),this.opts=e,this.source=t}get value(){return this.source.value}getValue(){const t=this.source.getBuffer(),e=this.getAccessor();if(t)return[t,e];const{value:n}=this.source,{size:i}=e;let r=n;if(n&&n.length!==i){r=new Float32Array(i);const t=e.elementOffset||0;for(let e=0;e<i;++e)r[e]=n[t+e]}return r}getAccessor(){return{...this.source.getAccessor(),...this.opts}}}function ac(t){return t.stride||t.size*t.bytesPerElement}function cc(t,e){e.offset&&Xt.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const n=ac(t),i=(void 0!==e.vertexOffset?e.vertexOffset:t.vertexOffset||0)*n+(e.elementOffset||0)*t.bytesPerElement+(t.offset||0);return{...e,offset:i,stride:n}}class lc{constructor(t,e,i){n(this,"gl",void 0),n(this,"id",void 0),n(this,"size",void 0),n(this,"settings",void 0),n(this,"value",void 0),n(this,"doublePrecision",void 0),n(this,"_buffer",void 0),n(this,"state",void 0),this.gl=t,this.id=e.id||"",this.size=e.size||1;const r=e.logicalType||e.type,s=5130===r;let o,{defaultValue:a}=e;a=Number.isFinite(a)?[a]:a||new Array(this.size).fill(0),o=s?5126:!r&&e.isIndexed?t&&ii(t,Dn)?5125:5123:r||5126;let c=function(t){switch(t){case 5126:return Float32Array;case 5130:return Float64Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return Uint8ClampedArray;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Unknown GL type")}}(r||o||5126);this.doublePrecision=s,s&&!1===e.fp64&&(c=Float32Array),this.value=null,this.settings={...e,defaultType:c,defaultValue:a,logicalType:r,type:o,size:this.size,bytesPerElement:c.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1},this._buffer=null}get isConstant(){return this.state.constant}get buffer(){if(!this._buffer){const{isIndexed:t,type:e}=this.settings;this._buffer=new gn(this.gl,{id:this.id,target:t?34963:34962,accessor:{type:e}})}return this._buffer}get byteOffset(){const t=this.getAccessor();return t.vertexOffset?t.vertexOffset*ac(t):0}get numInstances(){return this.state.numInstances}set numInstances(t){this.state.numInstances=t}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),Ea.release(this.state.allocatedValue)}getShaderAttributes(t,e){if(this.doublePrecision){const n={},i=this.value instanceof Float64Array,r=function(t,e){const n=cc(t,e);return{high:n,low:{...n,offset:n.offset+4*t.size}}}(this.getAccessor(),e||{});return n[t]=new oc(this,r.high),n["".concat(t,"64Low")]=i?new oc(this,r.low):new Float32Array(this.size),n}if(e){const n=cc(this.getAccessor(),e);return{[t]:new oc(this,n)}}return{[t]:this}}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(){return this.state.constant?this.value:[this.getBuffer(),this.getAccessor()]}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let t=null;if(this.state.constant&&this.value){const e=Array.from(this.value);t=[e,e]}else{const{value:e,numInstances:n,size:i}=this,r=n*i;if(e&&r&&e.length>=r){const n=new Array(i).fill(1/0),s=new Array(i).fill(-1/0);for(let t=0;t<r;)for(let r=0;r<i;r++){const i=e[t++];i<n[r]&&(n[r]=i),i>s[r]&&(s[r]=i)}t=[n,s]}}return this.state.bounds=t,t}setData(t){const{state:e}=this;let n;n=ArrayBuffer.isView(t)?{value:t}:t instanceof gn?{buffer:t}:t;const i={...this.settings,...n};if(e.bufferAccessor=i,e.bounds=null,n.constant){let t=n.value;t=this._normalizeValue(t,[],0),this.settings.normalized&&(t=this.normalizeConstant(t));if(!(!e.constant||!this._areValuesEqual(t,this.value)))return!1;e.externalBuffer=null,e.constant=!0,this.value=t}else if(n.buffer){const t=n.buffer;e.externalBuffer=t,e.constant=!1,this.value=n.value||null;const r=n.value instanceof Float64Array;i.type=n.type||t.accessor.type,i.bytesPerElement=t.accessor.BYTES_PER_ELEMENT*(r?2:1),i.stride=ac(i)}else if(n.value){this._checkExternalBuffer(n);let t=n.value;e.externalBuffer=null,e.constant=!1,this.value=t,i.bytesPerElement=t.BYTES_PER_ELEMENT,i.stride=ac(i);const{buffer:r,byteOffset:s}=this;this.doublePrecision&&t instanceof Float64Array&&(t=Ia(t,i));const o=t.byteLength+s+2*i.stride;r.byteLength<o&&r.reallocate(o),r.setAccessor(null),r.subData({data:t,offset:s}),i.type=n.type||r.accessor.type}return!0}updateSubBuffer(t={}){this.state.bounds=null;const e=this.value,{startOffset:n=0,endOffset:i}=t;this.buffer.subData({data:this.doublePrecision&&e instanceof Float64Array?Ia(e,{size:this.size,startIndex:n,endIndex:i}):e.subarray(n,i),offset:n*e.BYTES_PER_ELEMENT+this.byteOffset})}allocate(t,e=!1){const{state:n}=this,i=n.allocatedValue,r=Ea.allocate(i,t+1,{size:this.size,type:this.settings.defaultType,copy:e});this.value=r;const{buffer:s,byteOffset:o}=this;return s.byteLength<r.byteLength+o&&(s.reallocate(r.byteLength+o),e&&i&&s.subData({data:i instanceof Float64Array?Ia(i,this):i,offset:o})),n.allocatedValue=r,n.constant=!1,n.externalBuffer=null,n.bufferAccessor=this.settings,!0}_checkExternalBuffer(t){const{value:e}=t;if(!ArrayBuffer.isView(e))throw new Error("Attribute ".concat(this.id," value is not TypedArray"));const n=this.settings.defaultType;let i=!1;if(this.doublePrecision&&(i=e.BYTES_PER_ELEMENT<4),i)throw new Error("Attribute ".concat(this.id," does not support ").concat(e.constructor.name));e instanceof n||!this.settings.normalized||"normalized"in t||Xt.warn("Attribute ".concat(this.id," is normalized"))()}normalizeConstant(t){switch(this.settings.type){case 5120:return new Float32Array(t).map(t=>(t+128)/255*2-1);case 5122:return new Float32Array(t).map(t=>(t+32768)/65535*2-1);case 5121:return new Float32Array(t).map(t=>t/255);case 5123:return new Float32Array(t).map(t=>t/65535);default:return t}}_normalizeValue(t,e,n){const{defaultValue:i,size:r}=this.settings;if(Number.isFinite(t))return e[n]=t,e;if(!t){let t=r;for(;--t>=0;)e[n+t]=i[t];return e}switch(r){case 4:e[n+3]=Number.isFinite(t[3])?t[3]:i[3];case 3:e[n+2]=Number.isFinite(t[2])?t[2]:i[2];case 2:e[n+1]=Number.isFinite(t[1])?t[1]:i[1];case 1:e[n+0]=Number.isFinite(t[0])?t[0]:i[0];break;default:let s=r;for(;--s>=0;)e[n+s]=Number.isFinite(t[s])?t[s]:i[s]}return e}_areValuesEqual(t,e){if(!t||!e)return!1;const{size:n}=this;for(let i=0;i<n;i++)if(t[i]!==e[i])return!1;return!0}}const uc=[],hc=[];function dc(t,e=0,n=1/0){let i=uc;const r={index:-1,data:t,target:[]};return t?"function"==typeof t[Symbol.iterator]?i=t:t.length>0&&(hc.length=t.length,i=hc):i=uc,(e>0||Number.isFinite(n))&&(i=(Array.isArray(i)?i:Array.from(i)).slice(e,n),r.index=e-1),{iterable:i,objectInfo:r}}function fc(t){return t&&t[Symbol.asyncIterator]}function gc(t,e){const{size:n,stride:i,offset:r,startIndices:s,nested:o}=e,a=t.BYTES_PER_ELEMENT,c=i?i/a:n,l=r?r/a:0,u=Math.floor((t.length-l)/c);return(e,{index:i,target:r})=>{if(!s){const e=i*c+l;for(let i=0;i<n;i++)r[i]=t[e+i];return r}const a=s[i],h=s[i+1]||u;let d;if(o){d=new Array(h-a);for(let e=a;e<h;e++){const i=e*c+l;r=new Array(n);for(let e=0;e<n;e++)r[e]=t[i+e];d[e-a]=r}}else if(c===n)d=t.subarray(a*n+l,h*n+l);else{d=new t.constructor((h-a)*n);let e=0;for(let i=a;i<h;i++){const r=i*c+l;for(let i=0;i<n;i++)d[e++]=t[r+i]}}return d}}const pc=[],mc=[[0,1/0]];function vc(t){const{source:e,target:n,start:i=0,size:r,getData:s}=t,o=t.end||n.length,a=e.length,c=o-i;if(a>c)return void n.set(e.subarray(0,c),i);if(n.set(e,i),!s)return;let l=a;for(;l<c;){const t=s(l,e);for(let e=0;e<r;e++)n[i+l]=t[e]||0,l++}}const yc={interpolation:{duration:0,easing:t=>t},spring:{stiffness:.05,damping:.5}};function bc(t,e){if(!t)return null;Number.isFinite(t)&&(t={type:"interpolation",duration:t});const n=t.type||"interpolation";return{...yc[n],...e,...t,type:n}}function _c(t,e){const n=e.getBuffer();return n?[n,{divisor:0,size:e.size,normalized:e.settings.normalized}]:e.value}function xc(t){switch(t){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error('No defined attribute type for size "'.concat(t,'"'))}}function Pc(t){t.push(t.shift())}function wc(t,e){const{doublePrecision:n,settings:i,value:r,size:s}=t,o=n&&r instanceof Float64Array?2:1;return(i.noAlloc?r.length:e*s)*o}function Ac({buffer:t,numInstances:e,attribute:n,fromLength:i,fromStartIndices:r,getData:s=t=>t}){const o=n.doublePrecision&&n.value instanceof Float64Array?2:1,a=n.size*o,c=n.byteOffset,l=n.startIndices,u=r&&l,h=wc(n,e),d=n.isConstant;if(!u&&i>=h)return;const f=d?n.value:n.getBuffer().getData({srcByteOffset:c});if(n.settings.normalized&&!d){const t=s;s=(e,i)=>n.normalizeConstant(t(e,i))}const g=d?(t,e)=>s(f,e):(t,e)=>s(f.subarray(t,t+a),e),p=t.getData({length:i}),m=new Float32Array(h);!function({source:t,target:e,size:n,getData:i,sourceStartIndices:r,targetStartIndices:s}){if(!Array.isArray(s))return vc({source:t,target:e,size:n,getData:i}),e;let o=0,a=0;const c=i&&((t,e)=>i(t+a,e)),l=Math.min(r.length,s.length);for(let i=1;i<l;i++){const l=r[i]*n,u=s[i]*n;vc({source:t.subarray(o,l),target:e,start:a,end:u,size:n,getData:c}),o=l,a=u}a<e.length&&vc({source:[],target:e,start:a,size:n,getData:c})}({source:p,target:m,sourceStartIndices:r,targetStartIndices:l,size:a,getData:g}),t.byteLength<m.byteLength+c&&t.reallocate(m.byteLength+c),t.subData({data:m,offset:c})}class Sc extends lc{constructor(t,e){super(t,e,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,updateRanges:mc}),n(this,"constant",!1),this.settings.update=e.update||(e.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(t){this.state.startIndices=t}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:t=!1}={}){const e=this.state.needsRedraw;return this.state.needsRedraw=e&&!t,e}getUpdateTriggers(){const{accessor:t}=this.settings;return[this.id].concat("function"!=typeof t&&t||[])}supportsTransition(){return Boolean(this.settings.transition)}getTransitionSetting(t){if(!t||!this.supportsTransition())return null;const{accessor:e}=this.settings,n=this.settings.transition;return bc(Array.isArray(e)?t[e.find(e=>t[e])]:t[e],n)}setNeedsUpdate(t=this.id,e){if(this.state.needsUpdate=this.state.needsUpdate||t,this.setNeedsRedraw(t),e){const{startRow:t=0,endRow:n=1/0}=e;this.state.updateRanges=function(t,e){if(t===mc)return t;if(e[0]<0&&(e[0]=0),e[0]>=e[1])return t;const n=[],i=t.length;let r=0;for(let s=0;s<i;s++){const i=t[s];i[1]<e[0]?(n.push(i),r=s+1):i[0]>e[1]?n.push(i):e=[Math.min(i[0],e[0]),Math.max(i[1],e[1])]}return n.splice(r,0,e),n}(this.state.updateRanges,[t,n])}else this.state.updateRanges=mc}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=pc}setNeedsRedraw(t=this.id){this.state.needsRedraw=this.state.needsRedraw||t}allocate(t){const{state:e,settings:n}=this;return!n.noAlloc&&(!!n.update&&(super.allocate(t,e.updateRanges!==mc),!0))}updateBuffer({numInstances:t,data:e,props:n,context:i}){if(!this.needsUpdate())return!1;const{state:{updateRanges:r},settings:{update:s,noAlloc:o}}=this;let a=!0;if(s){for(const[o,a]of r)s.call(i,this,{data:e,startRow:o,endRow:a,props:n,numInstances:t});if(this.value)if(this.constant||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[e,n]of r){const i=Number.isFinite(e)?this.getVertexOffset(e):0,r=Number.isFinite(n)?this.getVertexOffset(n):o||!Number.isFinite(t)?this.value.length:t*this.size;super.updateSubBuffer({startOffset:i,endOffset:r})}else;this._checkAttributeArray()}else a=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),a}setConstantValue(t){if(void 0===t||"function"==typeof t)return!1;return this.setData({constant:!0,value:t})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(t){const{state:e}=this;return t?(this.clearNeedsUpdate(),e.lastExternalBuffer===t||(e.lastExternalBuffer=t,this.setNeedsRedraw(),this.setData(t)),!0):(e.lastExternalBuffer=null,!1)}setBinaryValue(t,e=null){const{state:n,settings:i}=this;if(!t)return n.binaryValue=null,n.binaryAccessor=null,!1;if(i.noAlloc)return!1;if(n.binaryValue===t)return this.clearNeedsUpdate(),!0;n.binaryValue=t,this.setNeedsRedraw();if(i.transform||e!==this.startIndices){ArrayBuffer.isView(t)&&(t={value:t});const r=t;ic(ArrayBuffer.isView(r.value),"invalid ".concat(i.accessor));const s=Boolean(r.size)&&r.size!==this.size;return n.binaryAccessor=gc(r.value,{size:r.size||this.size,stride:r.stride,offset:r.offset,startIndices:e,nested:s}),!1}return this.clearNeedsUpdate(),this.setData(t),!0}getVertexOffset(t){const{startIndices:e}=this;return(e?t<e.length?e[t]:this.numInstances:t)*this.size}getShaderAttributes(){const t=this.settings.shaderAttributes||{[this.id]:null},e={};for(const n in t)Object.assign(e,super.getShaderAttributes(n,t[n]));return e}_autoUpdater(t,{data:e,startRow:n,endRow:i,props:r,numInstances:s}){if(t.constant)return;const{settings:o,state:a,value:c,size:l,startIndices:u}=t,{accessor:h,transform:d}=o,f=a.binaryAccessor||("function"==typeof h?h:r[h]);ic("function"==typeof f,'accessor "'.concat(h,'" is not a function'));let g=t.getVertexOffset(n);const{iterable:p,objectInfo:m}=dc(e,n,i);for(const e of p){m.index++;let n=f(e,m);if(d&&(n=d.call(this,n)),u){const e=(m.index<u.length-1?u[m.index+1]:s)-u[m.index];if(n&&Array.isArray(n[0])){let e=g;for(const i of n)t._normalizeValue(i,c,e),e+=l}else n&&n.length>l?c.set(n,g):(t._normalizeValue(n,m.target,0),$a({target:c,source:m.target,start:g,count:e}));g+=e*l}else t._normalizeValue(n,c,g),g+=l}}_validateAttributeUpdaters(){const{settings:t}=this;if(!(t.noAlloc||"function"==typeof t.update))throw new Error("Attribute ".concat(this.id," missing update or accessor"))}_checkAttributeArray(){const{value:t}=this,e=Math.min(4,this.size);if(t&&t.length>=e){let n=!0;switch(e){case 4:n=n&&Number.isFinite(t[3]);case 3:n=n&&Number.isFinite(t[2]);case 2:n=n&&Number.isFinite(t[1]);case 1:n=n&&Number.isFinite(t[0]);break;default:n=!1}if(!n)throw new Error("Illegal attribute generated for ".concat(this.id))}}}const Tc="\n#define SHADER_NAME interpolation-transition-vertex-shader\n\nuniform float time;\nattribute ATTRIBUTE_TYPE aFrom;\nattribute ATTRIBUTE_TYPE aTo;\nvarying ATTRIBUTE_TYPE vCurrent;\n\nvoid main(void) {\n  vCurrent = mix(aFrom, aTo, time);\n  gl_Position = vec4(0.0);\n}\n";const Ec={interpolation:class{constructor({gl:t,attribute:e,timeline:i}){n(this,"gl",void 0),n(this,"type","interpolation"),n(this,"attributeInTransition",void 0),n(this,"settings",void 0),n(this,"attribute",void 0),n(this,"transition",void 0),n(this,"currentStartIndices",void 0),n(this,"currentLength",void 0),n(this,"transform",void 0),n(this,"buffers",void 0),this.gl=t,this.transition=new rc(i),this.attribute=e,this.attributeInTransition=new Sc(t,e.settings),this.currentStartIndices=e.startIndices,this.currentLength=0,this.transform=function(t,e){const n=xc(e.size);return new Mo(t,{vs:Tc,defines:{ATTRIBUTE_TYPE:n},varyings:["vCurrent"]})}(t,e);const r={byteLength:0,usage:35050};this.buffers=[new gn(t,r),new gn(t,r)]}get inProgress(){return this.transition.inProgress}start(t,e){if(t.duration<=0)return void this.transition.cancel();this.settings=t;const{gl:n,buffers:i,attribute:r}=this;Pc(i);const s={numInstances:e,attribute:r,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const t of i)Ac({buffer:t,...s});this.currentStartIndices=r.startIndices,this.currentLength=wc(r,e),this.attributeInTransition.setData({buffer:i[1],value:r.value}),this.transition.start(t),this.transform.update({elementCount:Math.floor(this.currentLength/r.size),sourceBuffers:{aFrom:i[0],aTo:_c(0,r)},feedbackBuffers:{vCurrent:i[1]}})}update(){const t=this.transition.update();if(t){const{duration:t,easing:e}=this.settings,{time:n}=this.transition;let i=n/t;e&&(i=e(i)),this.transform.run({uniforms:{time:i}})}return t}cancel(){this.transition.cancel(),this.transform.delete();for(const t of this.buffers)t.delete();this.buffers.length=0}},spring:class{constructor({gl:t,attribute:e,timeline:i}){n(this,"gl",void 0),n(this,"type","spring"),n(this,"attributeInTransition",void 0),n(this,"settings",void 0),n(this,"attribute",void 0),n(this,"transition",void 0),n(this,"currentStartIndices",void 0),n(this,"currentLength",void 0),n(this,"texture",void 0),n(this,"framebuffer",void 0),n(this,"transform",void 0),n(this,"buffers",void 0),this.gl=t,this.type="spring",this.transition=new rc(i),this.attribute=e,this.attributeInTransition=new Sc(t,{...e.settings,normalized:!1}),this.currentStartIndices=e.startIndices,this.currentLength=0,this.texture=function(t){return new xn(t,{data:new Uint8Array(4),format:6408,type:5121,border:0,mipmaps:!1,dataFormat:6408,width:1,height:1})}(t),this.framebuffer=function(t,e){return new ai(t,{id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,attachments:{36064:e}})}(t,this.texture),this.transform=function(t,e,n){const i=xc(e.size);return new Mo(t,{framebuffer:n,vs:"\n#define SHADER_NAME spring-transition-vertex-shader\n\n#define EPSILON 0.00001\n\nuniform float stiffness;\nuniform float damping;\nattribute ATTRIBUTE_TYPE aPrev;\nattribute ATTRIBUTE_TYPE aCur;\nattribute ATTRIBUTE_TYPE aTo;\nvarying ATTRIBUTE_TYPE vNext;\nvarying float vIsTransitioningFlag;\n\nATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {\n  ATTRIBUTE_TYPE velocity = cur - prev;\n  ATTRIBUTE_TYPE delta = dest - cur;\n  ATTRIBUTE_TYPE spring = delta * stiffness;\n  ATTRIBUTE_TYPE damper = velocity * -1.0 * damping;\n  return spring + damper + velocity + cur;\n}\n\nvoid main(void) {\n  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;\n  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;\n\n  vNext = getNextValue(aCur, aPrev, aTo);\n  gl_Position = vec4(0, 0, 0, 1);\n  gl_PointSize = 100.0;\n}\n",fs:"\n#define SHADER_NAME spring-transition-is-transitioning-fragment-shader\n\nvarying float vIsTransitioningFlag;\n\nvoid main(void) {\n  if (vIsTransitioningFlag == 0.0) {\n    discard;\n  }\n  gl_FragColor = vec4(1.0);\n}",defines:{ATTRIBUTE_TYPE:i},varyings:["vNext"]})}(t,e,this.framebuffer);const r={byteLength:0,usage:35050};this.buffers=[new gn(t,r),new gn(t,r),new gn(t,r)]}get inProgress(){return this.transition.inProgress}start(t,e){const{gl:n,buffers:i,attribute:r}=this,s={numInstances:e,attribute:r,fromLength:this.currentLength,fromStartIndices:this.currentStartIndices,getData:t.enter};for(const t of i)Ac({buffer:t,...s});this.settings=t,this.currentStartIndices=r.startIndices,this.currentLength=wc(r,e),this.attributeInTransition.setData({buffer:i[1],value:r.value}),this.transition.start({...t,duration:1/0}),this.transform.update({elementCount:Math.floor(this.currentLength/r.size),sourceBuffers:{aTo:_c(0,r)}})}update(){const{buffers:t,transform:e,framebuffer:n,transition:i}=this;if(!i.update())return!1;const r=this.settings;e.update({sourceBuffers:{aPrev:t[0],aCur:t[1]},feedbackBuffers:{vNext:t[2]}}),e.run({framebuffer:n,discard:!1,clearRenderTarget:!0,uniforms:{stiffness:r.stiffness,damping:r.damping},parameters:{depthTest:!1,blend:!0,viewport:[0,0,1,1],blendFunc:[1,1],blendEquation:[32776,32776]}}),Pc(t),this.attributeInTransition.setData({buffer:t[1],value:this.attribute.value});return On(n)[0]>0||i.end(),!0}cancel(){this.transition.cancel(),this.transform.delete();for(const t of this.buffers)t.delete();this.buffers.length=0,this.texture.delete(),this.framebuffer.delete()}}};class Cc{constructor(t,{id:e,timeline:i}){n(this,"id",void 0),n(this,"isSupported",void 0),n(this,"gl",void 0),n(this,"timeline",void 0),n(this,"transitions",void 0),n(this,"needsRedraw",void 0),n(this,"numInstances",void 0),this.id=e,this.gl=t,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1,this.isSupported=Mo.isSupported(t)}finalize(){for(const t in this.transitions)this._removeTransition(t)}update({attributes:t,transitions:e,numInstances:n}){this.numInstances=n||1;for(const n in t){const i=t[n],r=i.getTransitionSetting(e);r&&this._updateAttribute(n,i,r)}for(const n in this.transitions){const i=t[n];i&&i.getTransitionSetting(e)||this._removeTransition(n)}}hasAttribute(t){const e=this.transitions[t];return e&&e.inProgress}getAttributes(){const t={};for(const e in this.transitions){const n=this.transitions[e];n.inProgress&&(t[e]=n.attributeInTransition)}return t}run(){if(!this.isSupported||0===this.numInstances)return!1;for(const t in this.transitions){this.transitions[t].update()&&(this.needsRedraw=!0)}const t=this.needsRedraw;return this.needsRedraw=!1,t}_removeTransition(t){this.transitions[t].cancel(),delete this.transitions[t]}_updateAttribute(t,e,n){const i=this.transitions[t];let r=!i||i.type!==n.type;if(r){if(!this.isSupported)return void Xt.warn("WebGL2 not supported by this browser. Transition for ".concat(t," is disabled."))();i&&this._removeTransition(t);const s=Ec[n.type];s?this.transitions[t]=new s({attribute:e,timeline:this.timeline,gl:this.gl}):(Xt.error("unsupported transition type '".concat(n.type,"'"))(),r=!1)}(r||e.needsRedraw())&&(this.needsRedraw=!0,this.transitions[t].start(n,this.numInstances))}}const Lc="attributeManager.invalidate";class Mc{constructor(t,{id:e="attribute-manager",stats:i,timeline:r}={}){n(this,"id",void 0),n(this,"gl",void 0),n(this,"attributes",void 0),n(this,"updateTriggers",void 0),n(this,"needsRedraw",void 0),n(this,"userData",void 0),n(this,"stats",void 0),n(this,"attributeTransitionManager",void 0),n(this,"mergeBoundsMemoized",Xo(Ra)),this.id=e,this.gl=t,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new Cc(t,{id:"".concat(e,"-transitions"),timeline:r}),Object.seal(this)}finalize(){for(const t in this.attributes)this.attributes[t].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(t={clearRedrawFlags:!1}){const e=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!t.clearRedrawFlags,e&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(t){this._add(t)}addInstanced(t){this._add(t,{instanced:1})}remove(t){for(const e of t)void 0!==this.attributes[e]&&(this.attributes[e].delete(),delete this.attributes[e])}invalidate(t,e){const n=this._invalidateTrigger(t,e);Yt(Lc,this,t,n)}invalidateAll(t){for(const e in this.attributes)this.attributes[e].setNeedsUpdate(e,t);Yt(Lc,this,"all")}update({data:t,numInstances:e,startIndices:n=null,transitions:i,props:r={},buffers:s={},context:o={}}){let a=!1;Yt("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const i in this.attributes){const c=this.attributes[i],l=c.settings.accessor;c.startIndices=n,c.numInstances=e,r[i]&&Xt.removed("props.".concat(i),"data.attributes.".concat(i))(),c.setExternalBuffer(s[i])||c.setBinaryValue("string"==typeof l?s[l]:void 0,t.startIndices)||"string"==typeof l&&!s[l]&&c.setConstantValue(r[l])||c.needsUpdate()&&(a=!0,this._updateAttribute({attribute:c,numInstances:e,data:t,props:r,context:o})),this.needsRedraw=this.needsRedraw||c.needsRedraw()}a&&Yt("attributeManager.updateEnd",this,e),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:e,transitions:i})}updateTransition(){const{attributeTransitionManager:t}=this,e=t.run();return this.needsRedraw=this.needsRedraw||e,e}getAttributes(){return this.attributes}getBounds(t){const e=t.map(t=>{var e;return null===(e=this.attributes[t])||void 0===e?void 0:e.getBounds()});return this.mergeBoundsMemoized(e)}getChangedAttributes(t={clearChangedFlags:!1}){const{attributes:e,attributeTransitionManager:n}=this,i={...n.getAttributes()};for(const r in e){const s=e[r];s.needsRedraw(t)&&!n.hasAttribute(r)&&(i[r]=s)}return i}getShaderAttributes(t,e={}){t||(t=this.getAttributes());const n={};for(const i in t)e[i]||Object.assign(n,t[i].getShaderAttributes());return n}_add(t,e={}){for(const n in t){const i=t[n];this.attributes[n]=this._createAttribute(n,i,e)}this._mapUpdateTriggersToAttributes()}_createAttribute(t,e,n){const i={...e,id:t,size:(e.isIndexed?1:e.size)||1,divisor:n.instanced?1:e.divisor||0};return new Sc(this.gl,i)}_mapUpdateTriggersToAttributes(){const t={};for(const e in this.attributes){this.attributes[e].getUpdateTriggers().forEach(n=>{t[n]||(t[n]=[]),t[n].push(e)})}this.updateTriggers=t}_invalidateTrigger(t,e){const{attributes:n,updateTriggers:i}=this,r=i[t];return r&&r.forEach(t=>{const i=n[t];i&&i.setNeedsUpdate(i.id,e)}),r}_updateAttribute(t){const{attribute:e,numInstances:n}=t;if(Yt("attribute.updateStart",e),e.constant)return void e.setConstantValue(e.value);e.allocate(n)&&Yt("attribute.allocate",e,n);e.updateBuffer(t)&&(this.needsRedraw=!0,Yt("attribute.updateEnd",e,n))}}const Oc=1e-5;function Ic(t,e,n,i,r){const s=e-t;return(n-e)*r+-s*i+s+e}function Rc(t,e){if(Array.isArray(t)){let n=0;for(let i=0;i<t.length;i++){const r=t[i]-e[i];n+=r*r}return Math.sqrt(n)}return Math.abs(t-e)}const Fc={interpolation:class extends rc{get value(){return this._value}_onUpdate(){const{time:t,settings:{fromValue:e,toValue:n,duration:i,easing:r}}=this,s=r(t/i);this._value=_s(e,n,s)}},spring:class extends rc{get value(){return this._currValue}_onUpdate(){const{fromValue:t,toValue:e,damping:n,stiffness:i}=this.settings,{_prevValue:r=t,_currValue:s=t}=this;let o=function(t,e,n,i,r){if(Array.isArray(n)){const s=[];for(let o=0;o<n.length;o++)s[o]=Ic(t[o],e[o],n[o],i,r);return s}return Ic(t,e,n,i,r)}(r,s,e,n,i);const a=Rc(o,e),c=Rc(o,s);a<Oc&&c<Oc&&(o=e,this.end()),this._prevValue=s,this._currValue=o}}};class zc{constructor(t){this.transitions=new Map,this.timeline=t}get active(){return this.transitions.size>0}add(t,e,n,i){const{transitions:r}=this;if(r.has(t)){const n=r.get(t),{value:i=n.settings.fromValue}=n;e=i,this.remove(t)}if(!(i=bc(i)))return;const s=Fc[i.type];if(!s)return void Xt.error("unsupported transition type '".concat(i.type,"'"))();const o=new s(this.timeline);o.start({...i,fromValue:e,toValue:n}),r.set(t,o)}remove(t){const{transitions:e}=this;e.has(t)&&(e.get(t).cancel(),e.delete(t))}update(){const t={};for(const[e,n]of this.transitions)n.update(),t[e]=n.value,n.inProgress||this.remove(e);return t}clear(){for(const t of this.transitions.keys())this.remove(t)}}function kc(t,e){const n=Bc({newProps:t,oldProps:e,propTypes:t[Xa],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),i=function(t,e){if(null===e)return"oldProps is null, initial diff";let n=!1;const{dataComparator:i,_dataDiff:r}=t;i?i(t.data,e.data)||(n="Data comparator detected a change"):t.data!==e.data&&(n="A new data container was supplied");n&&r&&(n=r(t.data,e.data)||n);return n}(t,e);let r=!1;return i||(r=function(t,e){if(null===e)return{all:!0};if("all"in t.updateTriggers){if(Uc(t,e,"all"))return{all:!0}}const n={};let i=!1;for(const r in t.updateTriggers)if("all"!==r){Uc(t,e,r)&&(n[r]=!0,i=!0)}return!!i&&n}(t,e)),{dataChanged:i,propsChanged:n,updateTriggersChanged:r,extensionsChanged:Nc(t,e),transitionsChanged:jc(t,e)}}function jc(t,e){if(!t.transitions)return!1;const n={},i=t[Xa];let r=!1;for(const s in t.transitions){const o=i[s],a=o&&o.type;("number"===a||"color"===a||"array"===a)&&Dc(t[s],e[s],o)&&(n[s]=!0,r=!0)}return!!r&&n}function Bc({newProps:t,oldProps:e,ignoreProps:n={},propTypes:i={},triggerName:r="props"}){if(e===t)return!1;if("object"!=typeof t||null===t)return"".concat(r," changed shallowly");if("object"!=typeof e||null===e)return"".concat(r," changed shallowly");for(const s of Object.keys(t))if(!(s in n)){if(!(s in e))return"".concat(r,".").concat(s," added");const n=Dc(t[s],e[s],i[s]);if(n)return"".concat(r,".").concat(s," ").concat(n)}for(const s of Object.keys(e))if(!(s in n)){if(!(s in t))return"".concat(r,".").concat(s," dropped");if(!Object.hasOwnProperty.call(t,s)){const n=Dc(t[s],e[s],i[s]);if(n)return"".concat(r,".").concat(s," ").concat(n)}}return!1}function Dc(t,e,n){let i=n&&n.equal;return i&&!i(t,e,n)?"changed deeply":i||(i=t&&e&&t.equals,!i||i.call(t,e))?i||e===t?null:"changed shallowly":"changed deeply"}function Nc(t,e){if(null===e)return!0;const n=e.extensions,{extensions:i}=t;if(i===n)return!1;if(!n||!i)return!0;if(i.length!==n.length)return!0;for(let t=0;t<i.length;t++)if(!i[t].equals(n[t]))return!0;return!1}function Uc(t,e,n){let i=t.updateTriggers[n];i=null==i?{}:i;let r=e.updateTriggers[n];r=null==r?{}:r;return Bc({oldProps:r,newProps:i,triggerName:n})}function Vc(t){if(null===(e=t)||"object"!=typeof e)throw new Error("count(): argument not an object");var e;if("function"==typeof t.count)return t.count();if(Number.isFinite(t.size))return t.size;if(Number.isFinite(t.length))return t.length;if(function(t){return null!==t&&"object"==typeof t&&t.constructor===Object}(t))return Object.keys(t).length;throw new Error("count(): argument not a container")}function Gc(t,e){if(!e)return t;const n={...t,...e};if("defines"in e&&(n.defines={...t.defines,...e.defines}),"modules"in e&&(n.modules=(t.modules||[]).concat(e.modules),e.modules.some(t=>"project64"===t.name))){const t=n.modules.findIndex(t=>"project32"===t.name);t>=0&&n.modules.splice(t,1)}if("inject"in e)if(t.inject){const i={...t.inject};for(const t in e.inject)i[t]=(i[t]||"")+e.inject[t];n.inject=i}else n.inject=e.inject;return n}const Wc={10241:9987,10240:9729,10242:33071,10243:33071},Hc={};const Xc={boolean:{validate:(t,e)=>!0,equal:(t,e,n)=>Boolean(t)===Boolean(e)},number:{validate:(t,e)=>Number.isFinite(t)&&(!("max"in e)||t<=e.max)&&(!("min"in e)||t>=e.min)},color:{validate:(t,e)=>e.optional&&!t||Kc(t)&&(3===t.length||4===t.length),equal:(t,e,n)=>nc(t,e,1)},accessor:{validate(t,e){const n=qc(t);return"function"===n||n===qc(e.value)},equal:(t,e,n)=>"function"==typeof e||nc(t,e,1)},array:{validate:(t,e)=>e.optional&&!t||Kc(t),equal(t,e,n){const{compare:i}=n,r=Number.isInteger(i)?i:i?1:0;return i?nc(t,e,r):t===e}},object:{equal(t,e,n){if(n.ignore)return!0;const{compare:i}=n,r=Number.isInteger(i)?i:i?1:0;return i?nc(t,e,r):t===e}},function:{validate:(t,e)=>e.optional&&!t||"function"==typeof t,equal:(t,e,n)=>!n.compare&&!1!==n.ignore||t===e},data:{transform:(t,e,n)=>{const{dataTransform:i}=n.props;return i&&t?i(t):t}},image:{transform:(t,e,n)=>{const i=n.context;return i&&i.gl?function(t,e,n,i){if(n instanceof xn)return n;n.constructor&&"Object"!==n.constructor.name&&(n={data:n});let r=null;n.compressed&&(r={10241:n.data.length>1?9985:9729});const s=new xn(e,{...n,parameters:{...Wc,...r,...i}});return Hc[s.id]=t,s}(n.id,i.gl,t,{...e.parameters,...n.props.textureParameters}):null},release:(t,e,n)=>{var i,r;i=n.id,(r=t)&&r instanceof xn&&Hc[r.id]===i&&(r.delete(),delete Hc[r.id])}}};function Zc(t,e){switch(qc(e)){case"object":return Yc(t,e);case"array":return Yc(t,{type:"array",value:e,compare:!1});case"boolean":return Yc(t,{type:"boolean",value:e});case"number":return Yc(t,{type:"number",value:e});case"function":return Yc(t,{type:"function",value:e,compare:!0});default:return{name:t,type:"unknown",value:e}}}function Yc(t,e){return"type"in e?{name:t,...Xc[e.type],...e}:"value"in e?{name:t,type:qc(e.value),...e}:{name:t,type:"object",value:e}}function Kc(t){return Array.isArray(t)||ArrayBuffer.isView(t)}function qc(t){return Kc(t)?"array":null===t?"null":typeof t}const Jc="_mergedDefaultProps";function Qc(t,e){let n=Jc;if(e)for(const t of e){const e=t.constructor;e&&(n+=":".concat(e.extensionName||e.name))}const i=el(t,n);return i||(t[n]=function(t,e){const n=t.prototype;if(!n)return null;const i=Object.getPrototypeOf(t),r=Qc(i),s=el(t,"defaultProps")||{},o=function(t){const e={},n={},i={};for(const[r,s]of Object.entries(t)){const t=null==s?void 0:s.deprecatedFor;if(t)i[r]=Array.isArray(t)?t:[t];else{const t=Zc(r,s);e[r]=t,n[r]=t.value}}return{propTypes:e,defaultProps:n,deprecatedProps:i}}(s),a=Object.assign(Object.create(null),r,o.defaultProps),c=Object.assign(Object.create(null),null==r?void 0:r[Xa],o.propTypes),l=Object.assign(Object.create(null),null==r?void 0:r[Za],o.deprecatedProps);for(const t of e){const e=Qc(t.constructor);e&&(Object.assign(a,e),Object.assign(c,e[Xa]),Object.assign(l,e[Za]))}(function(t,e){const n=function(t){const e=t.componentName;e||Xt.warn("".concat(t.name,".componentName not specified"))();return e||t.name}(e);Object.defineProperties(t,{id:{writable:!0,value:n}})})(a,t),function(t,e){const n={},i={};for(const t in e){const r=e[t],{name:s,value:o}=r;r.async&&(n[s]=o,i[s]=$c(s))}t[Ya]=n,t[Ka]={},Object.defineProperties(t,i)}(a,c),function(t,e){for(const n in e)Object.defineProperty(t,n,{enumerable:!1,set(t){const i="".concat(this.id,": ").concat(n);for(const i of e[n])tl(this,i)||(this[i]=t);Xt.deprecated(i,e[n].join("/"))()}})}(a,l),a[Xa]=c,a[Za]=l,0!==e.length||tl(t,"_propTypes")||(t._propTypes=c);return a}(t,e||[]))}function $c(t){return{enumerable:!0,set(e){"string"==typeof e||e instanceof Promise||fc(e)?this[Ka][t]=e:this[qa][t]=e},get(){if(this[qa]){if(t in this[qa]){return this[qa][t]||this[Ya][t]}if(t in this[Ka]){const e=this[Ha]&&this[Ha].internalState;if(e&&e.hasAsyncProp(t))return e.getAsyncProp(t)||this[Ya][t]}}return this[Ya][t]}}}function tl(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function el(t,e){return tl(t,e)&&t[e]}let nl=0;class il{constructor(...t){n(this,"id",void 0),n(this,"props",void 0),n(this,"count",void 0),this.props=function(t,e){let n;for(let t=e.length-1;t>=0;t--){const i=e[t];"extensions"in i&&(n=i.extensions)}const i=Qc(t.constructor,n),r=Object.create(i);r[Ha]=t,r[Ka]={},r[qa]={};for(let t=0;t<e.length;++t){const n=e[t];for(const t in n)r[t]=n[t]}return Object.freeze(r),r}(this,t),this.id=this.props.id,this.count=nl++}clone(t){const{props:e}=this,n={};for(const t in e[Ya])t in e[qa]?n[t]=e[qa][t]:t in e[Ka]&&(n[t]=e[Ka][t]);return new this.constructor({...e,...n,...t})}}n(il,"componentName","Component"),n(il,"defaultProps",{});const rl=Object.freeze({});class sl{constructor(t){n(this,"component",void 0),n(this,"onAsyncPropUpdated",void 0),n(this,"asyncProps",void 0),n(this,"oldProps",void 0),n(this,"oldAsyncProps",void 0),this.component=t,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const t in this.asyncProps){const e=this.asyncProps[t];e&&e.type&&e.type.release&&e.type.release(e.resolvedValue,e.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||rl}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(t){return t in this.asyncProps}getAsyncProp(t){const e=this.asyncProps[t];return e&&e.resolvedValue}isAsyncPropLoading(t){if(t){const e=this.asyncProps[t];return Boolean(e&&e.pendingLoadCount>0&&e.pendingLoadCount!==e.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(t,e){this._watchPromise(t,Promise.resolve(e))}setAsyncProps(t){this.component=t[Ha]||this.component;const e=t[qa]||{},n=t[Ka]||t,i=t[Ya]||{};for(const t in e){const n=e[t];this._createAsyncPropData(t,i[t]),this._updateAsyncProp(t,n),e[t]=this.getAsyncProp(t)}for(const t in n){const e=n[t];this._createAsyncPropData(t,i[t]),this._updateAsyncProp(t,e)}}_fetch(t,e){return null}_onResolve(t,e){}_onError(t,e){}_updateAsyncProp(t,e){this._didAsyncInputValueChange(t,e)&&("string"==typeof e&&(e=this._fetch(t,e)),e instanceof Promise?this._watchPromise(t,e):fc(e)?this._resolveAsyncIterable(t,e):this._setPropValue(t,e))}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const t in this.asyncProps)Object.defineProperty(this.oldAsyncProps,t,{enumerable:!0,value:this.oldProps[t]})}}_didAsyncInputValueChange(t,e){const n=this.asyncProps[t];return e!==n.resolvedValue&&e!==n.lastValue&&(n.lastValue=e,!0)}_setPropValue(t,e){this._freezeAsyncOldProps();const n=this.asyncProps[t];n&&(e=this._postProcessValue(n,e),n.resolvedValue=e,n.pendingLoadCount++,n.resolvedLoadCount=n.pendingLoadCount)}_setAsyncPropValue(t,e,n){const i=this.asyncProps[t];i&&n>=i.resolvedLoadCount&&void 0!==e&&(this._freezeAsyncOldProps(),i.resolvedValue=e,i.resolvedLoadCount=n,this.onAsyncPropUpdated(t,e))}_watchPromise(t,e){const n=this.asyncProps[t];if(n){n.pendingLoadCount++;const i=n.pendingLoadCount;e.then(e=>{this.component&&(e=this._postProcessValue(n,e),this._setAsyncPropValue(t,e,i),this._onResolve(t,e))}).catch(e=>{this._onError(t,e)})}}async _resolveAsyncIterable(t,e){if("data"!==t)return void this._setPropValue(t,e);const n=this.asyncProps[t];if(!n)return;n.pendingLoadCount++;const i=n.pendingLoadCount;let r=[],s=0;for await(const n of e){if(!this.component)return;const{dataTransform:e}=this.component.props;r=e?e(n,r):r.concat(n),Object.defineProperty(r,"__diff",{enumerable:!1,value:[{startRow:s,endRow:r.length}]}),s=r.length,this._setAsyncPropValue(t,r,i)}this._onResolve(t,r)}_postProcessValue(t,e){const n=t.type;return n&&this.component&&(n.release&&n.release(t.resolvedValue,n,this.component),n.transform)?n.transform(e,n,this.component):e}_createAsyncPropData(t,e){if(!this.asyncProps[t]){const n=this.component&&this.component.props[Xa];this.asyncProps[t]={type:n&&n[t],lastValue:null,resolvedValue:e,pendingLoadCount:0,resolvedLoadCount:0}}}}class ol extends sl{constructor({attributeManager:t,layer:e}){super(e),n(this,"attributeManager",void 0),n(this,"needsRedraw",void 0),n(this,"needsUpdate",void 0),n(this,"subLayers",void 0),n(this,"usesPickingColorCache",void 0),n(this,"hasPickingBuffer",void 0),n(this,"changeFlags",void 0),n(this,"viewport",void 0),n(this,"uniformTransitions",void 0),n(this,"propsInTransition",void 0),this.attributeManager=t,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(t,e){const n=this.layer,i=null==n?void 0:n.props.fetch;return i?i(e,{propName:t,layer:n}):super._fetch(t,e)}_onResolve(t,e){const n=this.layer;if(n){const i=n.props.onDataLoad;"data"===t&&i&&i(e,{propName:t,layer:n})}}_onError(t,e){const n=this.layer;n&&n.raiseError(e,"loading ".concat(t," of ").concat(this.layer))}}const al=2**24-1,cl=Object.freeze([]),ll=Xo(({oldViewport:t,viewport:e})=>t.equals(e));let ul=new Uint8ClampedArray(0);const hl={data:{type:"data",value:cl,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:t=>t&&t.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(t,{propName:e,layer:n,loaders:i,loadOptions:r,signal:s})=>{const{resourceManager:o}=n.context;var a;(r=r||n.getLoadOptions(),i=i||n.props.loaders,s)&&(r={...r,fetch:{...null===(a=r)||void 0===a?void 0:a.fetch,signal:s}});let c=o.contains(t);return c||r||(o.add({resourceId:t,data:Ht(t,i),persistent:!1}),c=!0),c?o.subscribe({resourceId:t,onChange:t=>{var i;return null===(i=n.internalState)||void 0===i?void 0:i.reloadAsyncProp(e,t)},consumerId:n.id,requestId:e}):Ht(t,i,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:Kt.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:t})=>[0,100*-t]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class dl extends il{constructor(...t){super(...t),n(this,"internalState",null),n(this,"lifecycle",Wa),n(this,"context",void 0),n(this,"state",void 0),n(this,"parent",null)}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let t=this;for(;t.parent;)t=t.parent;return t}toString(){const t=this.constructor.layerName||this.constructor.name;return"".concat(t,"({id: '").concat(this.props.id,"'})")}project(t){ic(this.internalState);const e=this.internalState.viewport||this.context.viewport,n=Va(t,{viewport:e,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[i,r,s]=Pa(n,e.pixelProjectionMatrix);return 2===t.length?[i,r]:[i,r,s]}unproject(t){ic(this.internalState);return(this.internalState.viewport||this.context.viewport).unproject(t)}projectPosition(t,e){ic(this.internalState);return Ga(t,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...e})}get isComposite(){return!1}setState(t){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,t),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){return this.state&&(this.state.models||this.state.model&&[this.state.model])||[]}setModuleParameters(t){for(const e of this.getModels())e.updateModuleSettings(t)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:t}=this.props;return t===Kt.DEFAULT||t===Kt.LNGLAT||t===Kt.CARTESIAN}onHover(t,e){return this.props.onHover&&this.props.onHover(t,e)||!1}onClick(t,e){return this.props.onClick&&this.props.onClick(t,e)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(t,e=[]){return e[0]=t+1&255,e[1]=t+1>>8&255,e[2]=t+1>>8>>8&255,e}decodePickingColor(t){ic(t instanceof Uint8Array);const[e,n,i]=t;return e+256*n+65536*i-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&void 0!==this.state.numInstances?this.state.numInstances:Vc(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){var t;return null===(t=this.getAttributeManager())||void 0===t?void 0:t.getBounds(["positions","instancePositions"])}getShaders(t){for(const e of this.props.extensions)t=Gc(t,e.getShaders.call(this,e));return t}shouldUpdateState(t){return t.changeFlags.propsOrDataChanged}updateState(t){const e=this.getAttributeManager(),{dataChanged:n}=t.changeFlags;if(n&&e)if(Array.isArray(n))for(const t of n)e.invalidateAll(t);else e.invalidateAll();if(e){const{props:n}=t,i=this.internalState.hasPickingBuffer,r=Number.isInteger(n.highlightedObjectIndex)||n.pickable||n.extensions.some(t=>t.getNeedsPickingBuffer.call(this,t));if(i!==r){this.internalState.hasPickingBuffer=r;const{pickingColors:t,instancePickingColors:n}=e.attributes,i=t||n;i&&(r&&i.constant&&(i.constant=!1,e.invalidate(i.id)),i.value||r||(i.constant=!0,i.value=[0,0,0]))}}}finalizeState(t){for(const t of this.getModels())t.delete();const e=this.getAttributeManager();e&&e.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(t){for(const e of this.getModels())e.draw(t)}getPickingInfo({info:t,mode:e,sourceLayer:n}){const{index:i}=t;return i>=0&&Array.isArray(this.props.data)&&(t.object=this.props.data[i]),t}raiseError(t,e){var n,i,r,s;(e&&(t=new Error("".concat(e,": ").concat(t.message),{cause:t})),null!==(n=(i=this.props).onError)&&void 0!==n&&n.call(i,t))||(null===(r=this.context)||void 0===r||null===(s=r.onError)||void 0===s||s.call(r,t,this))}getNeedsRedraw(t={clearRedrawFlags:!1}){return this._getNeedsRedraw(t)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){var t;return(null===(t=this.internalState)||void 0===t?void 0:t.uniformTransitions.active)||!1}activateViewport(t){if(!this.internalState)return;const e=this.internalState.viewport;this.internalState.viewport=t,e&&ll({oldViewport:e,viewport:t})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(t="all"){const e=this.getAttributeManager();e&&("all"===t?e.invalidateAll():e.invalidate(t))}updateAttributes(t){for(const e of this.getModels())this._setModelAttributes(e,t)}_updateAttributes(){const t=this.getAttributeManager();if(!t)return;const e=this.props,n=this.getNumInstances(),i=this.getStartIndices();t.update({data:e.data,numInstances:n,startIndices:i,props:e,transitions:e.transitions,buffers:e.data.attributes,context:this});const r=t.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(r)}_updateAttributeTransition(){const t=this.getAttributeManager();t&&t.updateTransition()}_updateUniformTransition(){const{uniformTransitions:t}=this.internalState;if(t.active){const e=t.update(),n=Object.create(this.props);for(const t in e)Object.defineProperty(n,t,{value:e[t]});return n}return this.props}calculateInstancePickingColors(t,{numInstances:e}){if(t.constant)return;const n=Math.floor(ul.length/3);if(this.internalState.usesPickingColorCache=!0,n<e){e>al&&Xt.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),ul=Ea.allocate(ul,e,{size:3,copy:!0,maxCount:Math.max(e,al)});const t=Math.floor(ul.length/3),i=[];for(let e=n;e<t;e++)this.encodePickingColor(e,i),ul[3*e+0]=i[0],ul[3*e+1]=i[1],ul[3*e+2]=i[2]}t.value=ul.subarray(0,3*e)}_setModelAttributes(t,e){const n=this.getAttributeManager(),i=t.userData.excludeAttributes||{},r=n.getShaderAttributes(e,i);t.setAttributes(r)}disablePickingIndex(t){const e=this.props.data;if(!("attributes"in e))return void this._disablePickingIndex(t);const{pickingColors:n,instancePickingColors:i}=this.getAttributeManager().attributes,r=n||i,s=r&&e.attributes&&e.attributes[r.id];if(s&&s.value){const n=s.value,i=this.encodePickingColor(t);for(let t=0;t<e.length;t++){const e=r.getVertexOffset(t);n[e]===i[0]&&n[e+1]===i[1]&&n[e+2]===i[2]&&this._disablePickingIndex(t)}}else this._disablePickingIndex(t)}_disablePickingIndex(t){const{pickingColors:e,instancePickingColors:n}=this.getAttributeManager().attributes,i=e||n;if(!i)return;const r=i.getVertexOffset(t),s=i.getVertexOffset(t+1);i.buffer.subData({data:new Uint8Array(s-r),offset:r})}restorePickingColors(){const{pickingColors:t,instancePickingColors:e}=this.getAttributeManager().attributes,n=t||e;n&&(this.internalState.usesPickingColorCache&&n.value.buffer!==ul.buffer&&(n.value=ul.subarray(0,n.value.length)),n.updateSubBuffer({startOffset:0}))}_initialize(){ic(!this.internalState),ic(Number.isFinite(this.props.coordinateSystem)),Yt("layer.initialize",this);const t=this._getAttributeManager();t&&t.addInstanced({instancePickingColors:{type:5121,size:3,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new ol({attributeManager:t,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(Xt.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),t)}),this.internalState.uniformTransitions=new zc(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(t){Yt("layer.matched",this,this===t);const{state:e,internalState:n}=t;this!==t&&(this.internalState=n,this.state=e,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const t=this.needsUpdate();if(Yt("layer.update",this,t),!t)return;const e=this.props,n=this.context,i=this.internalState,r=n.viewport,s=this._updateUniformTransition();i.propsInTransition=s,n.viewport=i.viewport||r,this.props=s;try{const t=this._getUpdateParams(),e=this.getModels();if(n.gl)this.updateState(t);else try{this.updateState(t)}catch(t){}for(const e of this.props.extensions)e.updateState.call(this,t,e);const i=this.getModels()[0]!==e[0];this._postUpdate(t,i)}finally{n.viewport=r,this.props=e,this._clearChangeFlags(),i.needsUpdate=!1,i.resetOldProps()}}_finalize(){Yt("layer.finalize",this),this.finalizeState(this.context);for(const t of this.props.extensions)t.finalizeState.call(this,this.context,t)}_drawLayer({moduleParameters:t=null,uniforms:e={},parameters:n={}}){this._updateAttributeTransition();const i=this.props,r=this.context;this.props=this.internalState.propsInTransition||i;const s=this.props.opacity;e.opacity=Math.pow(s,1/2.2);try{t&&this.setModuleParameters(t);const{getPolygonOffset:i}=this.props,s=i&&i(e)||[0,0];Ge(r.gl,{polygonOffset:s}),We(r.gl,n,()=>{const i={moduleParameters:t,uniforms:e,parameters:n,context:r};for(const t of this.props.extensions)t.draw.call(this,i,t);this.draw(i)})}finally{this.props=i}}getChangeFlags(){var t;return null===(t=this.internalState)||void 0===t?void 0:t.changeFlags}setChangeFlags(t){if(!this.internalState)return;const{changeFlags:e}=this.internalState;for(const n in t)if(t[n]){let i=!1;if("dataChanged"===n){const r=t[n],s=e[n];r&&Array.isArray(s)&&(e.dataChanged=Array.isArray(r)?s.concat(r):r,i=!0)}e[n]||(e[n]=t[n],i=!0),i&&Yt("layer.changeFlag",this,n,t)}const n=Boolean(e.dataChanged||e.updateTriggersChanged||e.propsChanged||e.extensionsChanged);e.propsOrDataChanged=n,e.somethingChanged=n||e.viewportChanged||e.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(t,e){const n=kc(t,e);if(n.updateTriggersChanged)for(const t in n.updateTriggersChanged)n.updateTriggersChanged[t]&&this.invalidateAttribute(t);if(n.transitionsChanged)for(const r in n.transitionsChanged){var i;this.internalState.uniformTransitions.add(r,e[r],t[r],null===(i=t.transitions)||void 0===i?void 0:i[r])}return this.setChangeFlags(n)}validateProps(){!function(t){const e=t[Xa];for(const n in e){const i=e[n],{validate:r}=i;if(r&&!r(t[n],i))throw new Error("Invalid prop ".concat(n,": ").concat(t[n]))}}(this.props)}updateAutoHighlight(t){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(t)}_updateAutoHighlight(t){const e={pickingSelectedColor:t.picked?t.color:null},{highlightColor:n}=this.props;t.picked&&"function"==typeof n&&(e.pickingHighlightColor=n(t)),this.setModuleParameters(e),this.setNeedsRedraw()}_getAttributeManager(){const t=this.context;return new Mc(t.gl,{id:this.props.id,stats:t.stats,timeline:t.timeline})}_postUpdate(t,e){const{props:n,oldProps:i}=t;this.setNeedsRedraw(),this._updateAttributes();const{model:r}=this.state;null==r||r.setInstanceCount(this.getNumInstances());const{autoHighlight:s,highlightedObjectIndex:o,highlightColor:a}=n;if(e||i.autoHighlight!==s||i.highlightedObjectIndex!==o||i.highlightColor!==a){const t={};s||(t.pickingSelectedColor=null),Array.isArray(a)&&(t.pickingHighlightColor=a),(e||o!==i.highlightedObjectIndex)&&(t.pickingSelectedColor=Number.isFinite(o)&&o>=0?this.encodePickingColor(o):null),this.setModuleParameters(t)}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(t){if(!this.internalState)return!1;let e=!1;e=e||this.internalState.needsRedraw&&this.id;const n=this.getAttributeManager(),i=!!n&&n.getNeedsRedraw(t);if(e=e||i,e)for(const t of this.props.extensions)t.onNeedsRedraw.call(this,t);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!t.clearRedrawFlags,e}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}n(dl,"defaultProps",hl),n(dl,"layerName","Layer");class fl extends dl{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(t=>t.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(t){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){const{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id?(t.object=e.__source.object,t.index=e.__source.index,t):t}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){const{_subLayerProps:n}=this.props;return n&&n[t]&&n[t].type||e}getSubLayerRow(t,e,n){return t.__source={parent:this,object:e,index:n},t}getSubLayerAccessor(t){if("function"==typeof t){const e={index:-1,data:this.props.data,target:[]};return(n,i)=>n&&n.__source?(e.index=n.__source.index,t(n.__source.object,e)):t(n,i)}return t}getSubLayerProps(t={}){var e;const{opacity:n,pickable:i,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:d,positionFormat:f,modelMatrix:g,extensions:p,fetch:m,operation:v,_subLayerProps:y}=this.props,b={id:"",updateTriggers:{},opacity:n,pickable:i,visible:r,parameters:s,getPolygonOffset:o,highlightedObjectIndex:a,autoHighlight:c,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:d,positionFormat:f,modelMatrix:g,extensions:p,fetch:m,operation:v},_=y&&t.id&&y[t.id],x=_&&_.updateTriggers,P=t.id||"sublayer";if(_){const e=this.props[Xa],n=t.type?t.type._propTypes:{};for(const t in _){const i=n[t]||e[t];i&&"accessor"===i.type&&(_[t]=this.getSubLayerAccessor(_[t]))}}Object.assign(b,t,_),b.id="".concat(this.props.id,"-").concat(P),b.updateTriggers={all:null===(e=this.props.updateTriggers)||void 0===e?void 0:e.all,...t.updateTriggers,...x};for(const t of p){const e=t.getSubLayerProps.call(this,t);e&&Object.assign(b,e,{updateTriggers:Object.assign(b.updateTriggers,e.updateTriggers)})}return b}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_postUpdate(t,e){let n=this.internalState.subLayers;const i=!n||this.needsUpdate();if(i){n=Ja(this.renderLayers(),Boolean),this.internalState.subLayers=n}Yt("compositeLayer.renderLayers",this,i,n);for(const t of n)t.parent=this}}n(fl,"layerName","CompositeLayer");class gl{constructor(t){n(this,"opts",void 0),n(this,"typedArrayManager",void 0),n(this,"indexStarts",[0]),n(this,"vertexStarts",[0]),n(this,"vertexCount",0),n(this,"instanceCount",0),n(this,"attributes",void 0),n(this,"_attributeDefs",void 0),n(this,"data",void 0),n(this,"getGeometry",void 0),n(this,"geometryBuffer",void 0),n(this,"buffers",void 0),n(this,"positionSize",void 0),n(this,"normalize",void 0);const{attributes:e={}}=t;this.typedArrayManager=Ea,this.attributes={},this._attributeDefs=e,this.opts=t,this.updateGeometry(t)}updateGeometry(t){Object.assign(this.opts,t);const{data:e,buffers:n={},getGeometry:i,geometryBuffer:r,positionFormat:s,dataChanged:o,normalize:a=!0}=this.opts;if(this.data=e,this.getGeometry=i,this.positionSize=r&&r.size||("XY"===s?2:3),this.buffers=n,this.normalize=a,r&&(ic(e.startIndices),this.getGeometry=this.getGeometryFromBuffer(r),a||(n.positions=r)),this.geometryBuffer=n.positions,Array.isArray(o))for(const t of o)this._rebuildGeometry(t);else this._rebuildGeometry()}updatePartialGeometry({startRow:t,endRow:e}){this._rebuildGeometry({startRow:t,endRow:e})}getGeometryFromBuffer(t){const e=t.value||t;return ArrayBuffer.isView(e)?gc(e,{size:this.positionSize,offset:t.offset,stride:t.stride,startIndices:this.data.startIndices}):null}_allocate(t,e){const{attributes:n,buffers:i,_attributeDefs:r,typedArrayManager:s}=this;for(const o in r)if(o in i)s.release(n[o]),n[o]=null;else{const i=r[o];i.copy=e,n[o]=s.allocate(n[o],t,i)}}_forEachGeometry(t,e,n){const{data:i,getGeometry:r}=this,{iterable:s,objectInfo:o}=dc(i,e,n);for(const e of s){o.index++;t(r?r(e,o):null,o.index)}}_rebuildGeometry(t){if(!this.data)return;let{indexStarts:e,vertexStarts:n,instanceCount:i}=this;const{data:r,geometryBuffer:s}=this,{startRow:o=0,endRow:a=1/0}=t||{},c={};if(t||(e=[0],n=[0]),this.normalize||!s)this._forEachGeometry((t,e)=>{const i=t&&this.normalizeGeometry(t);c[e]=i,n[e+1]=n[e]+(i?this.getGeometrySize(i):0)},o,a),i=n[n.length-1];else if(n=r.startIndices,i=n[r.length]||0,ArrayBuffer.isView(s))i=i||s.length/this.positionSize;else if(s instanceof gn){const t=s.accessor.stride||4*this.positionSize;i=i||s.byteLength/t}else if(s.buffer){const t=s.stride||4*this.positionSize;i=i||s.buffer.byteLength/t}else if(s.value){const t=s.value,e=s.stride/t.BYTES_PER_ELEMENT||this.positionSize;i=i||t.length/e}this._allocate(i,Boolean(t)),this.indexStarts=e,this.vertexStarts=n,this.instanceCount=i;const l={};this._forEachGeometry((t,r)=>{const s=c[r]||t;l.vertexStart=n[r],l.indexStart=e[r];const o=r<n.length-1?n[r+1]:i;l.geometrySize=o-n[r],l.geometryIndex=r,this.updateGeometryAttributes(s,l)},o,a),this.vertexCount=e[e.length-1]}}const pl=[0,0,0,255],ml={getSourcePosition:{type:"accessor",value:t=>t.sourcePosition},getTargetPosition:{type:"accessor",value:t=>t.targetPosition},getSourceColor:{type:"accessor",value:pl},getTargetColor:{type:"accessor",value:pl},getWidth:{type:"accessor",value:1},getHeight:{type:"accessor",value:1},getTilt:{type:"accessor",value:0},greatCircle:!1,numSegments:{type:"number",value:50,min:1},widthUnits:"pixels",widthScale:{type:"number",value:1,min:0},widthMinPixels:{type:"number",value:0,min:0},widthMaxPixels:{type:"number",value:Number.MAX_SAFE_INTEGER,min:0}};class vl extends dl{constructor(...t){super(...t),n(this,"state",void 0)}getBounds(){var t;return null===(t=this.getAttributeManager())||void 0===t?void 0:t.getBounds(["instanceSourcePositions","instanceTargetPositions"])}getShaders(){return super.getShaders({vs:"#define SHADER_NAME arc-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec4 instanceSourceColors;\nattribute vec4 instanceTargetColors;\nattribute vec3 instanceSourcePositions;\nattribute vec3 instanceSourcePositions64Low;\nattribute vec3 instanceTargetPositions;\nattribute vec3 instanceTargetPositions64Low;\nattribute vec3 instancePickingColors;\nattribute float instanceWidths;\nattribute float instanceHeights;\nattribute float instanceTilts;\n\nuniform bool greatCircle;\nuniform bool useShortestPath;\nuniform float numSegments;\nuniform float opacity;\nuniform float widthScale;\nuniform float widthMinPixels;\nuniform float widthMaxPixels;\nuniform int widthUnits;\n\nvarying vec4 vColor;\nvarying vec2 uv;\nvarying float isValid;\n\nfloat paraboloid(float distance, float sourceZ, float targetZ, float ratio) {\n\n  float deltaZ = targetZ - sourceZ;\n  float dh = distance * instanceHeights;\n  if (dh == 0.0) {\n    return sourceZ + deltaZ * ratio;\n  }\n  float unitZ = deltaZ / dh;\n  float p2 = unitZ * unitZ + 1.0;\n  float dir = step(deltaZ, 0.0);\n  float z0 = mix(sourceZ, targetZ, dir);\n  float r = mix(ratio, 1.0 - ratio, dir);\n  return sqrt(r * (p2 - r)) * dh + z0;\n}\nvec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {\n  vec2 dir_screenspace = normalize(line_clipspace * project_uViewportSize);\n  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n\n  return dir_screenspace * offset_direction * width / 2.0;\n}\n\nfloat getSegmentRatio(float index) {\n  return smoothstep(0.0, 1.0, index / (numSegments - 1.0));\n}\n\nvec3 interpolateFlat(vec3 source, vec3 target, float segmentRatio) {\n  float distance = length(source.xy - target.xy);\n  float z = paraboloid(distance, source.z, target.z, segmentRatio);\n\n  float tiltAngle = radians(instanceTilts);\n  vec2 tiltDirection = normalize(target.xy - source.xy);\n  vec2 tilt = vec2(-tiltDirection.y, tiltDirection.x) * z * sin(tiltAngle);\n\n  return vec3(\n    mix(source.xy, target.xy, segmentRatio) + tilt,\n    z * cos(tiltAngle)\n  );\n}\nfloat getAngularDist (vec2 source, vec2 target) {\n  vec2 sourceRadians = radians(source);\n  vec2 targetRadians = radians(target);\n  vec2 sin_half_delta = sin((sourceRadians - targetRadians) / 2.0);\n  vec2 shd_sq = sin_half_delta * sin_half_delta;\n\n  float a = shd_sq.y + cos(sourceRadians.y) * cos(targetRadians.y) * shd_sq.x;\n  return 2.0 * asin(sqrt(a));\n}\n\nvec3 interpolateGreatCircle(vec3 source, vec3 target, vec3 source3D, vec3 target3D, float angularDist, float t) {\n  vec2 lngLat;\n  if(abs(angularDist - PI) < 0.001) {\n    lngLat = (1.0 - t) * source.xy + t * target.xy;\n  } else {\n    float a = sin((1.0 - t) * angularDist);\n    float b = sin(t * angularDist);\n    vec3 p = source3D.yxz * a + target3D.yxz * b;\n    lngLat = degrees(vec2(atan(p.y, -p.x), atan(p.z, length(p.xy))));\n  }\n\n  float z = paraboloid(angularDist * EARTH_RADIUS, source.z, target.z, t);\n\n  return vec3(lngLat, z);\n}\n\nvoid main(void) {\n  geometry.worldPosition = instanceSourcePositions;\n  geometry.worldPositionAlt = instanceTargetPositions;\n\n  float segmentIndex = positions.x;\n  float segmentRatio = getSegmentRatio(segmentIndex);\n  float prevSegmentRatio = getSegmentRatio(max(0.0, segmentIndex - 1.0));\n  float nextSegmentRatio = getSegmentRatio(min(numSegments - 1.0, segmentIndex + 1.0));\n  float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));\n  isValid = 1.0;\n\n  uv = vec2(segmentRatio, positions.y);\n  geometry.uv = uv;\n  geometry.pickingColor = instancePickingColors;\n\n  vec4 curr;\n  vec4 next;\n  vec3 source;\n  vec3 target;\n\n  if ((greatCircle || project_uProjectionMode == PROJECTION_MODE_GLOBE) && project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n    source = project_globe_(vec3(instanceSourcePositions.xy, 0.0));\n    target = project_globe_(vec3(instanceTargetPositions.xy, 0.0));\n    float angularDist = getAngularDist(instanceSourcePositions.xy, instanceTargetPositions.xy);\n\n    vec3 prevPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, prevSegmentRatio);\n    vec3 currPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, segmentRatio);\n    vec3 nextPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, nextSegmentRatio);\n\n    if (abs(currPos.x - prevPos.x) > 180.0) {\n      indexDir = -1.0;\n      isValid = 0.0;\n    } else if (abs(currPos.x - nextPos.x) > 180.0) {\n      indexDir = 1.0;\n      isValid = 0.0;\n    }\n    nextPos = indexDir < 0.0 ? prevPos : nextPos;\n    nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;\n\n    if (isValid == 0.0) {\n      nextPos.x += nextPos.x > 0.0 ? -360.0 : 360.0;\n      float t = ((currPos.x > 0.0 ? 180.0 : -180.0) - currPos.x) / (nextPos.x - currPos.x);\n      currPos = mix(currPos, nextPos, t);\n      segmentRatio = mix(segmentRatio, nextSegmentRatio, t);\n    }\n\n    vec3 currPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, segmentRatio);\n    vec3 nextPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, nextSegmentRatio);\n  \n    curr = project_position_to_clipspace(currPos, currPos64Low, vec3(0.0), geometry.position);\n    next = project_position_to_clipspace(nextPos, nextPos64Low, vec3(0.0));\n  \n  } else {\n    vec3 source_world = instanceSourcePositions;\n    vec3 target_world = instanceTargetPositions;\n    if (useShortestPath) {\n      source_world.x = mod(source_world.x + 180., 360.0) - 180.;\n      target_world.x = mod(target_world.x + 180., 360.0) - 180.;\n\n      float deltaLng = target_world.x - source_world.x;\n      if (deltaLng > 180.) target_world.x -= 360.;\n      if (deltaLng < -180.) source_world.x -= 360.;\n    }\n    source = project_position(source_world, instanceSourcePositions64Low);\n    target = project_position(target_world, instanceTargetPositions64Low);\n    float antiMeridianX = 0.0;\n\n    if (useShortestPath) {\n      if (project_uProjectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {\n        antiMeridianX = -(project_uCoordinateOrigin.x + 180.) / 360. * TILE_SIZE;\n      }\n      float thresholdRatio = (antiMeridianX - source.x) / (target.x - source.x);\n\n      if (prevSegmentRatio <= thresholdRatio && nextSegmentRatio > thresholdRatio) {\n        isValid = 0.0;\n        indexDir = sign(segmentRatio - thresholdRatio);\n        segmentRatio = thresholdRatio;\n      }\n    }\n\n    nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;\n    vec3 currPos = interpolateFlat(source, target, segmentRatio);\n    vec3 nextPos = interpolateFlat(source, target, nextSegmentRatio);\n\n    if (useShortestPath) {\n      if (nextPos.x < antiMeridianX) {\n        currPos.x += TILE_SIZE;\n        nextPos.x += TILE_SIZE;\n      }\n    }\n\n    curr = project_common_position_to_clipspace(vec4(currPos, 1.0));\n    next = project_common_position_to_clipspace(vec4(nextPos, 1.0));\n    geometry.position = vec4(currPos, 1.0);\n  }\n  float widthPixels = clamp(\n    project_size_to_pixel(instanceWidths * widthScale, widthUnits),\n    widthMinPixels, widthMaxPixels\n  );\n  vec3 offset = vec3(\n    getExtrusionOffset((next.xy - curr.xy) * indexDir, positions.y, widthPixels),\n    0.0);\n  DECKGL_FILTER_SIZE(offset, geometry);\n  DECKGL_FILTER_GL_POSITION(curr, geometry);\n  gl_Position = curr + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);\n\n  vec4 color = mix(instanceSourceColors, instanceTargetColors, segmentRatio);\n  vColor = vec4(color.rgb, color.a * opacity);\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#define SHADER_NAME arc-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying vec2 uv;\nvarying float isValid;\n\nvoid main(void) {\n  if (isValid == 0.0) {\n    discard;\n  }\n\n  gl_FragColor = vColor;\n  geometry.uv = uv;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[tc,ec]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getTargetPosition"},instanceSourceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getSourceColor",defaultValue:pl},instanceTargetColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getTargetColor",defaultValue:pl},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceHeights:{size:1,transition:!0,accessor:"getHeight",defaultValue:1},instanceTilts:{size:1,transition:!0,accessor:"getTilt",defaultValue:0}})}updateState(t){super.updateState(t);const{props:e,oldProps:n,changeFlags:i}=t;if(i.extensionsChanged||i.propsChanged&&e.numSegments!==n.numSegments){var r;const{gl:t}=this.context;null===(r=this.state.model)||void 0===r||r.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}}draw({uniforms:t}){const{widthUnits:e,widthScale:n,widthMinPixels:i,widthMaxPixels:r,greatCircle:s,wrapLongitude:o}=this.props;this.state.model.setUniforms(t).setUniforms({greatCircle:s,widthUnits:Jt[e],widthScale:n,widthMinPixels:i,widthMaxPixels:r,useShortestPath:o}).draw()}_getModel(t){const{id:e,numSegments:n}=this.props;let i=[];for(let t=0;t<n;t++)i=i.concat([t,1,0,t,-1,0]);const r=new Po(t,{...this.getShaders(),id:e,geometry:new Io({drawMode:5,attributes:{positions:new Float32Array(i)}}),isInstanced:!0});return r.setUniforms({numSegments:n}),r}}n(vl,"layerName","ArcLayer"),n(vl,"defaultProps",ml);const yl=new Uint16Array([0,2,1,0,3,2]),bl=new Float32Array([0,1,0,0,1,0,1,1]);function _l(t,e){if(!e)return function(t){const e=new Float64Array(12);for(let n=0;n<t.length;n++)e[3*n+0]=t[n][0],e[3*n+1]=t[n][1],e[3*n+2]=t[n][2]||0;return{vertexCount:6,positions:e,indices:yl,texCoords:bl}}(t);const n=Math.max(Math.abs(t[0][0]-t[3][0]),Math.abs(t[1][0]-t[2][0])),i=Math.max(Math.abs(t[1][1]-t[0][1]),Math.abs(t[2][1]-t[3][1])),r=Math.ceil(n/e)+1,s=Math.ceil(i/e)+1,o=(r-1)*(s-1)*6,a=new Uint32Array(o),c=new Float32Array(r*s*2),l=new Float64Array(r*s*3);let u=0,h=0;for(let e=0;e<r;e++){const n=e/(r-1);for(let i=0;i<s;i++){const r=i/(s-1),o=xl(t,n,r);l[3*u+0]=o[0],l[3*u+1]=o[1],l[3*u+2]=o[2]||0,c[2*u+0]=n,c[2*u+1]=1-r,e>0&&i>0&&(a[h++]=u-s,a[h++]=u-s-1,a[h++]=u-1,a[h++]=u-s,a[h++]=u-1,a[h++]=u),u++}}return{vertexCount:o,positions:l,indices:a,texCoords:c}}function xl(t,e,n){return _s(_s(t[0],t[1],n),_s(t[3],t[2],n),e)}var Pl="\n#define SHADER_NAME bitmap-layer-fragment-shader\n\n#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform sampler2D bitmapTexture;\n\nvarying vec2 vTexCoord;\nvarying vec2 vTexPos;\n\nuniform float desaturate;\nuniform vec4 transparentColor;\nuniform vec3 tintColor;\nuniform float opacity;\n\nuniform float coordinateConversion;\nuniform vec4 bounds;\n\n/* projection utils */\nconst float TILE_SIZE = 512.0;\nconst float PI = 3.1415926536;\nconst float WORLD_SCALE = TILE_SIZE / PI / 2.0;\n\n// from degrees to Web Mercator\nvec2 lnglat_to_mercator(vec2 lnglat) {\n  float x = lnglat.x;\n  float y = clamp(lnglat.y, -89.9, 89.9);\n  return vec2(\n    radians(x) + PI,\n    PI + log(tan(PI * 0.25 + radians(y) * 0.5))\n  ) * WORLD_SCALE;\n}\n\n// from Web Mercator to degrees\nvec2 mercator_to_lnglat(vec2 xy) {\n  xy /= WORLD_SCALE;\n  return degrees(vec2(\n    xy.x - PI,\n    atan(exp(xy.y - PI)) * 2.0 - PI * 0.5\n  ));\n}\n/* End projection utils */\n\n// apply desaturation\nvec3 color_desaturate(vec3 color) {\n  float luminance = (color.r + color.g + color.b) * 0.333333333;\n  return mix(color, vec3(luminance), desaturate);\n}\n\n// apply tint\nvec3 color_tint(vec3 color) {\n  return color * tintColor;\n}\n\n// blend with background color\nvec4 apply_opacity(vec3 color, float alpha) {\n  if (transparentColor.a == 0.0) {\n    return vec4(color, alpha);\n  }\n  float blendedAlpha = alpha + transparentColor.a * (1.0 - alpha);\n  float highLightRatio = alpha / blendedAlpha;\n  vec3 blendedRGB = mix(transparentColor.rgb, color, highLightRatio);\n  return vec4(blendedRGB, blendedAlpha);\n}\n\nvec2 getUV(vec2 pos) {\n  return vec2(\n    (pos.x - bounds[0]) / (bounds[2] - bounds[0]),\n    (pos.y - bounds[3]) / (bounds[1] - bounds[3])\n  );\n}\n\n".concat("\nvec3 packUVsIntoRGB(vec2 uv) {\n  // Extract the top 8 bits. We want values to be truncated down so we can add a fraction\n  vec2 uv8bit = floor(uv * 256.);\n\n  // Calculate the normalized remainders of u and v parts that do not fit into 8 bits\n  // Scale and clamp to 0-1 range\n  vec2 uvFraction = fract(uv * 256.);\n  vec2 uvFraction4bit = floor(uvFraction * 16.);\n\n  // Remainder can be encoded in blue channel, encode as 4 bits for pixel coordinates\n  float fractions = uvFraction4bit.x + uvFraction4bit.y * 16.;\n\n  return vec3(uv8bit, fractions) / 255.;\n}\n","\n\nvoid main(void) {\n  vec2 uv = vTexCoord;\n  if (coordinateConversion < -0.5) {\n    vec2 lnglat = mercator_to_lnglat(vTexPos);\n    uv = getUV(lnglat);\n  } else if (coordinateConversion > 0.5) {\n    vec2 commonPos = lnglat_to_mercator(vTexPos);\n    uv = getUV(commonPos);\n  }\n  vec4 bitmapColor = texture2D(bitmapTexture, uv);\n\n  gl_FragColor = apply_opacity(color_tint(color_desaturate(bitmapColor.rgb)), bitmapColor.a * opacity);\n\n  geometry.uv = uv;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n\n  if (picking_uActive && !picking_uAttribute) {\n    // Since instance information is not used, we can use picking color for pixel index\n    gl_FragColor.rgb = packUVsIntoRGB(uv);\n  }\n}\n");const wl={image:{type:"image",value:null,async:!0},bounds:{type:"array",value:[1,0,0,1],compare:!0},_imageCoordinateSystem:Kt.DEFAULT,desaturate:{type:"number",min:0,max:1,value:0},transparentColor:{type:"color",value:[0,0,0,0]},tintColor:{type:"color",value:[255,255,255]},textureParameters:{type:"object",ignore:!0}};class Al extends dl{constructor(...t){super(...t),n(this,"state",void 0)}getShaders(){return super.getShaders({vs:"\n#define SHADER_NAME bitmap-layer-vertex-shader\n\nattribute vec2 texCoords;\nattribute vec3 positions;\nattribute vec3 positions64Low;\n\nvarying vec2 vTexCoord;\nvarying vec2 vTexPos;\n\nuniform float coordinateConversion;\n\nconst vec3 pickingColor = vec3(1.0, 0.0, 0.0);\n\nvoid main(void) {\n  geometry.worldPosition = positions;\n  geometry.uv = texCoords;\n  geometry.pickingColor = pickingColor;\n\n  gl_Position = project_position_to_clipspace(positions, positions64Low, vec3(0.0), geometry.position);\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  vTexCoord = texCoords;\n\n  if (coordinateConversion < -0.5) {\n    vTexPos = geometry.position.xy + project_uCommonOrigin.xy;\n  } else if (coordinateConversion > 0.5) {\n    vTexPos = geometry.worldPosition.xy;\n  }\n\n  vec4 color = vec4(0.0);\n  DECKGL_FILTER_COLOR(color, geometry);\n}\n",fs:Pl,modules:[tc,ec]})}initializeState(){const t=this.getAttributeManager();t.remove(["instancePickingColors"]);const e=!0;t.add({indices:{size:1,isIndexed:!0,update:t=>t.value=this.state.mesh.indices,noAlloc:e},positions:{size:3,type:5130,fp64:this.use64bitPositions(),update:t=>t.value=this.state.mesh.positions,noAlloc:e},texCoords:{size:2,update:t=>t.value=this.state.mesh.texCoords,noAlloc:e}})}updateState({props:t,oldProps:e,changeFlags:n}){const i=this.getAttributeManager();if(n.extensionsChanged){var r;const{gl:t}=this.context;null===(r=this.state.model)||void 0===r||r.delete(),this.state.model=this._getModel(t),i.invalidateAll()}if(t.bounds!==e.bounds){const t=this.state.mesh,e=this._createMesh();this.state.model.setVertexCount(e.vertexCount);for(const n in e)t&&t[n]!==e[n]&&i.invalidate(n);this.setState({mesh:e,...this._getCoordinateUniforms()})}else t._imageCoordinateSystem!==e._imageCoordinateSystem&&this.setState(this._getCoordinateUniforms())}getPickingInfo(t){const{image:e}=this.props,n=t.info;if(!n.color||!e)return n.bitmap=null,n;const{width:i,height:r}=e;n.index=0;const s=function(t){const[e,n,i]=t;return[(e+(15&i)/16)/256,(n+(240&i)/256)/256]}(n.color),o=[Math.floor(s[0]*i),Math.floor(s[1]*r)];return n.bitmap={size:{width:i,height:r},uv:s,pixel:o},n}disablePickingIndex(){this.setState({disablePicking:!0})}restorePickingColors(){this.setState({disablePicking:!1})}_updateAutoHighlight(t){super._updateAutoHighlight({...t,color:this.encodePickingColor(0)})}_createMesh(){const{bounds:t}=this.props;let e=t;return Sl(t)&&(e=[[t[0],t[1]],[t[0],t[3]],[t[2],t[3]],[t[2],t[1]]]),_l(e,this.context.viewport.resolution)}_getModel(t){return t?new Po(t,{...this.getShaders(),id:this.props.id,geometry:new Io({drawMode:4,vertexCount:6}),isInstanced:!1}):null}draw(t){const{uniforms:e,moduleParameters:n}=t,{model:i,coordinateConversion:r,bounds:s,disablePicking:o}=this.state,{image:a,desaturate:c,transparentColor:l,tintColor:u}=this.props;n.pickingActive&&o||a&&i&&i.setUniforms(e).setUniforms({bitmapTexture:a,desaturate:c,transparentColor:l.map(t=>t/255),tintColor:u.slice(0,3).map(t=>t/255),coordinateConversion:r,bounds:s}).draw()}_getCoordinateUniforms(){const{LNGLAT:t,CARTESIAN:e,DEFAULT:n}=Kt;let{_imageCoordinateSystem:i}=this.props;if(i!==n){const{bounds:n}=this.props;if(!Sl(n))throw new Error("_imageCoordinateSystem only supports rectangular bounds");const r=this.context.viewport.resolution?t:e;if(i=i===t?t:e,i===t&&r===e)return{coordinateConversion:-1,bounds:n};if(i===e&&r===t){const t=ga([n[0],n[1]]),e=ga([n[2],n[3]]);return{coordinateConversion:1,bounds:[t[0],t[1],e[0],e[1]]}}}return{coordinateConversion:0,bounds:[0,0,0,0]}}}function Sl(t){return Number.isFinite(t[0])}n(Al,"layerName","BitmapLayer"),n(Al,"defaultProps",wl);const Tl=()=>{},El={10241:9987,10240:9729,10242:33071,10243:33071};function Cl(t,e,n,i){const r=Math.min(n/e.width,i/e.height),s=Math.floor(e.width*r),o=Math.floor(e.height*r);return 1===r?{data:e,width:s,height:o}:(t.canvas.height=o,t.canvas.width=s,t.clearRect(0,0,s,o),t.drawImage(e,0,0,e.width,e.height,0,0,s,o),{data:t.canvas,width:s,height:o})}function Ll(t){return t&&(t.id||t.url)}function Ml(t,e,n,i){const r=t.width,s=t.height,o=new xn(t.gl,{width:e,height:n,parameters:i});return function(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{sourceX:i=0,sourceY:r=0,targetMipmaplevel:s=0,targetInternalFormat:o=6408}=n;let{targetX:a,targetY:c,targetZ:l,width:u,height:h}=n;const{framebuffer:d,deleteFramebuffer:f}=Rn(t);Ze(d);const{gl:g,handle:p}=d,m=void 0!==a||void 0!==c||void 0!==l;a=a||0,c=c||0,l=l||0;const v=g.bindFramebuffer(36160,p);Ze(e);let y=null;if(e instanceof _n&&(y=e,u=Number.isFinite(u)?u:y.width,h=Number.isFinite(h)?h:y.height,y.bind(0),e=y.target),m)switch(e){case 3553:case 34067:g.copyTexSubImage2D(e,s,a,c,i,r,u,h);break;case 35866:case 32879:ie(g).copyTexSubImage3D(e,s,a,c,l,i,r,u,h)}else g.copyTexImage2D(e,s,o,i,r,u,h,0);y&&y.unbind(),g.bindFramebuffer(36160,v||null),f&&d.delete()}(t,o,{targetY:0,width:r,height:s}),t.delete(),o}function Ol(t,e,n){for(let i=0;i<e.length;i++){const{icon:r,xOffset:s}=e[i];t[Ll(r)]={...r,x:s,y:n}}}class Il{constructor(t,{onUpdate:e=Tl,onError:i=Tl}){n(this,"gl",void 0),n(this,"onUpdate",void 0),n(this,"onError",void 0),n(this,"_loadOptions",null),n(this,"_texture",null),n(this,"_externalTexture",null),n(this,"_mapping",{}),n(this,"_textureParameters",null),n(this,"_pendingCount",0),n(this,"_autoPacking",!1),n(this,"_xOffset",0),n(this,"_yOffset",0),n(this,"_rowHeight",0),n(this,"_buffer",4),n(this,"_canvasWidth",1024),n(this,"_canvasHeight",0),n(this,"_canvas",null),this.gl=t,this.onUpdate=e,this.onError=i}finalize(){var t;null===(t=this._texture)||void 0===t||t.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(t){const e=this._autoPacking?Ll(t):t;return this._mapping[e]||{}}setProps({loadOptions:t,autoPacking:e,iconAtlas:n,iconMapping:i,textureParameters:r}){var s;(t&&(this._loadOptions=t),void 0!==e&&(this._autoPacking=e),i&&(this._mapping=i),n)&&(null===(s=this._texture)||void 0===s||s.delete(),this._texture=null,this._externalTexture=n);r&&(this._textureParameters=r)}get isLoaded(){return 0===this._pendingCount}packIcons(t,e){if(!this._autoPacking||"undefined"==typeof document)return;const n=Object.values(function(t,e,n){if(!t||!e)return null;n=n||{};const i={},{iterable:r,objectInfo:s}=dc(t);for(const t of r){s.index++;const r=e(t,s),o=Ll(r);if(!r)throw new Error("Icon is missing.");if(!r.url)throw new Error("Icon url is missing.");i[o]||n[o]&&r.url===n[o].url||(i[o]={...r,source:t,sourceIndex:s.index})}return i}(t,e,this._mapping)||{});if(n.length>0){const{mapping:t,xOffset:e,yOffset:i,rowHeight:r,canvasHeight:s}=function({icons:t,buffer:e,mapping:n={},xOffset:i=0,yOffset:r=0,rowHeight:s=0,canvasWidth:o}){let a=[];for(let c=0;c<t.length;c++){const l=t[c];if(!n[Ll(l)]){const{height:t,width:c}=l;i+c+e>o&&(Ol(n,a,r),i=0,r=s+r+e,s=0,a=[]),a.push({icon:l,xOffset:i}),i=i+c+e,s=Math.max(s,t)}}return a.length>0&&Ol(n,a,r),{mapping:n,rowHeight:s,xOffset:i,yOffset:r,canvasWidth:o,canvasHeight:(c=s+r+e,Math.pow(2,Math.ceil(Math.log2(c))))};var c}({icons:n,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=r,this._mapping=t,this._xOffset=e,this._yOffset=i,this._canvasHeight=s,this._texture||(this._texture=new xn(this.gl,{width:this._canvasWidth,height:this._canvasHeight,parameters:this._textureParameters||El})),this._texture.height!==this._canvasHeight&&(this._texture=Ml(this._texture,this._canvasWidth,this._canvasHeight,this._textureParameters||El)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(n)}}_loadIcons(t){const e=this._canvas.getContext("2d",{willReadFrequently:!0});for(const n of t)this._pendingCount++,Ht(n.url,this._loadOptions).then(t=>{const i=Ll(n),r=this._mapping[i],{x:s,y:o,width:a,height:c}=r,{data:l,width:u,height:h}=Cl(e,t,a,c);this._texture.setSubImageData({data:l,x:s+(a-u)/2,y:o+(c-h)/2,width:u,height:h}),r.width=u,r.height=h,this._texture.generateMipmap(),this.onUpdate()}).catch(t=>{this.onError({url:n.url,source:n.source,sourceIndex:n.sourceIndex,loadOptions:this._loadOptions,error:t})}).finally(()=>{this._pendingCount--})}}const Rl=[0,0,0,255],Fl={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:t=>t.position},getIcon:{type:"accessor",value:t=>t.icon},getColor:{type:"accessor",value:Rl},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0}};class zl extends dl{constructor(...t){super(...t),n(this,"state",void 0)}getShaders(){return super.getShaders({vs:"#define SHADER_NAME icon-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute float instanceSizes;\nattribute float instanceAngles;\nattribute vec4 instanceColors;\nattribute vec3 instancePickingColors;\nattribute vec4 instanceIconFrames;\nattribute float instanceColorModes;\nattribute vec2 instanceOffsets;\nattribute vec2 instancePixelOffset;\n\nuniform float sizeScale;\nuniform vec2 iconsTextureDim;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform bool billboard;\nuniform int sizeUnits;\n\nvarying float vColorMode;\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvec2 rotate_by_angle(vec2 vertex, float angle) {\n  float angle_radian = angle * PI / 180.0;\n  float cos_angle = cos(angle_radian);\n  float sin_angle = sin(angle_radian);\n  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\n  return rotationMatrix * vertex;\n}\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = positions;\n  geometry.pickingColor = instancePickingColors;\n  uv = positions;\n\n  vec2 iconSize = instanceIconFrames.zw;\n  float sizePixels = clamp(\n    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits), \n    sizeMinPixels, sizeMaxPixels\n  );\n  float instanceScale = iconSize.y == 0.0 ? 0.0 : sizePixels / iconSize.y;\n  vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;\n  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;\n  pixelOffset += instancePixelOffset;\n  pixelOffset.y *= -1.0;\n\n  if (billboard)  {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = vec3(pixelOffset, 0.0);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n\n  } else {\n    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\n    DECKGL_FILTER_SIZE(offset_common, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position); \n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n\n  vTextureCoords = mix(\n    instanceIconFrames.xy,\n    instanceIconFrames.xy + iconSize,\n    (positions.xy + 1.0) / 2.0\n  ) / iconsTextureDim;\n\n  vColor = instanceColors;\n  DECKGL_FILTER_COLOR(vColor, geometry);\n\n  vColorMode = instanceColorModes;\n}\n",fs:"#define SHADER_NAME icon-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D iconsTexture;\nuniform float alphaCutoff;\n\nvarying float vColorMode;\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  vec4 texColor = texture2D(iconsTexture, vTextureCoords);\n  vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);\n  float a = texColor.a * opacity * vColor.a;\n\n  if (a < alphaCutoff) {\n    discard;\n  }\n\n  gl_FragColor = vec4(color, a);\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[tc,ec]})}initializeState(){this.state={iconManager:new Il(this.context.gl,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})};this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:5121,accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:Rl},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(t){super.updateState(t);const{props:e,oldProps:n,changeFlags:i}=t,r=this.getAttributeManager(),{iconAtlas:s,iconMapping:o,data:a,getIcon:c,textureParameters:l}=e,{iconManager:u}=this.state,h=s||this.internalState.isAsyncPropLoading("iconAtlas");if(u.setProps({loadOptions:e.loadOptions,autoPacking:!h,iconAtlas:s,iconMapping:h?o:null,textureParameters:l}),h?n.iconMapping!==e.iconMapping&&r.invalidate("getIcon"):(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getIcon))&&u.packIcons(a,c),i.extensionsChanged){var d;const{gl:t}=this.context;null===(d=this.state.model)||void 0===d||d.delete(),this.state.model=this._getModel(t),r.invalidateAll()}}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(t){super.finalizeState(t),this.state.iconManager.finalize()}draw({uniforms:t}){const{sizeScale:e,sizeMinPixels:n,sizeMaxPixels:i,sizeUnits:r,billboard:s,alphaCutoff:o}=this.props,{iconManager:a}=this.state,c=a.getTexture();c&&this.state.model.setUniforms(t).setUniforms({iconsTexture:c,iconsTextureDim:[c.width,c.height],sizeUnits:Jt[r],sizeScale:e,sizeMinPixels:n,sizeMaxPixels:i,billboard:s,alphaCutoff:o}).draw()}_getModel(t){return new Po(t,{...this.getShaders(),id:this.props.id,geometry:new Io({drawMode:6,attributes:{positions:{size:2,value:new Float32Array([-1,-1,-1,1,1,1,1,-1])}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(t){var e;const n=null===(e=this.getCurrentLayer())||void 0===e?void 0:e.props.onIconError;n?n(t):Xt.error(t.error.message)()}getInstanceOffset(t){const{width:e,height:n,anchorX:i=e/2,anchorY:r=n/2}=this.state.iconManager.getIconMapping(t);return[e/2-i,n/2-r]}getInstanceColorMode(t){return this.state.iconManager.getIconMapping(t).mask?1:0}getInstanceIconFrame(t){const{x:e,y:n,width:i,height:r}=this.state.iconManager.getIconMapping(t);return[e,n,i,r]}}n(zl,"defaultProps",Fl),n(zl,"layerName","IconLayer");const kl={getSourcePosition:{type:"accessor",value:t=>t.sourcePosition},getTargetPosition:{type:"accessor",value:t=>t.targetPosition},getColor:{type:"accessor",value:[0,0,0,255]},getWidth:{type:"accessor",value:1},widthUnits:"pixels",widthScale:{type:"number",value:1,min:0},widthMinPixels:{type:"number",value:0,min:0},widthMaxPixels:{type:"number",value:Number.MAX_SAFE_INTEGER,min:0}};class jl extends dl{getBounds(){var t;return null===(t=this.getAttributeManager())||void 0===t?void 0:t.getBounds(["instanceSourcePositions","instanceTargetPositions"])}getShaders(){return super.getShaders({vs:"#define SHADER_NAME line-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec3 instanceSourcePositions;\nattribute vec3 instanceTargetPositions;\nattribute vec3 instanceSourcePositions64Low;\nattribute vec3 instanceTargetPositions64Low;\nattribute vec4 instanceColors;\nattribute vec3 instancePickingColors;\nattribute float instanceWidths;\n\nuniform float opacity;\nuniform float widthScale;\nuniform float widthMinPixels;\nuniform float widthMaxPixels;\nuniform float useShortestPath;\nuniform int widthUnits;\n\nvarying vec4 vColor;\nvarying vec2 uv;\nvec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {\n  vec2 dir_screenspace = normalize(line_clipspace * project_uViewportSize);\n  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n\n  return dir_screenspace * offset_direction * width / 2.0;\n}\n\nvec3 splitLine(vec3 a, vec3 b, float x) {\n  float t = (x - a.x) / (b.x - a.x);\n  return vec3(x, mix(a.yz, b.yz, t));\n}\n\nvoid main(void) {\n  geometry.worldPosition = instanceSourcePositions;\n  geometry.worldPositionAlt = instanceTargetPositions;\n\n  vec3 source_world = instanceSourcePositions;\n  vec3 target_world = instanceTargetPositions;\n  vec3 source_world_64low = instanceSourcePositions64Low;\n  vec3 target_world_64low = instanceTargetPositions64Low;\n\n  if (useShortestPath > 0.5 || useShortestPath < -0.5) {\n    source_world.x = mod(source_world.x + 180., 360.0) - 180.;\n    target_world.x = mod(target_world.x + 180., 360.0) - 180.;\n    float deltaLng = target_world.x - source_world.x;\n\n    if (deltaLng * useShortestPath > 180.) {\n      source_world.x += 360. * useShortestPath;\n      source_world = splitLine(source_world, target_world, 180. * useShortestPath);\n      source_world_64low = vec3(0.0);\n    } else if (deltaLng * useShortestPath < -180.) {\n      target_world.x += 360. * useShortestPath;\n      target_world = splitLine(source_world, target_world, 180. * useShortestPath);\n      target_world_64low = vec3(0.0);\n    } else if (useShortestPath < 0.) {\n      gl_Position = vec4(0.);\n      return;\n    }\n  }\n  vec4 source_commonspace;\n  vec4 target_commonspace;\n  vec4 source = project_position_to_clipspace(source_world, source_world_64low, vec3(0.), source_commonspace);\n  vec4 target = project_position_to_clipspace(target_world, target_world_64low, vec3(0.), target_commonspace);\n  float segmentIndex = positions.x;\n  vec4 p = mix(source, target, segmentIndex);\n  geometry.position = mix(source_commonspace, target_commonspace, segmentIndex);\n  uv = positions.xy;\n  geometry.uv = uv;\n  geometry.pickingColor = instancePickingColors;\n  float widthPixels = clamp(\n    project_size_to_pixel(instanceWidths * widthScale, widthUnits),\n    widthMinPixels, widthMaxPixels\n  );\n  vec3 offset = vec3(\n    getExtrusionOffset(target.xy - source.xy, positions.y, widthPixels),\n    0.0);\n  DECKGL_FILTER_SIZE(offset, geometry);\n  DECKGL_FILTER_GL_POSITION(p, geometry);\n  gl_Position = p + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);\n  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#define SHADER_NAME line-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying vec2 uv;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[tc,ec]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getTargetPosition"},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:[0,0,0,255]},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1}})}updateState(t){if(super.updateState(t),t.changeFlags.extensionsChanged){var e;const{gl:t}=this.context;null===(e=this.state.model)||void 0===e||e.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}}draw({uniforms:t}){const{widthUnits:e,widthScale:n,widthMinPixels:i,widthMaxPixels:r,wrapLongitude:s}=this.props;this.state.model.setUniforms(t).setUniforms({widthUnits:Jt[e],widthScale:n,widthMinPixels:i,widthMaxPixels:r,useShortestPath:s?1:0}).draw(),s&&this.state.model.setUniforms({useShortestPath:-1}).draw()}_getModel(t){return new Po(t,{...this.getShaders(),id:this.props.id,geometry:new Io({drawMode:5,attributes:{positions:new Float32Array([0,-1,0,0,1,0,1,-1,0,1,1,0])}}),isInstanced:!0})}}n(jl,"layerName","LineLayer"),n(jl,"defaultProps",kl);const Bl=[0,0,0,255],Dl=[0,0,1],Nl={sizeUnits:"pixels",pointSize:{type:"number",min:0,value:10},getPosition:{type:"accessor",value:t=>t.position},getNormal:{type:"accessor",value:Dl},getColor:{type:"accessor",value:Bl},material:!0,radiusPixels:{deprecatedFor:"pointSize"}};class Ul extends dl{getShaders(){return super.getShaders({vs:"#define SHADER_NAME point-cloud-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec3 instanceNormals;\nattribute vec4 instanceColors;\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform float radiusPixels;\nuniform int sizeUnits;\n\nvarying vec4 vColor;\nvarying vec2 unitPosition;\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.normal = project_normal(instanceNormals);\n  unitPosition = positions.xy;\n  geometry.uv = unitPosition;\n  geometry.pickingColor = instancePickingColors;\n  vec3 offset = vec3(positions.xy * project_size_to_pixel(radiusPixels, sizeUnits), 0.0);\n  DECKGL_FILTER_SIZE(offset, geometry);\n\n  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.), geometry.position);\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  vec3 lightColor = lighting_getLightColor(instanceColors.rgb, project_uCameraPosition, geometry.position.xyz, geometry.normal);\n  vColor = vec4(lightColor, instanceColors.a * opacity);\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#define SHADER_NAME point-cloud-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying vec2 unitPosition;\n\nvoid main(void) {\n  geometry.uv = unitPosition;\n\n  float distToCenter = length(unitPosition);\n\n  if (distToCenter > 1.0) {\n    discard;\n  }\n\n  gl_FragColor = vColor;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[tc,fo,ec]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceNormals:{size:3,transition:!0,accessor:"getNormal",defaultValue:Dl},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getColor",defaultValue:Bl}})}updateState(t){const{changeFlags:e,props:n}=t;if(super.updateState(t),e.extensionsChanged){var i;const{gl:t}=this.context;null===(i=this.state.model)||void 0===i||i.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}e.dataChanged&&function(t){const{header:e,attributes:n}=t;e&&n&&(t.length=e.vertexCount,n.POSITION&&(n.instancePositions=n.POSITION),n.NORMAL&&(n.instanceNormals=n.NORMAL),n.COLOR_0&&(n.instanceColors=n.COLOR_0))}(n.data)}draw({uniforms:t}){const{pointSize:e,sizeUnits:n}=this.props;this.state.model.setUniforms(t).setUniforms({sizeUnits:Jt[n],radiusPixels:e}).draw()}_getModel(t){const e=[];for(let t=0;t<3;t++){const n=t/3*Math.PI*2;e.push(2*Math.cos(n),2*Math.sin(n),0)}return new Po(t,{...this.getShaders(),id:this.props.id,geometry:new Io({drawMode:4,attributes:{positions:new Float32Array(e)}}),isInstanced:!0})}}n(Ul,"layerName","PointCloudLayer"),n(Ul,"defaultProps",Nl);const Vl=[0,0,0,255],Gl={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:t=>t.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:Vl},getLineColor:{type:"accessor",value:Vl},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class Wl extends dl{getShaders(){return super.getShaders({vs:"#define SHADER_NAME scatterplot-layer-vertex-shader\n\nattribute vec3 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute float instanceRadius;\nattribute float instanceLineWidths;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform float radiusScale;\nuniform float radiusMinPixels;\nuniform float radiusMaxPixels;\nuniform float lineWidthScale;\nuniform float lineWidthMinPixels;\nuniform float lineWidthMaxPixels;\nuniform float stroked;\nuniform bool filled;\nuniform bool antialiasing;\nuniform bool billboard;\nuniform int radiusUnits;\nuniform int lineWidthUnits;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying vec2 unitPosition;\nvarying float innerUnitRadius;\nvarying float outerRadiusPixels;\n\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  outerRadiusPixels = clamp(\n    project_size_to_pixel(radiusScale * instanceRadius, radiusUnits),\n    radiusMinPixels, radiusMaxPixels\n  );\n  float lineWidthPixels = clamp(\n    project_size_to_pixel(lineWidthScale * instanceLineWidths, lineWidthUnits),\n    lineWidthMinPixels, lineWidthMaxPixels\n  );\n  outerRadiusPixels += stroked * lineWidthPixels / 2.0;\n  float edgePadding = antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;\n  unitPosition = edgePadding * positions.xy;\n  geometry.uv = unitPosition;\n  geometry.pickingColor = instancePickingColors;\n\n  innerUnitRadius = 1.0 - stroked * lineWidthPixels / outerRadiusPixels;\n  \n  if (billboard) {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = edgePadding * positions * outerRadiusPixels;\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  } else {\n    vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);\n  DECKGL_FILTER_COLOR(vFillColor, geometry);\n  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);\n  DECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs:"#define SHADER_NAME scatterplot-layer-fragment-shader\n\nprecision highp float;\n\nuniform bool filled;\nuniform float stroked;\nuniform bool antialiasing;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying vec2 unitPosition;\nvarying float innerUnitRadius;\nvarying float outerRadiusPixels;\n\nvoid main(void) {\n  geometry.uv = unitPosition;\n\n  float distToCenter = length(unitPosition) * outerRadiusPixels;\n  float inCircle = antialiasing ? \n    smoothedge(distToCenter, outerRadiusPixels) : \n    step(distToCenter, outerRadiusPixels);\n\n  if (inCircle == 0.0) {\n    discard;\n  }\n\n  if (stroked > 0.5) {\n    float isLine = antialiasing ? \n      smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :\n      step(innerUnitRadius * outerRadiusPixels, distToCenter);\n\n    if (filled) {\n      gl_FragColor = mix(vFillColor, vLineColor, isLine);\n    } else {\n      if (isLine == 0.0) {\n        discard;\n      }\n      gl_FragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);\n    }\n  } else if (!filled) {\n    discard;\n  } else {\n    gl_FragColor = vFillColor;\n  }\n\n  gl_FragColor.a *= inCircle;\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[tc,ec]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(t){if(super.updateState(t),t.changeFlags.extensionsChanged){var e;const{gl:t}=this.context;null===(e=this.state.model)||void 0===e||e.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}}draw({uniforms:t}){const{radiusUnits:e,radiusScale:n,radiusMinPixels:i,radiusMaxPixels:r,stroked:s,filled:o,billboard:a,antialiasing:c,lineWidthUnits:l,lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d}=this.props;this.state.model.setUniforms(t).setUniforms({stroked:s?1:0,filled:o,billboard:a,antialiasing:c,radiusUnits:Jt[e],radiusScale:n,radiusMinPixels:i,radiusMaxPixels:r,lineWidthUnits:Jt[l],lineWidthScale:u,lineWidthMinPixels:h,lineWidthMaxPixels:d}).draw()}_getModel(t){return new Po(t,{...this.getShaders(),id:this.props.id,geometry:new Io({drawMode:6,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0])}}}),isInstanced:!0})}}n(Wl,"defaultProps",Gl),n(Wl,"layerName","ScatterplotLayer");const Hl=1,Xl=-1;function Zl(t,e,n={}){const i=function(t,e={}){return Math.sign(function(t,e={}){const{start:n=0,end:i=t.length}=e,r=e.size||2;let s=0;for(let e=n,o=i-r;e<i;e+=r)s+=(t[e]-t[o])*(t[e+1]+t[o+1]),o=e;return s/2}(t,e))}(t,n);return i!==e&&(function(t,e){const{start:n=0,end:i=t.length,size:r=2}=e,s=(i-n)/r,o=Math.floor(s/2);for(let e=0;e<o;++e){const i=n+e*r,o=n+(s-1-e)*r;for(let e=0;e<r;++e){const n=t[i+e];t[i+e]=t[o+e],t[o+e]=n}}}(t,n),!0)}function Yl(t,e){const n=e.length,i=t.length;if(i>0){let r=!0;for(let s=0;s<n;s++)if(t[i-n+s]!==e[s]){r=!1;break}if(r)return!1}for(let r=0;r<n;r++)t[i+r]=e[r];return!0}function Kl(t,e){const n=e.length;for(let i=0;i<n;i++)t[i]=e[i]}function ql(t,e,n,i,r=[]){const s=i+e*n;for(let e=0;e<n;e++)r[e]=t[s+e];return r}function Jl(t,e,n,i,r=[]){let s,o;if(8&n)s=(i[3]-t[1])/(e[1]-t[1]),o=3;else if(4&n)s=(i[1]-t[1])/(e[1]-t[1]),o=1;else if(2&n)s=(i[2]-t[0])/(e[0]-t[0]),o=2;else{if(!(1&n))return null;s=(i[0]-t[0])/(e[0]-t[0]),o=0}for(let n=0;n<t.length;n++)r[n]=(1&o)===n?i[o]:s*(e[n]-t[n])+t[n];return r}function Ql(t,e){let n=0;return t[0]<e[0]?n|=1:t[0]>e[2]&&(n|=2),t[1]<e[1]?n|=4:t[1]>e[3]&&(n|=8),n}function $l(t,e){const{size:n=2,broken:i=!1,gridResolution:r=10,gridOffset:s=[0,0],startIndex:o=0,endIndex:a=t.length}=e||{},c=(a-o)/n;let l=[];const u=[l],h=ql(t,0,n,o);let d,f;const g=iu(h,r,s,[]),p=[];Yl(l,h);for(let e=1;e<c;e++){for(d=ql(t,e,n,o,d),f=Ql(d,g);f;){Jl(h,d,f,g,p);const t=Ql(p,g);t&&(Jl(h,p,t,g,p),f=t),Yl(l,p),Kl(h,p),ru(g,r,f),i&&l.length>n&&(l=[],u.push(l),Yl(l,h)),f=Ql(d,g)}Yl(l,d),Kl(h,d)}return i?u:u[0]}function tu(t,e){for(let n=0;n<e.length;n++)t.push(e[n]);return t}function eu(t,e=null,n){if(!t.length)return[];const{size:i=2,gridResolution:r=10,gridOffset:s=[0,0],edgeTypes:o=!1}=n||{},a=[],c=[{pos:t,types:o?new Array(t.length/i).fill(1):null,holes:e||[]}],l=[[],[]];let u=[];for(;c.length;){const{pos:t,types:e,holes:n}=c.shift();su(t,i,n[0]||t.length,l),u=iu(l[0],r,s,u);const h=Ql(l[1],u);if(h){let r=nu(t,e,i,0,n[0]||t.length,u,h);const s={pos:r[0].pos,types:r[0].types,holes:[]},a={pos:r[1].pos,types:r[1].types,holes:[]};c.push(s,a);for(let c=0;c<n.length;c++)r=nu(t,e,i,n[c],n[c+1]||t.length,u,h),r[0]&&(s.holes.push(s.pos.length),s.pos=tu(s.pos,r[0].pos),o&&(s.types=tu(s.types,r[0].types))),r[1]&&(a.holes.push(a.pos.length),a.pos=tu(a.pos,r[1].pos),o&&(a.types=tu(a.types,r[1].types)))}else{const i={positions:t};o&&(i.edgeTypes=e),n.length&&(i.holeIndices=n),a.push(i)}}return a}function nu(t,e,n,i,r,s,o){const a=(r-i)/n,c=[],l=[],u=[],h=[],d=[];let f,g,p;const m=ql(t,a-1,n,i);let v=Math.sign(8&o?m[1]-s[3]:m[0]-s[2]),y=e&&e[a-1],b=0,_=0;for(let r=0;r<a;r++)f=ql(t,r,n,i,f),g=Math.sign(8&o?f[1]-s[3]:f[0]-s[2]),p=e&&e[i/n+r],g&&v&&v!==g&&(Jl(m,f,o,s,d),Yl(c,d)&&u.push(y),Yl(l,d)&&h.push(y)),g<=0?(Yl(c,f)&&u.push(p),b-=g):u.length&&(u[u.length-1]=0),g>=0?(Yl(l,f)&&h.push(p),_+=g):h.length&&(h[h.length-1]=0),Kl(m,f),v=g,y=p;return[b?{pos:c,types:e&&u}:null,_?{pos:l,types:e&&h}:null]}function iu(t,e,n,i){const r=Math.floor((t[0]-n[0])/e)*e+n[0],s=Math.floor((t[1]-n[1])/e)*e+n[1];return i[0]=r,i[1]=s,i[2]=r+e,i[3]=s+e,i}function ru(t,e,n){8&n?(t[1]+=e,t[3]+=e):4&n?(t[1]-=e,t[3]-=e):2&n?(t[0]+=e,t[2]+=e):1&n&&(t[0]-=e,t[2]-=e)}function su(t,e,n,i){let r=1/0,s=-1/0,o=1/0,a=-1/0;for(let i=0;i<n;i+=e){const e=t[i],n=t[i+1];r=e<r?e:r,s=e>s?e:s,o=n<o?n:o,a=n>a?n:a}return i[0][0]=r,i[0][1]=o,i[1][0]=s,i[1][1]=a,i}function ou(t,e,n,i){let r=-1,s=-1;for(let o=n+1;o<i;o+=e){const e=Math.abs(t[o]);e>r&&(r=e,s=o-1)}return s}function au(t,e,n,i,r=85.051129){const s=t[n],o=t[i-e];if(Math.abs(s-o)>180){const i=ql(t,0,e,n);i[0]+=360*Math.round((o-s)/360),Yl(t,i),i[1]=Math.sign(i[1])*r,Yl(t,i),i[0]=s,Yl(t,i)}}function cu(t,e,n,i){let r,s=t[0];for(let o=n;o<i;o+=e){r=t[o];const e=r-s;(e>180||e<-180)&&(r-=360*Math.round(e/360)),t[o]=s=r}}function lu(t,e){let n;const i=t.length/e;for(let r=0;r<i&&(n=t[r*e],(n+180)%360==0);r++);const r=360*-Math.round(n/360);if(0!==r)for(let n=0;n<i;n++)t[n*e]+=r}class uu extends Io{constructor(t){const{id:e=Je("column-geometry")}=t,{indices:n,attributes:i}=function(t){const{radius:e,height:n=1,nradial:i=10}=t;let{vertices:r}=t;r&&(Xt.assert(r.length>=i),r=r.flatMap(t=>[t[0],t[1]]),Zl(r,Xl));const s=n>0,o=i+1,a=s?3*o+1:i,c=2*Math.PI/i,l=new Uint16Array(s?3*i*2:0),u=new Float32Array(3*a),h=new Float32Array(3*a);let d=0;if(s){for(let t=0;t<o;t++){const s=t*c,o=t%i,a=Math.sin(s),l=Math.cos(s);for(let t=0;t<2;t++)u[d+0]=r?r[2*o]:l*e,u[d+1]=r?r[2*o+1]:a*e,u[d+2]=(.5-t)*n,h[d+0]=r?r[2*o]:l,h[d+1]=r?r[2*o+1]:a,d+=3}u[d+0]=u[d-3],u[d+1]=u[d-2],u[d+2]=u[d-1],d+=3}for(let t=s?0:1;t<o;t++){const s=Math.floor(t/2)*Math.sign(.5-t%2),o=s*c,a=(s+i)%i,l=Math.sin(o),f=Math.cos(o);u[d+0]=r?r[2*a]:f*e,u[d+1]=r?r[2*a+1]:l*e,u[d+2]=n/2,h[d+2]=1,d+=3}if(s){let t=0;for(let e=0;e<i;e++)l[t++]=2*e+0,l[t++]=2*e+2,l[t++]=2*e+0,l[t++]=2*e+1,l[t++]=2*e+1,l[t++]=2*e+3}return{indices:l,attributes:{POSITION:{size:3,value:u},NORMAL:{size:3,value:h}}}}(t);super({...t,id:e,indices:n,attributes:i})}}const hu=[0,0,0,255],du={diskResolution:{type:"number",min:4,value:20},vertices:null,radius:{type:"number",min:0,value:1e3},angle:{type:"number",value:0},offset:{type:"array",value:[0,0]},coverage:{type:"number",min:0,max:1,value:1},elevationScale:{type:"number",min:0,value:1},radiusUnits:"meters",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,extruded:!0,wireframe:!1,filled:!0,stroked:!1,getPosition:{type:"accessor",value:t=>t.position},getFillColor:{type:"accessor",value:hu},getLineColor:{type:"accessor",value:hu},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0,getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class fu extends dl{getShaders(){const{gl:t}=this.context,e=!ee(t),n={},i=this.props.flatShading&&ii(t,ti);return i&&(n.FLAT_SHADING=1),super.getShaders({vs:"#version 300 es\n\n#define SHADER_NAME column-layer-vertex-shader\n\nin vec3 positions;\nin vec3 normals;\n\nin vec3 instancePositions;\nin float instanceElevations;\nin vec3 instancePositions64Low;\nin vec4 instanceFillColors;\nin vec4 instanceLineColors;\nin float instanceStrokeWidths;\n\nin vec3 instancePickingColors;\nuniform float opacity;\nuniform float radius;\nuniform float angle;\nuniform vec2 offset;\nuniform bool extruded;\nuniform bool stroked;\nuniform bool isStroke;\nuniform float coverage;\nuniform float elevationScale;\nuniform float edgeDistance;\nuniform float widthScale;\nuniform float widthMinPixels;\nuniform float widthMaxPixels;\nuniform int radiusUnits;\nuniform int widthUnits;\nout vec4 vColor;\n#ifdef FLAT_SHADING\nout vec4 position_commonspace;\n#endif\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n\n  vec4 color = isStroke ? instanceLineColors : instanceFillColors;\n  mat2 rotationMatrix = mat2(cos(angle), sin(angle), -sin(angle), cos(angle));\n  float elevation = 0.0;\n  float strokeOffsetRatio = 1.0;\n\n  if (extruded) {\n    elevation = instanceElevations * (positions.z + 1.0) / 2.0 * elevationScale;\n  } else if (stroked) {\n    float widthPixels = clamp(\n      project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),\n      widthMinPixels, widthMaxPixels) / 2.0;\n    float halfOffset = project_pixel_size(widthPixels) / project_size(edgeDistance * coverage * radius);\n    if (isStroke) {\n      strokeOffsetRatio -= sign(positions.z) * halfOffset;\n    } else {\n      strokeOffsetRatio -= halfOffset;\n    }\n  }\n  float shouldRender = float(color.a > 0.0 && instanceElevations >= 0.0);\n  float dotRadius = radius * coverage * shouldRender;\n\n  geometry.pickingColor = instancePickingColors;\n  vec3 centroidPosition = vec3(instancePositions.xy, instancePositions.z + elevation);\n  vec3 centroidPosition64Low = instancePositions64Low;\n  vec2 offset = (rotationMatrix * positions.xy * strokeOffsetRatio + offset) * dotRadius;\n  if (radiusUnits == UNIT_METERS) {\n    offset = project_size(offset);\n  }\n  vec3 pos = vec3(offset, 0.);\n  DECKGL_FILTER_SIZE(pos, geometry);\n\n  gl_Position = project_position_to_clipspace(centroidPosition, centroidPosition64Low, pos, geometry.position);\n  geometry.normal = project_normal(vec3(rotationMatrix * normals.xy, normals.z));\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  if (extruded && !isStroke) {\n#ifdef FLAT_SHADING\n    position_commonspace = geometry.position;\n    vColor = vec4(color.rgb, color.a * opacity);\n#else\n    vec3 lightColor = lighting_getLightColor(color.rgb, project_uCameraPosition, geometry.position.xyz, geometry.normal);\n    vColor = vec4(lightColor, color.a * opacity);\n#endif\n  } else {\n    vColor = vec4(color.rgb, color.a * opacity);\n  }\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#version 300 es\n#define SHADER_NAME column-layer-fragment-shader\n\nprecision highp float;\n\nuniform vec3 project_uCameraPosition;\nuniform bool extruded;\nuniform bool isStroke;\n\nout vec4 fragColor;\n\nin vec4 vColor;\n#ifdef FLAT_SHADING\nin vec4 position_commonspace;\n#endif\n\nvoid main(void) {\n  fragColor = vColor;\n#ifdef FLAT_SHADING\n  if (extruded && !isStroke && !picking_uActive) {\n    vec3 normal = normalize(cross(dFdx(position_commonspace.xyz), dFdy(position_commonspace.xyz)));\n    fragColor.rgb = lighting_getLightColor(vColor.rgb, project_uCameraPosition, position_commonspace.xyz, normal);\n  }\n#endif\n  DECKGL_FILTER_COLOR(fragColor, geometry);\n}\n",defines:n,transpileToGLSL100:e,modules:[tc,i?go:fo,ec]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceElevations:{size:1,transition:!0,accessor:"getElevation"},instanceFillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getFillColor",defaultValue:hu},instanceLineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:!0,accessor:"getLineColor",defaultValue:hu},instanceStrokeWidths:{size:1,accessor:"getLineWidth",transition:!0}})}updateState(t){super.updateState(t);const{props:e,oldProps:n,changeFlags:i}=t,r=i.extensionsChanged||e.flatShading!==n.flatShading;if(r){var s;const{gl:t}=this.context;null===(s=this.state.model)||void 0===s||s.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}(r||e.diskResolution!==n.diskResolution||e.vertices!==n.vertices||(e.extruded||e.stroked)!==(n.extruded||n.stroked))&&this._updateGeometry(e)}getGeometry(t,e,n){const i=new uu({radius:1,height:n?2:0,vertices:e,nradial:t});let r=0;if(e)for(let n=0;n<t;n++){const i=e[n];r+=Math.sqrt(i[0]*i[0]+i[1]*i[1])/t}else r=1;return this.setState({edgeDistance:Math.cos(Math.PI/t)*r}),i}_getModel(t){return new Po(t,{...this.getShaders(),id:this.props.id,isInstanced:!0})}_updateGeometry({diskResolution:t,vertices:e,extruded:n,stroked:i}){const r=this.getGeometry(t,e,n||i);this.setState({fillVertexCount:r.attributes.POSITION.value.length/3,wireframeVertexCount:r.indices.value.length}),this.state.model.setProps({geometry:r})}draw({uniforms:t}){const{lineWidthUnits:e,lineWidthScale:n,lineWidthMinPixels:i,lineWidthMaxPixels:r,radiusUnits:s,elevationScale:o,extruded:a,filled:c,stroked:l,wireframe:u,offset:h,coverage:d,radius:f,angle:g}=this.props,{model:p,fillVertexCount:m,wireframeVertexCount:v,edgeDistance:y}=this.state;p.setUniforms(t).setUniforms({radius:f,angle:g/180*Math.PI,offset:h,extruded:a,stroked:l,coverage:d,elevationScale:o,edgeDistance:y,radiusUnits:Jt[s],widthUnits:Jt[e],widthScale:n,widthMinPixels:i,widthMaxPixels:r}),a&&u&&(p.setProps({isIndexed:!0}),p.setVertexCount(v).setDrawMode(1).setUniforms({isStroke:!0}).draw()),c&&(p.setProps({isIndexed:!1}),p.setVertexCount(m).setDrawMode(5).setUniforms({isStroke:!1}).draw()),!a&&l&&(p.setProps({isIndexed:!1}),p.setVertexCount(2*m/3).setDrawMode(5).setUniforms({isStroke:!0}).draw())}}n(fu,"layerName","ColumnLayer"),n(fu,"defaultProps",du);class gu extends fu{getGeometry(t){return new Bo}draw({uniforms:t}){const{elevationScale:e,extruded:n,offset:i,coverage:r,cellSize:s,angle:o,radiusUnits:a}=this.props;this.state.model.setUniforms(t).setUniforms({radius:s/2,radiusUnits:Jt[a],angle:o,offset:i,extruded:n,coverage:r,elevationScale:e,edgeDistance:1,isWireframe:!1}).draw()}}function pu(t,e,n,i){let r;if(Array.isArray(t[0])){const n=t.length*e;r=new Array(n);for(let n=0;n<t.length;n++)for(let i=0;i<e;i++)r[n*e+i]=t[n][i]||0}else r=t;return n?$l(r,{size:e,gridResolution:n}):i?function(t,e){const{size:n=2,startIndex:i=0,endIndex:r=t.length,normalize:s=!0}=e||{},o=t.slice(i,r);cu(o,n,0,r-i);const a=$l(o,{size:n,broken:!0,gridResolution:360,gridOffset:[-180,-180]});if(s)for(const t of a)lu(t,n);return a}(r,{size:e}):r}n(gu,"layerName","GridCellLayer"),n(gu,"defaultProps",{cellSize:{type:"number",min:0,value:1e3},offset:{type:"array",value:[1,1]}});class mu extends gl{constructor(t){super({...t,attributes:{positions:{size:3,padding:18,initialize:!0,type:t.fp64?Float64Array:Float32Array},segmentTypes:{size:1,type:Uint8ClampedArray}}})}get(t){return this.attributes[t]}getGeometryFromBuffer(t){return this.normalize?super.getGeometryFromBuffer(t):null}normalizeGeometry(t){return this.normalize?pu(t,this.positionSize,this.opts.resolution,this.opts.wrapLongitude):t}getGeometrySize(t){if(vu(t)){let e=0;for(const n of t)e+=this.getGeometrySize(n);return e}const e=this.getPathLength(t);return e<2?0:this.isClosed(t)?e<3?0:e+2:e}updateGeometryAttributes(t,e){if(0!==e.geometrySize)if(t&&vu(t))for(const n of t){const t=this.getGeometrySize(n);e.geometrySize=t,this.updateGeometryAttributes(n,e),e.vertexStart+=t}else this._updateSegmentTypes(t,e),this._updatePositions(t,e)}_updateSegmentTypes(t,e){const n=this.attributes.segmentTypes,i=!!t&&this.isClosed(t),{vertexStart:r,geometrySize:s}=e;n.fill(0,r,r+s),i?(n[r]=4,n[r+s-2]=4):(n[r]+=1,n[r+s-2]+=2),n[r+s-1]=4}_updatePositions(t,e){const{positions:n}=this.attributes;if(!n||!t)return;const{vertexStart:i,geometrySize:r}=e,s=new Array(3);for(let e=i,o=0;o<r;e++,o++)this.getPointOnPath(t,o,s),n[3*e]=s[0],n[3*e+1]=s[1],n[3*e+2]=s[2]}getPathLength(t){return t.length/this.positionSize}getPointOnPath(t,e,n=[]){const{positionSize:i}=this;e*i>=t.length&&(e+=1-t.length/i);const r=e*i;return n[0]=t[r],n[1]=t[r+1],n[2]=3===i&&t[r+2]||0,n}isClosed(t){if(!this.normalize)return Boolean(this.opts.loop);const{positionSize:e}=this,n=t.length-e;return t[0]===t[n]&&t[1]===t[n+1]&&(2===e||t[2]===t[n+2])}}function vu(t){return Array.isArray(t[0])}const yu=[0,0,0,255],bu={widthUnits:"meters",widthScale:{type:"number",min:0,value:1},widthMinPixels:{type:"number",min:0,value:0},widthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},jointRounded:!1,capRounded:!1,miterLimit:{type:"number",min:0,value:4},billboard:!1,_pathType:null,getPath:{type:"accessor",value:t=>t.path},getColor:{type:"accessor",value:yu},getWidth:{type:"accessor",value:1},rounded:{deprecatedFor:["jointRounded","capRounded"]}},_u={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t};class xu extends dl{constructor(...t){super(...t),n(this,"state",void 0)}getShaders(){return super.getShaders({vs:"#define SHADER_NAME path-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute float instanceTypes;\nattribute vec3 instanceStartPositions;\nattribute vec3 instanceEndPositions;\nattribute vec3 instanceLeftPositions;\nattribute vec3 instanceRightPositions;\nattribute vec3 instanceLeftPositions64Low;\nattribute vec3 instanceStartPositions64Low;\nattribute vec3 instanceEndPositions64Low;\nattribute vec3 instanceRightPositions64Low;\nattribute float instanceStrokeWidths;\nattribute vec4 instanceColors;\nattribute vec3 instancePickingColors;\n\nuniform float widthScale;\nuniform float widthMinPixels;\nuniform float widthMaxPixels;\nuniform float jointType;\nuniform float capType;\nuniform float miterLimit;\nuniform bool billboard;\nuniform int widthUnits;\n\nuniform float opacity;\n\nvarying vec4 vColor;\nvarying vec2 vCornerOffset;\nvarying float vMiterLength;\nvarying vec2 vPathPosition;\nvarying float vPathLength;\nvarying float vJointType;\n\nconst float EPSILON = 0.001;\nconst vec3 ZERO_OFFSET = vec3(0.0);\n\nfloat flipIfTrue(bool flag) {\n  return -(float(flag) * 2. - 1.);\n}\nvec3 getLineJoinOffset(\n  vec3 prevPoint, vec3 currPoint, vec3 nextPoint,\n  vec2 width\n) {\n  bool isEnd = positions.x > 0.0;\n  float sideOfPath = positions.y;\n  float isJoint = float(sideOfPath == 0.0);\n\n  vec3 deltaA3 = (currPoint - prevPoint);\n  vec3 deltaB3 = (nextPoint - currPoint);\n\n  mat3 rotationMatrix;\n  bool needsRotation = !billboard && project_needs_rotation(currPoint, rotationMatrix);\n  if (needsRotation) {\n    deltaA3 = deltaA3 * rotationMatrix;\n    deltaB3 = deltaB3 * rotationMatrix;\n  }\n  vec2 deltaA = deltaA3.xy / width;\n  vec2 deltaB = deltaB3.xy / width;\n\n  float lenA = length(deltaA);\n  float lenB = length(deltaB);\n\n  vec2 dirA = lenA > 0. ? normalize(deltaA) : vec2(0.0, 0.0);\n  vec2 dirB = lenB > 0. ? normalize(deltaB) : vec2(0.0, 0.0);\n\n  vec2 perpA = vec2(-dirA.y, dirA.x);\n  vec2 perpB = vec2(-dirB.y, dirB.x);\n  vec2 tangent = dirA + dirB;\n  tangent = length(tangent) > 0. ? normalize(tangent) : perpA;\n  vec2 miterVec = vec2(-tangent.y, tangent.x);\n  vec2 dir = isEnd ? dirA : dirB;\n  vec2 perp = isEnd ? perpA : perpB;\n  float L = isEnd ? lenA : lenB;\n  float sinHalfA = abs(dot(miterVec, perp));\n  float cosHalfA = abs(dot(dirA, miterVec));\n  float turnDirection = flipIfTrue(dirA.x * dirB.y >= dirA.y * dirB.x);\n  float cornerPosition = sideOfPath * turnDirection;\n\n  float miterSize = 1.0 / max(sinHalfA, EPSILON);\n  miterSize = mix(\n    min(miterSize, max(lenA, lenB) / max(cosHalfA, EPSILON)),\n    miterSize,\n    step(0.0, cornerPosition)\n  );\n\n  vec2 offsetVec = mix(miterVec * miterSize, perp, step(0.5, cornerPosition))\n    * (sideOfPath + isJoint * turnDirection);\n  bool isStartCap = lenA == 0.0 || (!isEnd && (instanceTypes == 1.0 || instanceTypes == 3.0));\n  bool isEndCap = lenB == 0.0 || (isEnd && (instanceTypes == 2.0 || instanceTypes == 3.0));\n  bool isCap = isStartCap || isEndCap;\n  if (isCap) {\n    offsetVec = mix(perp * sideOfPath, dir * capType * 4.0 * flipIfTrue(isStartCap), isJoint);\n    vJointType = capType;\n  } else {\n    vJointType = jointType;\n  }\n  vPathLength = L;\n  vCornerOffset = offsetVec;\n  vMiterLength = dot(vCornerOffset, miterVec * turnDirection);\n  vMiterLength = isCap ? isJoint : vMiterLength;\n\n  vec2 offsetFromStartOfPath = vCornerOffset + deltaA * float(isEnd);\n  vPathPosition = vec2(\n    dot(offsetFromStartOfPath, perp),\n    dot(offsetFromStartOfPath, dir)\n  );\n  geometry.uv = vPathPosition;\n\n  float isValid = step(instanceTypes, 3.5);\n  vec3 offset = vec3(offsetVec * width * isValid, 0.0);\n\n  if (needsRotation) {\n    offset = rotationMatrix * offset;\n  }\n  return offset;\n}\nvoid clipLine(inout vec4 position, vec4 refPosition) {\n  if (position.w < EPSILON) {\n    float r = (EPSILON - refPosition.w) / (position.w - refPosition.w);\n    position = refPosition + (position - refPosition) * r;\n  }\n}\n\nvoid main() {\n  geometry.pickingColor = instancePickingColors;\n\n  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity);\n\n  float isEnd = positions.x;\n\n  vec3 prevPosition = mix(instanceLeftPositions, instanceStartPositions, isEnd);\n  vec3 prevPosition64Low = mix(instanceLeftPositions64Low, instanceStartPositions64Low, isEnd);\n\n  vec3 currPosition = mix(instanceStartPositions, instanceEndPositions, isEnd);\n  vec3 currPosition64Low = mix(instanceStartPositions64Low, instanceEndPositions64Low, isEnd);\n\n  vec3 nextPosition = mix(instanceEndPositions, instanceRightPositions, isEnd);\n  vec3 nextPosition64Low = mix(instanceEndPositions64Low, instanceRightPositions64Low, isEnd);\n\n  geometry.worldPosition = currPosition;\n  vec2 widthPixels = vec2(clamp(\n    project_size_to_pixel(instanceStrokeWidths * widthScale, widthUnits),\n    widthMinPixels, widthMaxPixels) / 2.0);\n  vec3 width;\n\n  if (billboard) {\n    vec4 prevPositionScreen = project_position_to_clipspace(prevPosition, prevPosition64Low, ZERO_OFFSET);\n    vec4 currPositionScreen = project_position_to_clipspace(currPosition, currPosition64Low, ZERO_OFFSET, geometry.position);\n    vec4 nextPositionScreen = project_position_to_clipspace(nextPosition, nextPosition64Low, ZERO_OFFSET);\n\n    clipLine(prevPositionScreen, currPositionScreen);\n    clipLine(nextPositionScreen, currPositionScreen);\n    clipLine(currPositionScreen, mix(nextPositionScreen, prevPositionScreen, isEnd));\n\n    width = vec3(widthPixels, 0.0);\n    DECKGL_FILTER_SIZE(width, geometry);\n\n    vec3 offset = getLineJoinOffset(\n      prevPositionScreen.xyz / prevPositionScreen.w,\n      currPositionScreen.xyz / currPositionScreen.w,\n      nextPositionScreen.xyz / nextPositionScreen.w,\n      project_pixel_size_to_clipspace(width.xy)\n    );\n\n    DECKGL_FILTER_GL_POSITION(currPositionScreen, geometry);\n    gl_Position = vec4(currPositionScreen.xyz + offset * currPositionScreen.w, currPositionScreen.w);\n  } else {\n    prevPosition = project_position(prevPosition, prevPosition64Low);\n    currPosition = project_position(currPosition, currPosition64Low);\n    nextPosition = project_position(nextPosition, nextPosition64Low);\n\n    width = vec3(project_pixel_size(widthPixels), 0.0);\n    DECKGL_FILTER_SIZE(width, geometry);\n\n    vec3 offset = getLineJoinOffset(prevPosition, currPosition, nextPosition, width.xy);\n    geometry.position = vec4(currPosition + offset, 1.0);\n    gl_Position = project_common_position_to_clipspace(geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",fs:"#define SHADER_NAME path-layer-fragment-shader\n\nprecision highp float;\n\nuniform float miterLimit;\n\nvarying vec4 vColor;\nvarying vec2 vCornerOffset;\nvarying float vMiterLength;\nvarying vec2 vPathPosition;\nvarying float vPathLength;\nvarying float vJointType;\n\nvoid main(void) {\n  geometry.uv = vPathPosition;\n\n  if (vPathPosition.y < 0.0 || vPathPosition.y > vPathLength) {\n    if (vJointType > 0.5 && length(vCornerOffset) > 1.0) {\n      discard;\n    }\n    if (vJointType < 0.5 && vMiterLength > miterLimit + 1.0) {\n      discard;\n    }\n  }\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[tc,ec]})}get wrapLongitude(){return!1}initializeState(){const t=!0;this.getAttributeManager().addInstanced({positions:{size:3,vertexOffset:1,type:5130,fp64:this.use64bitPositions(),transition:_u,accessor:"getPath",update:this.calculatePositions,noAlloc:t,shaderAttributes:{instanceLeftPositions:{vertexOffset:0},instanceStartPositions:{vertexOffset:1},instanceEndPositions:{vertexOffset:2},instanceRightPositions:{vertexOffset:3}}},instanceTypes:{size:1,type:5121,update:this.calculateSegmentTypes,noAlloc:t},instanceStrokeWidths:{size:1,accessor:"getWidth",transition:_u,defaultValue:1},instanceColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,accessor:"getColor",transition:_u,defaultValue:yu},instancePickingColors:{size:3,type:5121,accessor:(t,{index:e,target:n})=>this.encodePickingColor(t&&t.__source?t.__source.index:e,n)}}),this.setState({pathTesselator:new mu({fp64:this.use64bitPositions()})})}updateState(t){super.updateState(t);const{props:e,changeFlags:n}=t,i=this.getAttributeManager();if(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPath)){const{pathTesselator:t}=this.state,r=e.data.attributes||{};t.updateGeometry({data:e.data,geometryBuffer:r.getPath,buffers:r,normalize:!e._pathType,loop:"loop"===e._pathType,getGeometry:e.getPath,positionFormat:e.positionFormat,wrapLongitude:e.wrapLongitude,resolution:this.context.viewport.resolution,dataChanged:n.dataChanged}),this.setState({numInstances:t.instanceCount,startIndices:t.vertexStarts}),n.dataChanged||i.invalidateAll()}if(n.extensionsChanged){var r;const{gl:t}=this.context;null===(r=this.state.model)||void 0===r||r.delete(),this.state.model=this._getModel(t),i.invalidateAll()}}getPickingInfo(t){const e=super.getPickingInfo(t),{index:n}=e,{data:i}=this.props;return i[0]&&i[0].__source&&(e.object=i.find(t=>t.__source.index===n)),e}disablePickingIndex(t){const{data:e}=this.props;if(e[0]&&e[0].__source)for(let n=0;n<e.length;n++)e[n].__source.index===t&&this._disablePickingIndex(n);else super.disablePickingIndex(t)}draw({uniforms:t}){const{jointRounded:e,capRounded:n,billboard:i,miterLimit:r,widthUnits:s,widthScale:o,widthMinPixels:a,widthMaxPixels:c}=this.props;this.state.model.setUniforms(t).setUniforms({jointType:Number(e),capType:Number(n),billboard:i,widthUnits:Jt[s],widthScale:o,miterLimit:r,widthMinPixels:a,widthMaxPixels:c}).draw()}_getModel(t){return new Po(t,{...this.getShaders(),id:this.props.id,geometry:new Io({drawMode:4,attributes:{indices:new Uint16Array([0,1,2,1,4,2,1,3,4,3,5,4]),positions:{value:new Float32Array([0,0,0,-1,0,1,1,-1,1,1,1,0]),size:2}}}),isInstanced:!0})}calculatePositions(t){const{pathTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("positions")}calculateSegmentTypes(t){const{pathTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("segmentTypes")}}n(xu,"defaultProps",bu),n(xu,"layerName","PathLayer");var Pu={exports:{}};function wu(t,e,n){n=n||2;var i,r,s,o,a,c,l,u=e&&e.length,h=u?e[0]*n:t.length,d=Au(t,0,h,n,!0),f=[];if(!d||d.next===d.prev)return f;if(u&&(d=function(t,e,n,i){var r,s,o,a=[];for(r=0,s=e.length;r<s;r++)(o=Au(t,e[r]*i,r<s-1?e[r+1]*i:t.length,i,!1))===o.next&&(o.steiner=!0),a.push(zu(o));for(a.sort(Ou),r=0;r<a.length;r++)n=Iu(a[r],n);return n}(t,e,d,n)),t.length>80*n){i=s=t[0],r=o=t[1];for(var g=n;g<h;g+=n)(a=t[g])<i&&(i=a),(c=t[g+1])<r&&(r=c),a>s&&(s=a),c>o&&(o=c);l=0!==(l=Math.max(s-i,o-r))?32767/l:0}return Tu(d,f,n,i,r,l,0),f}function Au(t,e,n,i,r){var s,o;if(r===Yu(t,e,n,i)>0)for(s=e;s<n;s+=i)o=Hu(s,t[s],t[s+1],o);else for(s=n-i;s>=e;s-=i)o=Hu(s,t[s],t[s+1],o);return o&&Du(o,o.next)&&(Xu(o),o=o.next),o}function Su(t,e){if(!t)return t;e||(e=t);var n,i=t;do{if(n=!1,i.steiner||!Du(i,i.next)&&0!==Bu(i.prev,i,i.next))i=i.next;else{if(Xu(i),(i=e=i.prev)===i.next)break;n=!0}}while(n||i!==e);return e}function Tu(t,e,n,i,r,s,o){if(t){!o&&s&&function(t,e,n,i){var r=t;do{0===r.z&&(r.z=Fu(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,n,i,r,s,o,a,c,l=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,i=n,a=0,e=0;e<l&&(a++,i=i.nextZ);e++);for(c=l;a>0||c>0&&i;)0!==a&&(0===c||!i||n.z<=i.z)?(r=n,n=n.nextZ,a--):(r=i,i=i.nextZ,c--),s?s.nextZ=r:t=r,r.prevZ=s,s=r;n=i}s.nextZ=null,l*=2}while(o>1)}(r)}(t,i,r,s);for(var a,c,l=t;t.prev!==t.next;)if(a=t.prev,c=t.next,s?Cu(t,i,r,s):Eu(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(c.i/n|0),Xu(t),t=c.next,l=c.next;else if((t=c)===l){o?1===o?Tu(t=Lu(Su(t),e,n),e,n,i,r,s,2):2===o&&Mu(t,e,n,i,r,s):Tu(Su(t),e,n,i,r,s,1);break}}}function Eu(t){var e=t.prev,n=t,i=t.next;if(Bu(e,n,i)>=0)return!1;for(var r=e.x,s=n.x,o=i.x,a=e.y,c=n.y,l=i.y,u=r<s?r<o?r:o:s<o?s:o,h=a<c?a<l?a:l:c<l?c:l,d=r>s?r>o?r:o:s>o?s:o,f=a>c?a>l?a:l:c>l?c:l,g=i.next;g!==e;){if(g.x>=u&&g.x<=d&&g.y>=h&&g.y<=f&&ku(r,a,s,c,o,l,g.x,g.y)&&Bu(g.prev,g,g.next)>=0)return!1;g=g.next}return!0}function Cu(t,e,n,i){var r=t.prev,s=t,o=t.next;if(Bu(r,s,o)>=0)return!1;for(var a=r.x,c=s.x,l=o.x,u=r.y,h=s.y,d=o.y,f=a<c?a<l?a:l:c<l?c:l,g=u<h?u<d?u:d:h<d?h:d,p=a>c?a>l?a:l:c>l?c:l,m=u>h?u>d?u:d:h>d?h:d,v=Fu(f,g,e,n,i),y=Fu(p,m,e,n,i),b=t.prevZ,_=t.nextZ;b&&b.z>=v&&_&&_.z<=y;){if(b.x>=f&&b.x<=p&&b.y>=g&&b.y<=m&&b!==r&&b!==o&&ku(a,u,c,h,l,d,b.x,b.y)&&Bu(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,_.x>=f&&_.x<=p&&_.y>=g&&_.y<=m&&_!==r&&_!==o&&ku(a,u,c,h,l,d,_.x,_.y)&&Bu(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;b&&b.z>=v;){if(b.x>=f&&b.x<=p&&b.y>=g&&b.y<=m&&b!==r&&b!==o&&ku(a,u,c,h,l,d,b.x,b.y)&&Bu(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;_&&_.z<=y;){if(_.x>=f&&_.x<=p&&_.y>=g&&_.y<=m&&_!==r&&_!==o&&ku(a,u,c,h,l,d,_.x,_.y)&&Bu(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function Lu(t,e,n){var i=t;do{var r=i.prev,s=i.next.next;!Du(r,s)&&Nu(r,i,i.next,s)&&Gu(r,s)&&Gu(s,r)&&(e.push(r.i/n|0),e.push(i.i/n|0),e.push(s.i/n|0),Xu(i),Xu(i.next),i=t=s),i=i.next}while(i!==t);return Su(i)}function Mu(t,e,n,i,r,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&ju(o,a)){var c=Wu(o,a);return o=Su(o,o.next),c=Su(c,c.next),Tu(o,e,n,i,r,s,0),void Tu(c,e,n,i,r,s,0)}a=a.next}o=o.next}while(o!==t)}function Ou(t,e){return t.x-e.x}function Iu(t,e){var n=function(t,e){var n,i=e,r=t.x,s=t.y,o=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var a=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=r&&a>o&&(o=a,n=i.x<i.next.x?i:i.next,a===r))return n}i=i.next}while(i!==e);if(!n)return null;var c,l=n,u=n.x,h=n.y,d=1/0;i=n;do{r>=i.x&&i.x>=u&&r!==i.x&&ku(s<h?r:o,s,u,h,s<h?o:r,s,i.x,i.y)&&(c=Math.abs(s-i.y)/(r-i.x),Gu(i,t)&&(c<d||c===d&&(i.x>n.x||i.x===n.x&&Ru(n,i)))&&(n=i,d=c)),i=i.next}while(i!==l);return n}(t,e);if(!n)return e;var i=Wu(n,t);return Su(i,i.next),Su(n,n.next)}function Ru(t,e){return Bu(t.prev,t,e.prev)<0&&Bu(e.next,t,t.next)<0}function Fu(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function zu(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function ku(t,e,n,i,r,s,o,a){return(r-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(i-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(r-o)*(i-a)}function ju(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Nu(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Gu(t,e)&&Gu(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&r<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)&&(Bu(t.prev,t,e.prev)||Bu(t,e.prev,e))||Du(t,e)&&Bu(t.prev,t,t.next)>0&&Bu(e.prev,e,e.next)>0)}function Bu(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Du(t,e){return t.x===e.x&&t.y===e.y}function Nu(t,e,n,i){var r=Vu(Bu(t,e,n)),s=Vu(Bu(t,e,i)),o=Vu(Bu(n,i,t)),a=Vu(Bu(n,i,e));return r!==s&&o!==a||(!(0!==r||!Uu(t,n,e))||(!(0!==s||!Uu(t,i,e))||(!(0!==o||!Uu(n,t,i))||!(0!==a||!Uu(n,e,i)))))}function Uu(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Vu(t){return t>0?1:t<0?-1:0}function Gu(t,e){return Bu(t.prev,t,t.next)<0?Bu(t,e,t.next)>=0&&Bu(t,t.prev,e)>=0:Bu(t,e,t.prev)<0||Bu(t,t.next,e)<0}function Wu(t,e){var n=new Zu(t.i,t.x,t.y),i=new Zu(e.i,e.x,e.y),r=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,s.next=i,i.prev=s,i}function Hu(t,e,n,i){var r=new Zu(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Xu(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Zu(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Yu(t,e,n,i){for(var r=0,s=e,o=n-i;s<n;s+=i)r+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return r}Pu.exports=wu,Pu.exports.default=wu,wu.deviation=function(t,e,n,i){var r=e&&e.length,s=r?e[0]*n:t.length,o=Math.abs(Yu(t,0,s,n));if(r)for(var a=0,c=e.length;a<c;a++){var l=e[a]*n,u=a<c-1?e[a+1]*n:t.length;o-=Math.abs(Yu(t,l,u,n))}var h=0;for(a=0;a<i.length;a+=3){var d=i[a]*n,f=i[a+1]*n,g=i[a+2]*n;h+=Math.abs((t[d]-t[g])*(t[f+1]-t[d+1])-(t[d]-t[f])*(t[g+1]-t[d+1]))}return 0===o&&0===h?0:Math.abs((h-o)/o)},wu.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},i=0,r=0;r<t.length;r++){for(var s=0;s<t[r].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[r][s][o]);r>0&&(i+=t[r-1].length,n.holes.push(i))}return n};var Ku=sc(Pu.exports);const qu=Hl,Ju=Xl,Qu={};function $u(t){return"positions"in t?t.positions:t}function th(t){return"holeIndices"in t?t.holeIndices:null}function eh(t,e,n,i,r){let s=e;const o=n.length;for(let e=0;e<o;e++)for(let r=0;r<i;r++)t[s++]=n[e][r]||0;if(!function(t){const e=t[0],n=t[t.length-1];return e[0]===n[0]&&e[1]===n[1]&&e[2]===n[2]}(n))for(let e=0;e<i;e++)t[s++]=n[0][e]||0;return Qu.start=e,Qu.end=s,Qu.size=i,Zl(t,r,Qu),s}function nh(t,e,n,i,r=0,s,o){const a=(s=s||n.length)-r;if(a<=0)return e;let c=e;for(let e=0;e<a;e++)t[c++]=n[r+e];if(!function(t,e,n,i){for(let r=0;r<e;r++)if(t[n+r]!==t[i-e+r])return!1;return!0}(n,i,r,s))for(let e=0;e<i;e++)t[c++]=n[r+e];return Qu.start=e,Qu.end=c,Qu.size=i,Zl(t,o,Qu),c}function ih(t,e){!function(t){if(t=t&&t.positions||t,!Array.isArray(t)&&!ArrayBuffer.isView(t))throw new Error("invalid polygon")}(t);const n=[],i=[];if("positions"in t){const{positions:r,holeIndices:s}=t;if(s){let t=0;for(let o=0;o<=s.length;o++)t=nh(n,t,r,e,s[o-1],s[o],0===o?qu:Ju),i.push(t);return i.pop(),{positions:n,holeIndices:i}}t=r}if(!function(t){return Array.isArray(t[0])}(t))return nh(n,0,t,e,0,n.length,qu),n;if(!function(t){return t.length>=1&&t[0].length>=2&&Number.isFinite(t[0][0])}(t)){let r=0;for(const[s,o]of t.entries())r=eh(n,r,o,e,0===s?qu:Ju),i.push(r);return i.pop(),{positions:n,holeIndices:i}}return eh(n,0,t,e,qu),n}function rh(t,e,n){const i=t.length/3;let r=0;for(let s=0;s<i;s++){const o=(s+1)%i;r+=t[3*s+e]*t[3*o+n],r-=t[3*o+e]*t[3*s+n]}return Math.abs(r/2)}function sh(t,e,n,i){const r=t.length/3;for(let s=0;s<r;s++){const r=3*s,o=t[r+0],a=t[r+1],c=t[r+2];t[r+e]=o,t[r+n]=a,t[r+i]=c}}class oh extends gl{constructor(t){const{fp64:e,IndexType:n=Uint32Array}=t;super({...t,attributes:{positions:{size:3,type:e?Float64Array:Float32Array},vertexValid:{type:Uint8ClampedArray,size:1},indices:{type:n,size:1}}})}get(t){const{attributes:e}=this;return"indices"===t?e.indices&&e.indices.subarray(0,this.vertexCount):e[t]}updateGeometry(t){super.updateGeometry(t);const e=this.buffers.indices;if(e)this.vertexCount=(e.value||e).length;else if(this.data&&!this.getGeometry)throw new Error("missing indices buffer")}normalizeGeometry(t){if(this.normalize){const e=ih(t,this.positionSize);return this.opts.resolution?eu($u(e),th(e),{size:this.positionSize,gridResolution:this.opts.resolution,edgeTypes:!0}):this.opts.wrapLongitude?function(t,e=null,n){const{size:i=2,normalize:r=!0,edgeTypes:s=!1}=n||{};e=e||[];const o=[],a=[];let c=0,l=0;for(let r=0;r<=e.length;r++){const s=e[r]||t.length,u=l,h=ou(t,i,c,s);for(let e=h;e<s;e++)o[l++]=t[e];for(let e=c;e<h;e++)o[l++]=t[e];cu(o,i,u,l),au(o,i,u,l,null==n?void 0:n.maxLatitude),c=s,a[r]=l}a.pop();const u=eu(o,a,{size:i,gridResolution:360,gridOffset:[-180,-180],edgeTypes:s});if(r)for(const t of u)lu(t.positions,i);return u}($u(e),th(e),{size:this.positionSize,maxLatitude:86,edgeTypes:!0}):e}return t}getGeometrySize(t){if(ah(t)){let e=0;for(const n of t)e+=this.getGeometrySize(n);return e}return $u(t).length/this.positionSize}getGeometryFromBuffer(t){return this.normalize||!this.buffers.indices?super.getGeometryFromBuffer(t):null}updateGeometryAttributes(t,e){if(t&&ah(t))for(const n of t){const t=this.getGeometrySize(n);e.geometrySize=t,this.updateGeometryAttributes(n,e),e.vertexStart+=t,e.indexStart=this.indexStarts[e.geometryIndex+1]}else this._updateIndices(t,e),this._updatePositions(t,e),this._updateVertexValid(t,e)}_updateIndices(t,{geometryIndex:e,vertexStart:n,indexStart:i}){const{attributes:r,indexStarts:s,typedArrayManager:o}=this;let a=r.indices;if(!a||!t)return;let c=i;const l=function(t,e,n,i){let r=th(t);r&&(r=r.map(t=>t/e));let s=$u(t);const o=i&&3===e;if(n){const t=s.length;s=s.slice();const i=[];for(let r=0;r<t;r+=e){i[0]=s[r],i[1]=s[r+1],o&&(i[2]=s[r+2]);const t=n(i);s[r]=t[0],s[r+1]=t[1],o&&(s[r+2]=t[2])}}if(o){const t=rh(s,0,1),e=rh(s,0,2),i=rh(s,1,2);if(!t&&!e&&!i)return[];t>e&&t>i||(e>i?(n||(s=s.slice()),sh(s,0,2,1)):(n||(s=s.slice()),sh(s,2,0,1)))}return Ku(s,r,e)}(t,this.positionSize,this.opts.preproject,this.opts.full3d);a=o.allocate(a,i+l.length,{copy:!0});for(let t=0;t<l.length;t++)a[c++]=l[t]+n;s[e+1]=i+l.length,r.indices=a}_updatePositions(t,{vertexStart:e,geometrySize:n}){const{attributes:{positions:i},positionSize:r}=this;if(!i||!t)return;const s=$u(t);for(let t=e,o=0;o<n;t++,o++){const e=s[o*r],n=s[o*r+1],a=r>2?s[o*r+2]:0;i[3*t]=e,i[3*t+1]=n,i[3*t+2]=a}}_updateVertexValid(t,{vertexStart:e,geometrySize:n}){const{positionSize:i}=this,r=this.attributes.vertexValid,s=t&&th(t);if(t&&t.edgeTypes?r.set(t.edgeTypes,e):r.fill(1,e,e+n),s)for(let t=0;t<s.length;t++)r[e+s[t]/i-1]=0;r[e+n-1]=0}}function ah(t){return Array.isArray(t)&&t.length>0&&!Number.isFinite(t[0])}var ch="\nattribute vec2 vertexPositions;\nattribute float vertexValid;\n\nuniform bool extruded;\nuniform bool isWireframe;\nuniform float elevationScale;\nuniform float opacity;\n\nvarying vec4 vColor;\n\nstruct PolygonProps {\n  vec4 fillColors;\n  vec4 lineColors;\n  vec3 positions;\n  vec3 nextPositions;\n  vec3 pickingColors;\n  vec3 positions64Low;\n  vec3 nextPositions64Low;\n  float elevations;\n};\n\nvec3 project_offset_normal(vec3 vector) {\n  if (project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT ||\n    project_uCoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSETS) {\n    return normalize(vector * project_uCommonUnitsPerWorldUnit);\n  }\n  return project_normal(vector);\n}\n\nvoid calculatePosition(PolygonProps props) {\n#ifdef IS_SIDE_VERTEX\n  if(vertexValid < 0.5){\n    gl_Position = vec4(0.);\n    return;\n  }\n#endif\n\n  vec3 pos;\n  vec3 pos64Low;\n  vec3 normal;\n  vec4 colors = isWireframe ? props.lineColors : props.fillColors;\n\n  geometry.worldPosition = props.positions;\n  geometry.worldPositionAlt = props.nextPositions;\n  geometry.pickingColor = props.pickingColors;\n\n#ifdef IS_SIDE_VERTEX\n  pos = mix(props.positions, props.nextPositions, vertexPositions.x);\n  pos64Low = mix(props.positions64Low, props.nextPositions64Low, vertexPositions.x);\n#else\n  pos = props.positions;\n  pos64Low = props.positions64Low;\n#endif\n\n  if (extruded) {\n    pos.z += props.elevations * vertexPositions.y * elevationScale;\n  }\n  gl_Position = project_position_to_clipspace(pos, pos64Low, vec3(0.), geometry.position);\n\n  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n\n  if (extruded) {\n  #ifdef IS_SIDE_VERTEX\n    normal = vec3(\n      props.positions.y - props.nextPositions.y + (props.positions64Low.y - props.nextPositions64Low.y),\n      props.nextPositions.x - props.positions.x + (props.nextPositions64Low.x - props.positions64Low.x),\n      0.0);\n    normal = project_offset_normal(normal);\n  #else\n    normal = project_normal(vec3(0.0, 0.0, 1.0));\n  #endif\n    geometry.normal = normal;\n    vec3 lightColor = lighting_getLightColor(colors.rgb, project_uCameraPosition, geometry.position.xyz, normal);\n    vColor = vec4(lightColor, colors.a * opacity);\n  } else {\n    vColor = vec4(colors.rgb, colors.a * opacity);\n  }\n  DECKGL_FILTER_COLOR(vColor, geometry);\n}\n",lh="#define SHADER_NAME solid-polygon-layer-vertex-shader\n\nattribute vec3 positions;\nattribute vec3 positions64Low;\nattribute float elevations;\nattribute vec4 fillColors;\nattribute vec4 lineColors;\nattribute vec3 pickingColors;\n\n".concat(ch,"\n\nvoid main(void) {\n  PolygonProps props;\n\n  props.positions = positions;\n  props.positions64Low = positions64Low;\n  props.elevations = elevations;\n  props.fillColors = fillColors;\n  props.lineColors = lineColors;\n  props.pickingColors = pickingColors;\n\n  calculatePosition(props);\n}\n"),uh="#define SHADER_NAME solid-polygon-layer-vertex-shader-side\n#define IS_SIDE_VERTEX\n\n\nattribute vec3 instancePositions;\nattribute vec3 nextPositions;\nattribute vec3 instancePositions64Low;\nattribute vec3 nextPositions64Low;\nattribute float instanceElevations;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\n".concat(ch,"\n\nvoid main(void) {\n  PolygonProps props;\n\n  #if RING_WINDING_ORDER_CW == 1\n    props.positions = instancePositions;\n    props.positions64Low = instancePositions64Low;\n    props.nextPositions = nextPositions;\n    props.nextPositions64Low = nextPositions64Low;\n  #else\n    props.positions = nextPositions;\n    props.positions64Low = nextPositions64Low;\n    props.nextPositions = instancePositions;\n    props.nextPositions64Low = instancePositions64Low;\n  #endif\n  props.elevations = instanceElevations;\n  props.fillColors = instanceFillColors;\n  props.lineColors = instanceLineColors;\n  props.pickingColors = instancePickingColors;\n\n  calculatePosition(props);\n}\n");const hh=[0,0,0,255],dh={filled:!0,extruded:!1,wireframe:!1,_normalize:!0,_windingOrder:"CW",_full3d:!1,elevationScale:{type:"number",min:0,value:1},getPolygon:{type:"accessor",value:t=>t.polygon},getElevation:{type:"accessor",value:1e3},getFillColor:{type:"accessor",value:hh},getLineColor:{type:"accessor",value:hh},material:!0},fh={enter:(t,e)=>e.length?e.subarray(e.length-t.length):t};class gh extends dl{constructor(...t){super(...t),n(this,"state",void 0)}getShaders(t){return super.getShaders({vs:"top"===t?lh:uh,fs:"#define SHADER_NAME solid-polygon-layer-fragment-shader\n\nprecision highp float;\n\nvarying vec4 vColor;\n\nvoid main(void) {\n  gl_FragColor = vColor;\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",defines:{RING_WINDING_ORDER_CW:this.props._normalize||"CCW"!==this.props._windingOrder?1:0},modules:[tc,fo,ec]})}get wrapLongitude(){return!1}initializeState(){const{gl:t,viewport:e}=this.context;let{coordinateSystem:n}=this.props;const{_full3d:i}=this.props;let r;e.isGeospatial&&n===Kt.DEFAULT&&(n=Kt.LNGLAT),n===Kt.LNGLAT&&(r=i?e.projectPosition.bind(e):e.projectFlat.bind(e)),this.setState({numInstances:0,polygonTesselator:new oh({preproject:r,fp64:this.use64bitPositions(),IndexType:!t||ri(t,Dn)?Uint32Array:Uint16Array})});const s=this.getAttributeManager(),o=!0;s.remove(["instancePickingColors"]),s.add({indices:{size:1,isIndexed:!0,update:this.calculateIndices,noAlloc:o},positions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:fh,accessor:"getPolygon",update:this.calculatePositions,noAlloc:o,shaderAttributes:{positions:{vertexOffset:0,divisor:0},instancePositions:{vertexOffset:0,divisor:1},nextPositions:{vertexOffset:1,divisor:1}}},vertexValid:{size:1,divisor:1,type:5121,update:this.calculateVertexValid,noAlloc:o},elevations:{size:1,transition:fh,accessor:"getElevation",shaderAttributes:{elevations:{divisor:0},instanceElevations:{divisor:1}}},fillColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:fh,accessor:"getFillColor",defaultValue:hh,shaderAttributes:{fillColors:{divisor:0},instanceFillColors:{divisor:1}}},lineColors:{size:this.props.colorFormat.length,type:5121,normalized:!0,transition:fh,accessor:"getLineColor",defaultValue:hh,shaderAttributes:{lineColors:{divisor:0},instanceLineColors:{divisor:1}}},pickingColors:{size:3,type:5121,accessor:(t,{index:e,target:n})=>this.encodePickingColor(t&&t.__source?t.__source.index:e,n),shaderAttributes:{pickingColors:{divisor:0},instancePickingColors:{divisor:1}}}})}getPickingInfo(t){const e=super.getPickingInfo(t),{index:n}=e,{data:i}=this.props;return i[0]&&i[0].__source&&(e.object=i.find(t=>t.__source.index===n)),e}disablePickingIndex(t){const{data:e}=this.props;if(e[0]&&e[0].__source)for(let n=0;n<e.length;n++)e[n].__source.index===t&&this._disablePickingIndex(n);else super.disablePickingIndex(t)}draw({uniforms:t}){const{extruded:e,filled:n,wireframe:i,elevationScale:r}=this.props,{topModel:s,sideModel:o,polygonTesselator:a}=this.state,c={...t,extruded:Boolean(e),elevationScale:r};o&&(o.setInstanceCount(a.instanceCount-1),o.setUniforms(c),i&&(o.setDrawMode(3),o.setUniforms({isWireframe:!0}).draw()),n&&(o.setDrawMode(6),o.setUniforms({isWireframe:!1}).draw())),s&&(s.setVertexCount(a.vertexCount),s.setUniforms(c).draw())}updateState(t){super.updateState(t),this.updateGeometry(t);const{props:e,oldProps:n,changeFlags:i}=t,r=this.getAttributeManager();var s;(i.extensionsChanged||e.filled!==n.filled||e.extruded!==n.extruded)&&(null===(s=this.state.models)||void 0===s||s.forEach(t=>t.delete()),this.setState(this._getModels(this.context.gl)),r.invalidateAll())}updateGeometry({props:t,oldProps:e,changeFlags:n}){if(n.dataChanged||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPolygon)){const{polygonTesselator:e}=this.state,i=t.data.attributes||{};e.updateGeometry({data:t.data,normalize:t._normalize,geometryBuffer:i.getPolygon,buffers:i,getGeometry:t.getPolygon,positionFormat:t.positionFormat,wrapLongitude:t.wrapLongitude,resolution:this.context.viewport.resolution,fp64:this.use64bitPositions(),dataChanged:n.dataChanged,full3d:t._full3d}),this.setState({numInstances:e.instanceCount,startIndices:e.vertexStarts}),n.dataChanged||this.getAttributeManager().invalidateAll()}}_getModels(t){const{id:e,filled:n,extruded:i}=this.props;let r,s;if(n){const n=this.getShaders("top");n.defines.NON_INSTANCED_MODEL=1,r=new Po(t,{...n,id:"".concat(e,"-top"),drawMode:4,attributes:{vertexPositions:new Float32Array([0,1])},uniforms:{isWireframe:!1,isSideVertex:!1},vertexCount:0,isIndexed:!0})}return i&&(s=new Po(t,{...this.getShaders("side"),id:"".concat(e,"-side"),geometry:new Io({drawMode:1,vertexCount:4,attributes:{vertexPositions:{size:2,value:new Float32Array([1,0,0,0,0,1,1,1])}}}),instanceCount:0,isInstanced:1}),s.userData.excludeAttributes={indices:!0}),{models:[s,r].filter(Boolean),topModel:r,sideModel:s}}calculateIndices(t){const{polygonTesselator:e}=this.state;t.startIndices=e.indexStarts,t.value=e.get("indices")}calculatePositions(t){const{polygonTesselator:e}=this.state;t.startIndices=e.vertexStarts,t.value=e.get("positions")}calculateVertexValid(t){t.value=this.state.polygonTesselator.get("vertexValid")}}function ph({data:t,getIndex:e,dataRange:n,replace:i}){const{startRow:r=0,endRow:s=1/0}=n,o=t.length;let a=o,c=o;for(let n=0;n<o;n++){const i=e(t[n]);if(a>n&&i>=r&&(a=n),i>=s){c=n;break}}let l=a;const u=c-a!==i.length?t.slice(c):void 0;for(let e=0;e<i.length;e++)t[l++]=i[e];if(u){for(let e=0;e<u.length;e++)t[l++]=u[e];t.length=l}return{startRow:a,endRow:a+i.length}}n(gh,"defaultProps",dh),n(gh,"layerName","SolidPolygonLayer");const mh=[0,0,0,255],vh={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:t=>t.polygon},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:mh},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class yh extends fl{initializeState(){this.state={paths:[]},this.props.getLineDashArray&&Xt.removed("getLineDashArray","PathStyleExtension")()}updateState({changeFlags:t}){const e=t.dataChanged||t.updateTriggersChanged&&(t.updateTriggersChanged.all||t.updateTriggersChanged.getPolygon);if(e&&Array.isArray(t.dataChanged)){const e=this.state.paths.slice(),n=t.dataChanged.map(t=>ph({data:e,getIndex:t=>t.__source.index,dataRange:t,replace:this._getPaths(t)}));this.setState({paths:e,pathsDiff:n})}else e&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(t={}){const{data:e,getPolygon:n,positionFormat:i,_normalize:r}=this.props,s=[],o="XY"===i?2:3,{startRow:a,endRow:c}=t,{iterable:l,objectInfo:u}=dc(e,a,c);for(const t of l){u.index++;let e=n(t,u);r&&(e=ih(e,o));const{holeIndices:i}=e,a=e.positions||e;if(i)for(let e=0;e<=i.length;e++){const n=a.slice(i[e-1]||0,i[e]||a.length);s.push(this.getSubLayerRow({path:n},t,u.index))}else s.push(this.getSubLayerRow({path:a},t,u.index))}return s}renderLayers(){const{data:t,_dataDiff:e,stroked:n,filled:i,extruded:r,wireframe:s,_normalize:o,_windingOrder:a,elevationScale:c,transitions:l,positionFormat:u}=this.props,{lineWidthUnits:h,lineWidthScale:d,lineWidthMinPixels:f,lineWidthMaxPixels:g,lineJointRounded:p,lineMiterLimit:m,lineDashJustified:v}=this.props,{getFillColor:y,getLineColor:b,getLineWidth:_,getLineDashArray:x,getElevation:P,getPolygon:w,updateTriggers:A,material:S}=this.props,{paths:T,pathsDiff:E}=this.state,C=this.getSubLayerClass("fill",gh),L=this.getSubLayerClass("stroke",xu),M=this.shouldRenderSubLayer("fill",T)&&new C({_dataDiff:e,extruded:r,elevationScale:c,filled:i,wireframe:s,_normalize:o,_windingOrder:a,getElevation:P,getFillColor:y,getLineColor:r&&s?b:mh,material:S,transitions:l},this.getSubLayerProps({id:"fill",updateTriggers:A&&{getPolygon:A.getPolygon,getElevation:A.getElevation,getFillColor:A.getFillColor,lineColors:r&&s,getLineColor:A.getLineColor}}),{data:t,positionFormat:u,getPolygon:w});return[!r&&M,!r&&n&&this.shouldRenderSubLayer("stroke",T)&&new L({_dataDiff:E&&(()=>E),widthUnits:h,widthScale:d,widthMinPixels:f,widthMaxPixels:g,jointRounded:p,miterLimit:m,dashJustified:v,_pathType:"loop",transitions:l&&{getWidth:l.getLineWidth,getColor:l.getLineColor,getPath:l.getPolygon},getColor:this.getSubLayerAccessor(b),getWidth:this.getSubLayerAccessor(_),getDashArray:this.getSubLayerAccessor(x)},this.getSubLayerProps({id:"stroke",updateTriggers:A&&{getWidth:A.getLineWidth,getColor:A.getLineColor,getDashArray:A.getLineDashArray}}),{data:T,positionFormat:u,getPath:t=>t.path}),r&&M]}}n(yh,"layerName","PolygonLayer"),n(yh,"defaultProps",vh);const bh=.75,_h=[];class xh extends zl{constructor(...t){super(...t),n(this,"state",void 0)}getShaders(){return{...super.getShaders(),fs:"#define SHADER_NAME multi-icon-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D iconsTexture;\nuniform float gamma;\nuniform bool sdf;\nuniform float alphaCutoff;\nuniform float sdfBuffer;\nuniform float outlineBuffer;\nuniform vec4 outlineColor;\n\nvarying vec4 vColor;\nvarying vec2 vTextureCoords;\nvarying vec2 uv;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  if (!picking_uActive) {\n    float alpha = texture2D(iconsTexture, vTextureCoords).a;\n    vec4 color = vColor;\n    if (sdf) {\n      float distance = alpha;\n      alpha = smoothstep(sdfBuffer - gamma, sdfBuffer + gamma, distance);\n\n      if (outlineBuffer > 0.0) {\n        float inFill = alpha;\n        float inBorder = smoothstep(outlineBuffer - gamma, outlineBuffer + gamma, distance);\n        color = mix(outlineColor, vColor, inFill);\n        alpha = inBorder;\n      }\n    }\n    float a = alpha * color.a;\n    \n    if (a < alphaCutoff) {\n      discard;\n    }\n\n    gl_FragColor = vec4(color.rgb, a * opacity);\n  }\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n"}}initializeState(){super.initializeState();this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:5121,size:3,accessor:(t,{index:e,target:n})=>this.encodePickingColor(e,n)}})}updateState(t){super.updateState(t);const{props:e,oldProps:n}=t;let{outlineColor:i}=e;i!==n.outlineColor&&(i=i.map(t=>t/255),i[3]=Number.isFinite(i[3])?i[3]:1,this.setState({outlineColor:i})),!e.sdf&&e.outlineWidth&&Xt.warn("".concat(this.id,": fontSettings.sdf is required to render outline"))()}draw(t){const{sdf:e,smoothing:n,outlineWidth:i}=this.props,{outlineColor:r}=this.state,s=i?Math.max(n,bh*(1-i)):-1;if(t.uniforms={...t.uniforms,sdfBuffer:bh,outlineBuffer:s,gamma:n,sdf:Boolean(e),outlineColor:r},super.draw(t),e&&i){const{iconManager:t}=this.state;t.getTexture()&&this.state.model.draw({uniforms:{outlineBuffer:bh}})}}getInstanceOffset(t){return t?Array.from(t).flatMap(t=>super.getInstanceOffset(t)):_h}getInstanceColorMode(t){return 1}getInstanceIconFrame(t){return t?Array.from(t).flatMap(t=>super.getInstanceIconFrame(t)):_h}}n(xh,"defaultProps",{getIconOffsets:{type:"accessor",value:t=>t.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}}),n(xh,"layerName","MultiIconLayer");const Ph=1e20;class wh{constructor({fontSize:t=24,buffer:e=3,radius:n=8,cutoff:i=.25,fontFamily:r="sans-serif",fontWeight:s="normal",fontStyle:o="normal",lang:a=null}={}){this.buffer=e,this.cutoff=i,this.radius=n,this.lang=a;const c=this.size=t+4*e,l=this._createCanvas(c),u=this.ctx=l.getContext("2d",{willReadFrequently:!0});u.font=`${o} ${s} ${t}px ${r}`,u.textBaseline="alphabetic",u.textAlign="left",u.fillStyle="black",this.gridOuter=new Float64Array(c*c),this.gridInner=new Float64Array(c*c),this.f=new Float64Array(c),this.z=new Float64Array(c+1),this.v=new Uint16Array(c)}_createCanvas(t){const e=document.createElement("canvas");return e.width=e.height=t,e}draw(t){const{width:e,actualBoundingBoxAscent:n,actualBoundingBoxDescent:i,actualBoundingBoxLeft:r,actualBoundingBoxRight:s}=this.ctx.measureText(t),o=Math.ceil(n),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(s-r))),c=Math.min(this.size-this.buffer,o+Math.ceil(i)),l=a+2*this.buffer,u=c+2*this.buffer,h=Math.max(l*u,0),d=new Uint8ClampedArray(h),f={data:d,width:l,height:u,glyphWidth:a,glyphHeight:c,glyphTop:o,glyphLeft:0,glyphAdvance:e};if(0===a||0===c)return f;const{ctx:g,buffer:p,gridInner:m,gridOuter:v}=this;this.lang&&(g.lang=this.lang),g.clearRect(p,p,a,c),g.fillText(t,p,p+o);const y=g.getImageData(p,p,a,c);v.fill(Ph,0,h),m.fill(0,0,h);for(let t=0;t<c;t++)for(let e=0;e<a;e++){const n=y.data[4*(t*a+e)+3]/255;if(0===n)continue;const i=(t+p)*l+e+p;if(1===n)v[i]=0,m[i]=Ph;else{const t=.5-n;v[i]=t>0?t*t:0,m[i]=t<0?t*t:0}}Ah(v,0,0,l,u,l,this.f,this.v,this.z),Ah(m,p,p,a,c,l,this.f,this.v,this.z);for(let t=0;t<h;t++){const e=Math.sqrt(v[t])-Math.sqrt(m[t]);d[t]=Math.round(255-255*(e/this.radius+this.cutoff))}return f}}function Ah(t,e,n,i,r,s,o,a,c){for(let l=e;l<e+i;l++)Sh(t,n*s+l,s,r,o,a,c);for(let l=n;l<n+r;l++)Sh(t,l*s+e,1,i,o,a,c)}function Sh(t,e,n,i,r,s,o){s[0]=0,o[0]=-Ph,o[1]=Ph,r[0]=t[e];for(let a=1,c=0,l=0;a<i;a++){r[a]=t[e+a*n];const i=a*a;do{const t=s[c];l=(r[a]-r[t]+i-t*t)/(a-t)/2}while(l<=o[c]&&--c>-1);c++,s[c]=a,o[c]=l,o[c+1]=Ph}for(let a=0,c=0;a<i;a++){for(;o[c+1]<a;)c++;const i=s[c],l=a-i;t[e+a*n]=r[i]+l*l}}const Th=[];function Eh(t,e,n,i){let r=0;for(let o=e;o<n;o++){var s;r+=(null===(s=i[t[o]])||void 0===s?void 0:s.layoutWidth)||0}return r}function Ch(t,e,n,i,r,s){let o=e,a=0;for(let c=e;c<n;c++){const e=Eh(t,c,c+1,r);a+e>i&&(o<c&&s.push(c),o=c,a=0),a+=e}return a}function Lh(t,e,n,i,r=0,s){void 0===s&&(s=t.length);const o=[];return"break-all"===e?Ch(t,r,s,n,i,o):function(t,e,n,i,r,s){let o=e,a=e,c=e,l=0;for(let u=e;u<n;u++)if(" "===t[u]?c=u+1:" "!==t[u+1]&&u+1!==n||(c=u+1),c>a){let e=Eh(t,a,c,r);l+e>i&&(o<a&&(s.push(a),o=a,l=0),e>i&&(e=Ch(t,a,c,i,r,s),o=s[s.length-1])),a=c,l+=e}}(t,r,s,n,i,o),o}function Mh(t,e,n,i,r,s){let o=0,a=0;for(let s=e;s<n;s++){const e=t[s],n=i[e];n?(a||(a=n.layoutHeight),r[s]=o+n.layoutWidth/2,o+=n.layoutWidth):(Xt.warn("Missing character: ".concat(e," (").concat(e.codePointAt(0),")"))(),r[s]=o,o+=32)}s[0]=o,s[1]=a}class Oh{constructor(t=5){n(this,"limit",void 0),n(this,"_cache",{}),n(this,"_order",[]),this.limit=t}get(t){const e=this._cache[t];return e&&(this._deleteOrder(t),this._appendOrder(t)),e}set(t,e){this._cache[t]?(this.delete(t),this._cache[t]=e,this._appendOrder(t)):(Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[t]=e,this._appendOrder(t))}delete(t){this._cache[t]&&(delete this._cache[t],this._deleteOrder(t))}_deleteOrder(t){const e=this._order.indexOf(t);e>=0&&this._order.splice(e,1)}_appendOrder(t){this._order.push(t)}}const Ih={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:function(){const t=[];for(let e=32;e<128;e++)t.push(String.fromCharCode(e));return t}(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1};let Rh=new Oh(3);function Fh(t,e){for(let n=0;n<t.length;n++)e.data[4*n+3]=t[n]}function zh(t,e,n,i){t.font="".concat(i," ").concat(n,"px ").concat(e),t.fillStyle="#000",t.textBaseline="alphabetic",t.textAlign="left"}class kh{constructor(){n(this,"props",{...Ih}),n(this,"_key",void 0),n(this,"_atlas",void 0)}get texture(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){const{fontSize:t,buffer:e}=this.props;return(1.2*t+2*e)/t}setProps(t={}){Object.assign(this.props,t),this._key=this._getKey();const e=function(t,e){let n;n="string"==typeof e?new Set(Array.from(e)):new Set(e);const i=Rh.get(t);if(!i)return n;for(const t in i.mapping)n.has(t)&&n.delete(t);return n}(this._key,this.props.characterSet),n=Rh.get(this._key);if(n&&0===e.size)return void(this._atlas!==n&&(this._atlas=n));const i=this._generateFontAtlas(e,n);this._atlas=i,Rh.set(this._key,i)}_generateFontAtlas(t,e){const{fontFamily:n,fontWeight:i,fontSize:r,buffer:s,sdf:o,radius:a,cutoff:c}=this.props;let l=e&&e.data;l||(l=document.createElement("canvas"),l.width=1024);const u=l.getContext("2d",{willReadFrequently:!0});zh(u,n,r,i);const{mapping:h,canvasHeight:d,xOffset:f,yOffset:g}=function({characterSet:t,getFontWidth:e,fontHeight:n,buffer:i,maxCanvasWidth:r,mapping:s={},xOffset:o=0,yOffset:a=0}){let c=0,l=o;const u=n+2*i;for(const o of t)if(!s[o]){const t=e(o);l+t+2*i>r&&(l=0,c++),s[o]={x:l+i,y:a+c*u+i,width:t,height:u,layoutWidth:t,layoutHeight:n},l+=t+2*i}return{mapping:s,xOffset:l,yOffset:a+c*u,canvasHeight:(h=a+(c+1)*u,Math.pow(2,Math.ceil(Math.log2(h))))};var h}({getFontWidth:t=>u.measureText(t).width,fontHeight:1.2*r,buffer:s,characterSet:t,maxCanvasWidth:1024,...e&&{mapping:e.mapping,xOffset:e.xOffset,yOffset:e.yOffset}});if(l.height!==d){const t=u.getImageData(0,0,l.width,l.height);l.height=d,u.putImageData(t,0,0)}if(zh(u,n,r,i),o){const e=new wh({fontSize:r,buffer:s,radius:a,cutoff:c,fontFamily:n,fontWeight:"".concat(i)});for(const n of t){const{data:t,width:i,height:s,glyphTop:o}=e.draw(n);h[n].width=i,h[n].layoutOffsetY=.9*r-o;const a=u.createImageData(i,s);Fh(t,a),u.putImageData(a,h[n].x,h[n].y)}}else for(const e of t)u.fillText(e,h[e].x,h[e].y+s+.9*r);return{xOffset:f,yOffset:g,mapping:h,data:l,width:l.width,height:l.height}}_getKey(){const{fontFamily:t,fontWeight:e,fontSize:n,buffer:i,sdf:r,radius:s,cutoff:o}=this.props;return r?"".concat(t," ").concat(e," ").concat(n," ").concat(i," ").concat(s," ").concat(o):"".concat(t," ").concat(e," ").concat(n," ").concat(i)}}const jh={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:t=>t.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class Bh extends dl{constructor(...t){super(...t),n(this,"state",void 0)}getShaders(){return super.getShaders({vs:"#define SHADER_NAME text-background-layer-vertex-shader\n\nattribute vec2 positions;\n\nattribute vec3 instancePositions;\nattribute vec3 instancePositions64Low;\nattribute vec4 instanceRects;\nattribute float instanceSizes;\nattribute float instanceAngles;\nattribute vec2 instancePixelOffsets;\nattribute float instanceLineWidths;\nattribute vec4 instanceFillColors;\nattribute vec4 instanceLineColors;\nattribute vec3 instancePickingColors;\n\nuniform bool billboard;\nuniform float opacity;\nuniform float sizeScale;\nuniform float sizeMinPixels;\nuniform float sizeMaxPixels;\nuniform vec4 padding;\nuniform int sizeUnits;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying float vLineWidth;\nvarying vec2 uv;\nvarying vec2 dimensions;\n\nvec2 rotate_by_angle(vec2 vertex, float angle) {\n  float angle_radian = radians(angle);\n  float cos_angle = cos(angle_radian);\n  float sin_angle = sin(angle_radian);\n  mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);\n  return rotationMatrix * vertex;\n}\n\nvoid main(void) {\n  geometry.worldPosition = instancePositions;\n  geometry.uv = positions;\n  geometry.pickingColor = instancePickingColors;\n  uv = positions;\n  vLineWidth = instanceLineWidths;\n  float sizePixels = clamp(\n    project_size_to_pixel(instanceSizes * sizeScale, sizeUnits),\n    sizeMinPixels, sizeMaxPixels\n  );\n\n  dimensions = instanceRects.zw * sizePixels + padding.xy + padding.zw;\n\n  vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-padding.xy, padding.zw, positions);\n  pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);\n  pixelOffset += instancePixelOffsets;\n  pixelOffset.y *= -1.0;\n\n  if (billboard)  {\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n    vec3 offset = vec3(pixelOffset, 0.0);\n    DECKGL_FILTER_SIZE(offset, geometry);\n    gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);\n  } else {\n    vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);\n    DECKGL_FILTER_SIZE(offset_common, geometry);\n    gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);\n    DECKGL_FILTER_GL_POSITION(gl_Position, geometry);\n  }\n  vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * opacity);\n  DECKGL_FILTER_COLOR(vFillColor, geometry);\n  vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * opacity);\n  DECKGL_FILTER_COLOR(vLineColor, geometry);\n}\n",fs:"#define SHADER_NAME text-background-layer-fragment-shader\n\nprecision highp float;\n\nuniform bool stroked;\n\nvarying vec4 vFillColor;\nvarying vec4 vLineColor;\nvarying float vLineWidth;\nvarying vec2 uv;\nvarying vec2 dimensions;\n\nvoid main(void) {\n  geometry.uv = uv;\n\n  vec2 pixelPosition = uv * dimensions;\n  if (stroked) {\n    float distToEdge = min(\n      min(pixelPosition.x, dimensions.x - pixelPosition.x),\n      min(pixelPosition.y, dimensions.y - pixelPosition.y)\n    );\n    float isBorder = smoothedge(distToEdge, vLineWidth);\n    gl_FragColor = mix(vFillColor, vLineColor, isBorder);\n  } else {\n    gl_FragColor = vFillColor;\n  }\n\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n",modules:[tc,ec]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:5130,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,normalized:!0,type:5121,accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(t){super.updateState(t);const{changeFlags:e}=t;if(e.extensionsChanged){var n;const{gl:t}=this.context;null===(n=this.state.model)||void 0===n||n.delete(),this.state.model=this._getModel(t),this.getAttributeManager().invalidateAll()}}draw({uniforms:t}){const{billboard:e,sizeScale:n,sizeUnits:i,sizeMinPixels:r,sizeMaxPixels:s,getLineWidth:o}=this.props;let{padding:a}=this.props;a.length<4&&(a=[a[0],a[1],a[0],a[1]]),this.state.model.setUniforms(t).setUniforms({billboard:e,stroked:Boolean(o),padding:a,sizeUnits:Jt[i],sizeScale:n,sizeMinPixels:r,sizeMaxPixels:s}).draw()}_getModel(t){return new Po(t,{...this.getShaders(),id:this.props.id,geometry:new Io({drawMode:6,vertexCount:4,attributes:{positions:{size:2,value:new Float32Array([0,0,1,0,1,1,0,1])}}}),isInstanced:!0})}}n(Bh,"defaultProps",jh),n(Bh,"layerName","TextBackgroundLayer");const Dh={start:1,middle:0,end:-1},Nh={top:1,center:0,bottom:-1},Uh=[0,0,0,255],Vh={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:Uh},getBorderWidth:{type:"accessor",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:Ih.characterSet},fontFamily:Ih.fontFamily,fontWeight:Ih.fontWeight,lineHeight:1,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:Uh},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:t=>t.text},getPosition:{type:"accessor",value:t=>t.position},getColor:{type:"accessor",value:Uh},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class Gh extends fl{constructor(...t){super(...t),n(this,"state",void 0),n(this,"getBoundingRect",(t,e)=>{let{size:[n,i]}=this.transformParagraph(t,e);const{fontSize:r}=this.state.fontAtlasManager.props;n/=r,i/=r;const{getTextAnchor:s,getAlignmentBaseline:o}=this.props;return[(Dh["function"==typeof s?s(t,e):s]-1)*n/2,(Nh["function"==typeof o?o(t,e):o]-1)*i/2,n,i]}),n(this,"getIconOffsets",(t,e)=>{const{getTextAnchor:n,getAlignmentBaseline:i}=this.props,{x:r,y:s,rowWidth:o,size:[a,c]}=this.transformParagraph(t,e),l=Dh["function"==typeof n?n(t,e):n],u=Nh["function"==typeof i?i(t,e):i],h=r.length,d=new Array(2*h);let f=0;for(let t=0;t<h;t++){const e=(1-l)*(a-o[t])/2;d[f++]=(l-1)*a/2+e+r[t],d[f++]=(u-1)*c/2+s[t]}return d})}initializeState(){this.state={styleVersion:0,fontAtlasManager:new kh},this.props.maxWidth>0&&Xt.warn("v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(t){const{props:e,oldProps:n,changeFlags:i}=t;(i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getText))&&this._updateText();(this._updateFontAtlas()||e.lineHeight!==n.lineHeight||e.wordBreak!==n.wordBreak||e.maxWidth!==n.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:t}){return t.object=t.index>=0?this.props.data[t.index]:null,t}_updateFontAtlas(){const{fontSettings:t,fontFamily:e,fontWeight:n}=this.props,{fontAtlasManager:i,characterSet:r}=this.state,s={...t,characterSet:r,fontFamily:e,fontWeight:n};if(!i.mapping)return i.setProps(s),!0;for(const t in s)if(s[t]!==i.props[t])return i.setProps(s),!0;return!1}_updateText(){var t;const{data:e,characterSet:n}=this.props,i=null===(t=e.attributes)||void 0===t?void 0:t.getText;let r,{getText:s}=this.props,o=e.startIndices;const a="auto"===n&&new Set;if(i&&o){const{texts:t,characterCount:n}=function({value:t,length:e,stride:n,offset:i,startIndices:r,characterSet:s}){const o=t.BYTES_PER_ELEMENT,a=n?n/o:1,c=i?i/o:0,l=r[e]||Math.ceil((t.length-c)/a),u=s&&new Set,h=new Array(e);let d=t;if(a>1||c>0){d=new(0,t.constructor)(l);for(let e=0;e<l;e++)d[e]=t[e*a+c]}for(let t=0;t<e;t++){const e=r[t],n=r[t+1]||l,i=d.subarray(e,n);h[t]=String.fromCodePoint.apply(null,i),u&&i.forEach(u.add,u)}if(u)for(const t of u)s.add(String.fromCodePoint(t));return{texts:h,characterCount:l}}({...ArrayBuffer.isView(i)?{value:i}:i,length:e.length,startIndices:o,characterSet:a});r=n,s=(e,{index:n})=>t[n]}else{const{iterable:t,objectInfo:n}=dc(e);o=[0],r=0;for(const e of t){n.index++;const t=Array.from(s(e,n)||"");a&&t.forEach(a.add,a),r+=t.length,o.push(r)}}this.setState({getText:s,startIndices:o,numInstances:r,characterSet:a||n})}transformParagraph(t,e){const{fontAtlasManager:n}=this.state,i=n.mapping,r=this.state.getText,{wordBreak:s,lineHeight:o,maxWidth:a}=this.props;return function(t,e,n,i,r){const s=Array.from(t),o=s.length,a=new Array(o),c=new Array(o),l=new Array(o),u=("break-word"===n||"break-all"===n)&&isFinite(i)&&i>0,h=[0,0],d=[0,0];let f=0,g=0,p=0;for(let t=0;t<=o;t++){const v=s[t];if("\n"!==v&&t!==o||(p=t),p>g){const t=u?Lh(s,n,i,r,g,p):Th;for(let n=0;n<=t.length;n++){const i=0===n?g:t[n-1],o=n<t.length?t[n]:p;Mh(s,i,o,r,a,d);for(let t=i;t<o;t++){var m;const e=(null===(m=r[s[t]])||void 0===m?void 0:m.layoutOffsetY)||0;c[t]=f+d[1]/2+e,l[t]=d[0]}f+=d[1]*e,h[0]=Math.max(h[0],d[0])}g=p}"\n"===v&&(a[g]=0,c[g]=0,l[g]=0,g++)}return h[1]=f,{x:a,y:c,rowWidth:l,size:h}}(r(t,e)||"",o,s,a*n.props.fontSize,i)}renderLayers(){const{startIndices:t,numInstances:e,getText:n,fontAtlasManager:{scale:i,texture:r,mapping:s},styleVersion:o}=this.state,{data:a,_dataDiff:c,getPosition:l,getColor:u,getSize:h,getAngle:d,getPixelOffset:f,getBackgroundColor:g,getBorderColor:p,getBorderWidth:m,backgroundPadding:v,background:y,billboard:b,fontSettings:_,outlineWidth:x,outlineColor:P,sizeScale:w,sizeUnits:A,sizeMinPixels:S,sizeMaxPixels:T,transitions:E,updateTriggers:C}=this.props,L=this.getSubLayerClass("characters",xh),M=this.getSubLayerClass("background",Bh);return[y&&new M({getFillColor:g,getLineColor:p,getLineWidth:m,padding:v,getPosition:l,getSize:h,getAngle:d,getPixelOffset:f,billboard:b,sizeScale:w,sizeUnits:A,sizeMinPixels:S,sizeMaxPixels:T,transitions:E&&{getPosition:E.getPosition,getAngle:E.getAngle,getSize:E.getSize,getFillColor:E.getBackgroundColor,getLineColor:E.getBorderColor,getLineWidth:E.getBorderWidth,getPixelOffset:E.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:C.getPosition,getAngle:C.getAngle,getSize:C.getSize,getFillColor:C.getBackgroundColor,getLineColor:C.getBorderColor,getLineWidth:C.getBorderWidth,getPixelOffset:C.getPixelOffset,getBoundingRect:{getText:C.getText,getTextAnchor:C.getTextAnchor,getAlignmentBaseline:C.getAlignmentBaseline,styleVersion:o}}}),{data:a.attributes&&a.attributes.background?{length:a.length,attributes:a.attributes.background}:a,_dataDiff:c,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new L({sdf:_.sdf,smoothing:Number.isFinite(_.smoothing)?_.smoothing:Ih.smoothing,outlineWidth:x/(_.radius||Ih.radius),outlineColor:P,iconAtlas:r,iconMapping:s,getPosition:l,getColor:u,getSize:h,getAngle:d,getPixelOffset:f,billboard:b,sizeScale:w*i,sizeUnits:A,sizeMinPixels:S*i,sizeMaxPixels:T*i,transitions:E&&{getPosition:E.getPosition,getAngle:E.getAngle,getColor:E.getColor,getSize:E.getSize,getPixelOffset:E.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:C.getText,getPosition:C.getPosition,getAngle:C.getAngle,getColor:C.getColor,getSize:C.getSize,getPixelOffset:C.getPixelOffset,getIconOffsets:{getTextAnchor:C.getTextAnchor,getAlignmentBaseline:C.getAlignmentBaseline,styleVersion:o}}}),{data:a,_dataDiff:c,startIndices:t,numInstances:e,getIconOffsets:this.getIconOffsets,getIcon:n})]}static set fontAtlasCacheLimit(t){!function(t){Xt.assert(Number.isFinite(t)&&t>=3,"Invalid cache limit"),Rh=new Oh(t)}(t)}}n(Gh,"defaultProps",Vh),n(Gh,"layerName","TextLayer");const Wh={circle:{type:Wl,props:{filled:"filled",stroked:"stroked",lineWidthMaxPixels:"lineWidthMaxPixels",lineWidthMinPixels:"lineWidthMinPixels",lineWidthScale:"lineWidthScale",lineWidthUnits:"lineWidthUnits",pointRadiusMaxPixels:"radiusMaxPixels",pointRadiusMinPixels:"radiusMinPixels",pointRadiusScale:"radiusScale",pointRadiusUnits:"radiusUnits",pointAntialiasing:"antialiasing",pointBillboard:"billboard",getFillColor:"getFillColor",getLineColor:"getLineColor",getLineWidth:"getLineWidth",getPointRadius:"getRadius"}},icon:{type:zl,props:{iconAtlas:"iconAtlas",iconMapping:"iconMapping",iconSizeMaxPixels:"sizeMaxPixels",iconSizeMinPixels:"sizeMinPixels",iconSizeScale:"sizeScale",iconSizeUnits:"sizeUnits",iconAlphaCutoff:"alphaCutoff",iconBillboard:"billboard",getIcon:"getIcon",getIconAngle:"getAngle",getIconColor:"getColor",getIconPixelOffset:"getPixelOffset",getIconSize:"getSize"}},text:{type:Gh,props:{textSizeMaxPixels:"sizeMaxPixels",textSizeMinPixels:"sizeMinPixels",textSizeScale:"sizeScale",textSizeUnits:"sizeUnits",textBackground:"background",textBackgroundPadding:"backgroundPadding",textFontFamily:"fontFamily",textFontWeight:"fontWeight",textLineHeight:"lineHeight",textMaxWidth:"maxWidth",textOutlineColor:"outlineColor",textOutlineWidth:"outlineWidth",textWordBreak:"wordBreak",textCharacterSet:"characterSet",textBillboard:"billboard",textFontSettings:"fontSettings",getText:"getText",getTextAngle:"getAngle",getTextColor:"getColor",getTextPixelOffset:"getPixelOffset",getTextSize:"getSize",getTextAnchor:"getTextAnchor",getTextAlignmentBaseline:"getAlignmentBaseline",getTextBackgroundColor:"getBackgroundColor",getTextBorderColor:"getBorderColor",getTextBorderWidth:"getBorderWidth"}}},Hh={type:xu,props:{lineWidthUnits:"widthUnits",lineWidthScale:"widthScale",lineWidthMinPixels:"widthMinPixels",lineWidthMaxPixels:"widthMaxPixels",lineJointRounded:"jointRounded",lineCapRounded:"capRounded",lineMiterLimit:"miterLimit",lineBillboard:"billboard",getLineColor:"getColor",getLineWidth:"getWidth"}},Xh={type:gh,props:{extruded:"extruded",filled:"filled",wireframe:"wireframe",elevationScale:"elevationScale",material:"material",_full3d:"_full3d",getElevation:"getElevation",getFillColor:"getFillColor",getLineColor:"getLineColor"}};function Zh({type:t,props:e}){const n={};for(const i in e)n[i]=t.defaultProps[e[i]];return n}function Yh(t,e){const{transitions:n,updateTriggers:i}=t.props,r={updateTriggers:{},transitions:n&&{getPosition:n.geometry}};for(const s in e){const o=e[s];let a=t.props[s];s.startsWith("get")&&(a=t.getSubLayerAccessor(a),r.updateTriggers[o]=i[s],n&&(r.transitions[o]=n[s])),r[o]=a}return r}function Kh(t,e,n={}){const i={pointFeatures:[],lineFeatures:[],polygonFeatures:[],polygonOutlineFeatures:[]},{startRow:r=0,endRow:s=t.length}=n;for(let n=r;n<s;n++){const r=t[n],{geometry:s}=r;if(s)if("GeometryCollection"===s.type){Xt.assert(Array.isArray(s.geometries),"GeoJSON does not have geometries array");const{geometries:t}=s;for(let s=0;s<t.length;s++){qh(t[s],i,e,r,n)}}else qh(s,i,e,r,n)}return i}function qh(t,e,n,i,r){const{type:s,coordinates:o}=t,{pointFeatures:a,lineFeatures:c,polygonFeatures:l,polygonOutlineFeatures:u}=e;if(function(t,e){let n=Jh[t];Xt.assert(n,"Unknown GeoJSON type ".concat(t));for(;e&&--n>0;)e=e[0];return e&&Number.isFinite(e[0])}(s,o))switch(s){case"Point":a.push(n({geometry:t},i,r));break;case"MultiPoint":o.forEach(t=>{a.push(n({geometry:{type:"Point",coordinates:t}},i,r))});break;case"LineString":c.push(n({geometry:t},i,r));break;case"MultiLineString":o.forEach(t=>{c.push(n({geometry:{type:"LineString",coordinates:t}},i,r))});break;case"Polygon":l.push(n({geometry:t},i,r)),o.forEach(t=>{u.push(n({geometry:{type:"LineString",coordinates:t}},i,r))});break;case"MultiPolygon":o.forEach(t=>{l.push(n({geometry:{type:"Polygon",coordinates:t}},i,r)),t.forEach(t=>{u.push(n({geometry:{type:"LineString",coordinates:t}},i,r))})})}else Xt.warn("".concat(s," coordinates are malformed"))()}const Jh={Point:1,MultiPoint:2,LineString:2,MultiLineString:3,Polygon:3,MultiPolygon:4};function Qh(t){return t.geometry.coordinates}function $h(t,e){const n={points:{},lines:{},polygons:{},polygonsOutline:{}},{points:i,lines:r,polygons:s}=t,o=function(t,e){const n={points:null,lines:null,polygons:null};for(const i in n){const r=t[i].globalFeatureIds.value;n[i]=new Uint8ClampedArray(3*r.length);const s=[];for(let t=0;t<r.length;t++)e(r[t],s),n[i][3*t+0]=s[0],n[i][3*t+1]=s[1],n[i][3*t+2]=s[2]}return n}(t,e);return n.points.data={length:i.positions.value.length/i.positions.size,attributes:{...i.attributes,getPosition:i.positions,instancePickingColors:{size:3,value:o.points}},properties:i.properties,numericProps:i.numericProps,featureIds:i.featureIds},n.lines.data={length:r.pathIndices.value.length-1,startIndices:r.pathIndices.value,attributes:{...r.attributes,getPath:r.positions,instancePickingColors:{size:3,value:o.lines}},properties:r.properties,numericProps:r.numericProps,featureIds:r.featureIds},n.lines._pathType="open",n.polygons.data={length:s.polygonIndices.value.length-1,startIndices:s.polygonIndices.value,attributes:{...s.attributes,getPolygon:s.positions,pickingColors:{size:3,value:o.polygons}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},n.polygons._normalize=!1,s.triangles&&(n.polygons.data.attributes.indices=s.triangles.value),n.polygonsOutline.data={length:s.primitivePolygonIndices.value.length-1,startIndices:s.primitivePolygonIndices.value,attributes:{...s.attributes,getPath:s.positions,instancePickingColors:{size:3,value:o.polygons}},properties:s.properties,numericProps:s.numericProps,featureIds:s.featureIds},n.polygonsOutline._pathType="open",n}const td=["points","linestrings","polygons"],ed={...Zh(Wh.circle),...Zh(Wh.icon),...Zh(Wh.text),...Zh(Hh),...Zh(Xh),stroked:!0,filled:!0,extruded:!1,wireframe:!1,_full3d:!1,iconAtlas:{type:"object",value:null},iconMapping:{type:"object",value:{}},getIcon:{type:"accessor",value:t=>t.properties.icon},getText:{type:"accessor",value:t=>t.properties.text},pointType:"circle",getRadius:{deprecatedFor:"getPointRadius"}};class nd extends fl{initializeState(){this.state={layerProps:{},features:{}}}updateState({props:t,changeFlags:e}){if(!e.dataChanged)return;const{data:n}=this.props,i=n&&"points"in n&&"polygons"in n&&"lines"in n;this.setState({binary:i}),i?this._updateStateBinary({props:t,changeFlags:e}):this._updateStateJSON({props:t,changeFlags:e})}_updateStateBinary({props:t,changeFlags:e}){const n=$h(t.data,this.encodePickingColor);this.setState({layerProps:n})}_updateStateJSON({props:t,changeFlags:e}){const n=function(t){if(Array.isArray(t))return t;switch(Xt.assert(t.type,"GeoJSON does not have type"),t.type){case"Feature":return[t];case"FeatureCollection":return Xt.assert(Array.isArray(t.features),"GeoJSON does not have features array"),t.features;default:return[{geometry:t}]}}(t.data),i=this.getSubLayerRow.bind(this);let r={};const s={};if(Array.isArray(e.dataChanged)){const t=this.state.features;for(const e in t)r[e]=t[e].slice(),s[e]=[];for(const o of e.dataChanged){const e=Kh(n,i,o);for(const n in t)s[n].push(ph({data:r[n],getIndex:t=>t.__source.index,dataRange:o,replace:e[n]}))}}else r=Kh(n,i);const o=function(t,e){const n={points:{},lines:{},polygons:{},polygonsOutline:{}},{pointFeatures:i,lineFeatures:r,polygonFeatures:s,polygonOutlineFeatures:o}=t;return n.points.data=i,n.points._dataDiff=e.pointFeatures&&(()=>e.pointFeatures),n.points.getPosition=Qh,n.lines.data=r,n.lines._dataDiff=e.lineFeatures&&(()=>e.lineFeatures),n.lines.getPath=Qh,n.polygons.data=s,n.polygons._dataDiff=e.polygonFeatures&&(()=>e.polygonFeatures),n.polygons.getPolygon=Qh,n.polygonsOutline.data=o,n.polygonsOutline._dataDiff=e.polygonOutlineFeatures&&(()=>e.polygonOutlineFeatures),n.polygonsOutline.getPath=Qh,n}(r,s);this.setState({features:r,featuresDiff:s,layerProps:o})}getPickingInfo(t){const e=super.getPickingInfo(t),{index:n,sourceLayer:i}=e;return e.featureType=td.find(t=>i.id.startsWith("".concat(this.id,"-").concat(t,"-"))),n>=0&&i.id.startsWith("".concat(this.id,"-points-text"))&&this.state.binary&&(e.index=this.props.data.points.globalFeatureIds.value[n]),e}_updateAutoHighlight(t){const e="".concat(this.id,"-points-"),n="points"===t.featureType;for(const i of this.getSubLayers())i.id.startsWith(e)===n&&i.updateAutoHighlight(t)}_renderPolygonLayer(){const{extruded:t,wireframe:e}=this.props,{layerProps:n}=this.state,i="polygons-fill",r=this.shouldRenderSubLayer(i,n.polygons.data)&&this.getSubLayerClass(i,Xh.type);if(r){const s=Yh(this,Xh.props),o=t&&e;return o||delete s.getLineColor,s.updateTriggers.lineColors=o,new r(s,this.getSubLayerProps({id:i,updateTriggers:s.updateTriggers}),n.polygons)}return null}_renderLineLayers(){const{extruded:t,stroked:e}=this.props,{layerProps:n}=this.state,i="polygons-stroke",r="linestrings",s=!t&&e&&this.shouldRenderSubLayer(i,n.polygonsOutline.data)&&this.getSubLayerClass(i,Hh.type),o=this.shouldRenderSubLayer(r,n.lines.data)&&this.getSubLayerClass(r,Hh.type);if(s||o){const t=Yh(this,Hh.props);return[s&&new s(t,this.getSubLayerProps({id:i,updateTriggers:t.updateTriggers}),n.polygonsOutline),o&&new o(t,this.getSubLayerProps({id:r,updateTriggers:t.updateTriggers}),n.lines)]}return null}_renderPointLayers(){const{pointType:t}=this.props,{layerProps:e,binary:n}=this.state;let{highlightedObjectIndex:i}=this.props;!n&&Number.isFinite(i)&&(i=e.points.data.findIndex(t=>t.__source.index===i));const r=new Set(t.split("+")),s=[];for(const t of r){const r="points-".concat(t),o=Wh[t],a=o&&this.shouldRenderSubLayer(r,e.points.data)&&this.getSubLayerClass(r,o.type);if(a){const c=Yh(this,o.props);let l=e.points;if("text"===t&&n){const{instancePickingColors:t,...e}=l.data.attributes;l={...l,data:{...l.data,attributes:e}}}s.push(new a(c,this.getSubLayerProps({id:r,updateTriggers:c.updateTriggers,highlightedObjectIndex:i}),l))}}return s}renderLayers(){const{extruded:t}=this.props,e=this._renderPolygonLayer();return[!t&&e,this._renderLineLayers(),this._renderPointLayers(),t&&e]}getSubLayerAccessor(t){const{binary:e}=this.state;return e&&"function"==typeof t?(e,n)=>{const{data:i,index:r}=n,s=function(t,e){if(!t)return null;const n="startIndices"in t?t.startIndices[e]:e,i=t.featureIds.value[n];return-1!==n?function(t,e,n){const i={properties:{...t.properties[e]}};for(const e in t.numericProps)i.properties[e]=t.numericProps[e].value[n];return i}(t,i,n):null}(i,r);return t(s,n)}:super.getSubLayerAccessor(t)}}n(nd,"layerName","GeoJsonLayer"),n(nd,"defaultProps",ed);var id=Object.freeze({__proto__:null,ArcLayer:vl,BitmapLayer:Al,ColumnLayer:fu,GeoJsonLayer:nd,GridCellLayer:gu,IconLayer:zl,LineLayer:jl,PathLayer:xu,PointCloudLayer:Ul,PolygonLayer:yh,ScatterplotLayer:Wl,SolidPolygonLayer:gh,TextLayer:Gh,_MultiIconLayer:xh,_TextBackgroundLayer:Bh});return"undefined"!=typeof window&&(window.DeckLayers=id),id});
