{% extends 'layout.html' %}
{% block css %}
    <link rel="stylesheet" href="/static/css/dropzone.min.css">
{% endblock %}

{% block content %}

    <v-main class="align-start ma-3">
        <v-stepper v-model="step">
            <v-stepper-header>
                <v-stepper-item title="{{ _('Upload Sheet / Select Map') }}" value="one"></v-stepper-item>
                <v-divider></v-divider>

                <v-stepper-item title="{{ _('Fields Map') }}" value="two"></v-stepper-item>
                <v-divider></v-divider>
                <v-stepper-item title="{{ _('Bulk Upload \& Import') }}" value="three"></v-stepper-item>
                <v-divider></v-divider>
                <v-stepper-item title="{{ _('Status') }}" value="four"></v-stepper-item>
            </v-stepper-header>


            <v-stepper-window>
                <v-stepper-window-item value="one">
                    <v-sheet class="my-8">

                        <v-btn-toggle borderless color="primary darken-2" mandatory
                                      class="d-flex justify-center" v-model="firstAction">
                            <v-btn>{{ _('Create a new map') }}</v-btn>
                            <v-btn>{{ _('Select an existing map') }}</v-btn>
                        </v-btn-toggle>
                    </v-sheet>

                    <v-sheet max-width="800" class="mx-auto fp-wrap">
                        <v-card elevation="1" class="text-center my-3">
                            <v-card-title class="subtitle-1">{{ _('Select Sheet Language') }}</v-card-title>
                            <v-card-text>
                                <v-chip-group class="mx-auto"
                                              column
                                              mandatory
                                              v-model="lang"
                                >
                                    <v-chip 
                                    v-for="(name, code) in languages"
                                    :value="code"
                                    small label 
                                    filter 
                                    outlined
                                    >
                                        ${name}
                                    </v-chip>
                                </v-chip-group>
                            </v-card-text>

                        </v-card>

                        <vue-dropzone ref="dropzone" id="dropzone" class="ma-auto" :options="dzOpts"
                                      @vdropzone-error="showError"
                                      @vdropzone-success="uploadSuccess"></vue-dropzone>

                        <v-select label="{{ _('Select Sheet to continue') }}" v-model="selectedSheet"
                                  @update:model-value="sheetSelected" v-if="sheets.length && files.length"
                                  class="my-3" :items="sheets">
                        </v-select>


                    </v-sheet>


                    <v-sheet max-width="800" class="pa-4 my-8 mx-auto" v-show="firstAction==1">
                        <v-autocomplete
                                class="mt-2 mx-2"
                                label="{{ _('Load existing map') }}"
                                @update:focused="loadMaps"
                                :items="maps || []"
                                item-title="name"
                                item-value="id"
                                :return-object="true"
                                @update:model-value="selectMap"
                                @click:clear="resetFields"
                        >
                        </v-autocomplete>

                        <template v-if="selectedMap">
                            <v-btn @click="step=2" class=" mx-2" color="primary" elevation="0">

                                {{ _('Continue') }}

                            </v-btn>
                        </template>

                    </v-sheet>

                    <v-sheet max-height="calc(100vh - 560px)">
                        <v-img v-show="firstAction!=1" style="max-width: 75%; margin:auto"
                               src="/static/img/csv-tool-bg.jpg">
                        </v-img>
                    </v-sheet>

                </v-stepper-window-item>

                <v-stepper-window-item value="two">
                    <v-sheet class=" pa-3 align-center d-flex">
                        <v-btn small @click="step=1"
                        >
                            {{ _('Back') }}
                        </v-btn>
                        <v-spacer></v-spacer>
                        <v-select density="compact"
                                @click:clear="resetFields"
                                class="mt-2 mx-2"
                                label="{{ _('Load existing map') }}"
                                :items="maps"
                                item-title="name"
                                item-value="id"
                                return-object
                                @update:model-value="loadMap"
                                clearable
                        >
                        </v-select>

                        <v-btn
                                class="mx-2"
                                color="success"
                                @click="toStepThree"
                        >
                            {{ _('Next') }}
                        </v-btn>
                    </v-sheet>

                    <v-card class="pa-3" max-height="calc(100vh - 370px)">

                        <v-row class="align-stretch">
                            <v-col cols="12" md="3">

                                <v-card class="csv-panel " max-height="calc(100vh - 400px)">
                                    <v-toolbar>
                                        <v-toolbar-title class="d-flex">
                                            {{ _('Sheet Fields') }}

                                            <v-btn @click="resetFields" size="small"
                                                   variant="text"

                                            >{{ _('Reset') }}
                                            </v-btn>
                                        </v-toolbar-title>


                                    </v-toolbar>
                                    <v-text-field @keydown.enter="filterFields"
                                                  label="{{ _('Search Fields') }}" v-model="ffilter"
                                                  clearable></v-text-field>

                                    <draggable
                                            class="list-group"
                                            :clone="clone"
                                            :group="{ name: 'columns', pull: customPull , animation: 100, ghostClass: 'ghost' }"
                                            v-model="fields"
                                            @start="start"
                                            item-key="id"
                                    >
                                        <template #item="{ element, index }">
                                            <v-chip size="small" class="ma-1 list-group-item" color="success"
                                                    :key="element.id" @click:close="removeMe(index)">
                                                <v-menu top nudge-top="20" open-on-hover offset-y>
                                                    <template #activator="{ props }">
                                                        <v-icon icon="mdi-google-spreadsheet" v-bind="props" small
                                                                color="white"></v-icon>
                                                    </template>
                                                    <v-sheet class="pa-3">
                                                        <h6 class="font-italic text--black mb-2">{{ _('Sample Data') }}</h6>
                                                        <div class="caption text--disabled my-2"
                                                             v-for="s in structure.head[element]">{{ s }}</div>
                                                    </v-sheet>
                                                </v-menu>
                                                ${element}
                                            </v-chip>
                                        </template>
                                    </draggable>
                                </v-card>

                            </v-col>

                            <v-col cols="12" md="9">
                                <v-sheet class="csv-panel pa-5" max-height="calc(100vh - 400px)">
                                    <div class="d-flex align-center">
                                        <h3 class="my-3">
                                            {{ _('Actor Fields') }}

                                        </h3>
                                        <v-divider vertical class="mx-3"></v-divider>
                                        <v-text-field
                                                label="{{ _('Map Name') }}"
                                                v-model="mapName"
                                                class="ml-5 "
                                        >

                                        </v-text-field>
                                        <v-spacer></v-spacer>
                                        <v-btn v-if="mapid" @click="updateMap" primary small
                                               class="mx-2">{{ _('Update map') }}</v-btn>
                                        <v-btn @click="createMap" primary small
                                               class="mx-2">{{ _('Create a new map') }}
                                        </v-btn>
                                        <v-btn v-if="mapid" x-small
                                               class="mx-2">{{ _('Delete') }}</v-btn>
                                    </div>

                                    <v-divider class="mb-2"></v-divider>

                                    <v-row>
                                        <v-sheet class="d-flex align-center">
                                            <drop-field v-if="dynamicAtype"
                                                        caption="{{ _('Actor Type') }}"
                                                        v-model="map.dtype"></drop-field>

                                            <v-sheet v-if="!dynamicAtype" class="d-flex align-center ma-2 pa-2" elevation="0">
                                                <h5 class="text-caption mr-1">{{ _('Actor Type') }}</h5>
                                                <v-select
                                                    class="mt-5"
                                                    density="compact"
                                                    :items="translations.actorTypes"
                                                    item-title="tr"
                                                    item-value="en"
                                                    clearable
                                                    v-model="map.type">
                                                </v-select>
                                            </v-sheet>

                                            <v-icon @click="switchAtype" x-small
                                                    color="primary">mdi-swap-horizontal
                                            </v-icon>
                                        </v-sheet>

                                        <drop-field v-model="map.originid"
                                                    caption="{{ _('Origin ID') }}">
                                            <template v-slot:extra>
                                                <v-btn-toggle v-model="vmap.originid"
                                                              color="primary"
                                                              group>
                                                    <v-tooltip location="top" text="{{_('Make it Unique!')}}">
                                                        <template #activator="{ props }">
                                                    <v-btn
                                                            :="props"
                                                            variant="plain"
                                                            icon="mdi-key" value="1"></v-btn>
                                                        </template>
                                                    </v-tooltip>
                                                </v-btn-toggle>
                                            </template>
                                        </drop-field>
                                    </v-row>

                                    <v-row style="gap: 20px">

                                        <drop-field v-model="map.name" caption="{{ _('Name') }}">
                                            <template v-slot:extra>
                                                <v-tooltip location="top" text="{{_('Make it Unique!')}}">
                                                    <template #activator="{ props }">
                                                <v-btn-toggle v-model="vmap.name"
                                                              color="primary"
                                                              group>
                                                    <v-btn :="props" variant="plain" icon="mdi-key" value="1"></v-btn>
                                                </v-btn-toggle>
                                                    </template>
                                                </v-tooltip>
                                            </template>
                                        </drop-field>

                                        <drop-field v-model="map.name_ar"
                                                    caption="{{ _('Name (AR)') }}"></drop-field>

                                        <drop-field v-model="map.nickname"
                                                    caption="{{ _('Nickname') }}"></drop-field>

                                        <drop-field v-model="map.nickname_ar"
                                                    caption="{{ _('Nickname (AR)') }}"></drop-field>

                                    </v-row>
                                    <v-row>
                                        <drop-field v-model="map.first_name"
                                                    caption="{{ _('First Name') }}"></drop-field>

                                        <drop-field v-model="map.first_name_ar"
                                                    caption="{{ _('First Name (AR)') }}"></drop-field>


                                        <drop-field v-model="map.middle_name"
                                                    caption="{{ _('Middle Name(s)') }}"></drop-field>

                                        <drop-field v-model="map.middle_name_ar"
                                                    caption="{{ _('Middle Name(s) (AR)') }}"></drop-field>


                                        <drop-field v-model="map.last_name"
                                                    caption="{{ _('Last Name') }}"></drop-field>

                                        <drop-field v-model="map.last_name_ar"
                                                    caption="{{ _('Last Name (AR)') }}"></drop-field>

                                        <drop-field v-model="map.father_name"
                                                    caption="{{ _('Father\'s Name') }}"></drop-field>

                                        <drop-field v-model="map.father_name_ar"
                                                    caption="{{ _('Father\'s Name (AR)') }}"></drop-field>

                                        <drop-field v-model="map.mother_name"
                                                    caption="{{ _('Mother\'s Name') }}"></drop-field>

                                        <drop-field v-model="map.mother_name_ar"
                                                    caption="{{ _('Mother\'s Name (AR)') }}"></drop-field>

                                    </v-row>

                                    <v-row>
                                        <drop-field v-model="map.sex"
                                                    caption="{{ _('Sex') }}"></drop-field>
                                        <drop-field v-model="map.age"
                                                    caption="{{ _('Minor/Adult') }}"></drop-field>
                                        <drop-field v-model="map.civilian"
                                                    caption="{{ _('Civilian/Non Civilian') }}"></drop-field>
                                    </v-row>
                                    <v-row>
                                        <drop-field v-model="map.origin_place"
                                                    caption="{{ _('Place of Origin') }}"></drop-field>
                                    </v-row>

                                    <v-row>
                                        <drop-field v-model="map.occupation"
                                                    caption="{{ _('Occupation') }}"></drop-field>

                                        <drop-field v-model="map.occupation_ar"
                                                    caption="{{ _('Occupation (AR)') }}"></drop-field>


                                        <drop-field v-model="map.position"
                                                    caption="{{ _('Position') }}"></drop-field>
                                        <drop-field v-model="map.position_ar"
                                                    caption="{{ _('Position (AR)') }}"></drop-field>


                                        <drop-field v-model="map.family_status"
                                                    caption="{{ _('Family Status') }}"></drop-field>

                                        <drop-field v-model="map.no_children"
                                                    caption="{{ _('No of Children') }}"></drop-field>

                                    </v-row>
                                    <v-row>
                                        <drop-field v-model="map.ethnographies"
                                                    caption="{{ _('Ethnographic Information') }}"></drop-field>
                                        <drop-field v-model="map.nationalities"
                                                    caption="{{ _('Nationalities') }}"></drop-field>
                                        <drop-field v-model="map.dialects"
                                                    caption="{{ _('Spoken Dialects') }}"></drop-field>
                                        <drop-field v-model="map.id_number"
                                                    caption="{{ _('ID Number') }}"></drop-field>
                                        <drop-field v-model="map.tags"
                                                    caption="{{ _('Tags') }}"></drop-field>
                                    </v-row>

                                    <!-- Actor Profile -->
                                    <v-row>
                                        <v-card class="pa-3 my-2 flex-wrap align-center"
                                                outlined>
                                            <h3 class="pa-2 my-3">
                                                {{ _('Actor Profile') }}
                                            </h3>

                                            <v-row>
                                                <drop-field v-model="map.sources"
                                                            caption="{{ _('Sources') }}"></drop-field>
                                                <drop-field v-model="map.labels"
                                                            caption="{{ _('Labels') }}"></drop-field>
                                                <drop-field v-model="map.verLabels"
                                                            caption="{{ _('Verified Labels') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <v-sheet class="d-flex flex-wrap ma-1 pa-1">
                                                    <template 
                                                        v-for="(d,i) in map.description" 
                                                        :key="i">
                                                        <input 
                                                            v-if="i!=0" 
                                                            class="d-sep ml-2 mr-1" 
                                                            width="10" 

                                                            v-model="map.description[i].sep"
                                                            placeholder="{{ _('Separator') }}">
                                                        <drop-field 
                                                            v-model="map.description[i].data"
                                                            caption="{{ _('Description') }}">
                                                        </drop-field>
                                                        <v-btn
                                                            v-if="i!=0" 
                                                            color="red" 
                                                            size="x-small"
                                                            variant="text"
                                                            class="my-auto mr-2"
                                                            icon="mdi-minus"
                                                            @click="map.description.splice(i,1)">
                                                        </v-btn>
                                                    </template>
                                                <v-btn 
                                                    @click="map.description.push({})"
                                                    class="my-auto"
                                                    variant="text"
                                                    color="green"
                                                    icon="mdi-plus"
                                                    size="x-small">

                                                </v-btn>
                                                </v-sheet>
                                                
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.source_link"
                                                            caption="{{ _('Source Link') }}">
                                                    <template v-slot:extra>
                                                        <v-tooltip location="top" text="{{_('Make it Unique!')}}">
                                                            <template #activator="{ props }">
                                                        <v-btn-toggle v-model="vmap.source_link"
                                                                      color="primary"
                                                                      group>
                                                            <v-btn :="props" variant="plain" icon="mdi-key" value="1"></v-btn>
                                                        </v-btn-toggle>
                                                            </template>
                                                        </v-tooltip>
                                                    </template>

                                                </drop-field>
                                                <drop-field v-model="map.source_link_type"
                                                            caption="{{ _('Private') }}"></drop-field>
                                                <drop-field v-model="map.publish_date"
                                                            caption="{{ _('Publish Date') }}"></drop-field>
                                                <drop-field v-model="map.documentation_date"
                                                            caption="{{ _('Documentation Date') }}"></drop-field>

                                            </v-row>

                                            <v-divider class="my-3"></v-divider>

                                            <h3 class="pa-2 my-3">
                                                {{ _('Missing Person Details') }}
                                            </h3>

                                            <v-row>
                                                <drop-field v-model="map.last_address"
                                                            caption="{{ _('Last Address') }}"></drop-field>
                                                <drop-field v-model="map.marriage_history"
                                                            caption="{{ _('Marriage History') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.pregnant_at_disappearance"
                                                            caption="{{ _('Pregnant at Disappearance') }}"></drop-field>
                                                <drop-field v-model="map.months_pregnant"
                                                            caption="{{ _('Months Pregnant') }}"></drop-field>
                                                <drop-field v-model="map.missing_relatives"
                                                            caption="{{ _('Missing Relatives') }}"></drop-field>

                                            </v-row>

                                            <div class="text-subtitle-2">
                                                {{ _('Details of the person who saw them last') }}
                                            </div>

                                            <v-row>
                                                <v-sheet class="pa-3 ma-2 d-flex align-center" outlined>
                                                    <drop-field v-model="map.saw_name"
                                                                caption="{{ _('Name') }}"></drop-field>
                                                    <drop-field v-model="map.saw_address"
                                                                caption="{{ _('Address') }}"></drop-field>
                                                    <drop-field v-model="map.saw_phone"
                                                                caption="{{ _('Phone') }}"></drop-field>
                                                    <drop-field v-model="map.saw_email"
                                                                caption="{{ _('Email') }}"></drop-field>
                                                </v-sheet>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.seen_in_detention_opts"
                                                            caption="{{ _('Seen in a detention center') }}"></drop-field>
                                                <drop-field v-model="map.seen_in_detention_details"
                                                            caption="{{ _('Details') }}"></drop-field>

                                                <drop-field v-model="map.injured_opts"
                                                            caption="{{ _('Injured around time of disappearance') }}"></drop-field>
                                                <drop-field v-model="map.injured_details"
                                                            caption="{{ _('Details') }}"></drop-field>
                                            </v-row>

                                            <v-row>

                                                <drop-field v-model="map.known_dead_opts"
                                                            caption="{{ _('Known to be dead') }}"></drop-field>
                                                <drop-field v-model="map.known_dead_details"
                                                            caption="{{ _('Details') }}"></drop-field>
                                                <drop-field v-model="map.personal_items"
                                                            caption="{{ _('Personal Items') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.height"
                                                            caption="{{ _('Height') }}"></drop-field>
                                                <drop-field v-model="map.weight"
                                                            caption="{{ _('Weight') }}"></drop-field>
                                                <drop-field v-model="map.physique"
                                                            caption="{{ _('Physique') }}"></drop-field>
                                                <drop-field v-model="map.hair_loss"
                                                            caption="{{ _('Hair Loss') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.hair_type"
                                                            caption="{{ _('Hair Type') }}"></drop-field>
                                                <drop-field v-model="map.hair_length"
                                                            caption="{{ _('Hair Length') }}"></drop-field>
                                                <drop-field v-model="map.hair_color"
                                                            caption="{{ _('Hair Color') }}"></drop-field>
                                                <drop-field v-model="map.facial_hair"
                                                            caption="{{ _('Facial Hair') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.posture"
                                                            caption="{{ _('Notes on posture') }}"></drop-field>
                                                <drop-field v-model="map.handedness"
                                                            caption="{{ _('Handedness') }}"></drop-field>
                                                <drop-field v-model="map.glasses"
                                                            caption="{{ _('Glasses') }}"></drop-field>
                                                <drop-field v-model="map.eye_color"
                                                            caption="{{ _('Eye Color') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.skin_markings_opts"
                                                            caption="{{ _('Skin Markings Options') }}"></drop-field>
                                                <drop-field v-model="map.skin_markings_details"
                                                            caption="{{ _('Skin Markings Details') }}"></drop-field>
                                            </v-row>

                                            <v-row>

                                                <drop-field v-model="map.dist_char_con"
                                                            caption="{{ _('Distinctive characteristics (congenital)') }}"></drop-field>
                                                <drop-field v-model="map.dist_char_acq"
                                                            caption="{{ _('Distinctive characteristics (acquired)') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.physical_habits"
                                                            caption="{{ _('Physical Habits') }}"></drop-field>
                                                <drop-field v-model="map.other"
                                                            caption="{{ _('Other comments') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.phys_name_contact"
                                                            caption="{{ _('Physician\'s name and contact') }}"></drop-field>
                                                <drop-field v-model="map.injuries"
                                                            caption="{{ _('Fractures / Injuries') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.implants"
                                                            caption="{{ _('Implants') }}"></drop-field>
                                                <drop-field v-model="map.malforms"
                                                            caption="{{ _('Congenital malformations') }}"></drop-field>

                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.pain"
                                                            caption="{{ _('Pain and/or ailments') }}"></drop-field>
                                                <drop-field v-model="map.other_conditions"
                                                            caption="{{ _('Other medical conditions') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.accidents"
                                                            caption="{{ _('Accidents') }}"></drop-field>
                                                <drop-field v-model="map.pres_drugs"
                                                            caption="{{ _('Prescription drugs taken') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.smoker"
                                                            caption="{{ _('Smoker') }}"></drop-field>
                                                <drop-field v-model="map.dental_record"
                                                            caption="{{ _('Dental Record') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.dentist_info"
                                                            caption="{{ _('Dentist\'s name and contact') }}"></drop-field>
                                                <drop-field v-model="map.teeth_features"
                                                            caption="{{ _('Teeth features') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.dental_problems"
                                                            caption="{{ _('Dental problems') }}"></drop-field>
                                                <drop-field v-model="map.dental_treatments"
                                                            caption="{{ _('Dental treatments') }}"></drop-field>
                                                <drop-field v-model="map.dental_habits"
                                                            caption="{{ _('Dental Habits') }}"></drop-field>
                                                <drop-field v-model="map.case_status"
                                                            caption="{{ _('Case Status') }}"></drop-field>
                                            </v-row>

                                            <div class="text-subtitle-2">
                                                {{ _('Details of the person(s) who reported them missing') }}
                                            </div>

                                            <v-row>

                                                <v-sheet class="pa-3 ma-2 d-flex align-center" outlined
                                                         v-for="(reporter,i) in map.reporters">
                                                    <drop-field caption="{{ _('Reporter name') }}"
                                                                v-model="map.reporters[i].name"></drop-field>
                                                    <drop-field caption="{{ _('Reporter contact') }}"
                                                                v-model="map.reporters[i].contact"></drop-field>
                                                    <drop-field caption="{{ _('Reporter relationship') }}"
                                                                v-model="map.reporters[i].relationship"></drop-field>
                                                    <v-btn v-if="i==map.reporters.length-1" small fab
                                                           text
                                                           @click="map.reporters.push({})">
                                                        <v-icon small color="green lighten-2">mdi-plus
                                                        </v-icon>
                                                    </v-btn>
                                                    <v-btn v-if="i==map.reporters.length-1 && map.reporters.length !=1"
                                                           small fab text
                                                           @click="map.reporters.splice(i,1)">
                                                        <v-icon small color="red lighten-2">mdi-minus
                                                        </v-icon>
                                                    </v-btn>
                                                </v-sheet>

                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.identified_by"
                                                            caption="{{ _('Identified by') }}"></drop-field>
                                                <drop-field v-model="map.family_notified"
                                                            caption="{{ _('Family Notified') }}"></drop-field>
                                                <drop-field v-model="map.reburial_location"
                                                            caption="{{ _('Location of reburial') }}"></drop-field>

                                            </v-row>
                                        </v-card>
                                    </v-row>

                                    <v-row>
                                        <div class="text-subtitle-2">
                                            {{ _('Events') }}
                                        </div>

                                        <v-sheet class="pa-3 my-2 d-flex flex-wrap align-center"
                                                 outlined
                                                 v-for="(event,i) in map.events" :key="i">
                                            <drop-field caption="{{ _('Title') }}"
                                                        v-model="map.events[i].title"></drop-field>

                                            <v-sheet class="d-flex align-center">

                                                <drop-field v-if="dynamicEtype"
                                                            caption="{{ _('Event Type') }}"
                                                            v-model="map.events[i].dtype"></drop-field>

                                                <v-sheet v-if="!dynamicEtype" class="d-flex align-center ma-2 pa-2" elevation="0">
                                                    <h5 class="text-caption mr-1">{{ _('Event Type') }}</h5>
                                                    <v-select
                                                        class="mt-5"
                                                        density="compact"
                                                        :items="eventtypes"
                                                        item-title="title"
                                                        item-value="title"
                                                        v-model="map.events[i].type">
                                                    </v-select>
                                                </v-sheet>
                                                

                                                <v-icon @click="switchEtype" x-small
                                                        color="primary">mdi-swap-horizontal
                                                </v-icon>

                                            </v-sheet>

                                            <drop-field caption="{{ _('Comments') }}"
                                                        v-model="map.events[i].comments"></drop-field>
                                            <drop-field caption="{{ _('Location') }}"
                                                        v-model="map.events[i].location"></drop-field>


                                            <drop-field caption="{{ _('From') }}"
                                                        v-model="map.events[i].from_date"></drop-field>
                                            <drop-field caption="{{ _('To') }}"
                                                        v-model="map.events[i].to_date"></drop-field>
                                            <drop-field caption="{{ _('Estimated Time') }}"
                                                        v-model="map.events[i].estimated"></drop-field>

                                            <v-btn icon="mdi-plus" color="success" size="small"
                                                   v-if="i==map.events.length-1" variant="text"
                                                   @click="map.events.push({})">
                                            </v-btn>
                                            <v-btn variant="text" icon="mdi-minus" color="error" size="small"
                                                   v-if="i==map.events.length-1 && map.events.length !=1"

                                                   @click="map.events.splice(i,1)">

                                            </v-btn>
                                        </v-sheet>
                                    </v-row>
                                </v-sheet>
                            </v-col>
                        </v-row>
                    </v-card>

                </v-stepper-window-item>

                <v-stepper-window-item value="three">
                    <v-card class="pa-5">

                        <v-card-text>
                            <v-sheet>
                                <v-list color="yellow lighten-4" density="compact">
                                    <v-list-item> {{ _('Sheet file:') }}
                                        <v-chip small dark class="mx-2"
                                                color="green">{{ _('Selected') }}
                                            <v-icon right>mdi-check</v-icon>
                                        </v-chip>
                                    </v-list-item>
                                    <v-list-item> {{ _('Map:') }}
                                        <v-tooltip location="top">
                                            <template v-slot:activator="{props}">
                                                <v-chip :="props" small dark class="mx-2"
                                                        color="green">{{ _('Selected') }}
                                                    <v-icon right>mdi-check</v-icon>
                                                </v-chip>
                                            </template>
                                            <span>
                                                                    ${this.selectedMap}
                                                                </span>
                                        </v-tooltip>


                                    </v-list-item>

                                </v-list>


                            </v-sheet>

                        </v-card-text>

                        <v-card-title>
                            {{ _('Optional: Upload more sheets to process') }}
                        </v-card-title>

                        <v-card-text class="overflow-y-auto" style="max-height: 45vh">

                            <vue-dropzone ref="extradropzone" id="dropzone" class="ma-auto"
                                          :options="dzMoreOpts"
                                          @vdropzone-error="showError"
                                          @vdropzone-removed-file="fileRemoveHandler"
                                          @vdropzone-success="extraUploadSuccess"></vue-dropzone>

                            <search-field
                                    api="/admin/api/roles/"
                                    item-title="name"
                                    item-value="id"
                                    :multiple="true"
                                    label="{{ _('Access Roles') }}"
                                    v-model="roles"
                            ></search-field>
                        </v-card-text>
                        <v-card-actions class="d-flex justify-center">
                            <v-btn variant="elevated" @click="toStepFour" :disabled="processDisabled" color="primary">
                                {{ _('Process File(s)') }}
                            </v-btn>

                        </v-card-actions>
                    </v-card>
                </v-stepper-window-item>


                <v-stepper-window-item value="four">
                    <v-card class="pa-5">
                        <v-card-text>
                            ${ status }
                        </v-card-text>
                        <v-btn
                                v-if="batch_id"
                                color="primary"
                                dark
                                class="ma-2"
                                :href="'/import/log/?batch_id='+batch_id">
                            {{ _('Check Import Progress') }}
                        </v-btn>
                    </v-card>
                </v-stepper-window-item>


            </v-stepper-window>


        </v-stepper>


    </v-main>


    <v-overlay v-model="loading">

    </v-overlay>



{% endblock %}
{% block outside %}
    <div class="d-none" data-allowed-sheets-types='.{{ ",.".join(config.SHEETS_ALLOWED_EXTENSIONS) }}'></div>
{% endblock %}
{% block js %}


    <script src="/static/js/dropzone.min.js"></script>
    <script src="/static/js/components/VueDropzone.js"></script>



    <script src="/static/js/Sortable.min.js"></script>
    <script src="/static/js/vuedraggable.umd.js"></script>
    <script src="/static/js/components/DropField.js"></script>
    <script src="/static/js/components/SearchField.js"></script>

    <script>

        const draggable = vuedraggable;
        const allowedSheetsTypes = document.querySelector('[data-allowed-sheets-types]').dataset.allowedSheetsTypes;

        const {createApp} = Vue;
        const {createVuetify} = Vuetify;
        const vuetify = createVuetify(vuetifyConfig);

        const app = createApp({
            delimiters: delimiters,
            mixins: [globalMixin],

            data: () => ({
                translations: window.translations,
                drawer: drawer,
                mode: null,
                loading: false,
                status: '',
                batch_id: '',
                firstAction: 0,

                dzOpts: {
                    url: '/import/api/csv/upload',
                    // accept any file
                    acceptedFiles: allowedSheetsTypes,
                    addRemoveLinks: true,
                    thumbnailWidth: 80, // px
                    thumbnailHeight: 80,
                    maxFiles: 1,
                    maxFilesize: mediaUploadMaxFileSize
                },
                dzMoreOpts: {
                    url: '/import/api/csv/upload',
                    // accept any file
                    acceptedFiles: allowedSheetsTypes,
                    addRemoveLinks: true,
                    thumbnailWidth: 80, // px
                    thumbnailHeight: 80,
                    maxFiles: null,
                    maxFilesize: mediaUploadMaxFileSize
                },

                lang: 'en',

                structure: null,
                fields: null,

                processDisabled: false,

                controlOnStart: true,
                
                dynamicAtype: true,

                eventtypes: [],
                dynamicEtype: true,


                maps: null,
                map: {
                    events: [{}],
                    reporters: [{}],
                    description: [{}]
                },
                defaultMap: {
                    events: [{}],
                    reporters: [{}],
                    description: [{}]
                },
                // dedicate another separate map for validation
                vmap: {},

                backup: [],

                mapName: "{{ _('New Map')}}",
                mapid: null,
                selectedMap: null,


                step: "one",

                sheets: [],
                selectedSheet: null,

                ffilter: null,
                files: [],
                extra: [],
                roles: [],
                options: {
                    page: 1,
                    itemsPerPage: 100
                },

                headers: [
                    {text: "{{_('Name')}}", value: 'file.name', sortable: false},


                ],
                itemsLength: 100,
                editedIndex: -1,


                log: []

            }),
            components: {
                vueDropzone: VueDropzone,

            },

            mounted() {
                this.loadMaps();
                this.loadEtypes();


            },

            computed: {
                allFiles() {
                    return this.files.concat(this.extra);
                }
            },


            watch: {

                items(val) {
                    if (val.length) {
                        this.selAllDisabled = false;
                    } else {
                        this.selAllDisabled = true;
                    }

                },


            },


            methods: {

                showError(err, message) {
                    this.showSnack(message);
                },

                fileRemoveHandler(file, error, xhr) {
                    if (!error) {
                        // pop out that specific removed file
                        this.extra = this.extra.filter(x =>
                            x.uuid !== file.upload.uuid
                        );
                    }
                },

                extraUploadSuccess(dzfile) {
                    // pick file from dropzone files list
                    const file = findUploadedFileByUUID(this.$refs.extradropzone.dz.getAcceptedFiles(), dzfile.upload.uuid);

                    this.extra.push(file);
                },

                uploadSuccess(dzfile) {
                    // pick file from dropzone files list
                    const file = findUploadedFileByUUID(this.$refs.dropzone.dz.getAcceptedFiles(), dzfile.upload.uuid);

                    this.files.push(file);

                    const ext = file.filename.split('.').at(-1);

                    if (ext === 'csv') {

                        api.post('/import/api/csv/analyze', {file: file}).then(res => {
                            this.structure = res.data;
                            this.fields = this.structure.columns;
                            this.backup = this.fields.slice();
                            // since we are mapping, make sure selectedMap is not populated
                            this.selectedMap = null;
                            this.step = "two";
                        }).catch(
                            err => {
                                console.log(err.response.data)
                            }
                        ).finally(
                            () => {

                            }
                        );
                    } else if (ext === 'xls' || ext === 'xlsx') {
                        api.post('/import/api/xls/sheets', {file: file}).then(res => {
                            this.sheets = res.data;
                        }).catch(
                            err => {
                                console.log(err.response.data)
                            }
                        ).finally(
                            () => {

                            }
                        );
                    }

                },


                filterFields() {
                    if (this.ffilter) {
                        this.fields = this.structure.columns.filter(x => x.toLowerCase().includes(this.ffilter.toLowerCase()));
                    } else {
                        this.fields = this.structure.columns;
                    }


                },

                sheetSelected() {
                    api.post('/import/api/xls/analyze', {
                        file: this.files[0],
                        sheet: this.selectedSheet
                    }).then(res => {
                        this.structure = res.data;
                        this.fields = this.structure.columns;
                        this.backup = this.fields.slice();
                        // since we are mapping, make sure selectedMap is not populated
                        this.selectedMap = null;
                        this.step = "two";
                    }).catch(
                        err => {
                            console.log(err.response.data)
                        }
                    ).finally(
                        () => {

                        }
                    );
                },

                fileRemoved() {
                    this.selectedSheet = null;
                    this.sheets = [];
                },

                returnToStack(item) {
                    if (!item || !Array.isArray(item) || item.length === 0) return;

                    let field = item.pop();
                    this.fields.indexOf(field) === -1 ? this.fields.unshift(field) : console.log("This item already exists");

                },

                switchAtype() {
                    if (this.map.dtype?.length && this.dynamicAtype) {
                        this.returnToStack(this.map.dtype);
                    }
                    if (!this.dynamicAtype) {
                        this.map.type = null;
                    }
                    this.dynamicAtype = !this.dynamicAtype;
                },

                switchEtype() {
                    // use dtype as a way to identify the mode of import
                    if (this.dynamicEtype) {
                        for (const ev of this.map.events) {
                            if (ev.dtype?.length){
                                this.returnToStack(ev.dtype);
                            }   
                        }
                    } else {
                        for (const ev of this.map.events) {
                            if (ev.type){
                                ev.type = null;
                            }   
                        }
                    }
                    this.dynamicEtype = !this.dynamicEtype;
                },

                resetFields() {
                    this.fields = this.backup;
                    // hack to bypass js passing vars by reference
                    this.map = JSON.parse(JSON.stringify(this.defaultMap));
                    this.mapName = "{{ _('New Map')}}";
                    this.mapid = null;
                    this.vmap = {};

                },


                clone(name) {

                    return name;
                },
                customPull() {

                    return this.controlOnStart ? "clone" : true;
                },
                start({originalEvent}) {
                    this.controlOnStart = originalEvent.ctrlKey;
                },


                process() {
                    const files = this.allFiles.map(x => x.filename);

                    // add countries to actor config
                    let config = translations;


                    api.post('/import/api/process-sheet', {
                        map: this.map,
                        vmap: this.vmap,
                        sheet: this.selectedSheet,
                        roles: this.roles,
                        target: 'actor',
                        lang: this.lang,
                        files: files,
                        actorConfig: config
                    }).then(
                        res => {
                            this.status = "{{ _('Rows from file were added to queue successfully and will be imported in turn.') }}"
                            this.batch_id = res.data
                        }
                    ).catch(err => {
                        console.log(err.response.data);
                        this.status = "{{ _('Error importing rows. Check logs for more information.') }}"
                    }).finally(
                        () => {

                        }
                    );

                },


                loadMap(m) {
                    if (m) {
                        this.map = m.data.map;
                        this.mapid = m.id;
                        this.mapName = m.name;
                        this.vmap = m.data.vmap;
                    }


                },

                loadMaps() {

                    api.get('/import/api/mappings/').then(
                        res => {
                            this.maps = res.data;
                        }
                    ).catch(err => {
                        console.log(err.response.data);
                    }).finally(
                        () => {

                        }
                    )

                },

                loadEtypes() {
                    api.get('/admin/api/eventtypes/').then(res => {

                        this.eventtypes = res.data.items.filter(x => x.title);
                    })
                },

                toStepThree() {

                    this.selectedMap = this.map;
                    this.step = "three";


                },

                toStepFour() {
                    this.step = "four";
                    this.process();
                },

                selectMap(m) {


                    this.selectedMap = m.data;
                    this.mapName = m.name;
                },


                removeMe(i) {
                    let field = this.fields.splice(i, 1);
                },

                updateMap() {

                    if (this.mapid) {
                        // update existing map
                        api.put(`/import/api/mapping/${this.mapid}`, {
                            name: this.mapName,
                            data:
                                {
                                    map: this.map,
                                    vmap: this.vmap
                                }
                        }).then(res => {
                            this.showSnack(res.data.message);

                        }).catch(err => {
                            console.log(err.response);
                        }).finally(
                            () => {

                            }
                        );


                    }


                }
                ,

                createMap() {
                    //create new
                    api.post('/import/api/mapping/', {
                        name: this.mapName,
                        data: {
                            map: this.map,
                            vmap: this.vmap
                        }
                    }).then(res => {
                        this.showSnack(res.data.message);
                        this.mapid = res.data.id;
                    }).catch(err => {
                        console.log(err.response);
                    }).finally(
                        () => {

                        }
                    );
                },

                processStarted() {
                    this.processDisabled = true;
                }
                ,
                onExtraFilesUploaded(error, file) {

                    if (!error) {
                        this.processDisabled = false;

                    }

                }
                ,

                onFileUploaded(error, file) {

                    if (!error) {

                        //file uploaded, analyse server side and proceed if ok

                        const ext = this.files[0].fileExtension;
                        if (ext == 'csv') {

                            api.post('/import/api/csv/analyze', {file: JSON.parse(this.files[0].serverId)}).then(res => {
                                this.structure = res.data;
                                this.fields = this.structure.columns;
                                this.backup = this.fields.slice();
                                // since we are mapping, make sure selectedMap is not populated
                                this.selectedMap = null;
                                this.step = "two";
                            }).catch(
                                err => {
                                    console.log(err.response.data)
                                }
                            ).finally(
                                () => {

                                }
                            );
                        } else if (ext == 'xls' || ext == 'xlsx') {
                            api.post('/import/api/xls/sheets', {file: JSON.parse(this.files[0].serverId)}).then(res => {
                                this.sheets = res.data;
                            }).catch(
                                err => {
                                    console.log(err.response.data)
                                }
                            ).finally(
                                () => {

                                }
                            );
                        }


                    }


                },

            }
        });

        app.component('search-field', SearchField);
        app.component('drop-field', DropField);
        app.component('draggable', draggable);


        app.use(vuetify).mount('#app');
        window.app = app;
    </script>
{% endblock %}
