{% extends 'layout.html' %}

{% block content %}

    <v-main class="align-start ma-3">
        <v-stepper v-model="step">
            <v-stepper-header class="elevation-0">
                <v-stepper-item class="cursor-default" color="primary" title="{{ _('Upload or Select') }}" value="1" :complete="step > 1"></v-stepper-item>
                <v-divider></v-divider>
                <v-stepper-item class="cursor-default" color="primary" title="{{ _('Map') }}" value="2" :complete="step > 2"></v-stepper-item>
                <v-divider></v-divider>
                <v-stepper-item class="cursor-default" color="primary" title="{{ _('Upload More') }}" value="3" :complete="step > 3"></v-stepper-item>
                <v-divider></v-divider>
                <v-stepper-item class="cursor-default" color="primary" title="{{ _('Status') }}" value="4" :complete="step > 4"></v-stepper-item>
            </v-stepper-header>

            <v-stepper-actions>
                <template #next>
                    <v-btn v-bind="nextButtonProps"></v-btn>
                </template>
                <template #prev>
                    <v-btn v-bind="prevButtonProps"></v-btn>
                </template>
            </v-stepper-actions>

            <v-stepper-window style="height: calc(100vh - 212px);">
                <v-stepper-window-item value="1">
                    <v-sheet class="my-8">

                        <v-btn-toggle borderless color="primary darken-2" mandatory
                                      class="d-flex justify-center" v-model="firstAction">
                            <v-btn>{{ _('Create a new map') }}</v-btn>
                            <v-btn>{{ _('Select an existing map') }}</v-btn>
                        </v-btn-toggle>
                    </v-sheet>

                    <v-sheet max-width="800" class="mx-auto fp-wrap">
                        <v-card class="text-center my-3">
                            <v-card-title class="subtitle-1">{{ _('Select Sheet Language') }}</v-card-title>
                            <v-card-text>
                                <v-chip-group class="mx-auto"
                                              column
                                              mandatory
                                              v-model="lang"
                                >
                                    <v-chip 
                                    v-for="(name, code) in languages"
                                    :value="code"
                                    small label 
                                    filter 
                                    outlined
                                    >
                                        ${name}
                                    </v-chip>
                                </v-chip-group>
                            </v-card-text>

                        </v-card>

                        <div v-show="firstAction === 0">
                            <vue-dropzone
                                ref="dropzone"
                                id="dropzone"
                                class="ma-auto"
                                :options="dzOpts"
                                @vdropzone-error="showError"
                                @vdropzone-success="uploadSuccess"
                                @vdropzone-removed-file="removeFile"
                            ></vue-dropzone>

                            <v-select label="{{ _('Select Sheet to continue') }}" v-model="selectedSheet"
                                        @update:model-value="sheetSelected" v-if="sheets.length && files.length"
                                        class="my-3" :items="sheets">
                            </v-select>


                            <v-img style="margin:auto"
                                    src="/static/img/csv-tool-bg.jpg">
                        </div>
                    </v-sheet>


                    <v-sheet max-width="800" class="pa-4 my-8 mx-auto" v-show="firstAction === 1">
                        <v-autocomplete
                                class="mt-2 mx-2"
                                label="{{ _('Load existing map') }}"
                                @update:focused="loadMaps"
                                :items="maps || []"
                                item-title="name"
                                item-value="id"
                                :return-object="true"
                                :model-value="mapid"
                                @update:model-value="selectMap($event); step = '3';"
                        >
                        </v-autocomplete>
                    </v-sheet>
                </v-stepper-window-item>

                <v-stepper-window-item value="2" class="h-100">
                    <v-card elevation="0" class="pa-3 overflow-y-auto h-100">
                        <v-row class="align-stretch h-100">
                            <v-col cols="12" md="3" class="h-100">
                                <div class="mt-4 px-4 overflow-y-auto h-100">
                                    <v-toolbar>
                                        <v-toolbar-title class="d-flex">
                                            {{ _('Sheet Fields') }}

                                            <v-btn @click="confirmResetFields" size="small"
                                                   variant="outlined" prepend-icon="mdi-refresh" class="ml-2">
                                                   {{ _('Reset') }}
                                            </v-btn>
                                        </v-toolbar-title>
                                    </v-toolbar>

                                    <v-divider class="mb-2"></v-divider>

                                    <v-text-field
                                                  label="{{ _('Search Fields') }}" v-model="ffilter"
                                                  clearable class="mt-4" density="compact" prepend-inner-icon="mdi-magnify" @click:clear="ffilter = ''"></v-text-field>

                                    <draggable
                                            class="list-group"
                                            :clone="clone"
                                            :group="{ name: 'columns', pull: customPull , animation: 100, ghostClass: 'ghost' }"
                                            :model-value="filteredFields"
                                            @update:model-value="fields = $event"
                                            @start="start"
                                            item-key="id"
                                    >
                                        <template #item="{ element, index }">
                                            <v-chip size="small" class="ma-1 list-group-item" color="success"
                                                    :key="element.id" @click:close="removeMe(index)">
                                                <v-menu top nudge-top="20" open-on-hover offset-y>
                                                    <template #activator="{ props }">
                                                        <v-icon icon="mdi-google-spreadsheet" v-bind="props" small
                                                                color="white"></v-icon>
                                                    </template>
                                                    <v-sheet class="pa-3">
                                                        <h6 class="font-italic text--black mb-2">{{ _('Sample Data') }}</h6>
                                                        <div class="caption text--disabled my-2"
                                                             v-for="s in structure.head[element]">{{ s }}</div>
                                                    </v-sheet>
                                                </v-menu>
                                                ${element}
                                            </v-chip>
                                        </template>
                                    </draggable>
                                </div>
                            </v-col>

                            <v-divider vertical></v-divider>

                            <v-col cols="12" md="9" class="h-100">
                                <v-sheet :class="[`overflow-y-auto pa-5`, { 'h-100': $vuetify.display.mdAndUp }]">
                                    <div class="d-flex flex-wrap align-center pb-2">
                                        <div class="v-toolbar-title my-3">
                                            {{ _('Actor Fields') }}
                                        </div>
                                        <v-divider vertical class="mx-3"></v-divider>
                                        <v-text-field
                                            density="compact"
                                            label="{{ _('Map Name') }}"
                                            v-model="mapName"
                                            class="mx-5"
                                            hide-details
                                        ></v-text-field>

                                        <v-select density="compact" @click:clear="confirmResetFields()" label="{{ _('Load existing map') }}"
                                            :items="maps" item-title="name" item-value="id" return-object :model-value="mapid" @update:model-value="loadMap"
                                            clearable hide-details>
                                        </v-select>

                                        <v-spacer></v-spacer>
                                        <v-btn v-if="mapid" @click="deleteMap" prepend-icon="mdi-delete" color="error" variant="outlined"
                                           class="mx-2">{{ _('Delete') }}</v-btn>
                                        <v-btn v-if="mapid" :disabled="!isMapPopulated" @click="updateMap" prepend-icon="mdi-pencil" variant="outlined"
                                               class="mx-2">{{ _('Update') }}</v-btn>
                                        <v-btn :disabled="!isMapPopulated" @click="createMap" color="primary" prepend-icon="mdi-plus"
                                                class="mx-2">{{ _('New map') }}
                                        </v-btn>
                                    </div>

                                    <v-divider class="mb-2"></v-divider>

                                    <v-row>
                                        <v-sheet class="d-flex align-center">
                                            <drop-field v-if="dynamicAtype"
                                                        caption="{{ _('Actor Type') }}"
                                                        v-model="map.dtype"></drop-field>

                                            <v-sheet v-if="!dynamicAtype" class="d-flex align-center ma-2 pa-2" elevation="0">
                                                <h5 class="text-caption mr-1">{{ _('Actor Type') }}</h5>
                                                <v-select
                                                    class="mt-5"
                                                    density="compact"
                                                    :items="translations.actorTypes"
                                                    item-title="tr"
                                                    item-value="en"
                                                    clearable
                                                    v-model="map.type">
                                                </v-select>
                                            </v-sheet>

                                            <v-icon @click="switchAtype" x-small
                                                    color="primary">mdi-swap-horizontal
                                            </v-icon>
                                        </v-sheet>


                                    </v-row>

                                    <v-row style="gap: 20px">

                                        <drop-field v-model="map.name" caption="{{ _('Name') }}">
                                            <template v-slot:extra>
                                                <v-tooltip location="top" text="{{_('Make it Unique!')}}">
                                                    <template #activator="{ props }">
                                                <v-btn-toggle v-model="vmap.name"
                                                              color="primary"
                                                              group>
                                                    <v-btn v-bind="props" variant="plain" icon="mdi-key" value="1"></v-btn>
                                                </v-btn-toggle>
                                                    </template>
                                                </v-tooltip>
                                            </template>
                                        </drop-field>

                                        <drop-field v-model="map.name_ar"
                                                    caption="{{ _('Name (AR)') }}"></drop-field>

                                        <drop-field v-model="map.nickname"
                                                    caption="{{ _('Nickname') }}"></drop-field>

                                        <drop-field v-model="map.nickname_ar"
                                                    caption="{{ _('Nickname (AR)') }}"></drop-field>

                                    </v-row>
                                    <v-row>
                                        <drop-field v-model="map.first_name"
                                                    caption="{{ _('First Name') }}"></drop-field>

                                        <drop-field v-model="map.first_name_ar"
                                                    caption="{{ _('First Name (AR)') }}"></drop-field>


                                        <drop-field v-model="map.middle_name"
                                                    caption="{{ _('Middle Name(s)') }}"></drop-field>

                                        <drop-field v-model="map.middle_name_ar"
                                                    caption="{{ _('Middle Name(s) (AR)') }}"></drop-field>


                                        <drop-field v-model="map.last_name"
                                                    caption="{{ _('Last Name') }}"></drop-field>

                                        <drop-field v-model="map.last_name_ar"
                                                    caption="{{ _('Last Name (AR)') }}"></drop-field>

                                        <drop-field v-model="map.father_name"
                                                    caption="{{ _('Father\'s Name') }}"></drop-field>

                                        <drop-field v-model="map.father_name_ar"
                                                    caption="{{ _('Father\'s Name (AR)') }}"></drop-field>

                                        <drop-field v-model="map.mother_name"
                                                    caption="{{ _('Mother\'s Name') }}"></drop-field>

                                        <drop-field v-model="map.mother_name_ar"
                                                    caption="{{ _('Mother\'s Name (AR)') }}"></drop-field>

                                    </v-row>

                                    <v-row>
                                        <drop-field v-model="map.sex"
                                                    caption="{{ _('Sex') }}"></drop-field>
                                        <drop-field v-model="map.age"
                                                    caption="{{ _('Minor/Adult') }}"></drop-field>
                                        <drop-field v-model="map.civilian"
                                                    caption="{{ _('Civilian/Non Civilian') }}"></drop-field>
                                    </v-row>
                                    <v-row>
                                        <drop-field v-model="map.origin_place"
                                                    caption="{{ _('Place of Origin') }}"></drop-field>
                                    </v-row>

                                    <v-row>
                                        <drop-field v-model="map.occupation"
                                                    caption="{{ _('Occupation') }}"></drop-field>

                                        <drop-field v-model="map.occupation_ar"
                                                    caption="{{ _('Occupation (AR)') }}"></drop-field>


                                        <drop-field v-model="map.position"
                                                    caption="{{ _('Position') }}"></drop-field>
                                        <drop-field v-model="map.position_ar"
                                                    caption="{{ _('Position (AR)') }}"></drop-field>


                                        <drop-field v-model="map.family_status"
                                                    caption="{{ _('Family Status') }}"></drop-field>

                                        <drop-field v-model="map.no_children"
                                                    caption="{{ _('No of Children') }}"></drop-field>

                                    </v-row>
                                    <v-row>
                                        <drop-field v-model="map.ethnographies"
                                                    caption="{{ _('Ethnographic Information') }}"></drop-field>
                                        <drop-field v-model="map.nationalities"
                                                    caption="{{ _('Nationalities') }}"></drop-field>
                                        <drop-field v-model="map.dialects"
                                                    caption="{{ _('Spoken Dialects') }}"></drop-field>
                                        <drop-field v-model="map.tags"
                                                    caption="{{ _('Tags') }}"></drop-field>
                                        <v-card class="w-100">
                                            <v-card-item>
                                                <v-card-title>
                                                    {{ _('ID Numbers') }}
                                                </v-card-title>
                                            </v-card-item>
                                        
                                            <v-card-text>
                                                <div v-for="(idNumber,i) in map.id_number" :key="i">
                                                    <v-sheet class="d-flex align-center" elevation="0">
                                                        <h5 class="text-caption mr-1">{{ _('ID Type') }}</h5>
                                                        <v-select
                                                            max-width="300px"
                                                            density="compact"
                                                            :items="idNumberTypes"
                                                            item-title="title"
                                                            item-value="id"
                                                            :model-value="idNumber.type || null"
                                                            @update:model-value="idNumber.type = $event"
                                                            hide-details
                                                        ></v-select>
                                        
                                                        <drop-field
                                                            caption="{{ _('Number') }}"
                                                            :model-value="[idNumber.number].filter(Boolean)"
                                                            @update:model-value="idNumber.number = $event[0] || ''"
                                                            @change="setIdEntityOnDrop($event, idNumber)"
                                                        ></drop-field>
                                        
                                                        <v-btn icon="mdi-plus" color="success" size="small" v-if="i==map.id_number.length-1" variant="text"
                                                            @click="map.id_number.push({})">
                                                        </v-btn>
                                                        <v-btn variant="text" icon="mdi-minus" color="error" size="small"
                                                            v-if="i==map.id_number.length-1 && map.id_number.length !=1" @click="map.id_number.splice(i,1)">
                                                        </v-btn>
                                                </div>
                                            </v-card-text>
                                        </v-card>
                                    </v-row>

                                    <!-- Actor Profile -->
                                    <v-row>
                                        <v-card class="pa-3 my-2 flex-wrap align-center"
                                                outlined>
                                            <h3 class="pa-2 my-3">
                                                {{ _('Actor Profile') }}
                                            </h3>

                                            <v-row>
                                                <drop-field v-model="map.originid"
                                                            caption="{{ _('Origin ID') }}">
                                                    <template v-slot:extra>
                                                        <v-btn-toggle v-model="vmap.originid"
                                                                      color="primary"
                                                                      group>
                                                            <v-tooltip location="top" text="{{_('Make it Unique!')}}">
                                                                <template #activator="{ props }">
                                                            <v-btn
                                                                    v-bind="props"
                                                                    variant="plain"
                                                                    icon="mdi-key" value="1"></v-btn>
                                                                </template>
                                                            </v-tooltip>
                                                        </v-btn-toggle>
                                                    </template>
                                                </drop-field>
                                                <drop-field v-model="map.sources"
                                                            caption="{{ _('Sources') }}"></drop-field>
                                                <drop-field v-model="map.labels"
                                                            caption="{{ _('Labels') }}"></drop-field>
                                                <drop-field v-model="map.verLabels"
                                                            caption="{{ _('Verified Labels') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <v-sheet class="d-flex flex-wrap ma-1 pa-1">
                                                    <template 
                                                        v-for="(d,i) in map.description" 
                                                        :key="i">
                                                        <input 
                                                            v-if="i!=0" 
                                                            class="d-sep ml-2 mr-1" 
                                                            width="10" 

                                                            v-model="map.description[i].sep"
                                                            placeholder="{{ _('Separator') }}">
                                                        <drop-field 
                                                            v-model="map.description[i].data"
                                                            caption="{{ _('Description') }}">
                                                        </drop-field>
                                                        <v-btn
                                                            v-if="i!=0" 
                                                            color="red" 
                                                            size="x-small"
                                                            variant="text"
                                                            class="my-auto mr-2"
                                                            icon="mdi-minus"
                                                            @click="map.description.splice(i,1)">
                                                        </v-btn>
                                                    </template>
                                                <v-btn 
                                                    @click="map.description.push({})"
                                                    class="my-auto"
                                                    variant="text"
                                                    color="green"
                                                    icon="mdi-plus"
                                                    size="x-small">

                                                </v-btn>
                                                </v-sheet>
                                                
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.source_link"
                                                            caption="{{ _('Source Link') }}">
                                                    <template v-slot:extra>
                                                        <v-tooltip location="top" text="{{_('Make it Unique!')}}">
                                                            <template #activator="{ props }">
                                                        <v-btn-toggle v-model="vmap.source_link"
                                                                      color="primary"
                                                                      group>
                                                            <v-btn v-bind="props" variant="plain" icon="mdi-key" value="1"></v-btn>
                                                        </v-btn-toggle>
                                                            </template>
                                                        </v-tooltip>
                                                    </template>

                                                </drop-field>
                                                <drop-field v-model="map.source_link_type"
                                                            caption="{{ _('Private') }}"></drop-field>
                                                <drop-field v-model="map.publish_date"
                                                            caption="{{ _('Publish Date') }}"></drop-field>
                                                <drop-field v-model="map.documentation_date"
                                                            caption="{{ _('Documentation Date') }}"></drop-field>

                                            </v-row>

                                            <v-divider class="my-3"></v-divider>

                                            <h3 class="pa-2 my-3">
                                                {{ _('Missing Person Details') }}
                                            </h3>

                                            <v-row>
                                                <drop-field v-model="map.last_address"
                                                            caption="{{ _('Last Address') }}"></drop-field>
                                                <drop-field v-model="map.marriage_history"
                                                            caption="{{ _('Marriage History') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.pregnant_at_disappearance"
                                                            caption="{{ _('Pregnant at Disappearance') }}"></drop-field>
                                                <drop-field v-model="map.months_pregnant"
                                                            caption="{{ _('Months Pregnant') }}"></drop-field>
                                                <drop-field v-model="map.missing_relatives"
                                                            caption="{{ _('Missing Relatives') }}"></drop-field>

                                            </v-row>

                                            <div class="text-subtitle-2">
                                                {{ _('Details of the person who saw them last') }}
                                            </div>

                                            <v-row>
                                                <v-sheet class="pa-3 ma-2 d-flex align-center" outlined>
                                                    <drop-field v-model="map.saw_name"
                                                                caption="{{ _('Name') }}"></drop-field>
                                                    <drop-field v-model="map.saw_address"
                                                                caption="{{ _('Address') }}"></drop-field>
                                                    <drop-field v-model="map.saw_phone"
                                                                caption="{{ _('Phone') }}"></drop-field>
                                                    <drop-field v-model="map.saw_email"
                                                                caption="{{ _('Email') }}"></drop-field>
                                                </v-sheet>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.seen_in_detention_opts"
                                                            caption="{{ _('Seen in a detention center') }}"></drop-field>
                                                <drop-field v-model="map.seen_in_detention_details"
                                                            caption="{{ _('Details') }}"></drop-field>

                                                <drop-field v-model="map.injured_opts"
                                                            caption="{{ _('Injured around time of disappearance') }}"></drop-field>
                                                <drop-field v-model="map.injured_details"
                                                            caption="{{ _('Details') }}"></drop-field>
                                            </v-row>

                                            <v-row>

                                                <drop-field v-model="map.known_dead_opts"
                                                            caption="{{ _('Known to be dead') }}"></drop-field>
                                                <drop-field v-model="map.known_dead_details"
                                                            caption="{{ _('Details') }}"></drop-field>
                                                <drop-field v-model="map.personal_items"
                                                            caption="{{ _('Personal Items') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.height"
                                                            caption="{{ _('Height') }}"></drop-field>
                                                <drop-field v-model="map.weight"
                                                            caption="{{ _('Weight') }}"></drop-field>
                                                <drop-field v-model="map.physique"
                                                            caption="{{ _('Physique') }}"></drop-field>
                                                <drop-field v-model="map.hair_loss"
                                                            caption="{{ _('Hair Loss') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.hair_type"
                                                            caption="{{ _('Hair Type') }}"></drop-field>
                                                <drop-field v-model="map.hair_length"
                                                            caption="{{ _('Hair Length') }}"></drop-field>
                                                <drop-field v-model="map.hair_color"
                                                            caption="{{ _('Hair Color') }}"></drop-field>
                                                <drop-field v-model="map.facial_hair"
                                                            caption="{{ _('Facial Hair') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.posture"
                                                            caption="{{ _('Notes on posture') }}"></drop-field>
                                                <drop-field v-model="map.handedness"
                                                            caption="{{ _('Handedness') }}"></drop-field>
                                                <drop-field v-model="map.glasses"
                                                            caption="{{ _('Glasses') }}"></drop-field>
                                                <drop-field v-model="map.eye_color"
                                                            caption="{{ _('Eye Color') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.skin_markings_opts"
                                                            caption="{{ _('Skin Markings Options') }}"></drop-field>
                                                <drop-field v-model="map.skin_markings_details"
                                                            caption="{{ _('Skin Markings Details') }}"></drop-field>
                                            </v-row>

                                            <v-row>

                                                <drop-field v-model="map.dist_char_con"
                                                            caption="{{ _('Distinctive characteristics (congenital)') }}"></drop-field>
                                                <drop-field v-model="map.dist_char_acq"
                                                            caption="{{ _('Distinctive characteristics (acquired)') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.physical_habits"
                                                            caption="{{ _('Physical Habits') }}"></drop-field>
                                                <drop-field v-model="map.other"
                                                            caption="{{ _('Other comments') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.phys_name_contact"
                                                            caption="{{ _('Physician\'s name and contact') }}"></drop-field>
                                                <drop-field v-model="map.injuries"
                                                            caption="{{ _('Fractures / Injuries') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.implants"
                                                            caption="{{ _('Implants') }}"></drop-field>
                                                <drop-field v-model="map.malforms"
                                                            caption="{{ _('Congenital malformations') }}"></drop-field>

                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.pain"
                                                            caption="{{ _('Pain and/or ailments') }}"></drop-field>
                                                <drop-field v-model="map.other_conditions"
                                                            caption="{{ _('Other medical conditions') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.accidents"
                                                            caption="{{ _('Accidents') }}"></drop-field>
                                                <drop-field v-model="map.pres_drugs"
                                                            caption="{{ _('Prescription drugs taken') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.smoker"
                                                            caption="{{ _('Smoker') }}"></drop-field>
                                                <drop-field v-model="map.dental_record"
                                                            caption="{{ _('Dental Record') }}"></drop-field>
                                            </v-row>
                                            <v-row>
                                                <drop-field v-model="map.dentist_info"
                                                            caption="{{ _('Dentist\'s name and contact') }}"></drop-field>
                                                <drop-field v-model="map.teeth_features"
                                                            caption="{{ _('Teeth features') }}"></drop-field>
                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.dental_problems"
                                                            caption="{{ _('Dental problems') }}"></drop-field>
                                                <drop-field v-model="map.dental_treatments"
                                                            caption="{{ _('Dental treatments') }}"></drop-field>
                                                <drop-field v-model="map.dental_habits"
                                                            caption="{{ _('Dental Habits') }}"></drop-field>
                                                <drop-field v-model="map.case_status"
                                                            caption="{{ _('Case Status') }}"></drop-field>
                                            </v-row>

                                            <div class="text-subtitle-2">
                                                {{ _('Details of the person(s) who reported them missing') }}
                                            </div>

                                            <v-row>

                                                <v-sheet class="pa-3 ma-2 d-flex align-center" outlined
                                                         v-for="(reporter,i) in map.reporters">
                                                    <drop-field caption="{{ _('Reporter name') }}"
                                                                v-model="map.reporters[i].name"></drop-field>
                                                    <drop-field caption="{{ _('Reporter contact') }}"
                                                                v-model="map.reporters[i].contact"></drop-field>
                                                    <drop-field caption="{{ _('Reporter relationship') }}"
                                                                v-model="map.reporters[i].relationship"></drop-field>
                                                    <v-btn v-if="i==map.reporters.length-1" small fab
                                                           text
                                                           @click="map.reporters.push({})">
                                                        <v-icon small color="green lighten-2">mdi-plus
                                                        </v-icon>
                                                    </v-btn>
                                                    <v-btn v-if="i==map.reporters.length-1 && map.reporters.length !=1"
                                                           small fab text
                                                           @click="map.reporters.splice(i,1)">
                                                        <v-icon small color="red lighten-2">mdi-minus
                                                        </v-icon>
                                                    </v-btn>
                                                </v-sheet>

                                            </v-row>

                                            <v-row>
                                                <drop-field v-model="map.identified_by"
                                                            caption="{{ _('Identified by') }}"></drop-field>
                                                <drop-field v-model="map.family_notified"
                                                            caption="{{ _('Family Notified') }}"></drop-field>
                                                <drop-field v-model="map.reburial_location"
                                                            caption="{{ _('Location of reburial') }}"></drop-field>

                                            </v-row>
                                        </v-card>
                                    </v-row>

                                    <v-row>
                                        <div class="text-subtitle-2">
                                            {{ _('Events') }}
                                        </div>

                                        <v-sheet class="pa-3 my-2 d-flex flex-wrap align-center"
                                                 outlined
                                                 v-for="(event,i) in map.events" :key="i">
                                            <drop-field caption="{{ _('Title') }}"
                                                        v-model="map.events[i].title"></drop-field>

                                            <v-sheet class="d-flex align-center">

                                                <drop-field v-if="dynamicEtype"
                                                            caption="{{ _('Event Type') }}"
                                                            v-model="map.events[i].dtype"></drop-field>

                                                <v-sheet v-if="!dynamicEtype" class="d-flex align-center ma-2 pa-2" elevation="0">
                                                    <h5 class="text-caption mr-1">{{ _('Event Type') }}</h5>
                                                    <v-select
                                                        class="mt-5"
                                                        density="compact"
                                                        :items="eventtypes"
                                                        item-title="title"
                                                        item-value="title"
                                                        v-model="map.events[i].type">
                                                    </v-select>
                                                </v-sheet>
                                                

                                                <v-icon @click="switchEtype" x-small
                                                        color="primary">mdi-swap-horizontal
                                                </v-icon>

                                            </v-sheet>

                                            <drop-field caption="{{ _('Comments') }}"
                                                        v-model="map.events[i].comments"></drop-field>
                                            <drop-field caption="{{ _('Location') }}"
                                                        v-model="map.events[i].location"></drop-field>


                                            <drop-field caption="{{ _('From') }}"
                                                        v-model="map.events[i].from_date"></drop-field>
                                            <drop-field caption="{{ _('To') }}"
                                                        v-model="map.events[i].to_date"></drop-field>
                                            <drop-field caption="{{ _('Estimated Time') }}"
                                                        v-model="map.events[i].estimated"></drop-field>

                                            <v-btn icon="mdi-plus" color="success" size="small"
                                                   v-if="i==map.events.length-1" variant="text"
                                                   @click="map.events.push({})">
                                            </v-btn>
                                            <v-btn variant="text" icon="mdi-minus" color="error" size="small"
                                                   v-if="i==map.events.length-1 && map.events.length !=1"

                                                   @click="map.events.splice(i,1)">

                                            </v-btn>
                                        </v-sheet>
                                    </v-row>
                                </v-sheet>
                            </v-col>
                        </v-row>
                    </v-card>

                </v-stepper-window-item>

                <v-stepper-window-item value="3">
                    <v-card class="pa-5" elevation="0">

                        <v-card-text>
                            <v-list color="yellow lighten-4" density="compact">
                                <v-list-item> {{ _('Sheet file:') }}
                                    <v-chip small dark class="mx-2"
                                            color="green">{{ _('Selected') }}
                                        <v-icon right>mdi-check</v-icon>
                                    </v-chip>
                                </v-list-item>
                                <v-list-item> {{ _('Map:') }}
                                    <v-tooltip location="top">
                                        <template v-slot:activator="{props}">
                                            <v-chip v-bind="props" small dark class="mx-2"
                                                    color="green">{{ _('Selected') }}
                                                <v-icon right>mdi-check</v-icon>
                                            </v-chip>
                                        </template>
                                        <span>
                                            ${this.selectedMap}
                                        </span>
                                    </v-tooltip>


                                </v-list-item>

                            </v-list>
                        </v-card-text>

                        <v-card-title>
                            {{ _('Optional: Upload more sheets to process') }}
                        </v-card-title>

                        <v-card-text class="overflow-y-auto" style="max-height: 45vh">

                            <vue-dropzone ref="extradropzone" id="dropzone" class="ma-auto"
                                          :options="dzMoreOpts"
                                          @vdropzone-error="showError"
                                          @vdropzone-removed-file="fileRemoveHandler"
                                          @vdropzone-success="extraUploadSuccess"></vue-dropzone>

                            <search-field
                                    api="/admin/api/roles/"
                                    item-title="name"
                                    item-value="id"
                                    :multiple="true"
                                    label="{{ _('Access Roles') }}"
                                    v-model="roles"
                                    class="mt-4"
                            ></search-field>
                        </v-card-text>
                    </v-card>
                </v-stepper-window-item>


                <v-stepper-window-item value="4">
                    <v-card class="pa-5" elevation="0">
                        <v-card-text>
                            <v-empty-state :icon="processResult?.type === 'error' ? 'mdi-alert-circle' : 'mdi-check-circle'">
                                <template v-slot:headline>
                                    <div class="text-h5">
                                        ${processResult?.title}
                                    </div>
                                </template>
                        
                                <template v-slot:text>
                                    <div class="text-medium-emphasis text-caption">
                                        ${processResult?.description}
                                    </div>
                                </template>
                            </v-empty-state>
                        </v-card-text>
                    </v-card>
                </v-stepper-window-item>
            </v-stepper-window>
        </v-stepper>


    </v-main>


    <v-overlay v-model="loading">

    </v-overlay>



{% endblock %}
{% block outside %}
    <div class="d-none" data-allowed-sheets-types='.{{ ",.".join(config.SHEETS_ALLOWED_EXTENSIONS) }}'></div>
{% endblock %}
{% block js %}


    <script src="/static/js/components/VueDropzone.js"></script>



    <script src="/static/js/Sortable.min.js"></script>
    <script src="/static/js/vuedraggable.umd.js"></script>
    <script src="/static/js/components/DropField.js"></script>
    <script src="/static/js/components/SearchField.js"></script>

    <script nonce="{{ csp_nonce() }}">

        const draggable = vuedraggable;
        const allowedSheetsTypes = document.querySelector('[data-allowed-sheets-types]').dataset.allowedSheetsTypes;

        const {createApp} = Vue;
        const {createVuetify} = Vuetify;
        const vuetify = createVuetify(vuetifyConfig);

        const app = createApp({
            delimiters: delimiters,
            mixins: [globalMixin],

            data: () => ({
                translations: window.translations,
                drawer: drawer,
                mode: null,
                loading: false,
                processResult: {},
                batch_id: '',
                firstAction: 0,

                dzOpts: {
                    url: '/import/api/csv/upload',
                    // accept any file
                    acceptedFiles: allowedSheetsTypes,
                    addRemoveLinks: true,
                    thumbnailWidth: 80, // px
                    thumbnailHeight: 80,
                    maxFiles: 1,
                    maxFilesize: mediaUploadMaxFileSize
                },
                dzMoreOpts: {
                    url: '/import/api/csv/upload',
                    // accept any file
                    acceptedFiles: allowedSheetsTypes,
                    addRemoveLinks: true,
                    thumbnailWidth: 80, // px
                    thumbnailHeight: 80,
                    maxFiles: null,
                    maxFilesize: mediaUploadMaxFileSize
                },

                lang: 'en',

                structure: null,
                fields: null,

                processDisabled: false,

                controlOnStart: true,
                
                dynamicAtype: true,

                eventtypes: [],
                idNumberTypes: [],
                dynamicEtype: true,


                maps: null,
                map: {
                    events: [{}],
                    id_number: [{}],
                    reporters: [{}],
                    description: [{}]
                },
                defaultMap: {
                    events: [{}],
                    id_number: [{}],
                    reporters: [{}],
                    description: [{}]
                },
                // dedicate another separate map for validation
                vmap: {},

                backup: [],

                mapName: "{{ _('New Map')}}",
                mapid: null,
                selectedMap: null,


                step: "1",

                sheets: [],
                selectedSheet: null,

                ffilter: null,
                files: [],
                extra: [],
                roles: [],
                options: {
                    page: 1,
                    itemsPerPage: 100
                },

                headers: [
                    {text: "{{_('Name')}}", value: 'file.name', sortable: false},


                ],
                itemsLength: 100,
                editedIndex: -1,


                log: []

            }),

            mounted() {
                this.loadMaps();
                this.loadEtypes();
                this.fetchIdNumberTypes();


            },

            computed: {
                allFiles() {
                    return this.files.concat(this.extra);
                },
                filteredFields() {
                    if (!this.ffilter) return this.fields

                    return this.fields.filter(x => x.toLowerCase().includes(this.ffilter.toLowerCase()))
                },
                nextButtonProps() {
                    const commonProps = { text: 'Next', 'append-icon': 'mdi-chevron-right', color: 'primary' }
                    switch (this.step) {
                        case '1':{
                            const isFileSelected = this.structure
                            const isExistingMap = this.selectedMap
                            const isEnabled = isFileSelected || isExistingMap
                            return { ...commonProps, disabled: !isEnabled, onclick: () => this.step = '2' }
                        }
                        case '2':
                            return { ...commonProps, disabled: !this.isMapPopulated, onclick: () => { this.selectedMap = this.map; this.step = '3'; } }
                        case '3':
                            return { ...commonProps, disabled: this.processDisabled, text: 'Process File(s)', onclick: () => {this.step = '4'; this.process();} }
                        case '4':
                            return { ...commonProps, text: 'Check import progress', disabled: this.processResult?.type !== 'success', href: `/import/log/?batch_id=${this.batch_id}` }
                        default:
                            return commonProps
                    }
                },
                prevButtonProps() {
                    const commonProps = { text: 'Previous', 'prepend-icon': 'mdi-chevron-left', variant: 'tonal' }
                    switch (this.step) {
                        case '1':
                            return { ...commonProps, disabled: true }
                        case '2':
                            return { ...commonProps, onclick: () => this.step = '1' }
                        case '3':
                            return { ...commonProps, onclick: () => this.step = '2' }
                        case '4':
                            return { ...commonProps, disabled: true }
                        default:
                            return commonProps
                    }
                },
                isMapPopulated() {
                    return Object.values(this.map).some((value) => {
                        // Case 1: direct string
                        if (typeof value === "string") {
                            return value.trim() !== "";
                        }

                        // Case 2: direct number or boolean
                        if (typeof value === "number" || typeof value === "boolean") {
                            return true; // counts as data
                        }

                        // Case 3: array
                        if (Array.isArray(value)) {
                            return value.some((item) => {
                                if (typeof item === "string") {
                                    return item.trim() !== "";
                                }
                                if (typeof item === "number" || typeof item === "boolean") {
                                    return true;
                                }
                                if (typeof item === "object" && item !== null) {
                                    return Object.values(item).some(
                                        (val) =>
                                            (typeof val === "string" ? val.trim() !== "" : val != null)
                                    );
                                }
                                return item != null;
                            });
                        }

                        // Case 4: object (non-null)
                        if (typeof value === "object" && value !== null) {
                            return Object.values(value).some(
                                (val) =>
                                    (typeof val === "string" ? val.trim() !== "" : val != null)
                            );
                        }

                        return false;
                    });
                    
                }
            },


            watch: {

                items(val) {
                    if (val.length) {
                        this.selAllDisabled = false;
                    } else {
                        this.selAllDisabled = true;
                    }

                },


            },


            methods: {
                setIdEntityOnDrop(evt, idNumber) {
                    // If drop field has no value exit
                    if (!evt.length) return
                    if (idNumber?.type) return

                    idNumber.type = this.idNumberTypes.find(Boolean).id.toString()
                },

                showError(err, message) {
                    this.showSnack(message);
                },

                fileRemoveHandler(file, error, xhr) {
                    if (!error) {
                        // pop out that specific removed file
                        this.extra = this.extra.filter(x =>
                            x.uuid !== file.upload.uuid
                        );
                    }
                },

                extraUploadSuccess(dzfile) {
                    // pick file from dropzone files list
                    const file = findUploadedFileByUUID(this.$refs.extradropzone.dz.getAcceptedFiles(), dzfile.upload.uuid);

                    this.extra.push(file);
                },

                uploadSuccess(dzfile) {
                    // pick file from dropzone files list
                    const file = findUploadedFileByUUID(this.$refs.dropzone.dz.getAcceptedFiles(), dzfile.upload.uuid);

                    this.files.push(file);

                    const ext = file.filename.split('.').at(-1);

                    if (ext === 'csv') {

                        api.post('/import/api/csv/analyze', {file: file}).then(res => {
                            this.resetFields();
                            this.structure = res.data;
                            this.fields = this.structure.columns;
                            this.backup = this.fields.slice();
                            // since we are mapping, make sure selectedMap is not populated
                            this.selectedMap = null;
                            this.step = "2";
                        }).catch(
                            err => {
                                console.log(err.response.data)
                            }
                        ).finally(
                            () => {

                            }
                        );
                    } else if (ext === 'xls' || ext === 'xlsx') {
                        api.post('/import/api/xls/sheets', {file: file}).then(res => {
                            this.sheets = res?.data?.data ?? [];
                        }).catch(
                            err => {
                                console.log(err.response.data)
                            }
                        ).finally(
                            () => {

                            }
                        );
                    }

                },

                removeFile(dzfile) {
                    this.sheets = [];
                    this.backup = [];
                    this.structure = null;
                    this.fields = null;
                    this.selectedSheet = null;
                    this.map = deepClone(this.defaultMap);
                    this.mapName = "{{ _('New Map')}}";
                    this.mapid = null;
                    this.vmap = {};
                    this.files = [];
                },

                sheetSelected() {
                    api.post('/import/api/xls/analyze', {
                        file: this.files[0],
                        sheet: this.selectedSheet
                    }).then(res => {
                        this.resetFields();
                        this.structure = res.data;
                        this.fields = this.structure.columns;
                        this.backup = this.fields.slice();
                        // since we are mapping, make sure selectedMap is not populated
                        this.selectedMap = null;
                        this.step = "2";
                    }).catch(
                        err => {
                            console.log(err.response.data)
                        }
                    );
                },

                returnToStack(item) {
                    if (!item || !Array.isArray(item) || item.length === 0) return;

                    let field = item.pop();
                    this.fields.indexOf(field) === -1 ? this.fields.unshift(field) : console.log("This item already exists");

                },

                switchAtype() {
                    if (this.map.dtype?.length && this.dynamicAtype) {
                        this.returnToStack(this.map.dtype);
                    }
                    if (!this.dynamicAtype) {
                        this.map.type = null;
                    }
                    this.dynamicAtype = !this.dynamicAtype;
                },

                switchEtype() {
                    // use dtype as a way to identify the mode of import
                    if (this.dynamicEtype) {
                        for (const ev of this.map.events) {
                            if (ev.dtype?.length){
                                this.returnToStack(ev.dtype);
                            }   
                        }
                    } else {
                        for (const ev of this.map.events) {
                            if (ev.type){
                                ev.type = null;
                            }   
                        }
                    }
                    this.dynamicEtype = !this.dynamicEtype;
                },

                confirmResetFields() {
                    if (confirm("{{ _('Are you sure you want to reset this mapping?')}}")) {
                        this.resetFields();
                    }
                },
                resetFields() {
                    this.fields = this.backup;
                    // hack to bypass js passing vars by reference
                    this.map = deepClone(this.defaultMap);
                    this.mapName = "{{ _('New Map')}}";
                    this.mapid = null;
                    this.vmap = {};
                },


                clone(name) {

                    return name;
                },
                customPull() {

                    return this.controlOnStart ? "clone" : true;
                },
                start({originalEvent}) {
                    this.controlOnStart = originalEvent.ctrlKey;
                },


                process() {
                    const files = this.allFiles.map(x => x.filename);

                    // add countries to actor config
                    let config = translations;

                    const nextMap = {
                        ...this.map,
                        id_number: this.map.id_number.filter(idEntry => idEntry.type && idEntry.number) 
                    }

                    api.post('/import/api/process-sheet', {
                        map: this.map,
                        vmap: this.vmap,
                        sheet: this.selectedSheet,
                        roles: this.roles,
                        target: 'actor',
                        lang: this.lang,
                        files: files,
                        actorConfig: config
                    }).then(res => {
                        this.processResult = {
                            title: "{{ _('Success') }}",
                            description: "{{ _('Rows from file were added to queue successfully and will be imported in turn.') }}",
                            type: 'success'
                        };
                        console.log(res.data);
                        this.batch_id = res.data.data;
                    }).catch(err => {
                        console.log(err.response.data);
                        this.processResult = {
                            title: "{{ _('Error') }}",
                            description: "{{ _('Error importing rows. Check logs for more information.') }}",
                            type: 'error'
                        };
                    }).finally(() => {
                        // any cleanup if needed
                    });

                },


                loadMap(m) {
                    if (m) {
                        this.map = deepClone(m.data.map);
                        this.mapid = m.id;
                        this.mapName = m.name;
                        this.vmap = deepClone(m.data.vmap);
                    }


                },

                loadMaps() {

                    api.get('/import/api/mappings/').then(
                        res => {
                            this.maps = res?.data?.data ?? [];
                        }
                    ).catch(err => {
                        console.log(err.response.data);
                    }).finally(
                        () => {

                        }
                    )

                },

                loadEtypes() {
                    api.get('/admin/api/eventtypes/').then(res => {

                        this.eventtypes = res.data.items.filter(x => x.title);
                    })
                },

                fetchIdNumberTypes() {
                    axios.get('/admin/api/idnumbertypes/').then(res => {
                        // normalize id to be string
                        const numberTypes = res.data.items || []
                        const normalizedNumberTypes = numberTypes.map(numberType => ({ ...numberType, id: numberType.id.toString() }))

                        this.idNumberTypes = normalizedNumberTypes;
                    }).catch(err => {
                        this.idNumberTypes = [];
                        console.error('Error fetching id number types:', err);
                        this.showSnack(handleRequestError(err));
                    })
                },

                selectMap(m) {
                    this.loadMap(m);
                    this.selectedMap = m.data;
                    this.mapName = m.name;
                },


                removeMe(i) {
                    let field = this.fields.splice(i, 1);
                },

                deleteMap() {
                    if (!this.mapid) return
                    if (!confirm("{{ _('Are you sure you want to delete this mapping?')}}")) return
                    
                    const backupMaps = [...this.maps]; // Backup
                    const backupMapId = this.mapid; // Backup
                    const backupSelectedMap = this.maps.find(map => map.id === this.mapid); // Backup

                    console.log(this.map, this.vmap)

                    // Optimistic update
                    this.maps = this.maps.filter(map => map.id !== this.mapid);
                    const deleteMapId = this.mapid;
                    this.selectedMap = null;
                    this.mapid = null
                    this.resetFields();

                    api.delete(`/import/api/mapping/${deleteMapId}`)
                        .then(res => {
                            this.showSnack(res.data.message || res.data);
                        }).catch(err => {
                            // Revert on error
                            this.maps = backupMaps;
                            this.mapid = backupMapId;
                            this.loadMap(backupSelectedMap)
                            this.showSnack('Delete mapping failed');
                            console.log(err.response);
                        });
                },
                updateMap() {
                    const payload = {
                        name: this.mapName,
                        data: {
                            map: this.map,
                            vmap: this.vmap
                        }
                    }
                    if (!this.mapid) return
                    // update existing map
                    api.put(`/import/api/mapping/${this.mapid}`, payload).then(res => {
                        this.showSnack(res.data.message);
                        const updatedMap = deepClone({ ...payload, id: res.data.id })
                        const map = this.maps.find(map => map.id === updatedMap.id);
                        if (map) Object.assign(map, updatedMap);
                    }).catch(err => {
                        console.log(err.response);
                    });
                },
                createMap() {
                    const payload = {
                        name: this.mapName,
                        data: {
                            map: this.map,
                            vmap: this.vmap
                        }
                    }
                    //create new
                    api.post('/import/api/mapping/', payload).then(res => {
                        this.showSnack(res.data.message);
                        this.mapid = res.data.id;
                        const nextMap = deepClone({ ...payload, id: res.data.id })
                        this.maps.push(nextMap);
                        this.selectMap(nextMap);
                    }).catch(err => {
                        console.log(err.response);
                    });
                },

                processStarted() {
                    this.processDisabled = true;
                }
                ,
                onExtraFilesUploaded(error, file) {

                    if (!error) {
                        this.processDisabled = false;

                    }

                }
                ,

                onFileUploaded(error, file) {

                    if (!error) {

                        //file uploaded, analyse server side and proceed if ok

                        const ext = this.files[0].fileExtension;
                        if (ext == 'csv') {

                            api.post('/import/api/csv/analyze', {file: JSON.parse(this.files[0].serverId)}).then(res => {
                                this.structure = res.data;
                                this.fields = this.structure.columns;
                                this.backup = this.fields.slice();
                                // since we are mapping, make sure selectedMap is not populated
                                this.selectedMap = null;
                                this.step = "2";
                            }).catch(
                                err => {
                                    console.log(err.response.data)
                                }
                            ).finally(
                                () => {

                                }
                            );
                        } else if (ext == 'xls' || ext == 'xlsx') {
                            api.post('/import/api/xls/sheets', {file: JSON.parse(this.files[0].serverId)}).then(res => {
                                this.sheets = res.data;
                            }).catch(
                                err => {
                                    console.log(err.response.data)
                                }
                            ).finally(
                                () => {

                                }
                            );
                        }


                    }


                },

            }
        });

        app.component('VueDropzone', VueDropzone);
        app.component('SearchField', SearchField);
        app.component('DropField', DropField);
        app.component('Draggable', draggable);


        app.use(vuetify).mount('#app');
        window.app = app;
    </script>
{% endblock %}
