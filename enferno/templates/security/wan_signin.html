{# This template receives the following pieces of context in addition to the form: #} {% extends
"login-layout.html" %} {% from "security/_macros.html" import render_field_with_errors,
render_field, render_field_errors, prop_next %} {% block navbar %} {% endblock %} {% block head_js
%} {{ super() }}
<script
  src="{{ url_for('.static', filename='js/webauthn.js') }}"
  xmlns="http://www.w3.org/1999/html"
></script>
<script src="{{ url_for('.static', filename='js/base64.js') }}"></script>
{% endblock %} {% block content %} {% include "security/_messages.html" %}

<v-main class="d-flex flex-column align-center justify-center bg-background">
  <v-card class="mx-auto pa-8 w-100" rounded="lg" style="max-width: 424px">
    {% if is_secondary %}
    <v-card-title class="text-h4 text-center font-weight-bold px-0 pb-0">{{ _("Security key") }}</v-card-title>
    <v-card-subtitle class="text-subtitle-2 text-pre-wrap text-center px-0 pb-4">${passkeyMessage}</v-card-subtitle>
    {% endif %} {% if not credential_options %}
    <form
      action="{{ url_for_security('wan_signin') }}{{ prop_next() }}"
      method="post"
      name="wan_signin_form"
      id="wan-signin-form"
    >
      {{ wan_signin_form.hidden_tag() }} {% if not is_secondary %} {{
      render_field_with_errors(wan_signin_form.identity) }} {{
      render_field_with_errors(wan_signin_form.remember) }} {% endif %} {{
      render_field_errors(wan_signin_form.credential) }}

      <v-card-actions class="pa-0 d-flex flex-column ga-2">
        <v-btn color="primary" type="submit" block prepend-icon="mdi-usb-flash-drive">
          {{ _('Authenticate')}}</v-btn
        >
      </v-card-actions>
    </form>
    {% else %}
    <form
      action="{{ url_for_security('wan_signin_response', token=wan_state) }}{{ prop_next() }}"
      method="post"
      name="wan_signin_response_form"
      id="wan-signin-response-form"
    >
      {{ wan_signin_response_form.hidden_tag() }} {{ render_field_errors(wan_signin_form.remember)
      }} {# the following is important even though it is hidden - some browsers require an input
      focus field (such as Safari) #} {{ render_field(wan_signin_response_form.credential) }}
      <v-card-text class="px-0 pt-0">
        <v-alert v-if="wanErrors" color="error" variant="tonal">${wanErrors}</v-alert>
      </v-card-text>

      <v-card-actions class="pa-0 d-block">
        <v-btn
          v-if="isTryAgainVisible"
          color="primary"
          variant="outlined"
          type="button"
          @click="reloadPage"
          prepend-icon="mdi-reload"
          block
          class="mb-2"
          >{{ _('Try again')}}</v-btn
        >
        <v-btn class="ma-0" variant="outlined" block href="{{ url_for_security('mf_recovery') }}" prepend-icon="mdi-lifebuoy"
          >{{ _('Recovery Code')}}</v-btn
        >
      </v-card-actions>
    </form>
    {% endif %}
  </v-card>

  <div class="mt-6 w-100 d-flex justify-space-between" style="max-width: 424px">
    <v-btn
      href="{{ url_for_security('tf_select') }}{{ prop_next() }}"
      color="primary"
      variant="outlined"
      prepend-icon="mdi-chevron-left"
      >{{ _('Back') }}</v-btn
    >
    <v-btn href="{{ url_for_security('login') }}" color="error" variant="outlined"
      >{{ _('Log out') }}</v-btn
    >
  </div>
</v-main>

{% endblock content %} {% block js %}
<script>
  const { createApp } = Vue;
  const { createVuetify } = Vuetify;

  const vuetify = createVuetify(vuetifyConfig);

  const app = createApp({
      delimiters: delimiters,
      data: () => ({
          isTryAgainVisible: false,
          wanErrors: null,
      }),
      computed: {
          passkeyMessage() {
              return `{{ _('Use a saved passkey for {host}') }}`.replace('{host}', window.location.host);
          }
      },
      mounted() {
          {% if credential_options %}
              this.initWanSignIn('{{ credential_options|safe }}');
          {% else %}
              this.autoSubmitWanSignInForm();
          {% endif %}
      },
      methods: {
          autoSubmitWanSignInForm() {
              this.$nextTick(() => {
                document.forms["wan-signin-form"]?.submit?.();
              });
          },
          reloadPage() {
              window.location.reload();
          },
          initWanSignIn() {
              handleSignin('{{ credential_options|safe }}')
                  .then((result) => {
                      if (result.error_msg) {
                          const auth_failed_msg = `{{ _("Authentication was canceled or timed out.") }}`
                          this.isTryAgainVisible = true;
                          this.wanErrors = result.error_msg.includes('timed out') ? auth_failed_msg : result.error_msg;
                      } else {
                          document.getElementById("credential").value = result.credential;
                          document.forms["wan-signin-response-form"].submit();
                      }
                  });
          }
      }
  });

  app.use(vuetify).mount('#app');
</script>
{% endblock %}
