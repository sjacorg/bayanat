{% extends 'layout.html' %} {% block css %} {% endblock %} {% block content %}

<!-- Field Creation Modal -->
<field-builder-drawer :model-value="isFieldBuilderDrawerOpen" @update:model-value="closeDrawer" @save="saveField" :item="editedItem" entityType="bulletin"></field-builder-drawer>

<v-main>
  <v-container fluid>
    <v-card style="height: calc(100vh - 100px)">
      <v-toolbar class="flex-md-column">
        <v-toolbar-title>{{ _('Bulletin Fields Configuration') }}</v-toolbar-title>

        <template #append>
          <v-text-field
            density="compact"
            class="mr-2"
            placeholder="{{ _('Search') }}"
            prepend-inner-icon="mdi-magnify"
            max-width="300px"
            width="200px"
            hide-details
          ></v-text-field>
          <v-btn
            prepend-icon="mdi-plus"
            class="mr-2"
            variant="outlined"
            @click="isFieldBuilderDrawerOpen = true"
            >{{ _('Add new field') }}</v-btn
          >
          <v-btn @click="save()" prepend-icon="mdi-check" class="mr-4" color="primary" variant="flat" :loading="loading"
            >{{ _('Save changes') }}</v-btn
          >
        </template>
      </v-toolbar>

      <v-card-text class="d-flex flex-column ga-4 overflow-y-scroll" style="height: calc(100vh - 165px);">
        <span class="text-h6 font-weight-bold">Core fields</span>
        <draggable
          v-model="coreFields"
          :item-key="'id'"
          tag="v-row"
          handle=".drag-handle"
          @end="onDragEnd"
        >
          <template #item="{ element: field }">
            <v-col cols="12">
              <v-row>
                <v-col cols="12" lg="6">
                  <field-list-item
                    :field="mapFieldToComponent(field)"
                    @edit="edit"
                    @toggle-visibility="toggleFieldVisibility"
                    @delete="deleteField"
                  />
                </v-col>
              </v-row>
            </v-col>
          </template>
        </draggable>
      </v-card-text>
    </v-card>
  </v-container>
</v-main>

{% endblock %} {% block outside %} {% endblock %} {% block js %}
<script src="/static/js/tinymce/js/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
<script src="/static/js/tinymce-vue.min.js"></script>

<script src="/static/js/components/FieldListItem.js"></script>
<script src="/static/js/components/FieldBuilderDrawer.js"></script>
<script src="/static/js/components/PopDateField.js"></script>
<script src="/static/js/components/PopDateTimeField.js"></script>
<script src="/static/js/components/PopDateRangeField.js"></script>

<script src="/static/js/Sortable.min.js"></script>
<script src="/static/js/vuedraggable.umd.js"></script>

<script>
    const { createApp } = Vue;
    const { createVuetify } = Vuetify;
    const vuetify = createVuetify(vuetifyConfig);

    const app = createApp({
      delimiters: delimiters,
      mixins: [globalMixin],
      data: () => ({
        tinyConfig: tinyConfig,
        drawer: drawer,
        isFieldBuilderDrawerOpen: false,
        editedItem: {},
        coreFields: [
          {
            id: 101,
            name: 'title',
            title: 'Original Title',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input',
            schema_config: { required: true, max_length: 255 },
            ui_config: { sort_order: 1, help_text: 'Original title of the bulletin' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 102,
            name: 'sjac_title',
            title: 'Title',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input',
            schema_config: { required: false, max_length: 255 },
            ui_config: { sort_order: 2, help_text: 'Alternate or translated title' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 103,
            name: 'tags',
            title: 'Tags',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input', // v-combobox maps to input/multi input
            schema_config: { required: false },
            ui_config: { sort_order: 3, help_text: 'Tag the bulletin for search/filtering' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 104,
            name: 'sources',
            title: 'Sources',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input', // search-field mapped as custom input
            schema_config: { required: false },
            ui_config: { sort_order: 4, help_text: 'Linked sources for this bulletin' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 1025,
            name: 'description',
            title: 'Description',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'editor',
            schema_config: { required: false },
            ui_config: { sort_order: 5, help_text: 'Tag with general labels' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 105,
            name: 'labels',
            title: 'Labels',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input',
            schema_config: { required: false },
            ui_config: { sort_order: 5, help_text: 'Tag with general labels' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 106,
            name: 'verLabels',
            title: 'Verified Labels',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input',
            schema_config: { required: false },
            ui_config: { sort_order: 6, help_text: 'Use labels verified by the team' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 107,
            name: 'locations',
            title: 'Locations',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input',
            schema_config: { required: false },
            ui_config: { sort_order: 7, help_text: 'Affected locations' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 108,
            name: 'source_link',
            title: 'Source Link',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'input',
            schema_config: { required: false, max_length: 255 },
            ui_config: { sort_order: 8, help_text: 'Link to original source' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 109,
            name: 'source_link_na',
            title: 'Source Not Available',
            entity_type: 'bulletin',
            field_type: 'boolean',
            ui_component: 'checkbox',
            schema_config: { required: false },
            ui_config: { sort_order: 9, help_text: 'Check if source is not available' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 110,
            name: 'source_link_type',
            title: 'Source Link Private',
            entity_type: 'bulletin',
            field_type: 'boolean',
            ui_component: 'switch',
            schema_config: { required: false },
            ui_config: { sort_order: 10, help_text: 'Toggle to keep source private' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 111,
            name: 'publish_date',
            title: 'Publish Date',
            entity_type: 'bulletin',
            field_type: 'datetime',
            ui_component: 'date',
            schema_config: { required: false },
            ui_config: { sort_order: 11, help_text: 'When should this be published?' },
            validation_config: { format: 'YYYY-MM-DD' },
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 112,
            name: 'documentation_date',
            title: 'Documentation Date',
            entity_type: 'bulletin',
            field_type: 'datetime',
            ui_component: 'date',
            schema_config: { required: false },
            ui_config: { sort_order: 12, help_text: 'When was this documented?' },
            validation_config: { format: 'YYYY-MM-DD' },
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 113,
            name: 'comments',
            title: 'Comments',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'textarea',
            schema_config: { required: true },
            ui_config: { sort_order: 13, help_text: 'Add reviewer or system comments' },
            validation_config: {},
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          },
          {
            id: 114,
            name: 'status',
            title: 'Status',
            entity_type: 'bulletin',
            field_type: 'string',
            ui_component: 'dropdown',
            options: [{label: 'Draft', value: 'draft'}, { label: 'Published', value: 'published' }, {label: 'Archived', value: 'archived'}],
            schema_config: { required: false },
            ui_config: { sort_order: 14, help_text: 'Bulletin status' },
            validation_config: { allowed_values: ['Draft', 'Published', 'Archived'] },
            active: true,
            created_at: '2025-01-01T00:00:00Z'
          }
        ]
  ,
        searchQuery: '',
        loading: false,
      }),
      mounted() {
        this.fetchDynamicFields();
      },
      methods: {
        edit(field) {
          const matchingField = this.coreFields.find(coreField => coreField.id === Number(field.fieldId))
          this.editedItem = matchingField;
          this.isFieldBuilderDrawerOpen = true;
        },
        saveField(evt) {
          const index = this.coreFields.findIndex(coreField => coreField.id === evt.id)

          if (index !== -1) {
            // Update existing field
            this.coreFields[index] = { ...evt } // or use Object.assign if you want to preserve the reference
          } else {
            // Add new field
            this.coreFields.push(evt)
          }
        },
        save() {
          this.loading = true;
          setTimeout(() => {
            this.loading = false;
          }, 1000);
        },
        async fetchDynamicFields() {
          try {
            return await axios.get('/admin/api/dynamic-fields');
          } catch (err) {
            console.error(err);
            this.showSnack(handleRequestError(err));
          }
        },
        mapFieldToComponent(coreField) {
          const baseProps = {
            fieldId: coreField.id.toString(),
            label: coreField.title,
            name: coreField.name,
            variant: 'filled',
            disabled: !coreField.active,
            hint: coreField?.ui_config?.help_text,
          };

          const componentMap = {
            input: { component: 'v-text-field', ...baseProps },
            dropdown: { component: 'v-select', ...baseProps, items: coreField.options, multiple: coreField.field_type === 'array' },
            textarea: { component: 'v-textarea', ...baseProps },
            checkbox: { component: 'v-checkbox', ...baseProps },
            switch: { component: 'v-switch', ...baseProps },
            date: { component: 'pop-date-time-field' },
            editor: { component: 'tinymce-editor', init: tinyConfig, disabled: !coreField.active, fieldId: coreField.id.toString() },
          };

          const config = componentMap[coreField.ui_component];
          if (!config) return null;

          return config;
        },
        onDragEnd() {
          this.reindexFields()
        },
        reindexFields() {
          this.coreFields = this.coreFields.map((field, index) => ({ ...field, ui_config: { ...field.ui_config, sort_order: index+1 } }))
        },
        async deleteField(field) {
          if (confirm('{{ _('Are you sure?') }}')) {
            try {
              this.coreFields = this.coreFields.filter(coreField => Number(coreField.id) !== Number(field.fieldId))
              // return await axios.delete(`/admin/api/dynamic-fields/${field.fieldId}`);
            } catch (err) {
              console.error(err);
              this.showSnack(handleRequestError(err));
            }
          }
        },
        async toggleFieldVisibility(field) {
          try {
            const matchingField = this.coreFields.find(coreField => coreField.id === Number(field.fieldId))
            matchingField.active = !matchingField.active
            // return await axios.put(`/admin/api/dynamic-fields/${field.fieldId}`, {
            //   ...matchingField,
            //   active: !matchingField.active
            // });
          } catch (err) {
            console.error(err);
            this.showSnack(handleRequestError(err));
          }
        },
        closeDrawer(open) {
          this.isFieldBuilderDrawerOpen = open;

          if (!open) {
            this.editedItem = {}
          }
        }
      },
    });

    app.component('FieldListItem', FieldListItem);
    app.component('FieldBuilderDrawer', FieldBuilderDrawer);
    app.component('draggable', vuedraggable);
    app.component('tinymce-editor', Editor);
    app.component('PopDateField', PopDateField);
    app.component('PopDateRangeField', PopDateRangeField);
    app.component('PopDateTimeField', PopDateTimeField);

    app.use(router);
    app.use(vuetify).mount('#app');

    window.app = app;
</script>
{% endblock %}
