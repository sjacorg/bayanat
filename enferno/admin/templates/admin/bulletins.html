{% extends 'layout.html' %} {% block css %}

    <link rel="stylesheet" href="/static/js/dropzone/vue2Dropzone.min.css"/>
    <link rel="stylesheet" href="/static/js/dropzone/basic.css"/>

{% endblock %} {% block content %}

    <div id="app">
        <v-app id="bulletins" v-cloak>
            {% include 'nav-drawer.html' %} {% include 'nav-bar.html' %} {% include
    'admin/partials/bulletin_drawer.html' %} {% include
    'admin/partials/bulk_bulletin_drawer.html' %}

            {% include
    'admin/partials/export_drawer.html' %}
            <v-main>
                {% include 'admin/partials/bulletin_advsearch.html' %}
                <v-container class="container--fluid">

                    <v-card>
                        <v-card-title>
                            <div class="flex-grow-1"></div>
                        </v-card-title>
                        <v-card-text>


                            <v-data-table
                                    fixed-header
                                    height="calc(100vh - 355px)"
                                    id="bulletins-dt"
                                    v-model="selected"
                                    :headers="headers"
                                    @click:row="rowClick"
                                    show-select
                                    :items="items"
                                    :options.sync="options"
                                    :footer-props.sync="footerProps"
                                    :loading="loading"
                                    :server-items-length="itemsLength"
                                    class="elevation-1"
                                    :item-class="rowClass"
                                    @toggle-select-all="selectAllRestrict"
                            >

                                <template v-slot:item.data-table-select="{ item, isSelected, select }">
                                    <v-simple-checkbox
                                            :value="isSelected"
                                            :readonly="item.restricted"
                                            v-if="!item.restricted"

                                            @input="select($event)"
                                    ></v-simple-checkbox>
                                </template>
                                <template v-slot:top>
                                    <v-toolbar flat color="white">

                                        <v-btn class="hidden-sm-and-down" small @click="allBulletins" text
                                        >{{ _('All Bulletins') }}</v-btn
                                        >
                                        <v-divider class="mx-2 hidden-sm-and-down" inset vertical></v-divider>
                                        <v-btn class="hidden-sm-and-down" small @click="myAssigned" text
                                        >{{ _('Assigned to me') }}</v-btn
                                        >
                                        <v-divider class="mx-2 hidden-sm-and-down" inset vertical></v-divider>
                                        <v-btn small @click="myReview" class="mr-2 hidden-sm-and-down" text
                                        >{{ _('My Review List') }}</v-btn
                                        >

                                        <v-text-field
                                                flat
                                                dense
                                                outlined
                                                small
                                                v-model.trim="search[0].tsv"
                                                @keydown.enter="doSearch()"
                                                hide-details
                                                append-outer-icon="mdi-ballot"
                                                append-icon="mdi-close"
                                                @click:append="resetSearch"
                                                @click:append-outer="toggleAdvSearch"
                                                prepend-inner-icon="mdi-magnify"
                                                label="{{ _('Search') }}"
                                                :background-color="searchBg"
                                        ></v-text-field>


                                        <v-spacer></v-spacer>
                                        {% if current_user.roles_in(['Admin','DA']) %}
                                            <v-btn
                                                    @click="editItem"
                                                    color="primary"
                                                    dark
                                                    class="ma-2"
                                            >{{ _('New Bulletin') }}</v-btn
                                            >
                                        {% endif %} {% include
                            'admin/partials/bulletin_dialog.html' %} {% include
                            'admin/partials/review_dialog.html' %}
                                    </v-toolbar>

                                    <v-toolbar v-if="bulkAllowed() || exportAllowed()" dense color="white" flat>
                                        <template v-if="bulkIcons">

                                            <v-btn @click="selected=[]" x-small fab
                                                   class="mr-3" elevation="0" color="white">
                                                <v-icon>mdi-checkbox-blank-outline</v-icon>
                                            </v-btn>

                                            <v-btn
                                                    @click="bulkBulletinDrawer=true"
                                                    small
                                                    color="primary"
                                                    class="mx-2"
                                                    depressed
                                                    v-if="bulkAllowed()"
                                            >
                                                <v-icon small left
                                                >mdi-circle-edit-outline
                                                </v-icon>
                                                {{ _('Bulk update') }}
                                            </v-btn>
                                            {% if config.EXPORT_TOOL %}
                                                <v-btn
                                                        @click="exportDrawer=true"
                                                        small
                                                        color="primary"
                                                        class="mx-2"
                                                        depressed
                                                        v-if="exportAllowed()"
                                                >
                                                    <v-icon small left
                                                    >mdi-file-export-outline
                                                    </v-icon>
                                                    {{ _('Export') }}
                                                </v-btn>
                                            {% endif %}
                                        </template>
                                        <template>
                                            <v-progress-circular v-for="job in jobs"
                                                                 size="20" small
                                                                 :indeterminate="job.status!='SUCCESS'"

                                                                 :color="job.status=='SUCCESS' ? 'success': 'amber'"
                                                                 :value="job.status=='SUCCESS'?100:null"
                                                                 class="mx-1"
                                                                 stroke="1"
                                            ></v-progress-circular>
                                        </template>
                                        <v-spacer></v-spacer>

                                        <div>

                                            <v-tooltip top>
                                                <template v-slot:activator="{ on, attrs }">
                                                    <v-chip v-on="on" label small close color="yellow lighten-4"
                                                            class="grey--text text--darken-2"
                                                            @click:close="allBulletins"
                                                    >{{ _('About') }} ${itemsLength} {{ _('results') }}
                                                        (${searchTime} {{ _('seconds') }})
                                                    </v-chip>
                                                </template>
                                                <span>${search}</span>
                                            </v-tooltip>
                                        </div>


                                        <v-spacer></v-spacer>
                                        <v-chip small color="accent" v-if="selected.length"
                                        >${selected.length} {{ _('Selected items') }}</v-chip
                                        >
                                    </v-toolbar>

                                </template>

                                <template v-slot:item.roles="{item}">
                                    <v-chip
                                            small
                                            v-for="role in item.roles"
                                            :color="role.color"
                                            style="scale:0.7"
                                            v-tippy
                                            :content="role.name"
                                    >

                                    </v-chip>
                                </template>

                                <template v-slot:item.status="{ item }">
                                    ${item.status}
                                    <v-chip
                                            x-small
                                            v-if="item.review_action"
                                            color="grey lighten-4"
                                            class="secondary--text"
                                    >${item.review_action}
                                    </v-chip
                                    >
                                </template>
                                <template v-slot:item.action="{ item }">
                                    <v-tooltip top>
                                        <template v-slot:activator="{ on }">
                                            <v-icon
                                                    v-on="on"
                                                    color="ov darken-1"
                                                    class="mr-2"
                                                    @click.stop="editItem(item)"
                                                    v-if="editAllowed(item)"
                                            >
                                                mdi-pencil
                                            </v-icon>


                                        </template>
                                        <span>Edit</span>
                                    </v-tooltip>

                                    <v-tooltip top>
                                        <template v-slot:activator="{ on }">
                                            <v-icon
                                                    v-on="on"
                                                    color="primary lighten-1"
                                                    class="mr-2"

                                                    @click.stop="openSelfAssign(item)"
                                                    v-if="selfAssignAllowed(item)"
                                            >
                                                mdi-arrow-left-thin-circle-outline
                                            </v-icon>


                                        </template>
                                        <span>Assign to self</span>
                                    </v-tooltip>


                                    <v-tooltip top>
                                        <template v-slot:activator="{ on }">
                                            <v-icon v-on="on"
                                                    v-if="reviewAllowed(item)"
                                                    @click.stop="addReview(item)"
                                                    color="gv darken-1"
                                                    class="mr-2"
                                            >mdi-message-draw
                                            </v-icon>
                                        </template>
                                        <span>Add Review</span>
                                    </v-tooltip>

                                </template>


                                <template v-slot:no-data></template>
                            </v-data-table>

                            <v-overlay :value="loading">
                                <v-progress-circular
                                        indeterminate
                                        size="64"
                                ></v-progress-circular>
                            </v-overlay>
                            <relate-bulletins :i18n="translations" @relate="relateBulletin" :exids="exBulletins"
                                              ref="relateBulletins"></relate-bulletins>
                            <relate-actors :i18n="translations" @relate="relateActor" :exids="exActors"
                                           ref="relateActors"></relate-actors>
                            <relate-incidents :i18n="translations" @relate="relateIncident" :exids="exIncidents"
                                              ref="relateIncidents"></relate-incidents>


                            {% include 'admin/partials/video_player_dialog.html' %}

                            <visualization ref="viz" :i18n="translations"></visualization>

                            <v-dialog width="600" v-model="selfAssignDialog">
                                <v-card class="pa-3">
                                    <v-card-title>Self Assign Bulletin #${assignBulletin.id}</v-card-title>
                                    <v-card-text>
                                        <v-combobox

                                                small-chips
                                                multiple
                                                v-model="assignBulletin.ref"
                                                label="{{ _('Ref') }}"
                                                class="mr-2"
                                        ></v-combobox>
                                        <v-textarea v-model="assignBulletin.comments" label="Comments"></v-textarea>
                                    </v-card-text>
                                    <v-card-actions>
                                        <v-btn :disabled="!assignBulletin.comments" class="ma-auto" @click="selfAssign"
                                               color="primary">Assign to self
                                        </v-btn>
                                    </v-card-actions>
                                </v-card>

                            </v-dialog>


                            <v-snackbar v-model="snackbar">
                                <div class="d-flex justify-space-between align-center">
                                    <span class="text-subtitle-1">${snackMessage}</span>
                                    <v-btn color="white" fab small color="secondary" text @click="snackbar = false">
                                        <v-icon small>mdi-close</v-icon>
                                    </v-btn>
                                </div>

                            </v-snackbar>
                        </v-card-text>
                    </v-card>


                </v-container>
            </v-main>
            {% include 'footer.html' %}
        </v-app>
    </div>

<div class="d-none" data-itob='{{itobInfo|tojson}}'></div>
<div class="d-none" data-itoa='{{itoaInfo|tojson}}'></div>
<div class="d-none" data-atob='{{atobInfo|tojson}}'></div>
<div class="d-none" data-atoa='{{ atoaInfo|tojson }}'></div>
<div class="d-none" data-btob='{{btobInfo|tojson}}'></div>
<div class="d-none" data-itoi='{{itoiInfo|tojson}}'></div>
<div class="d-none" data-statuses='{{ statuses|tojson }}'></div>
<div class="d-none" data-allowed-media-types='{{ ", ".join(config.MEDIA_ALLOWED_EXTENSIONS) }}'></div>

{% endblock %} {% block js %}
    <script
            src="/static/js/tinymce/js/tinymce/tinymce.min.js"
            referrerpolicy="origin"
    ></script>
    <script src="/static/js/tinymce-vue.min.js"></script>

    <script src="/static/js/dropzone/vue2Dropzone.js"></script>
    <script src="/static/js/components/MediaCard.js"></script>
    <script src="/static/js/components/BulletinResult.js"></script>
    <script src="/static/js/components/ActorResult.js"></script>
    <script src="/static/js/components/IncidentResult.js"></script>
    <script src="/static/js/components/UniField.js"></script>
    <script src="/static/js/mixins/media-mixin.js"></script>
    <script src="/static/js/actorConfig.js"></script>
    <script src="/static/js/components/PdfViewer.js"></script>
    <script src="/static/js/components/GeoLocations.js"></script>
    <script src="/static/js/components/GlobalMap.js"></script>
    <script src="/static/js/components/Visualization.js"></script>
    <script src="/static/js/element-resize-detector.min.js"></script>
    <script src="/static/js/force-graph.min.js"></script>

    {% if config.GOOGLE_MAPS_API_KEY %}
        {{ '<script src="https://maps.googleapis.com/maps/api/js?key='|safe + config.GOOGLE_MAPS_API_KEY + '" async defer></script>'|safe }}
    {% endif %}
    <script src="/static/js/Leaflet.GoogleMutant.js"></script>





    <script>
        window.__GOOGLE_MAPS_API_KEY__ = '{{ config.GOOGLE_MAPS_API_KEY }}';
        window.__EXPORT_TOOL__ = ('{{ config.EXPORT_TOOL }}' === 'True');

        VeeValidate.extend("uniqueQueryName", {
            validate: async (str) => {
                try {
                    await axios.get(`/admin/api/query/${str}/exists`);
                    return true;
                } catch (error) {
                    return error?.response?.data ?? 'An error occurred.';
                }
            },
        });

        let app = new Vue({
            el: "#app",
            vuetify: vuetify,
            delimiters: delimiters,
            router,

            mixins: [mediaMixin],


            components: {

                "tinymce-editor": Editor, // <- Important part,
                vueDropzone: vue2Dropzone

            },


            data: () => ({


                translations: translations,

                itobInfo : JSON.parse(document.querySelector('[data-itob]').dataset.itob),
                itoaInfo : JSON.parse(document.querySelector('[data-itoa]').dataset.itoa),
                itoiInfo : JSON.parse(document.querySelector('[data-itoi]').dataset.itoi),
                atobInfo : JSON.parse(document.querySelector('[data-atob]').dataset.atob),
                btobInfo : JSON.parse(document.querySelector('[data-btob]').dataset.btob),
                atoaInfo : JSON.parse(document.querySelector('[data-atoa]').dataset.atoa),



                dzOpts: {
                    url: '/admin/api/media/chunk',
                    acceptedFiles: document.querySelector('[data-allowed-media-types]').dataset.allowedMediaTypes,
                    addRemoveLinks: true,
                    chunking: true,
                    forceChunking: true,
                    chunkSize: 500000, // Bytes
                    thumbnailWidth: 80, // px
                    thumbnailHeight: 80,
                    parallelUploads: 1,
                    maxFilesize: mediaUploadMaxFileSize,


                },


                assignBulletin: {},
                selfAssignDialog: false,

                //global preview dialog
                preview: false,
                pitem: null,
                search: [{}],
                queryName: null,
                saveQueryDialog: false,
                searchPanels: 0,
                searches: [],
                searchTime: null,
                savedSearchSelection: null,


                currentUser: JSON.parse(`{{ current_user.to_dict()|tojson }}`),
                users: JSON.parse(`{{users|tojson}}`),

                roles: [],
                // advanced search
                q: {},

                advSearchExpand: false,
                advSearchMenu: false,


                fsloading: true,


                dialog: dialog,
                eventDialog: false,
                eventParams: { typ: 'for_bulletin' },
                reviewDialog: false,
                reviewKey: 0,
                descKey: 0,


                // search and relate bulletin dialog vars


                relateBulletinTerm: "",
                relateBulletinResults: [],
                selectedRelatedBulletins: [],

                // search and relate actor dialog vars
                relateActorTerm: "",
                relateActorResults: [],
                selectedRelatedActors: [],


                // search and relate incident dialog vars
                relateIncidentDialog: false,
                relateIncidentLoader: true,
                relateIncidentTerm: "",
                relateIncidentResults: [],
                selectedRelatedIncidents: [],


                drawer: drawer,
                sideNav: sideNav,
                bulletinDrawer: false,
                bulkBulletinDrawer: false,

                exportDrawer: false,
                exportConfig: {},
                sources: [],
                locations: [],
                labels: [],
                verLabels: [],
                eventtypes: [],


                statuses: JSON.parse(document.querySelector('[data-statuses]').dataset.statuses)
                  .map(s => ({en: s.title, tr: s.title_tr})),

              statusItems: JSON.parse(document.querySelector('[data-statuses]').dataset.statuses)
                  .map(s => ({en: s.title, tr: s.title_tr})),
                statusDisabled: false,


                //field language switchers
                title__: true,
                sjac_title__: true,
                //events fields
                eventTitle__: true,
                eventComments__: true,


                //source link extras
                source_alt: null,
                source_disabled: false,

                //rich text config
                tinyConfig: tinyConfig,

                snackbar: false,
                snackMessage: "",
                loading: true,
                parentLoading: false,
                csvFile: null,
                options: {},
                searchLoading: {
                    assigned: false,
                    first: false,
                    second: false,
                    third: false
                },


                //event dates popups
                eventFromMenu: false,
                eventToMenu: false,

                //bulletin dates popups
                publishDateMenu: false,
                documentationDateMenu: false,

                footerProps: {
                    itemsPerPageOptions: itemsPerPageOptions,
                    itemsPerPageText: "{{ _('Rows per page')}}"
                },

                headers: [
                    {text: "{{_('ID')}}", value: "id", width: 12, sortable: true},
                    {text: "{{_('Title')}}", value: "title", width: 300, sortable: false},

                    {% if (current_user.has_role('Admin') or current_user.has_role('DA')) %}
                        {text: "{{_('Assigned To')}}", value: "assigned_to.name", width: 130, sortable: false},
                        {text: "{{_('Roles')}}", value: "roles", width: 130, sortable: false},
                    {% endif %}
                    {text: "{{_('Status')}}", value: "_status", width: 150, sortable: false},


                    {text: "{{_('Actions')}}", value: "action", sortable: false, width: 100}

                ],


                items: [],
                selected: [],
                itemsLength: 10,

                editedIndex: -1,
                editedItem: {
                    title: "",
                    events: [],
                    medias: [],
                    bulletin_relations: [],
                    actor_relations: [],
                    incident_relations: []
                },
                defaultItem: {
                    title: "",
                    description: "",

                    // related events
                    events: [],
                    // related media
                    medias: [],
                    // related bulletins
                    bulletin_relations: [],

                    // related actors
                    actor_relations: [],

                    // related incidents
                    incident_relations: [],
                    publish_date: '',
                    documentation_date: ''
                },

                reviewItem: {},

                // bulk actions
                bulk: {},
                bulkIcons: false,
                jobs: [],
                bulkTimer: 0,


                //events
                editedEventIndex: -1,
                editedEvent: {
                    title: ""
                },
                defaultEvent: {
                    title: "",
                    from_date: '',
                    to_date: ''
                },


                bulletin: {},
                bulletinLoader: false
            }),

            computed: {
                compLocations() {
                    return aggregateBulletinLocations(this.editedItem);
                },


                exBulletins() {
                    let ids = [this.editedItem.id];
                    if (this.editedItem.bulletin_relations) {
                        ids = ids.concat(this.editedItem.bulletin_relations.map(x => x.bulletin.id))
                    }
                    return ids;
                },

                exActors() {
                    let ids = [];
                    if (this.editedItem.actor_relations) {
                        ids = ids.concat(this.editedItem.actor_relations.map(x => x.actor.id))
                    }
                    return ids;
                },

                exIncidents() {
                    let ids = [];
                    if (this.editedItem.incident_relations) {
                        ids = ids.concat(this.editedItem.incident_relations.map(x => x.incident.id))
                    }
                    return ids;
                },


                searchBg() {
                    for (const s of this.search) {
                        let props = Object.values(s);
                        for (const v of props) {
                            if (v) {

                                return 'yellow lighten-5';
                            }
                        }
                    }
                    return ''

                },


                formTitle() {

                    return this.editedItem.id ? this.translations.editBulletin_ : this.translations.newBulletin_;
                },

            },


            watch: {

                bulletinDrawer: function (val) {
                    if (val == false) {

                        if (this.$route.path != '/admin/bulletins/')
                            this.$router.push('/admin/bulletins/')
                    }
                },


                selected: function (val) {
                    this.bulkIcons = val.length ? true : false;

                },

                source_alt: function (val) {

                    if (val) {
                        this.editedItem.source_link = 'NA';
                        this.source_disabled = true;
                    } else {
                        //this.editedItem.source_link = '';
                        this.source_disabled = false;
                    }
                },


                eventDialog(val) {
                    val || this.closeEvent();
                },

                mediaDialog(val) {
                    val || this.closeMedia();
                },

                options: {
                    handler: "refresh"
                }
            },
            mounted: function () {





                // populate roles for advanced search for admins
                {% if current_user.has_role('Admin') %}
                    axios.get('/admin/api/roles/').then(res => {
                        this.roles = res.data.items;
                    }).catch(e => {
                        this.roles = [];
                        console.error(e.message);
                    });
                {% endif  %}



                // display confirmation alert if edit dialog is open.
                let self = this;
                window.addEventListener("beforeunload", function (e) {
                    if (self.dialog) {
                        var confirmationMessage = 'It looks like you have been editing something. '
                            + 'If you leave before saving, your changes will be lost.';
                        (e || window.event).returnValue = confirmationMessage; //Gecko + IE
                        return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
                    }
                });


                if (this.$route.params.id) {
                    this.showBulletin(this.$route.params.id);
                }

                if (this.$route.query.reltob) {
                    this.filter_related_to_bulletin(this.$route.query.reltob);

                }

                if (this.$route.query.reltoa) {
                    this.filter_related_to_actor(this.$route.query.reltoa);
                }

                if (this.$route.query.reltoi) {
                    this.filter_related_to_incident(this.$route.query.reltoi);
                }


                this.$router.afterEach((to, from, next) => {

                    if (this.$route.query.reltob) {
                        this.filter_related_to_bulletin(this.$route.query.reltob);
                    }

                    if (this.$route.query.reltoa) {
                        this.filter_related_to_actor(this.$route.query.reltoa);
                    }

                    if (this.$route.query.reltoi) {
                        this.filter_related_to_incident(this.$route.query.reltoi);
                    }


                    if (this.$route.params.id) {
                        this.showBulletin(this.$route.params.id);
                    } else {
                        this.bulletinDrawer = false;
                    }

                })


            },

            methods: {

             exportRequest() {

                    let ids = this.selected.map(x => x.id);
                    this.loading = true;
                    axios.post(`/export/api/bulletin/export`, {
                        items: ids,
                        config: this.exportConfig
                    })
                        .then(response => {
                            this.showSnack(response.data);
                        }).catch(error => {
                        console.error(error.response?.data);
                        this.showSnack(error.response?.data)
                    }).finally(() => {
                        this.loading = false;
                        this.exportDrawer = false;
                        this.selected = [];
                        this.exportConfig = {};

                    });
                },


                selectAllRestrict(props) {
                    if (props.value === false) {
                        // untoggle on next tick
                        this.$nextTick(() => {
                            this.selected = [];
                        })
                    }


                    this.selected = this.selected.concat(props.items.filter(x => !x.restricted))
                },

                rowClass(item) {
                    if (item.restricted) {
                        return 'restricted'
                    }
                    return ''
                },

                openSelfAssign(bulletin) {
                    this.assignBulletin = {id: bulletin.id};
                    this.selfAssignDialog = true;

                },

                selfAssign() {


                    axios.put(`/admin/api/bulletin/assign/${this.assignBulletin.id}`, {bulletin: this.assignBulletin}).then(res => {
                        this.showSnack('Bulletin assigned successfully.')
                        this.searchBulletins(true)

                    }).catch(err => {
                        this.showSnack(err.response.data);
                    }).finally(() => {
                        this.selfAssignDialog = false;
                        this.assignBulletin = {};

                    });

                },

                filter_related_to_bulletin(id) {
                    this.bulletinDrawer = false;
                    this.search = [{rel_to_bulletin: id}];
                    this.searchBulletins();
                },

                filter_related_to_actor(id) {
                    this.bulletinDrawer = false;
                    this.search = [{rel_to_actor: id}];
                    this.searchBulletins();
                },

                filter_related_to_incident(id) {
                    this.bulletinDrawer = false;
                    this.search = [{rel_to_incident: id}];
                    this.searchBulletins();
                },

                previewItem(endpoint) {

                    axios.get(endpoint).then(res => {
                        this.pitem = res.data;
                        this.preview = true;

                    })


                },

                geoLocationsUpdated() {
                    if (this.editedItem.geoLocations.length > 0) {
                        this.editedItem.geoLocations.push(this.editedItem.geoLocations.pop())
                    }


                },


                bulkStatus() {

                    axios.get('/admin/api/bulk/status/?type=bulletin').then(res => {
                        this.jobs = res.data;

                        if (!this.jobs.length) {
                            clearInterval(this.bulkTimer);
                            // default refresh to first page
                            this.options.page = 1;

                            this.refresh(true);
                            this.showSnack('Bulk Update is finished!')
                        } else {
                            //console.log(this.jobs)
                            for (job of this.jobs) {
                                // console.log(job.status)
                            }
                        }
                    });

                },


                // bulk updates

                bulk_update() {
                    let ids = this.selected.map(x => x.id);
                    this.loading = true;
                    axios.put(`/admin/api/bulletin/bulk/`, {
                        items: ids,
                        bulk: this.bulk
                    })
                        .then(response => {
                            this.loading = false;
                            this.showSnack(response.data);
                            this.refresh(this.options);
                            //reset bulk drawer, and bulk data
                            this.bulkBulletinDrawer = false;
                            this.selected = [];
                            this.bulk = {};
                            clearInterval(this.bulkTimer);
                            // if (!this.bulkProcInterval)
                            this.bulkTimer = setInterval(this.bulkStatus, 3000);

                        });
                },


                // - ------------------ bulletins search methods  ---------------------------------

                toggleAdvSearch() {
                    this.advSearchExpand = !this.advSearchExpand
                    this.advSearchMenu = !this.advSearchMenu;


                },
                doSearch() {
                    this.options.page = 1;

                    // some good UX
                    if (this.advSearchExpand) {
                        this.advSearchExpand = false;
                    } else {
                        //this.search = Object.assign({},{tsv:this.search.tsv})
                    }

                    this.searchBulletins();
                }
                ,
                searchBulletins(cached) {

                    this.loading = true;
                    const startTime = new Date()
                    let url = `/admin/api/bulletins/?page=${this.options.page}&per_page=${this.options.itemsPerPage}`;
                    if (cached) {
                        url += '&cache=' + new Date().getTime();
                    }
                    axios.post(url, {
                        q: this.search,
                        options: this.options
                    }).then(response => {
                        const endTime = new Date()
                        this.searchTime = (endTime - startTime) / 1000;
                        this.loading = false;
                        this.itemsLength = response.data.total;
                        this.items = response.data.items;
                    });


                },
                removeQueryAt(i) {

                    this.search.splice(i, 1);

                },

                addQuery() {
                    this.search.push({})
                    this.searchPanels = this.search.length - 1;
                },


                resetSearch() {
                    this.savedSearchSelection = null;
                    this.search = [{}];
                    this.doSearch();
                },

                openSaveQueryDialog() {
                    // Separate method to include auto-focus on input

                    this.saveQueryDialog = true;
                    this.$nextTick(() => {
                        setTimeout(() => {
                            this.$refs.saveQueryInput.focus();
                        }, 0);
                    })
                },

                loadSearch(item) {

                    if (item) {
                        this.savedSearchSelection = Object.assign([], item);
                        this.search = Object.assign([], item.data);
                    }
                    this.$refs.savedSearchDropdown.blur()
                },


                loadSearchesFromAPI(selectLast = false) {
                    axios.get('/admin/api/queries/', {
                        params: {
                            type: 'bulletin'
                        }
                    }).then(res => {
                        this.searches = res.data;
                        if (selectLast === true) {
                            this.savedSearchSelection = this.searches.at(-1);
                        }
                    }).catch(error => {
                        this.showSnack(handleRequestError(error))
                    });

                },

                saveSearch() {
                    const newSearch = {q: this.search, name: this.queryName, type: 'bulletin'};

                    axios.post('/admin/api/query/', newSearch)
                        .then(res => {
                            this.showSnack(res.data);
                            this.saveQueryDialog = false;


                            this.queryName = null;
                            // just reload searches and select the last one
                            this.loadSearchesFromAPI(true);
                        })
                        .catch(error => {
                            this.showSnack(handleRequestError(error));
                        });
                },


                updateSearch() {
                    axios.put('/admin/api/query/' + this.savedSearchSelection.name, {q: this.search})
                        .then(res => {
                            this.showSnack(res.data);
                        })
                        .catch(error => {
                            this.showSnack(handleRequestError(error));
                        });
                },


                deleteSearch(searchName) {
                    axios.delete('/admin/api/query/' + searchName)
                        .then(res => {
                            this.showSnack(res.data);
                            this.searches = this.searches.filter(item => item.name !== searchName);
                            this.resetSearch();
                        })
                        .catch(error => {
                            this.showSnack(handleRequestError(error));
                        });
                }

                ,
                // - ------------------ end bulletins search methods  ---------------------------------


                /* Bulletins Custom Lists */

                allBulletins() {
                    this.search = [{}];
                    this.doSearch();

                },
                myAssigned() {
                    q = {};
                    this.options.page = 1;
                    q.assigned = [this.currentUser.id];
                    q.statuses = ["Assigned"];
                    this.search = [q];
                    this.searchBulletins();
                },

                myReview() {
                    q = {};
                    this.options.page = 1;
                    q.reviewer = [this.currentUser.id];
                    q.statuses = ["Peer Review Assigned"];
                    this.search = [q]
                    this.searchBulletins();
                },


                removeEvent: function (evt, index) {
                    if (confirm('Confirm deleting this event?')) {
                        this.editedItem.events.splice(index, 1);
                    }

                },


                //reset initial visible fields to english language

                resetSwitchers: function () {
                    this.title__ = true;
                    this.sjac_title__ = true;
                },

                refresh(cached = false) {

                    this.searchBulletins(this.search, cached = cached)

                },

                rowClick(item) {
                    if (item.restricted) {
                        this.showSnack('This item is restricted.')
                        return
                    }
                    path = `/admin/bulletins/${item.id}`;
                    if (this.$route.path !== path)
                        this.$router.push(path);

                },

                showBulletin(id) {
                    this.bulletinLoader = true
                    this.bulletinDrawer = true;
                    axios.get(`/admin/api/bulletin/${id}?mode=3`).then(response => {
                        this.bulletin = response.data;
                    }).catch(error => {
                        this.bulletinDrawer = false;
                        if (error.response) {
                            this.showSnack(error.response.data)
                            this.snackbar = true;
                        }
                    }).finally(() => {
                        this.bulletinLoader = false;
                    });
                },


                searchEventtypes: debounce(function (evt) {
                    axios
                        .get(`/admin/api/eventtypes/?q=${evt.target.value}&typ=for_bulletin`)
                        .then(response => {
                            this.eventtypes = response.data.items;
                        });
                }, 350),


                handleStatus(bulletin) {

                    if (this.editedItem.id) {
                        // edit existing bulletin mode
                        if (this.has_role(this.currentUser, 'Admin')) {

                            this.statusDisabled = false;
                            return;
                        }

                        // else is a standard user
                        this.statusItems = this.statuses;

                        if (this.editedItem.status == 'Assigned' || this.editedItem.status == 'Human Created') {
                            this.editedItem.status = this.statusItems[2].en;
                        }

                        if (this.editedItem.status == 'Peer Reviewed') {
                            this.editedItem.status = this.statusItems[9].en;
                        }

                        this.statusDisabled = true;
                    } else {
                        // new bulletin mode

                        this.editedItem.status = this.statusItems[1].en;
                        this.statusDisabled = true;

                    }

                },

                showSnack(message) {
                    this.snackMessage = message;
                    this.snackbar = true;
                },

                has_role(user, role) {
                    for (const r of user.roles) {
                        if (r.name === role) {
                            return true
                        }
                    }
                    return false;
                },

                bulkAllowed() {
                    if (this.has_role(this.currentUser, 'Admin')) {
                        return true;
                    }
                    if (this.has_role(this.currentUser, 'Mod')) {
                        return true;
                    }
                    return false;
                },

                exportAllowed() {
                    if (__EXPORT_TOOL__) {
                        if (this.has_role(this.currentUser, 'Admin')) {
                            return true;
                        }
                        if (this.currentUser.can_export) {
                            return true;
                        }
                    }
                    return false;
                },

                editAllowed(bulletin) {

                    if (bulletin.restricted) {
                        return false;
                    }

                    if (this.has_role(this.currentUser, 'Admin')) {
                        return true;
                    }
                    if (!this.has_role(this.currentUser, 'DA')) {
                        return false;
                    }
                    const statuses = ['Human Created', 'Assigned', 'Updated', 'Peer Reviewed', 'Revisited'];
                    if (bulletin.assigned_to && bulletin.assigned_to.id == this.currentUser.id && statuses.includes(bulletin.status)) {
                        return true
                    }
                    return false;
                },

                reviewAllowed(bulletin) {

                    if (bulletin.restricted) {
                        return false;
                    }

                    if (!this.currentUser.roles.length) {
                        return false;
                    }

                    const statuses = ['Peer Review Assigned', 'Peer Reviewed'];
                    if (bulletin.first_peer_reviewer && bulletin.first_peer_reviewer.id == this.currentUser.id && statuses.includes(bulletin.status)) {
                        return true
                    }
                    return false;
                },

                selfAssignAllowed(bulletin) {

                    if (bulletin.restricted) {
                        return false;
                    }

                    if (this.currentUser.can_self_assign) {
                        if ((!bulletin.assigned_to) || (bulletin.assigned_to && !bulletin.assigned_to.active)) {
                            return true
                        }

                    }

                    return false;

                },


                addReview(item) {

                    this.loading = true;
                    this.reviewDialog = true;


                    axios.get(`/admin/api/bulletin/${item.id}`).then(response => {
                        this.loading = false;
                        this.$nextTick(() => {
                            this.reviewItem = response.data;
                            this.reviewKey += 1;
                            // fix bug in vue reactivity with nested object attribs

                            if (!response.data.review) {
                                this.reviewItem.review = '';
                            }


                        })


                    })


                }
                ,

                saveReview() {

                    axios.put(`/admin/api/bulletin/review/${this.reviewItem.id}`, {
                        item: this.reviewItem
                    })
                        .then(response => {
                            this.reviewDialog = false;
                            this.showSnack(response.data);
                            this.searchBulletins();
                        });

                },

                adjustDates() {


                    if (this.editedItem.publish_date) {
                        this.editedItem.publish_time = dateFns.format(this.editedItem.publish_date, 'HH:mm');
                        this.editedItem.publish_date = dateFns.format(this.editedItem.publish_date, 'YYYY-MM-DD')
                    }

                    if (this.editedItem.documentation_date) {
                        this.editedItem.documentation_time = dateFns.format(this.editedItem.documentation_date, 'HH:mm');
                        this.editedItem.documentation_date = dateFns.format(this.editedItem.documentation_date, 'YYYY-MM-DD');
                    }
                },


                editItem(item) {

                    this.bulletinDrawer = false;


                    if (!item.id) {
                        // hack to invoke deep copy and avoid passing attributes by reference
                        // (resolves data the persists across dialogs)
                        this.editedItem = JSON.parse(JSON.stringify(this.defaultItem));
                        this.source_alt = null;
                        this.dialog = true;
                        this.handleStatus(item);
                    } else {
                        // load item from db
                        this.loading = true;
                        axios.get(`/admin/api/bulletin/${item.id}`).then(response => {
                            this.dialog = true;

                            this.$nextTick(() => {
                                this.loading = false
                                this.editedItem = response.data;
                                //reload tinymce component hack
                                this.descKey += 1;
                                if (this.editedItem.source_link == 'NA') {
                                    this.source_alt = true;
                                } else {
                                    this.source_alt = false;
                                }
                                this.editedItem.comments = '';

                                this.resetSwitchers();
                                this.handleStatus(item);
                            })


                        }).catch(error => {
                            this.showSnack('Oops! We couldn\'t find this item.')

                        });


                    }


                },

                deleteItem(item) {
                    const index = this.items.indexOf(item);
                    const cfm =
                        confirm("Are you sure you want to delete this item?") &&
                        this.items.splice(index, 1);
                    if (cfm) {
                        axios.delete(`/admin/api/bulletin/${item.id}`).then(response => {
                            this.showSnack(response.data);
                            this.refresh();
                        });
                    }
                },

                confirmClose() {

                    if (confirm('Are you sure?')) {
                        this.dialog = false;
                        setTimeout(() => {
                            this.editedItem = Object.assign({}, this.defaultItem);
                            this.editedIndex = -1;
                        }, 300);
                    }
                },
                close() {

                    this.dialog = false;
                    setTimeout(() => {
                        this.editedItem = Object.assign({}, this.defaultItem);
                        this.editedIndex = -1;
                    }, 300);
                },

                save() {

                    if (this.editedItem.id) {
                        axios.put(`/admin/api/bulletin/${this.editedItem.id}`, {
                            item: this.editedItem
                        })
                            .then(response => {
                                this.showSnack(response.data);
                                this.refresh(this.options);
                                this.close();
                            }).catch(err => {
                            this.showSnack(err.response.data);
                        }).then(() => {
                            this.close()
                        });
                    } else {
                        this.items.push(this.editedItem);
                        //create new record
                        axios.post("/admin/api/bulletin/", {item: this.editedItem})
                            .then(response => {
                                this.showSnack(response.data);
                                this.refresh(this.options);
                            }).catch(err => {
                            this.showSnack(err.response.data);
                        }).then(() => {
                            this.close();
                        });
                    }

                },

                editEvent(evt, item, index) {
                    this.eventDialog = true;

                    this.$nextTick(() => {
                        this.editedEvent = Object.assign({}, item);

                        this.editedEventIndex = index;

                        //reset dual fields display to english
                        this.eventTitle__ = true;
                        this.eventComments__ = true;

                    })

                    //this.locations = this.editedItem.locations;
                },

                closeEvent() {
                    this.eventDialog = false;
                    setTimeout(() => {
                        this.editedEvent = Object.assign({}, this.defaultEvent);
                        this.editedEventIndex = -1;
                    }, 300);
                },

                saveEvent() {

                    if (this.editedEventIndex > -1) {
                        Object.assign(
                            this.editedItem.events[this.editedEventIndex],
                            this.editedEvent
                        );
                        //update record
                    } else {
                        this.editedItem.events.push(this.editedEvent);
                        //create new record
                    }
                    this.closeEvent();
                },

                // related bulletins functions --------------------

                searchRelatedBulletins() {

                    this.$refs.relateBulletins.open();
                    this.$nextTick(() => {
                        this.$refs.relateBulletins.q = {tsv: this.relateBulletinTerm};
                        this.$refs.relateBulletins.reSearch();
                    });

                },

                relateBulletin(bulletin) {


                    // get list of existing attached bulletins
                    let ex = this.editedItem.bulletin_relations.map(x => x.bulletin.id);

                    if (!ex.includes(bulletin.id)) {
                        relation = {
                            bulletin: bulletin
                        };
                        this.editedItem.bulletin_relations.push(relation);
                    }
                },

                removeBulletin: function (evt, index) {
                    if (confirm("Are you sure?")) {
                        this.editedItem.bulletin_relations.splice(index, 1);
                    }
                },


                // -------------------------------------------------


                // related actors functions ------------------------

                searchRelatedActors() {
                    this.$refs.relateActors.open();
                    this.$nextTick(() => {
                        this.$refs.relateActors.q = {tsv: this.relateActorTerm};
                        this.$refs.relateActors.reSearch();
                    });

                },
                relateActor(actor) {
                    // get list of existing attached actors
                    let ex = this.editedItem.actor_relations.map(x => x.actor.id);

                    if (!ex.includes(actor.id)) {
                        relation = {
                            actor: actor
                        };
                        this.editedItem.actor_relations.push(relation);
                        this.relateActorResults.removeById(actor.id);
                    }
                },

                removeActor: function (evt, index) {
                    if (confirm("Are you sure?")) {
                        this.editedItem.actor_relations.splice(index, 1);
                    }
                },


                // related incidents functions ------------------------

                searchRelatedIncidents() {

                    this.$refs.relateIncidents.open();
                    this.$nextTick(() => {
                        this.$refs.relateIncidents.q = {tsv: this.relateIncidentTerm};
                        this.$refs.relateIncidents.reSearch();
                    });

                },
                relateIncident(incident) {

                    // get list of existing attached actors
                    let ex = this.editedItem.incident_relations.map(x => x.incident.id);

                    if (!ex.includes(incident.id)) {
                        relation = {
                            incident: incident
                        };
                        this.editedItem.incident_relations.push(relation);
                        this.relateIncidentResults.removeById(incident.id);
                    }
                },

                removeIncident: function (evt, index) {
                    if (confirm("Are you sure?")) {
                        this.editedItem.incident_relations.splice(index, 1);
                    }
                },


            }
        });
    </script>
{% endblock %}
