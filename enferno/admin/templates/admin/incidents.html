{% extends 'layout.html' %}

{% block css %}
    <link rel="stylesheet" href="/static/js/videojs/video-js.min.css">
{% endblock %}

{% block content %}


    {% include  'admin/partials/incident_drawer.html' %}
    {% include     'admin/partials/bulk_incident_drawer.html' %}
    {% include   'admin/partials/export_drawer.html' %}
    <v-main>
        <v-container fluid>
            <v-tooltip text="{{ _('Visualize Results') }}">
                <template #activator="{ props }">
                    <v-btn
                            elevation="16"
                            color="primary"
                            v-bind="props"
                            @click.stop="visualizeResults"
                            v-if="showVisualize"
                            :loading="visualizeLoading"
                            class="mb-5 mr-5 position-absolute "
                            style="right: 30px; bottom: 90px; z-index: 1000;"
                            icon="mdi-graph"
                    >


                    </v-btn>
                </template>
            </v-tooltip>

            <v-card>
                <v-card-title>
                    <div class="flex-grow-1"></div>
                </v-card-title>
                <v-card-text>
                    <v-data-table-server
                            fixed-header
                            height="calc(100vh - 331px)"
                            id="incidents-dt"
                            v-model="selected"
                            hover
                            :headers="headers"
                            @click:row="rowClick"
                            :items="items"
                            :loading="loading"
                            :row-props="rowClass"
                            :items-length="totalCount"
                            show-select
                            item-value="id"
                            select-strategy="page"
                            item-selectable="selectable"
                            class="elevation-1"
                            hide-default-footer
                    >

                        <template v-slot:top>
                            <v-sheet class="ma-3 d-flex align-center ">
                                <v-btn class="hidden-sm-and-down" @click="allIncidents"
                                variant="text">{{ _('All Incidents') }}</v-btn>
                                <v-divider class="mx-2 hidden-sm-and-down" inset vertical></v-divider>
                                <v-btn class="hidden-sm-and-down" @click="myAssigned"
                                variant="text">{{ _('Assigned to me') }}</v-btn>
                                <v-divider class="mx-2 hidden-sm-and-down" inset vertical></v-divider>
                                <v-btn @click="myReview" class="mr-2 hidden-sm-and-down"
                                       variant="text">{{ _('My Review List') }}</v-btn>


                                <v-text-field
                                        density="compact"
                                        variant="outlined"
                                        v-model="search.tsv"
                                        @keydown.enter="doSearch"
                                        hide-details
                                        append-icon="mdi-ballot"
                                        @click:append="toggleAdvSearch"
                                        :append-inner-icon="searchEmpty ? '' : 'mdi-close'"
                                        @click:append-inner="resetSearch"
                                        prepend-inner-icon="mdi-magnify"
                                        label="{{ _('Search') }}"
                                        :bg-color="searchBg"
                                ></v-text-field>


                                <v-spacer></v-spacer>
                                {% if current_user.roles_in(['Admin','DA']) %}
                                    <v-btn @click="editItem" color="primary" variant="elevated" class="ma-2"
                                    >{{ _('New Incident') }}</v-btn
                                    >
                                {% endif %}
                                {% include 'admin/partials/incident_dialog.html' %}
                                {% include 'admin/partials/review_dialog.html' %}

                            </v-sheet>


                            <v-toolbar class="px-3" v-if="bulkAllowed() || exportAllowed()">

                                <template v-if="bulkIcons">
                                    <v-tooltip location="top" text="{{ _('Unselect all') }}">
                                        <template #activator="{props}">
                                            <v-btn icon="mdi-checkbox-blank-outline"
                                                @click="selected=[]"
                                                class="mr-3 ml-1"
                                                density="compact"
                                                v-bind="props">
                                            </v-btn>
                                        </template>
                                    </v-tooltip>

                                    <v-btn
                                            @click="bulkIncidentDrawer=true"
                                            prepend-icon="mdi-circle-edit-outline"
                                            color="primary"
                                            variant="elevated"
                                            class="mx-2"
                                            v-if="bulkAllowed()"
                                    >

                                        {{ _('Bulk update') }}
                                    </v-btn>

                                    <v-btn
                                            @click="exportDrawer=true"
                                            variant="elevated"
                                            color="primary"
                                            class="mx-2"
                                            depressed
                                            v-if="exportAllowed()"
                                    >
                                        <v-icon small left
                                        >mdi-file-export-outline
                                        </v-icon>
                                        {{ _('Export') }}
                                    </v-btn>

                                </template>

                                <template>
                                    <v-progress-circular v-for="job in jobs"
                                                         size="20" small
                                                         :indeterminate="job.status!='SUCCESS'"

                                                         :color="job.status=='SUCCESS' ? 'success': 'amber'"
                                                         :value="job.status=='SUCCESS'?100:null"
                                                         class="mx-1"
                                                         stroke="1"
                                    ></v-progress-circular>
                                </template>
                                <v-spacer></v-spacer>

                                <v-chip small color="accent" v-if="selected.length">
                                    ${selected.length} {{ _('Selected items') }}</v-chip>

                            </v-toolbar>
                        </template>

                        <template #bottom>
                            <div class="d-flex align-center justify-space-between w-100 border-t px-3" style="height: 61px">
                                <div>{{ _('Search time: ') }}
                                    ${searchTime} {{ _('seconds') }}</div>
                                <div>
                        
                                    <div class="d-flex flex-row align-center ga-2">
                                        <div class="d-flex flex-row align-center ga-2">
                                            {{ _('Items per page:') }}
                                            <v-select :model-value="perPage" @update:model-value="setNextPerPageValue" hide-details
                                                density="compact" :items="itemsPerPageOptions" variant="outlined"></v-select>
                        
                                        </div>
                                        <div>
                                            <span>${rangeStart.toLocaleString('en-US')}-${rangeEnd.toLocaleString('en-US')} of ${totalCount.toLocaleString('en-US')}</span>
                                            <v-btn :disabled="loading || cursorPage === 1" @click="goToFirstPage()" variant="text"
                                                icon="mdi-page-first"></v-btn>
                                            <v-btn :disabled="loading || cursorPage === 1" @click="goToPrevPage()" variant="text"
                                                icon="mdi-chevron-left"></v-btn>
                                            <v-btn :disabled="loading || !nextCursor" @click="goToNextPage()" variant="text"
                                                icon="mdi-chevron-right"></v-btn>
                                        </div>
                                    </div>
                                </div>
                        </template>
                        
                        <template v-if="fetchingRecordsError" v-slot:no-data></template>

                        <template v-slot:item.roles="{item}">
                            <v-tooltip location="top" :text="role.name" v-for="role in item.roles">
                                <template v-slot:activator="{props}">
                                    <v-icon
                                            v-bind="props"
                                            size="small"
                                            :color="role.color || 'grey-lighten-1'"
                                            icon="mdi-shield-lock"
                                    >
                                    </v-icon>
                                </template>
                            </v-tooltip>
                        </template>

                        <template v-slot:item.status="{ item }">
                            ${item.status}
                            <v-chip x-small v-if="item.review_action" color="grey lighten-4"
                                    class="secondary--text">${item.review_action}
                            </v-chip>
                        </template>
                        <template v-slot:item.action="{ item }">

                            <v-tooltip text="{{ _('Edit') }}" location="top">
                                <template #activator="{ props }">
                                    <v-icon
                                            v-bind="props"
                                            color="ov"
                                            class="mr-2"
                                            @click.stop="editItem(item)"
                                            v-if="editAllowed(item)">
                                        mdi-pencil
                                    </v-icon>
                                </template>
                            </v-tooltip>


                            <v-tooltip text="{{ _('Assign to self') }}">
                                <template #activator="{ props }">
                                    <v-icon
                                            v-bind="props"
                                            color="primary lighten-1"
                                            class="mr-2"

                                            @click.stop="openSelfAssign(item)"
                                            v-if="selfAssignAllowed(item)"
                                    >
                                        mdi-arrow-left-thin-circle-outline
                                    </v-icon>
                                </template>
                            </v-tooltip>


                            <v-tooltip text="{{ _('Add Review') }}" location="top">
                                <template #activator="{ props }">
                                    <v-icon v-bind="props"
                                            v-if="reviewAllowed(item)"
                                            @click.stop="addReview(item)"
                                            color="gv darken-1"
                                            class="mr-2"
                                    >mdi-message-draw
                                    </v-icon>
                                </template>

                            </v-tooltip>


                        </template>
                        <template v-slot:no-data></template>
                    </v-data-table-server>

                    {% include 'admin/partials/incident_advsearch.html' %}

                    <v-overlay :value="loading">
                        <v-progress-circular indeterminate size="64"></v-progress-circular>
                    </v-overlay>

                    <relate-bulletins @relate="relateBulletin" :exids="exBulletins"
                                      ref="relateBulletins" :dialog-props="commonDialogProps"></relate-bulletins>
                    <relate-actors @relate="relateActor" :exids="exActors"
                                   ref="relateActors" :dialog-props="commonDialogProps"></relate-actors>
                    <relate-incidents @relate="relateIncident" :exids="exIncidents"
                                      ref="relateIncidents" :dialog-props="commonDialogProps"></relate-incidents>


                    <v-dialog width="600" v-model="selfAssignDialog">
                        <v-card class="pa-3">
                            <v-card-title>{{ _('Self Assign Incident') }} #${assignIncident.id}</v-card-title>
                            <v-card-text>

                                <v-textarea v-model="assignIncident.comments" label="{{ _('Comments') }}"></v-textarea>
                            </v-card-text>
                            <v-card-actions>
                                <v-btn :disabled="!assignIncident.comments" class="ma-auto"
                                       @click="selfAssign"
                                       color="primary">{{ _('Assign to self') }}
                                </v-btn>
                            </v-card-actions>
                        </v-card>

                    </v-dialog>
                </v-card-text>
            </v-card>

        </v-container>

    </v-main>

{% endblock %}

{% block outside %}

    <div class="d-none" data-statuses='{{ statuses|tojson }}'></div>
{% endblock %}

{% block js %}
    <script
            src="/static/js/tinymce/js/tinymce/tinymce.min.js"
            referrerpolicy="origin"
    ></script>

    <script src="/static/js/tinymce-vue.min.js"></script>

    <script src="/static/js/mixins/related-search-mixin.js"></script>
    <script src="/static/js/mixins/media-mixin.js"></script>
    <script src="/static/js/mixins/relations-mixin.js"></script>
    <script src="/static/js/mixins/form-builder-mixin.js"></script>
    <script src="/static/js/components/GeoMap.js"></script>
    <script src="/static/js/components/UniField.js"></script>
    <script src="/static/js/components/DualField.js"></script>
    <script src="/static/js/components/SearchField.js"></script>
    <script src="/static/js/components/SplitView.js"></script>

    <script src="/static/js/components/RelatedBulletinsCard.js"></script>
    <script src="/static/js/components/RelatedActorsCard.js"></script>
    <script src="/static/js/components/RelatedIncidentsCard.js"></script>

    <script src="/static/js/components/BulletinCard.js"></script>
    <script src="/static/js/components/ActorCard.js"></script>
    <script src="/static/js/components/ActorProfiles.js"></script>
    <script src="/static/js/components/IncidentCard.js"></script>
    <script src="/static/js/components/ReadMore.js"></script>

    <script src="/static/js/components/BulletinSearchBox.js"></script>
    <script src="/static/js/components/ActorSearchBox.js"></script>
    <script src="/static/js/components/IncidentSearchBox.js"></script>



    <script src="/static/js/components/BulletinResult.js"></script>
    <script src="/static/js/components/ActorResult.js"></script>
    <script src="/static/js/components/IncidentResult.js"></script>

    <script src="/static/js/components/RelateBulletins.js"></script>
    <script src="/static/js/components/RelateActors.js"></script>
    <script src="/static/js/components/RelateIncidents.js"></script>
    <script src="/static/js/components/RelateItemsTemplate.js"></script>

    <script src="/static/js/components/EventCard.js"></script>
    <script src="/static/js/components/GlobalMap.js"></script>
    <script src="/static/js/components/PopDateField.js"></script>
    <script src="/static/js/components/PopDateTimeField.js"></script>
    <script src="/static/js/components/PopDateRangeField.js"></script>

    <script src="/static/js/components/GeoLocations.js"></script>
    <script src="/static/js/components/MediaGrid.js"></script>
    <script src="/static/js/components/MediaCard.js"></script>
    <script src="/static/js/components/MediaThumbnail.js"></script>
    <script src="/static/js/components/PreviewCard.js"></script>
    <script src="/static/js/components/RelationEditorCard.js"></script>
    <script src="/static/js/components/EventsSection.js"></script>
    <script src="/static/js/components/FieldRenderer.js"></script>

    <script src="/static/js/components/PdfViewer.js"></script>
    <script src="/static/js/components/ImageViewer.js"></script>
    <script src="/static/js/components/InlineMediaRenderer.js"></script>
    <script src="/static/js/components/Visualization.js"></script>
    <script src="/static/js/force-graph.min.js"></script>

    <script src="/static/js/components/MissingPersonCard.js"></script>

    <script src="/static/js/videojs/video.min.js"></script>

    {% if config.GOOGLE_MAPS_API_KEY %}
        {{ '<script src="https://maps.googleapis.com/maps/api/js?key='|safe + config.GOOGLE_MAPS_API_KEY + '&loading=async" async defer></script>'|safe }}
    {% endif %}

    <script nonce="{{ csp_nonce() }}" type="module">
        import * as jsondiffpatch from '/static/js/jsondiffpatch/jsondiffpatch.esm.min.js'
        import * as htmlFormatter from '/static/js/jsondiffpatch/formatters/html.js'
        import '/static/js/jsondiffpatch/formatters/base.js'
        window.__GOOGLE_MAPS_API_KEY__ = '{{ config.GOOGLE_MAPS_API_KEY }}';
        window.__EXPORT_TOOL__ = ('{{ config.EXPORT_TOOL }}' === 'True');

        const {createApp} = Vue;
        const {createVuetify} = Vuetify;
        const vuetify = createVuetify(vuetifyConfig);

        const app = createApp({
            delimiters: delimiters,
            mixins: [mediaMixin, globalMixin, relationsMixin, formBuilderMixin],
            data: () => ({
                commonDialogProps: { class: 'w-sm-100 w-md-75' },
                itemsPerPageOptions: window.itemsPerPageOptions,
                valid: false,
                rightDialogProps: null,
                translations: window.translations,
                validationRules: validationRules,
                advFeatures: ('{{ config.ADV_ANALYSIS }}' === 'True'),

                helper: {}, // helper object for review items

                cursorPage: 1,
                currentCursor: null,          // the current request's cursor
                nextCursor: null,             // the next cursor from the API
                cursorHistory: [null],        // page 1 starts at null
                perPage: window.itemsPerPageOptions?.[0] ?? 20,
                items: [],
                selected: [],

                assignIncident: {},
                selfAssignDialog: false,

                //global preview dialog
                preview: false,
                pitem: null,


                currentUser: JSON.parse(`{{ current_user.to_dict()|tojson }}`),
                users: JSON.parse(`{{users|tojson}}`),

                // advanced search

                advSearchExpand: false,
                search: {},


                showVisualize: false,
                visualizeLoading: false,
                graphTimer: null,

                queryName: null,
                saveQueryDialog: false,
                searchPanels: 0,

                searchTime: null,
                searches: [],
                savedSearchSelection: null,

                roles: [],


                fsloading: false,

                // flags for lazy loaded relations state
                br_loaded: false,
                ar_loaded: false,
                ir_loaded: false,
                br_loading: false,
                ar_loading: false,
                ir_loading: false,


                dialog: dialog,
                saving: false,
                eventDialog: false,
                reviewDialog: false,
                eventParams: {typ: 'for_bulletin'},
                reviewKey: 0,

                // search and relate bulletin dialog vars
                relateBulletinDialog: false,
                relateBulletinLoader: true,
                relateBulletinTerm: "",

                // search and relate incident dialog vars
                relateIncidentDialog: false,
                relateIncidentLoader: true,
                relateIncidentTerm: "",

                // search and relate actor dialog vars
                relateActorDialog: false,
                relateActorLoader: true,
                relateActorTerm: "",

                drawer: drawer,
                incidentDrawer: false,
                bulkIncidentDrawer: false,

                exportDrawer: false,
                exportConfig: {
                    format: 'pdf',
                    hideCSV: true,
                    hideMedia: true
                },


                sources: [],
                locations: [],
                labels: [],
                verLabels: [],
                eventtypes: [],
                potentialViolations: [],
                claimedViolations: [],

                statuses: JSON.parse(document.querySelector('[data-statuses]').dataset.statuses)
                    .map(s => ({en: s.title, tr: s.title_tr})),

                statusItems: JSON.parse(document.querySelector('[data-statuses]').dataset.statuses)
                    .map(s => ({en: s.title, tr: s.title_tr})),
                statusDisabled: false,


                //field language switchers
                title__: true,
                sjac_title__: true,
                //events fields
                eventTitle__: true,
                eventComments__: true,


                //source link extras
                source_alt: null,
                source_disabled: false,

                //rich text config
                tinyConfig: tinyConfig,

                loading: false,
                parentLoading: false,
                csvFile: null,
                options: {},

                searchLoading: {
                    assigned: false,
                    first: false,
                    second: false,
                    third: false
                },
                sourcesLoading: false,
                locationsLoading: false,
                eventLocationLoading: false,
                labelsLoading: false,
                eventtypeLoading: false,

                //event dates popups
                eventFromMenu: false,
                eventToMenu: false,

                headers: [
                    {title: "{{_('ID')}}", value: "id", width: 12, sortable: false},
                    {title: "{{_('Title')}}", value: "title", width: 300, sortable: false},
                    {% if (current_user.has_role('Admin') or current_user.has_role('DA')) %}
                        {title: "{{_('Assigned To')}}", value: "assigned_to.name", width: 130, sortable: false},
                        {title: "{{_('Access Groups')}}", value: "roles", width: 130, sortable: false},
                    {% endif %}
                    {title: "{{_('Status')}}", value: "status", width: 150, sortable: false},
                    {title: "{{_('Actions')}}", value: "action", sortable: false, width: 100}
                ],


                items: [],
                selected: [],
                itemsLength: 10,

                editedIndex: -1,
                editedItem: {
                    title: "",
                    events: [],
                    incident_relations: [],
                    bulletin_relations: [],
                    actor_relations: []
                },
                defaultItem: {
                    title: "",
                    description: "",

                    // related events
                    events: [],
                    // related incidents
                    incident_relations: [],

                    // related bulletins
                    bulletin_relations: [],

                    // related actors
                    actor_relations: [],
                    roles: []

                },

                reviewItem: {},

                unrestricted: false,

                // bulk actions
                // bulk actions
                bulk: {},
                bulkIcons: false,
                jobs: [],
                bulkTimer: 0,

                incident: {},
                incidentLoader: false,

                fetchingRecordsError: false,

                // Count functionality  
                totalCount: 0,

                serverErrors: {},
            }),

            computed: {
                rangeStart() {
                    return this.totalCount === 0 ? 0 : (this.cursorPage - 1) * this.perPage + 1;
                },
                rangeEnd() {
                    return this.totalCount === 0 ? 0 : this.rangeStart + this.items.length - 1;
                },
                showingItemsOfText() {
                    return "{{ _('Showing {items} of') }}".replace('{items}', this.items.length)
                },
                searchEmpty() {
                    return !Object.values(this.search).some(Boolean);
                },
                searchBg() {
                    return Object.values(this.search).some(Boolean) ? 'yellow-lighten-5' : '';
                },

                bulletinRelationTypes() {
                    return this.itobInfo;
                },
                actorRelationTypes() {
                    return this.itoaInfo;
                },
                incidentRelationTypes() {
                    return this.itoiInfo;
                },
                bulletinRelationMultiple() {
                    return false;
                },
                actorRelationMultiple() {
                    return true;
                },
                incidentRelationMultiple() {
                    return false;
                },



                exBulletins() {
                    return this.getExcludedIds({ type: 'bulletin', editedItem: this.editedItem, reviewItem: this.reviewItem });
                },

                exActors() {
                    return this.getExcludedIds({ type: 'actor', editedItem: this.editedItem, reviewItem: this.reviewItem });
                },

                exIncidents() {
                    return this.getExcludedIds({ type: 'incident', includeSelf: true, editedItem: this.editedItem, reviewItem: this.reviewItem });
                },
                
                formTitle() {
                    return this.editedItem.id ? "{{_('Edit Incident')}}" : "{{_('New Incident')}}";
                },

                videoPlayer() {
                    return document.querySelector("#player");
                },

                allowedRoles() {
                    if (this.has_role(this.currentUser, 'Admin')) {
                        return this.roles;
                    }
                    return this.currentUser.roles;
                },
            },

            watch: {

                incidentDrawer: function (val) {
                    if (val === false) {
                        this.incident = {};
                        if (this.$route.path !== '/admin/incidents/')
                            this.$router.push('/admin/incidents/')
                    }
                },


                selected: {
                    handler(val) {
                        this.bulkIcons = !!val.length;
                    },
                    deep: true, // Enable deep watching
                    //  immediate: true
                },


                eventDialog(val) {
                    val || this.closeEvent();
                },


            },
            mounted: function () {
                // populate roles for advanced search for admins
                {% if current_user.has_role('Admin') %}
                    api.get('/admin/api/roles/').then(res => {
                        this.roles = res.data.items;
                    }).catch(e => {
                        this.roles = [];
                        console.log(e.message);
                    });
                {% endif  %}

                // display confirmation alert if edit dialog is open.
                let self = this;
                window.addEventListener("beforeunload", function (e) {
                    if (self.dialog) {
                        var confirmationMessage = "{{_('It looks like you have been editing something. ')}}"
                            + "{{_('If you leave before saving, your changes will be lost.')}}";
                        (e || window.event).returnValue = confirmationMessage; //Gecko + IE
                        return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
                    }
                });

                this.handleRoute({ initialLoad: true });
                this.$router.afterEach(() => {
                    this.handleRoute();
                });
            },

            methods: {
                handleRoute({ initialLoad = false } = {}) {
                    if (this.$route.params.id) this.showIncident(this.$route.params.id);
                    if (this.$route.query.reltob) return this.filter_related_to_bulletin(this.$route.query.reltob);
                    if (this.$route.query.reltoa) return this.filter_related_to_actor(this.$route.query.reltoa);
                    if (this.$route.query.reltoi) return this.filter_related_to_incident(this.$route.query.reltoi);

                    // Only refresh on initial page load
                    if (initialLoad) this.refresh();
                },
                validateForm() {
                    this.$refs.form.validate().then(({ valid, errors }) => {
                        if (valid) {
                            this.save();
                        } else {
                            this.showSnack("{{ _('Please review the form for errors.')}}")
                            scrollToFirstError()
                        }
                    });
                },

                checkGraphStatus: function () {
                    api.get('/admin/api/graph/status')
                        .then(res => {
                            if (res.data.status == 'done') {
                                clearInterval(this.graphTimer);
                                this.visualizeLoading = false;
                                this.$refs.viz.visualizeQuery();


                            }

                        })
                        .catch(error => {
                            console.error('API check failed:', error);
                        });
                },

                visualizeResults() {
                    this.visualizeLoading = true;
                    api.post('/admin/api/graph/visualize', {q: this.search}, {
                        params: {
                            type: 'incident'
                        }
                    }).then(res => {
                        this.showSnack("{{ _('Graph is being generated.') }}");
                        this.graphTimer = setInterval(this.checkGraphStatus, 3000);
                    }).catch(e => {
                        this.visualizeLoading = false;
                        console.error(e.message);
                    }).finally(() => {
                    });
                },

                exportRequest() {
                    this.loading = true;
                    api.post(`/export/api/incident/export`, {
                        items: this.selected,
                        config: this.exportConfig
                    }).then(response => {
                        this.showSnack(response.data);
                        this.exportDrawer = false;
                        this.selected = [];
                        this.exportConfig = {
                            format: 'pdf',
                            hideCSV: true,
                            hideMedia: true
                        };
                    }).catch(error => {
                        console.error(error.response?.data);
                    }).finally(() => {
                        this.loading = false;

                    });
                },

                rowClass(row) {
                    if (row.item.restricted) {
                        row.item.selectable = false;
                        return {class: 'restricted'}
                    }
                    return {class: ''}
                },

                openSelfAssign(incident) {
                    this.assignIncident = {id: incident.id};
                    this.selfAssignDialog = true;

                },

                selfAssign() {


                    api.put(`/admin/api/incident/assign/${this.assignIncident.id}`, {incident: this.assignIncident}).then(res => {
                        this.showSnack("{{_('Incident assigned successfully.')}}")
                        this.refresh()

                    }).finally(() => {
                        this.selfAssignDialog = false;
                        this.assignIncident = {};

                    });

                },

                filter_related_to_bulletin(id) {
                    this.incidentDrawer = false;
                    this.search = {rel_to_bulletin: id};
                    this.goToFirstPage();
                },

                filter_related_to_actor(id) {
                    this.incidentDrawer = false;
                    this.search = {rel_to_actor: id};
                    this.goToFirstPage();
                },

                filter_related_to_incident(id) {
                    this.incidentDrawer = false;
                    this.search = {rel_to_incident: id};
                    this.goToFirstPage();
                },

                previewItem(endpoint) {

                    api.get(endpoint).then(res => {
                        this.pitem = res.data;
                        this.preview = true;

                    })
                },


                bulkStatus() {

                    api.get('/admin/api/bulk/status/?type=incident').then(res => {
                        this.jobs = res?.data?.data ?? [];
                        if (!this.jobs.length) {
                            clearInterval(this.bulkTimer);
                            //reset search pager
                            this.options.page = 1;
                            this.goToFirstPage();
                            this.showSnack("{{_('Bulk Update is finished!')}}")
                        }
                    });

                },


                // bulk updates


                bulk_update() {
                    this.loading = true;
                    api.put(`/admin/api/incident/bulk/`, {
                        items: this.selected,
                        bulk: this.bulk
                    }).then(response => {
                        this.showSnack(response.data);
                        this.refresh();
                        //reset bulk drawer, and bulk data
                        this.bulkIncidentDrawer = false;
                        this.selected = [];
                        this.bulk = {};
                        clearInterval(this.bulkTimer);
                        // if (!this.bulkProcInterval)
                        this.bulkTimer = setInterval(this.bulkStatus, 3000);
                    }).finally(() => {
                        this.loading = false;
                    });
                },


                // - ------------------ incidents search methods  ---------------------------------

                toggleAdvSearch() {
                    this.advSearchExpand = !this.advSearchExpand
                    this.advSearchMenu = !this.advSearchMenu;
                    this.$nextTick(() => {
                        // trick to just invoke the binding
                        //this.search = {tsv:this.search.tsv}
                    })
                },

                doSearch() {
                    this.advSearchExpand = this.advSearchExpand && false;
                    this.goToFirstPage();
                },

                resetQuery() {
                    this.savedSearchSelection = null;
                    this.search = {};
                },


                resetSearch() {
                    this.resetQuery();
                    this.goToFirstPage();
                },

                setNextPerPageValue(nextPerPage) {
                    this.perPage = nextPerPage;
                    this.goToFirstPage();
                },

                refresh() {
                    if (this.loading) return;

                    this.loading = true;
                    const startTime = new Date()

                    const requestData = {
                        q: this.search,
                        per_page: this.perPage,
                        cursor: this.currentCursor,
                        include_count: true,
                    };

                    axios.post('/admin/api/incidents/', requestData)
                        .then((response) => {
                            const endTime = new Date()
                            const duration = endTime - startTime
                            this.searchTime = ((endTime - startTime) / 1000).toFixed(2);
                            console.log(`API call took ${duration}ms`)

                            this.items = response.data.items;
                            this.showVisualize = !(
                                Object.keys(this.search).length === 0
                            );
                            if ('total' in response.data) {
                                this.totalCount = response.data.total
                                this.countType = response.data.totalType
                            }
                            this.nextCursor = response.data.nextCursor || null;
                        })
                        .catch((error) => {
                            console.error('Error loading data:', error);
                            this.showSnack('Error loading data');
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },

                goToFirstPage() {
                    if (this.loading) return;

                    this.currentCursor = null;
                    this.cursorPage = 1

                    this.refresh();
                },

                goToNextPage() {
                    if (this.loading || !this.nextCursor) return;

                    this.currentCursor = this.nextCursor;
                    this.cursorPage++;

                    // Save currentCursor before moving to next page
                    this.cursorHistory[this.cursorPage - 1] = this.currentCursor;

                    this.refresh();
                },

                goToPrevPage() {
                    if (this.loading || this.cursorPage <= 1) return;

                    this.cursorPage--;

                    this.currentCursor = this.cursorHistory[this.cursorPage - 1] || null;
                    this.refresh();
                },

                openSaveQueryDialog() {
                    // Separate method to include auto-focus on input

                    this.saveQueryDialog = true;
                    this.$nextTick(() => {
                        setTimeout(() => {
                            this.$refs.saveQueryInput.focus();
                        }, 0);
                    })
                },

                loadSearch(item) {

                    if (item) {
                        this.savedSearchSelection = Object.assign([], item);
                        this.search = item.data;
                    }
                    this.$refs.savedSearchDropdown.blur()
                },


                loadSearchesFromAPI(selectLast = false) {
                    api.get('/admin/api/queries/', {
                        params: {
                            type: 'incident'
                        }
                    }).then(
                        res => {
                            this.searches = res?.data?.data ?? [];
                            if (selectLast === true) {

                                this.savedSearchSelection = this.searches.at(-1);


                            }
                        }
                    );

                },

                saveSearch() {
                    const newSearch = {q: this.search, name: this.queryName, type: 'incident'};

                    api.post('/admin/api/query/', newSearch)
                        .then(res => {
                            this.showSnack(res.data);
                            this.saveQueryDialog = false;


                            this.queryName = null;
                            // just reload searches and select the last one
                            this.loadSearchesFromAPI(true);
                        });
                },


                updateSearch() {
                    api.put('/admin/api/query/' + this.savedSearchSelection.id, {q: this.search})
                        .then(res => {
                            this.showSnack(res.data);
                        });
                },


                deleteSearch(id) {
                    api.delete('/admin/api/query/' + id)
                        .then(res => {
                            this.showSnack(res.data);
                            this.searches = this.searches.filter(item => item.id !== id);
                        });
                },

                // - ------------------ end incidents search methods  ---------------------------------


                /* Incidents Custom Lists */

                allIncidents() {
                    this.search = {};
                    this.goToFirstPage();

                },
                myAssigned() {
                    this.search = {};
                    this.search.assigned = [this.currentUser.id];
                    this.search.statuses = ["Assigned"];
                    this.goToFirstPage();
                },

                myReview() {
                    this.search = {};
                    this.search.reviewer = [this.currentUser.id];
                    this.search.statuses = ["Peer Review Assigned"];
                    this.goToFirstPage();
                },


                //reset initial visible fields to english language

                resetSwitchers: function () {
                    this.title__ = true;
                    this.sjac_title__ = true;
                },


                rowClick(e, row) {
                    const item = row.item;
                    if (item.restricted) {
                        this.showSnack("{{_('This item is restricted.')}}")
                        return
                    }
                    const path = `/admin/incidents/${item.id}`;
                    if (this.$route.path !== path)
                        this.$router.push(path);

                },

                showIncident(id) {
                    this.incidentLoader = true;
                    this.incidentDrawer = true;
                    api.get(`/admin/api/incident/${id}?mode=3`).then(response => {
                        this.incident = response.data;
                    }).catch(error => {
                        this.incidentDrawer = false;
                    }).finally(() => {
                        this.incidentLoader = false;
                    });
                },

                searchUsers: debounce(function (evt) {
                    this.searchLoading[evt.target.dataset.loader] = true;

                    api.get(`/admin/api/users/?q=${evt.target.value}`).then(response => {
                        this.users = response.data.items;
                        this.searchLoading[evt.target.dataset.loader] = false;
                    });
                }, 350),


                handleStatus(incident) {


                    if (this.editedItem.id) {
                        // edit existing bulletin mode
                        if (this.has_role(this.currentUser, 'Admin')) {

                            this.statusDisabled = false;
                            return;
                        }

                        // else is a standard user
                        this.statusItems = this.statuses;

                        if (this.editedItem.status == 'Assigned' || this.editedItem.status == 'Human Created') {
                            this.editedItem.status = this.statusItems[2].en;
                        }

                        if (this.editedItem.status == 'Peer Reviewed') {
                            this.editedItem.status = this.statusItems[9].en;
                        }

                        this.statusDisabled = true;
                    } else {
                        // new bulletin mode

                        this.editedItem.status = this.statusItems[1].en;
                        this.statusDisabled = true;

                    }
                },


                has_role(user, role) {
                    for (const r of user.roles) {
                        if (r.name === role) {
                            return true
                        }
                    }
                    return false;
                },

                bulkAllowed() {
                    if (this.has_role(this.currentUser, 'Admin')) {
                        return true;
                    }
                    if (this.has_role(this.currentUser, 'Mod')) {
                        return true;
                    }
                    return false;
                },

                exportAllowed() {
                    if (__EXPORT_TOOL__) {
                        if (this.has_role(this.currentUser, 'Admin')) {
                            return true;
                        }
                        if (this.currentUser.can_export) {
                            return true;
                        }
                    }
                    return false;
                },

                editAllowed(incident) {
                    if (incident.restricted) {
                        return false;
                    }
                    if (this.has_role(this.currentUser, 'Admin')) {
                        return true;
                    }
                    if (!this.has_role(this.currentUser, 'DA')) {
                        return false;
                    }
                    const statuses = ['Human Created', 'Assigned', 'Updated', 'Peer Reviewed', 'Revisited'];
                    if (incident.assigned_to && incident.assigned_to.id == this.currentUser.id && statuses.includes(incident.status)) {
                        return true
                    }
                    return false;
                },

                reviewAllowed(incident) {

                    if (incident.restricted) {
                        return false;
                    }

                    if (!this.currentUser.roles.length) {
                        return false;
                    }

                    const statuses = ['Peer Review Assigned', 'Peer Reviewed'];
                    if (incident.first_peer_reviewer && incident.first_peer_reviewer.id == this.currentUser.id && statuses.includes(incident.status)) {
                        return true
                    }
                    return false;
                },


                selfAssignAllowed(incident) {

                    if (incident.restricted) {
                        return false;
                    }


                    if (this.currentUser.can_self_assign) {
                        if ((!incident.assigned_to) || (incident.assigned_to && !incident.assigned_to.active)) {
                            return true
                        }

                    }

                    return false;

                },

                addReview(item) {
                    this.loading = true;
                    this.reviewDialog = true;
                    api.get(`/admin/api/incident/${item.id}`).then(response => {
                        this.loading = false;
                        this.$nextTick(() => {
                            this.reviewItem = response.data;
                            this.reviewKey += 1;
                            if (!response.data.review) {
                                this.reviewItem.review = '';
                            }
                        })


                    })
                },

                saveReview() {

                    api.put(`/admin/api/incident/review/${this.reviewItem.id}`, {
                        item: this.reviewItem
                    })
                        .then(response => {
                            this.reviewDialog = false;
                            this.showSnack(response.data);
                            this.refresh();
                        });

                },

                loadBulletinRelations() {
                    // UI feedback
                    this.br_loading = true;
                    // pass page=0 to load all relations
                    api.get(`/admin/api/incident/relations/${this.editedItem.id}?class=bulletin&page=0`).then(res => {

                        this.editedItem.bulletin_relations = res.data.items;
                        // update UI state / show related items
                        this.br_loaded = true;

                        // smart trick to pass relation update flag : attach a variable to the payload itself
                        this.editedItem.check_br = true;
                    }).catch(err => {
                        console.log(err.toJSON());
                    }).finally(() => {
                        this.br_loading = false;
                    });

                },

                loadActorRelations() {

                    //UI feedback
                    this.ar_loading = true;
                    // pass page=0 to load all relations
                    api.get(`/admin/api/incident/relations/${this.editedItem.id}?class=actor&page=0`).then(res => {

                        this.editedItem.actor_relations = res.data.items;
                        // update UI state / show related items
                        this.ar_loaded = true;

                        // smart trick to pass relation update flag : attach a variable to the payload itself
                        this.editedItem.check_ar = true;
                    }).catch(err => {
                        console.log(err.toJSON());
                    }).finally(() => {
                        this.ar_loading = false;
                    });

                },

                loadIncidentRelations() {

                    //UI Feedback
                    this.ir_loading = true;
                    // pass page=0 to load all relations
                    api.get(`/admin/api/incident/relations/${this.editedItem.id}?class=incident&page=0`).then(res => {

                        this.editedItem.incident_relations = res.data.items;
                        // update UI state / show related items
                        this.ir_loaded = true;

                        // smart trick to pass relation update flag : attach a variable to the payload itself
                        this.editedItem.check_ir = true;
                    }).catch(err => {
                        console.log(err.toJSON());
                    }).finally(() => {
                        this.ir_loading = false;
                    });

                },


                editItem(item) {
                    this.fetchDynamicFields({ entityType: 'incident' });


                    if (!item.id) {
                        // new incident
                        this.editedItem = JSON.parse(JSON.stringify(this.defaultItem));
                        this.editedItem.check_br = true;
                        this.br_loaded = true;
                        this.editedItem.check_ir = true;
                        this.ir_loaded = true;
                        this.editedItem.check_ar = true;
                        this.ar_loaded = true;
                        this.source_alt = null;
                        this.dialog = true;
                        this.handleStatus(item);
                    } else {
                        this.loading = true;
                        api.get(`/admin/api/incident/${item.id}?mode=3`).then(response => {
                            this.dialog = true;
                            this.$nextTick(() => {
                                this.loading = false
                                this.editedItem = response.data;


                                this.editedItem.comments = '';
                                this.resetSwitchers();
                                this.handleStatus(item);

                            });


                        }).finally(() => {
                            this.loading = false;
                        });


                    }


                    //this.locations = this.editedItem.locations;
                },

                deleteItem(item) {
                    const index = this.items.indexOf(item);
                    const cfm =
                        confirm("{{_('Are you sure you want to delete this item?')}}") &&
                        this.items.splice(index, 1);
                    if (cfm) {
                        api.delete(`/admin/api/incident/${item.id}`).then(response => {
                            this.showSnack(response.data);
                            this.refresh();
                        });
                    }
                },

                confirmClose() {
                    if (confirm(translations.areYouSure_)) {
                        this.close();
                    }
                },
                close() {
                    this.dialog = false;
                    setTimeout(() => {
                        this.editedItem = Object.assign({}, this.defaultItem);
                        this.unrestricted = false;
                        this.editedIndex = -1;
                        this.unrestricted = false;
                        this.br_loaded = false;
                        this.ir_loaded = false;
                        this.ar_loaded = false;
                        this.saving = false;
                        this.serverErrors = {}
                    }, 300);
                },

                save() {
                    this.saving = true;
                    if (this.editedItem.id) {
                        //update record
                        api.put(`/admin/api/incident/${this.editedItem.id}`, {
                            item: this.editedItem
                        }).then(response => {
                            this.showSnack(response.data);
                            this.refresh();
                            this.close();
                        }).catch(err => {
                            console.error(err.response?.data);
                            this.serverErrors = err.response?.data?.errors || {};
                            this.$nextTick(() => scrollToFirstError());
                        }).finally(() => {
                            this.saving = false;
                        });
                    } else {
                        //create new record
                        api.post("/admin/api/incident/", {
                            item: this.editedItem
                        }).then(response => {
                            this.items.unshift(response.data.item);
                            this.totalCount += 1;
                            this.showSnack(response.data.message);
                            this.close();
                        }).catch(err => {
                            console.error(err.response?.data);
                            this.serverErrors = err.response?.data?.errors || {};
                            this.$nextTick(() => scrollToFirstError());
                        }).finally(() => {
                            this.saving = false;
                        });
                    }
                },

                // related actors functions --------------------
                searchRelatedActors() {
                    this.searchRelatedItems({ ref: this.$refs.relateActors, searchTerm: this.relateActorTerm })
                },
                relateActor({ item, relationData }) {
                    this.addItemToRelation({
                        type: 'actor',
                        relationList: this.editedItem.actor_relations,
                        item,
                        relationData,
                    })
                },
                removeActor(evt, index) {
                    this.removeFromRelationList({ relationList: this.editedItem.actor_relations, index })
                },

                // related bulletins functions --------------------
                searchRelatedBulletins() {
                    this.searchRelatedItems({ ref: this.$refs.relateBulletins, searchTerm: this.relateBulletinTerm })
                },
                relateBulletin({ item, relationData }) {
                    this.addItemToRelation({
                        type: 'bulletin',
                        relationList: this.editedItem.bulletin_relations,
                        item,
                        relationData,
                    })
                },
                removeBulletin(evt, index) {
                    this.removeFromRelationList({ relationList: this.editedItem.bulletin_relations, index })
                },

                // related incidents functions ------------------------
                searchRelatedIncidents() {
                    this.searchRelatedItems({ ref: this.$refs.relateIncidents, searchTerm: this.relateIncidentTerm })
                },
                relateIncident({ item, relationData }) {
                    this.addItemToRelation({
                        type: 'incident',
                        relationList: this.editedItem.incident_relations,
                        item,
                        relationData,
                    })
                },
                removeIncident(evt, index) {
                    this.removeFromRelationList({ relationList: this.editedItem.incident_relations, index })
                },

                clearAssignee() {
                    if (this.bulk.assigneeClear){
                        this.bulk.assigned_to_id = null;
                    }
                },

                clearReviewer() {
                    if (this.bulk.reviewerClear){
                        this.bulk.first_peer_reviewer_id = null;
                    }
                }
            }
        });

        app.config.globalProperties.$jsondiffpatch = jsondiffpatch;
        app.config.globalProperties.$htmlFormatter = htmlFormatter;

        app.component("TinymceEditor", Editor);
        app.component('SplitView', SplitView);
        app.component('SearchField', SearchField);
        app.component('UniField', UniField);
        app.component('DualField', DualField);
        app.component('LocationSearchField', LocationSearchField);
        app.component('GeoMap', GeoMap);
        app.component('RelateBulletins', RelateBulletins);
        app.component('RelateActors', RelateActors);
        app.component('RelateIncidents', RelateIncidents);
        app.component('RelateItemsTemplate', RelateItemsTemplate);
        app.component('BulletinResult', BulletinResult);
        app.component('BulletinSearchBox', BulletinSearchBox);
        app.component('ActorSearchBox', ActorSearchBox);
        app.component('IncidentSearchBox', IncidentSearchBox);
        app.component('ActorResult', ActorResult);
        app.component('IncidentResult', IncidentResult);

        app.component('RelatedBulletinsCard', RelatedBulletinsCard);
        app.component('RelatedActorsCard', RelatedActorsCard);
        app.component('RelatedIncidentsCard', RelatedIncidentsCard);

        app.component('ReadMore', ReadMore);
        app.component('BulletinCard', BulletinCard);
        app.component('ActorCard', ActorCard);
        app.component('ActorProfiles', ActorProfiles);
        app.component('IncidentCard', IncidentCard);
        app.component('MissingPersonCard', MissingPersonCard);
        app.component('EventCard', EventCard);
        app.component('PopDateField', PopDateField);
        app.component('PopDateTimeField', PopDateTimeField);
        app.component('PopDateRangeField', PopDateRangeField);
        app.component('GeoLocations', GeoLocations);
        app.component('GlobalMap', GlobalMap);
        app.component('MediaGrid', MediaGrid);
        app.component('MediaCard', MediaCard);
        app.component('MediaThumbnail', MediaThumbnail);
        app.component('Visualization', Visualization);
        app.component('PdfViewer', PdfViewer);
        app.component('ImageViewer', ImageViewer);
        app.component('InlineMediaRenderer', InlineMediaRenderer);
        app.component('PreviewCard', PreviewCard);
        app.component('RelationEditorCard', RelationEditorCard);
        app.component('EventsSection', EventsSection);
        app.component('FieldRenderer', FieldRenderer);

        app.use(router).use(vuetify);
        router.isReady().then(() => {
            app.mount('#app');
            window.app = app;
        });
    </script>
{% endblock %}
