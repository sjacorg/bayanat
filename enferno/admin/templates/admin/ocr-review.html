{% extends 'layout.html' %} 
{% block content %}
<v-main>
    <v-container fluid>
        <v-card>
            <!-- Header -->
            <v-toolbar flat>
                <v-toolbar-title>{{ _('OCR Review Queue') }}</v-toolbar-title>
                <v-spacer></v-spacer>
                
                <!-- Progress Counter -->
                <v-chip variant="tonal" color="primary" class="mr-4">
                    <span v-if="total > 0">${currentIndex + 1} {{ _('of') }} ${total}</span>
                    <span v-else>0 {{ _('of') }} 0</span>
                </v-chip>

                <!-- Filter -->
                <v-select
                    v-model="filter"
                    :items="filterOptions"
                    label="{{ _('Filter') }}"
                    variant="outlined"
                    density="compact"
                    style="max-width: 200px;"
                    @update:model-value="loadQueue"
                    hide-details
                    class="pr-6"
                ></v-select>
            </v-toolbar>

            <v-divider></v-divider>

            <!-- Main Content -->
            <v-card-text v-if="currentItem" class="pa-6" style="height: calc(100vh - 161px);overflow-y: auto;">
                <v-row>
                    <!-- Left Side - Image Preview -->
                    <v-col cols="12" md="6">
                        <v-card variant="outlined" class="image-preview-card border-thin">
                            <v-card-text class="pa-0">
                                <div class="text-center pa-4" style="height: calc(100vh - 350px)">
                                    <image-viewer 
                                        v-if="currentItem.media_url"
                                        mode="click" 
                                        :media="{ 
                                            thumbnail_url: currentItem.media_url, 
                                            s3url: currentItem.media_url 
                                        }"
                                        class="h-100"
                                    >
                                    </image-viewer>
                                    <v-skeleton-loader 
                                        v-else 
                                        type="image" 
                                        height="500px"
                                    ></v-skeleton-loader>
                                </div>
                                <v-card-subtitle class="text-center text-caption">
                                    ${currentItem.media_filename}
                                    <br>
                                    <span class="text-medium-emphasis">{{ _('Click to zoom') }}</span>
                                </v-card-subtitle>
                            </v-card-text>
                        </v-card>
                    </v-col>

                    <!-- Right Side - Info Panel -->
                    <v-col cols="12" md="6">
                        <v-card variant="outlined" class="border-thin" style="height: calc(100vh - 314px)">
                            <v-card-text>
                                <!-- Bulletin Info -->
                                <div class="mb-4">
                                    <v-btn
                                        variant="tonal"
                                        prepend-icon="mdi-file-document"
                                        :href="`/admin/bulletins/${currentItem.bulletin.id}`"
                                        target="_blank"
                                        block
                                    >
                                        {{ _('Bulletin') }} ${currentItem.bulletin.ref}
                                    </v-btn>
                                    <div class="text-caption text-medium-emphasis mt-2">
                                        ${currentItem.bulletin.title}
                                    </div>
                                </div>

                                <v-divider class="my-4"></v-divider>

                                <!-- Confidence -->
                                <div class="mb-4">
                                    <div class="text-subtitle-2 mb-2">{{ _('Confidence') }}</div>
                                    <v-progress-linear
                                        :model-value="currentItem.confidence"
                                        :color="getConfidenceColor(currentItem.confidence)"
                                        height="20"
                                        rounded
                                    >
                                        <template v-slot:default>
                                            <strong>${Math.round(currentItem.confidence)}%</strong>
                                        </template>
                                    </v-progress-linear>
                                    <div class="text-caption text-medium-emphasis mt-1">
                                        ${getConfidenceLabel(currentItem.confidence)}
                                    </div>
                                </div>

                                <v-divider class="my-4"></v-divider>

                                <!-- Extracted Text -->
                                <div>
                                    <div class="text-subtitle-2 mb-2">{{ _('Extracted Text') }}</div>
                                    <v-textarea
                                        :model-value="currentItem.text"
                                        variant="outlined"
                                        readonly
                                        no-resize
                                        rows="12"
                                        :dir="isRTL(currentItem.text) ? 'rtl' : 'ltr'"
                                    ></v-textarea>
                                </div>
                            </v-card-text>
                        </v-card>
                    </v-col>
                </v-row>

                <!-- Action Buttons -->
                <v-row class="mt-4">
                    <v-col class="text-center">
                        <v-btn
                            color="success"
                            variant="elevated"
                            size="large"
                            prepend-icon="mdi-check"
                            @click="acceptItem"
                            :loading="actionLoading === 'accept'"
                            class="mx-2"
                        >
                            {{ _('Accept') }}
                        </v-btn>

                        <v-btn
                            color="warning"
                            variant="elevated"
                            size="large"
                            prepend-icon="mdi-pencil"
                            @click="transcribeItem"
                            :loading="actionLoading === 'transcribe'"
                            class="mx-2"
                        >
                            {{ _('Transcribe') }}
                        </v-btn>

                        <v-btn
                            variant="text"
                            size="large"
                            append-icon="mdi-arrow-right"
                            @click="skipItem"
                            class="mx-2"
                        >
                            {{ _('Skip') }}
                        </v-btn>
                    </v-col>
                </v-row>

                <!-- Keyboard Shortcuts Info -->
                <v-row>
                    <v-col class="text-center">
                        <div class="text-caption text-medium-emphasis">
                            {{ _('Keyboard') }}: A = {{ _('Accept') }}, T = {{ _('Transcribe') }}, → = {{ _('Skip') }}
                        </div>
                    </v-col>
                </v-row>
            </v-card-text>

            <!-- Empty State -->
            <v-card-text v-else class="pa-12">
                <v-row>
                    <v-col class="text-center">
                        <v-icon size="80" color="grey-lighten-1">mdi-check-all</v-icon>
                        <div class="text-h5 mt-4 text-medium-emphasis">
                            {{ _('No items to review') }}
                        </div>
                        <div class="text-body-2 text-medium-emphasis mt-2">
                            {{ _('All items in the queue have been processed') }}
                        </div>
                    </v-col>
                </v-row>
            </v-card-text>

            <!-- Loading State -->
            <v-overlay :model-value="loading" contained class="align-center justify-center">
                <v-progress-circular indeterminate size="64"></v-progress-circular>
            </v-overlay>
        </v-card>
    </v-container>
</v-main>

{% endblock %} 

{% block js %}
<script src="/static/js/components/ImageViewer.js"></script>

<script>
const {createApp} = Vue;
const {createVuetify} = Vuetify;
const vuetify = createVuetify(vuetifyConfig);

const app = createApp({
    delimiters: delimiters,
    mixins: [globalMixin],

    data: () => ({
        drawer: drawer,
        loading: true,
        actionLoading: null, // 'accept', 'transcribe', or null
        
        currentIndex: 0,
        items: [],
        total: 0,
        currentItem: null,

        filter: 'all',
        filterOptions: [
            { title: "{{_('All')}}", value: 'all' },
            { title: "{{_('Medium Confidence')}}", value: 'medium' },
            { title: "{{_('Low Confidence')}}", value: 'low' }
        ]
    }),

    mounted() {
        this.loadQueue();
        this.setupKeyboardShortcuts();
    },

    beforeUnmount() {
        this.removeKeyboardShortcuts();
    },

    methods: {
        async loadQueue() {
            this.loading = true;
            this.currentIndex = 0;

            // TODO: Replace with real API call
            // try {
            //     const response = await api.get('/admin/api/ocr/review', {
            //         params: { status: 'needs_review', filter: this.filter }
            //     });
            //     this.items = response.data.items;
            //     this.total = response.data.total;
            // } catch (error) {
            //     this.showSnack({ message: 'Failed to load queue', type: 'error' });
            // }

            // Placeholder data - remove this when API is ready
            this.loadPlaceholderData();
            this.updateCurrentItem();
            this.loading = false;
        },

        loadPlaceholderData() {
            const sampleTexts = [
                'هذا نص تجريبي باللغة العربية. يحتوي على معلومات حول انتهاكات حقوق الإنسان والاحتجاز التعسفي. قد يحتوي النص على أخطاء تحتاج إلى مراجعة وتصحيح.',
                'This document contains information about detention facilities in the northern region. Multiple violations of human rights have been documented, including arbitrary detention and lack of access to legal counsel. This document contains information about detention facilities in the northern region. Multiple violations of human rights have been documented, including arbitrary detention and lack of access to legal counsel. This document contains information about detention facilities in the northern region. Multiple violations of human rights have been documented, including arbitrary detention and lack of access to legal counsel. This document contains information about detention facilities in the northern region. Multiple violations of human rights have been documented, including arbitrary detention and lack of access to legal counsel. This document contains information about detention facilities in the northern region. Multiple violations of human rights have been documented, including arbitrary detention and lack of access to legal counsel. This document contains information about detention facilities in the northern region. Multiple violations of human rights have been documented, including arbitrary detention and lack of access to legal counsel.',
                'Report dated March 15, 2023: Witness testimony indicates systematic abuse at facility #7. Detainees report lack of medical care and inadequate food supplies. Further investigation required.',
                'تقرير عن مركز الاحتجاز رقم ٣. تم توثيق حالات تعذيب وسوء معاملة. الشهود أفادوا بعدم وجود رعاية طبية كافية.',
                'Internal memo regarding conditions at detention center. Staff shortages reported. Overcrowding remains a critical issue affecting detainee welfare.',
                'شهادة المعتقل السابق: تم احتجازي لمدة ٤٥ يومًا دون تهمة. لم يُسمح لي بالاتصال بمحامٍ أو عائلتي.',
                'Investigation findings: Evidence of systematic mistreatment documented across three facilities. Recommendations include immediate oversight and staff training.',
                'ملاحظات ميدانية من الزيارة التفتيشية. ظروف غير صحية. نقص في الأسرة والبطانيات. يحتاج المرفق إلى تجديد عاجل.',
                'Legal documentation: Case #2847 involves unlawful detention spanning 8 months. Subject denied access to family visits and legal representation.',
                'تحليل الأنماط: ٧٨٪ من الحالات المسجلة تشير إلى احتجاز تعسفي. يوصى باتخاذ إجراءات فورية لمعالجة هذه الانتهاكات.'
            ];

            const placeholderItems = [];
            for (let i = 1; i <= 10; i++) {
                placeholderItems.push({
                    id: 120 + i,
                    media_id: 450 + i,
                    media_url: `https://picsum.photos/seed/${i}/600/800`,
                    media_filename: `scan_2023_05_${String(i).padStart(2, '0')}.jpg`,
                    bulletin: {
                        id: 12340 + i,
                        title: `Document about detention facility ${i}`,
                        ref: `#${12340 + i}`
                    },
                    text: sampleTexts[i - 1],
                    confidence: 70 + (i * 1.5),
                    created_at: new Date(2026, 0, i).toISOString()
                });
            }
            
            this.items = placeholderItems;
            this.total = placeholderItems.length;
        },

        updateCurrentItem() {
            if (this.currentIndex >= 0 && this.currentIndex < this.items.length) {
                this.currentItem = this.items[this.currentIndex];
            } else {
                this.currentItem = null;
            }
        },

        async acceptItem() {
            if (!this.currentItem) return;
            
            this.actionLoading = 'accept';

            try {
                // TODO: Replace with real API call
                // await api.post(`/admin/api/ocr/${this.currentItem.id}/accept`);
                
                // Placeholder - simulate API call
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.showSnack({ message: 'Item accepted', type: 'success' });
                this.removeCurrentAndLoadNext();
            } catch (error) {
                this.showSnack({ message: 'Failed to accept item', type: 'error' });
            } finally {
                this.actionLoading = null;
            }
        },

        async transcribeItem() {
            if (!this.currentItem) return;
            
            this.actionLoading = 'transcribe';

            try {
                // TODO: Replace with real API call
                // await api.post(`/admin/api/ocr/${this.currentItem.id}/transcribe`);
                
                // Placeholder - simulate API call
                await new Promise(resolve => setTimeout(resolve, 300));
                
                this.showSnack({ message: 'Sent to transcription queue', type: 'success' });
                this.removeCurrentAndLoadNext();
            } catch (error) {
                this.showSnack({ message: 'Failed to send to transcription', type: 'error' });
            } finally {
                this.actionLoading = null;
            }
        },

        skipItem() {
            if (!this.currentItem) return;
            
            // Just move to next item without API call
            this.currentIndex++;
            if (this.currentIndex >= this.items.length) {
                this.currentIndex = 0; // Loop back to start
            }
            this.updateCurrentItem();
        },

        removeCurrentAndLoadNext() {
            // Remove current item from array
            this.items.splice(this.currentIndex, 1);
            this.total--;
            
            // Update current item (stay at same index, next item slides in)
            if (this.currentIndex >= this.items.length && this.currentIndex > 0) {
                this.currentIndex--;
            }
            this.updateCurrentItem();
        },

        setupKeyboardShortcuts() {
            this.handleKeyPress = (e) => {
                if (this.actionLoading || !this.currentItem) return;
                
                // Ignore if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                switch(e.key.toLowerCase()) {
                    case 'a':
                        this.acceptItem();
                        break;
                    case 't':
                        this.transcribeItem();
                        break;
                    case 'arrowright':
                        this.skipItem();
                        break;
                }
            };
            
            window.addEventListener('keydown', this.handleKeyPress);
        },

        removeKeyboardShortcuts() {
            if (this.handleKeyPress) {
                window.removeEventListener('keydown', this.handleKeyPress);
            }
        },

        getConfidenceColor(confidence) {
            if (confidence >= 85) return 'success';
            if (confidence >= 70) return 'warning';
            return 'error';
        },

        getConfidenceLabel(confidence) {
            if (confidence >= 85) return "{{_('High')}}";
            if (confidence >= 70) return "{{_('Medium')}}";
            return "{{_('Low')}}";
        },

        isRTL(text) {
            if (!text) return false;
            // Check if first character is Arabic
            const arabicRegex = /[\u0600-\u06FF]/;
            return arabicRegex.test(text.charAt(0));
        }
    }
});

app.component('ImageViewer', ImageViewer);
app.use(vuetify).mount("#app");
</script>

<style scoped>
.image-preview-card {
    min-height: 500px;
}
</style>
{% endblock %}