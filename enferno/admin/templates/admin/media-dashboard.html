{% extends 'layout.html' %} {% block content %}
    <media-transcription-dialog
        v-model:open="mediaDialog.show"
        :loading="mediaDialog.loading"
        :media="mediaDialog.data"
        @rejected="onTranscriptionUpdated($event)"
        @accepted="onTranscriptionUpdated($event)"
        @transcribed="onTranscriptionUpdated($event)"
        @processed="onMediaProcessed($event)"
    ></media-transcription-dialog>

    <v-main>
        <v-container fluid>
            <v-card>
                <!-- Stats Bar -->
                <v-card-text class="pb-0">
                    <v-row>
                        <v-col cols="12" md="3">
                            <v-card>
                                <v-card-text class="text-center">
                                    <div class="text-h4 text-primary">${ocr.stats.total.toLocaleString()}</div>
                                    <div class="text-caption text-medium-emphasis">{{ _('Total Media') }}</div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                        <v-col cols="12" md="3">
                            <v-card>
                                <v-card-text class="text-center">
                                    <div class="text-h4 text-primary">${ocr.stats.processed.toLocaleString()}</div>
                                    <div class="text-caption text-medium-emphasis">{{ _('Processed (Searchable)') }}</div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                        <v-col cols="12" md="3">
                            <v-card>
                                <v-card-text class="text-center">
                                    <div class="text-h4 text-primary">${ocr.stats.needs_review.toLocaleString()}</div>
                                    <div class="text-caption text-medium-emphasis">{{ _('Needs Review') }}</div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                        <v-col cols="12" md="3">
                            <v-card>
                                <v-card-text class="text-center">
                                    <div class="text-h4 text-primary">${(ocr.stats.failed + ocr.stats.pending + (ocr.stats.cant_read || 0)).toLocaleString()}</div>
                                    <div class="text-caption text-medium-emphasis">{{ _('Pending/Unprocessed') }}</div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-card-text>

                <!-- Data Table -->
                <v-card-text>
                    <v-data-table-server
                            :height="tableHeight"
                            fixed-header
                            :headers="headers"
                            v-model="selected"
                            :items="items"
                            @update:options="refresh"
                            :page="options.page"
                            :loading="loading"
                            :items-length="itemsLength"
                            class="elevation-1"
                            show-select
                            select-strategy="page"
                            :item-selectable="canRunOCRProcess"
                            :items-per-page-options="itemsPerPageOptions"
                            @click:row="rowClick"
                    >
                        <template v-slot:top>
                            <v-toolbar>
                                <v-toolbar-title>
                                    {{ _('Media Dashboard') }}
                                </v-toolbar-title>

                                <!-- Filters -->
                                <div class="d-flex align-center ga-2">
                                    <v-select
                                        v-model="filters.ocr_status"
                                        :items="statusOptions"
                                        label="{{ _('Status') }}"
                                        variant="outlined"
                                        density="compact"
                                        clearable
                                        hide-details
                                    ></v-select>
                                    
                                    <v-text-field
                                        v-model="filters.q"
                                        label="{{ _('Search Extracted Text') }}"
                                        variant="outlined"
                                        density="compact"
                                        clearable
                                        prepend-inner-icon="mdi-magnify"
                                        hide-details
                                        width="250px"
                                        @keyup.enter="applyFilters"
                                    ></v-text-field>
                                    
                                    <v-text-field
                                        v-model="filters.bulletin_id"
                                        label="{{ _('Bulletin ID') }}"
                                        variant="outlined"
                                        density="compact"
                                        clearable
                                        prepend-inner-icon="mdi-pound"
                                        hide-details
                                        type="number"
                                        width="150px"
                                        @keyup.enter="applyFilters"
                                    ></v-text-field>
                                    
                                    <pop-date-range-field
                                        v-model="filters.dateRange"
                                        label="{{ _('Date Range') }}"
                                        variant="outlined"
                                        density="compact"
                                        clearable
                                        hide-details
                                        width="320px"
                                    ></pop-date-range-field>
                                    
                                    <v-btn 
                                        variant="flat" 
                                        color="primary"
                                        @click="applyFilters"
                                    >
                                        {{ _('Apply') }}
                                    </v-btn>
                                    <v-btn
                                        v-if="hasActiveFilters"
                                        variant="text" 
                                        @click="clearFilters"
                                    >
                                        {{ _('Clear') }}
                                    </v-btn>
                                </div>

                                <v-spacer></v-spacer>
                            </v-toolbar>

                            <!-- Bulk Actions Bar -->
                            <v-toolbar v-if="selected.length > 0" height="auto" class="mb-2">
                                <div class="d-flex align-center justify-space-between w-100 px-4">
                                    <v-chip variant="tonal">${selected.length} {{ _('selected') }}</v-chip>
                                    <v-tooltip location="top" :disabled="Boolean(visionApiKey)">
                                        <template v-slot:activator="{ props }">
                                            <div v-bind="props">
                                                <v-btn
                                                    color="primary"
                                                    variant="elevated"
                                                    @click="runBulkOCR"
                                                    :loading="bulkLoading"
                                                    :disabled="!visionApiKey"
                                                    prepend-icon="mdi-text-recognition"
                                                >
                                                    {{ _('Run OCR') }}
                                                </v-btn>
                                            </div>
                                        </template>
                                        {{ _('Google Vision API is not configured. Please contact your administrator.') }}
                                    </v-tooltip>
                                </div>
                            </v-toolbar>
                        </template>

                        <!-- Thumbnail Column -->
                        <template #item.thumbnail="{ item }">
                            <v-avatar
                                size="48"
                                rounded="lg"
                                class="cursor-pointer"
                            >   
                                <v-img :src="item.thumbnail_url" alt="thumbnail"></v-img>
                            </v-avatar>
                        </template>

                        <!-- Bulletin Column -->
                        <template #item.bulletin="{ item }">
                            <v-btn
                                color="primary"
                                variant="text"
                                :href="`/admin/bulletins/${item.bulletin.id}`"
                                target="_blank"
                                @click.stop
                            >
                                #${item.bulletin.id}
                                <v-icon size="small" class="ml-1">mdi-open-in-new</v-icon>
                            </v-btn>
                        </template>

                        <!-- OCR Status Column -->
                        <template #item.ocr_status="{ item }">
                            <v-chip
                                :color="getStatusColor(getEffectiveStatus(item))"
                                size="small"
                                :prepend-icon="getStatusIcon(getEffectiveStatus(item))"
                                class="flex-0-0"
                            >
                                ${getStatusText(getEffectiveStatus(item))}
                            </v-chip>
                        </template>

                        <!-- Date Column -->
                        <template #item.updated_at="{ item }">
                            ${formatDate(item.updated_at)}
                        </template>
                    </v-data-table-server>

                </v-card-text>
            </v-card>
        </v-container>
    </v-main>

{% endblock %} {% block js %}
    <script src="/static/js/components/SplitView.js"></script>
    <script src="/static/js/components/MediaTranscriptionDialog.js"></script>
    <script src="/static/js/components/PdfViewer.js"></script>
    <script src="/static/js/components/ImageViewer.js"></script>
    <script src="/static/js/components/UniField.js"></script>
    <script src="/static/js/components/InlineMediaRenderer.js"></script>
    <script src="/static/js/components/PopDateField.js"></script>
    <script src="/static/js/components/PopDateRangeField.js"></script>
    <script>

        const {createApp} = Vue;
        const {createVuetify} = Vuetify;
        const vuetify = createVuetify(vuetifyConfig);

        const app = createApp({

            delimiters: delimiters,
            mixins: [globalMixin],

            data: () => ({
                drawer: drawer,
                loading: true,
                bulkLoading: false,
                itemsPerPageOptions: window.itemsPerPageOptions,
                visionApiKey: '{{ config.GOOGLE_VISION_API_KEY }}',
                bulkOcrStartedAt: null, // Track when we last ran bulk OCR
                options: {
                    page: 1,
                    per_page: window.itemsPerPageOptions?.[0] ?? 10,
                },
                mediaDialog: {
                    loading: false,
                    show: false,
                    data: null
                },
                ocr: {
                    stats: { total: 0, pending: 0, processed: 0, needs_review: 0, needs_transcription: 0, cant_read: 0, failed: 0 }
                },

                headers: [
                    { title: "{{_('Thumbnail')}}", value: "thumbnail", sortable: false },
                    { title: "{{_('Filename')}}", value: "filename" },
                    { title: "{{_('Bulletin')}}", value: "bulletin", sortable: false },
                    { title: "{{_('OCR Status')}}", value: "ocr_status" },
                    { title: "{{_('Date')}}", value: "updated_at" }
                ],

                selected: [],
                items: [],
                itemsLength: 10,

                defaultFilters: {
                    ocr_status: null,
                    q: '',
                    bulletin_id: null,
                    dateRange: null
                },
                filters: {
                    ocr_status: null,
                    q: '',
                    bulletin_id: null,
                    dateRange: null
                },
                statuses: {
                    pending: { key: 'pending', text: "{{_('Pending')}}", color: 'grey', icon: 'mdi-clock-outline' },
                    processing: { key: 'processing', text: "{{_('Processing')}}", color: 'blue', icon: 'mdi-cog-outline' },
                    processed: { key: 'processed', text: "{{_('Processed')}}", color: 'green', icon: 'mdi-check-circle-outline' },
                    manual: { key: 'manual', text: "{{_('Manually Transcribed')}}", color: 'indigo', icon: 'mdi-account-edit-outline' },
                    needs_review: { key: 'needs_review', text: "{{_('Needs Review')}}", color: 'orange', icon: 'mdi-alert-circle-outline' },
                    needs_transcription: { key: 'needs_transcription', text: "{{_('Needs Transcription')}}", color: 'purple', icon: 'mdi-alphabetical' },
                    cant_read: { key: 'cant_read', text: "{{_('Can\'t Read')}}", color: 'brown', icon: 'mdi-eye-off-outline' },
                    failed: { key: 'failed', text: "{{_('Failed')}}", color: 'red', icon: 'mdi-close-circle-outline' },
                }
            }),

            computed: {
                hasActiveFilters() {
                    return Object.values(this.filters).some(v => v !== null && v !== '' && v !== undefined);
                },
                statusOptions() {
                    return [
                        { title: "{{_('All')}}", value: null },
                        ...Object.values(this.statuses).map(s => ({ 
                            title: s.text, 
                            value: s.key 
                        }))
                    ];
                },
                tableHeight() {
                    return `calc(100vh - ${this.selected.length ? 405 : 360}px)`;
                },
                selectableStatuses() {
                    return ['pending', 'failed', 'cant_read'];
                }
            },

            mounted() {
                this.handleRoute();
                this.$router.afterEach(() => {
                    this.handleRoute();
                });
                this.loadOCRStats();

                this.bulkOcrStartedAt = new Date().toISOString().slice(0, 16);
            },

            methods: {
                handleRoute() {
                    if (this.$route.params.id) this.showMediaDialog(this.$route.params.id);
                },
                showMediaDialog(id) {
                    this.mediaDialog.loading = true;
                    this.mediaDialog.show = true;

                    api.get(`/admin/api/media/${id}`).then(response => {
                        this.mediaDialog.data = response.data;
                    }).catch(error => {
                        console.error('Error loading media:', error);
                        this.showSnack("{{ _('Error loading media') }}");
                        this.mediaDialog.show = false;
                    }).finally(() => {
                        this.mediaDialog.loading = false;
                    });
                },
                rowClick(e, row) {
                    const item = row.item;
                    const path = `/admin/media/${item.id}`;
                    if (this.$route.path !== path) this.$router.push(path);
                },
                runBulkOCR() {
                    if (this.selected.length === 0) return;
                    if (!this.visionApiKey) return this.showSnack("{{ _('Google Vision API is not configured. Please contact your administrator.') }}");

                    this.bulkLoading = true;

                    // Save the timestamp when we initiate bulk OCR
                    this.bulkOcrStartedAt = new Date().toISOString().slice(0, 16);

                    api.post('/admin/api/ocr/bulk', { media_ids: this.selected })
                        .then(response => {
                            this.showSnack(response.data.message);
                            this.selected = [];
                            this.refresh(this.options);
                            this.loadOCRStats();
                        })
                        .catch(error => {
                            console.error('Bulk OCR error:', error);
                            this.showSnack("{{ _('Error processing OCR request') }}");
                            this.bulkOcrStartedAt = null;
                        })
                        .finally(() => {
                            this.bulkLoading = false;
                        });
                },
                handleBulkOcrCompleted(notification) {
                    this.refresh(this.options);
                    this.loadOCRStats();
                    this.showSnack(notification?.message || "{{ _('Bulk OCR Complete') }}");
                    
                    // Clear the timestamp after handling
                    this.bulkOcrStartedAt = null;
                },
                clearFilters() {
                    this.filters = { ...this.defaultFilters };
                    this.applyFilters();
                },
                applyFilters() {
                    this.refresh({ ...this.options, page: 1 });
                },
                refresh(options) {
                    this.options = options || { ...this.options, page: 1 };
                    this.loading = true;

                    const params = new URLSearchParams({
                        page: this.options.page,
                        per_page: this.options.itemsPerPage || this.options.per_page
                    });

                    if (this.filters.ocr_status) params.append('ocr_status', this.filters.ocr_status);
                    if (this.filters.q) params.append('q', this.filters.q);
                    if (this.filters.bulletin_id) params.append('bulletin_id', this.filters.bulletin_id);
                    if (this.filters.dateRange?.[0] && this.filters.dateRange?.[1]) {
                        params.append('date_from', this.filters.dateRange[0]);
                        params.append('date_to', this.filters.dateRange[1]);
                    }

                    api.get(`/admin/api/media/dashboard?${params.toString()}`)
                        .then(response => {
                            this.itemsLength = response.data.total;
                            this.items = response.data.items;
                        })
                        .catch(error => {
                            console.error('Error loading media dashboard:', error);
                            this.showSnack("{{ _('Error loading data') }}");
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },

                getEffectiveStatus(item) {
                    // Show 'manual' status for manually transcribed items
                    if (item.extraction?.manual && item.ocr_status === 'processed') {
                        return 'manual';
                    }
                    return item.ocr_status;
                },
                getStatusText(status) {
                    return this.statuses[status]?.text || status;
                },
                getStatusColor(status) {
                    return this.statuses[status]?.color || 'grey';
                },
                getStatusIcon(status) {
                    return this.statuses[status]?.icon || 'mdi-help-circle-outline';
                },
                onTranscriptionUpdated({ media, text }) {
                    this.resetMediaDialog();
                    this.refresh();
                    this.loadOCRStats();
                },
                onMediaProcessed(media) {
                    // Reload the media to get fresh extraction data
                    this.showMediaDialog(media.id);
                    this.refresh();
                    this.loadOCRStats();
                },
                resetMediaDialog() {
                    this.mediaDialog.show = false;
                    this.mediaDialog.data = null;
                    this.mediaDialog.loading = false;
                },
                loadOCRStats() {
                    api.get('/admin/api/ocr/stats').then(res => {
                        this.ocr.stats = res?.data;
                    }).catch(err => {
                        console.error('Error loading OCR counts:', err);
                    });
                },
                canRunOCRProcess(item) {
                    return this.selectableStatuses.includes(item.ocr_status);
                },
            },
            watch: {
                'mediaDialog.show'(isOpen) {
                    if (isOpen === false) {
                        this.mediaDialog.data = null;
                        if (this.$route.path !== '/admin/media/')
                            this.$router.push('/admin/media/')
                    }
                },
                'filters.ocr_status'() {
                    this.applyFilters();
                },
                'filters.dateRange'() {
                    if (this.filters.dateRange) {
                        this.applyFilters();
                    }
                },
                'notifications.items': {
                    handler(newItems, oldItems) {
                        if (!newItems?.length) return;
                        
                        const oldIds = new Set((oldItems || []).map(n => n.id));
                        const freshNotifications = newItems.filter(n => !oldIds.has(n.id));
                        
                        freshNotifications.forEach(notification => {
                            if (notification.title === 'Bulk OCR Complete') {
                                // Only process if we have an active bulk OCR request
                                // AND the notification was created after we started it
                                if (this.bulkOcrStartedAt && 
                                    new Date(notification.created_at) >= new Date(this.bulkOcrStartedAt)) {
                                    this.handleBulkOcrCompleted(notification);
                                }
                            }
                        });
                    },
                    deep: true
                }
            },
        });

        app.component('SplitView', SplitView);
        app.component('MediaTranscriptionDialog', MediaTranscriptionDialog);
        app.component('PdfViewer', PdfViewer);
        app.component('ImageViewer', ImageViewer);
        app.component('UniField', UniField);
        app.component('InlineMediaRenderer', InlineMediaRenderer);
        app.component('PopDateField', PopDateField);
        app.component('PopDateRangeField', PopDateRangeField);
        
        app.use(router).use(vuetify);
        router.isReady().then(() => {
            app.mount('#app');
            window.app = app;
        });
    </script>
{% endblock %}