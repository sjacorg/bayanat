{% extends 'layout.html' %}
{% block content %}

    <v-main class="system-admin overflow-auto">
        <v-card class="ma-5 pb-2 px-2 pt-0 overflow-unset">

                        <v-card-title class="d-flex flex-column position-sticky pt-0 bg-surface top-0 z-1">
                            <div class="d-flex mb-6 mt-4">
                                {{ _('Administration Dashboard') }}
                                <v-spacer></v-spacer>
                                <div class="d-flex ga-4">
                                    <v-btn prepend-icon="mdi-restore" variant="elevated" color="warning" @click="loadDefaults">
                                        {{ _('Restore Default Settings') }}
                                    </v-btn>
                                    <v-btn prepend-icon="mdi-history" variant="elevated" @click="showRevisions=!showRevisions">
                                        {{ _('Revision History') }}
                                    </v-btn>
                                    <v-btn
                                        @click.stop="showConfigDiff"
                                        variant="elevated"
                                        color="primary"
                                        prepend-icon="mdi-content-save"
                                    >{{ _('Save') }}</v-btn>    
                                </div>
                            </div>

                            <v-tabs bg-color="primary" v-model="tab">
                                <v-tab value="general">{{ _('General') }}</v-tab>
                                <v-tab value="storage">{{ _('Storage') }}</v-tab>
                                <v-tab value="security">{{ _('Security') }}</v-tab>
                                <v-tab value="control">{{ _('Access Control') }}</v-tab>
                                <v-tab value="logging">{{ _('Activity Monitor') }}</v-tab>
                                <v-tab value="import">{{ _('Import Tools') }}</v-tab>
                                <v-tab value="export">{{ _('Export Tool') }}</v-tab>
                                <v-tab value="maps">{{ _('Maps') }}</v-tab>
                                <v-tab value="locations">{{ _('Locations') }}</v-tab>
                            </v-tabs>
                        </v-card-title>
                        <v-card-text class="pa-4">


                            <v-window v-model="tab">
                                <v-window-item value="general">
                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>

                                            <v-combobox class="mb-9"
                                                        multiple
                                                        persistent-hint
                                                        chips
                                                        hint="{{ _('Allows to load different set of items in pages that has data tables') }}"
                                                        :items="eitem.ITEMS_PER_PAGE_OPTIONS"
                                                        label="{{ _('Items Per Page Options') }}"
                                                        v-model="eitem.ITEMS_PER_PAGE_OPTIONS"></v-combobox>

                                            <v-combobox class="mb-9" multiple chips
                                                        :items="eitem.VIDEO_RATES"
                                                        persistent-hint
                                                        hint="{{ _('Allows to play videos at different speed rates') }}"
                                                        label="{{ _('Video Player Playback Rates') }}"
                                                        v-model="eitem.VIDEO_RATES"></v-combobox>

                                            <h4 class="mt-3 subtitle-2 mb-2">{{ _('Default Language') }}</h4>
                                            <v-btn-toggle divided variant="outlined" color="primary" mandatory class="mb-3"
                                                          v-model="eitem.BABEL_DEFAULT_LOCALE">
                                                <v-btn size="small" v-for="(name, code) in languages"
                                                       :value="code">
                                                    ${name}
                                                </v-btn>
                                            </v-btn-toggle>
                                            <p class="caption">{{ _('Changes default interface language for all users. Users can still choose their own interface language.') }}</p>


                                            <v-switch color="primary" label="{{ _('Deduplication Tool') }}"
                                                      v-model="eitem.DEDUP_TOOL"
                                                      persistent-hint
                                                      hint="{{ _('Enables integration with Benetech\'s Deduplication tool.') }}"></v-switch>

                                            <v-slide-y-transition>
                                                <v-sheet v-show="eitem.DEDUP_TOOL" class=" pa-4 grey lighten-4">

                                                    <v-text-field class="mb-5" type="number"
                                                                  persistent-hint
                                                                  hint="{{ _('Lowest value of distance to process.') }}"
                                                                  label="{{ _('Deduplication Low Distance') }}"
                                                                  v-model.number="eitem.DEDUP_LOW_DISTANCE"></v-text-field>


                                                    <v-text-field class="mb-9" type="number"
                                                                  persistent-hint
                                                                  hint="{{ _('Highest value of distance to process.') }}"
                                                                  label="{{ _('Deduplication Max Distance') }}"
                                                                  v-model.number="eitem.DEDUP_MAX_DISTANCE"></v-text-field>

                                                    <v-text-field class="mb-9" type="number"
                                                                  persistent-hint
                                                                  hint="{{ _('Number of matches to send for processing in every batch. Affects speed of processing and performance of the server.') }}"
                                                                  label="{{ _('Deduplication Batch Size') }}"
                                                                  v-model.number="eitem.DEDUP_BATCH_SIZE"></v-text-field>
                                                    <v-text-field class="mb-9" type="number"
                                                                  persistent-hint
                                                                  hint="{{ _('Interval of batches sent for processing. Affects speed of processing and performance of the server.') }}"
                                                                  label="{{ _('Deduplication Interval') }}"
                                                                  v-model.number="eitem.DEDUP_INTERVAL"></v-text-field>

                                                </v-sheet>
                                            </v-slide-y-transition>

                                            <v-switch color="primary" label="{{ _('Advanced Analysis Features') }}"
                                                      v-model="eitem.ADV_ANALYSIS"
                                                      persistent-hint
                                                      hint="{{ _('Advanced features for more efficient analysis.') }}"></v-switch>
                                        </v-card-text>
                                    </v-card>
                                </v-window-item>


                                <v-window-item value="storage">
                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>
                                            <h2 class="mt-1 subtitle-2 mb-2">{{ _('Media Storage') }}</h2>
                                            <p class="text-caption">{{ _('Storage options for media files uploaded to Bayanat. By default, Bayanat store these files locally on the server. It\'s also possible to use S3 compatible bucket using cloud providers like AWS, Azure, Google Cloud, or MinIO (which can be used in offline installations).') }}</p>
                                            <v-btn-toggle divided variant="outlined" color="primary" mandatory
                                                            v-model="eitem.FILESYSTEM_LOCAL"
                                                            class="my-3 mb-9">
                                                <v-btn :value="1">{{ _('Local Filesystem') }}</v-btn>
                                                <v-btn :value="0">{{ _('S3 Storage') }}</v-btn>
                                            </v-btn-toggle>

                                            <v-slide-y-transition>
                                                <v-sheet v-show="!eitem.FILESYSTEM_LOCAL"
                                                         class="pa-4 grey lighten-4">

                                                    <v-text-field label="{{ _('AWS Access Key ID') }}"
                                                                  v-model="eitem.AWS_ACCESS_KEY_ID"></v-text-field>

                                                    <v-text-field label="{{ _('AWS Access Key Secret') }}"
                                                                  v-model="eitem.AWS_SECRET_ACCESS_KEY"></v-text-field>

                                                    <v-text-field label="{{ _('S3 Bucket Name') }}"
                                                                  v-model="eitem.S3_BUCKET"></v-text-field>

                                                    <v-text-field label="{{ _('S3 Region') }}"
                                                                  v-model="eitem.AWS_REGION"></v-text-field>

                                                </v-sheet>
                                            </v-slide-y-transition>

                                            <v-combobox class="mb-9" multiple chips
                                                        :items="eitem.MEDIA_ALLOWED_EXTENSIONS"
                                                        v-model="eitem.MEDIA_ALLOWED_EXTENSIONS"
                                                        label="{{ _('Allowed Media Extensions') }}"
                                                        persistent-hint
                                                        hint="{{ _('The system will only allow files uploaded whose extensions are included in this list and reject all other extensions.') }}"></v-combobox>

                                            <v-text-field class="mb-9" v-model="eitem.MEDIA_UPLOAD_MAX_FILE_SIZE"
                                                          label="{{ _('Media Max Upload Size') }}"
                                                          persistent-hint
                                                          hint="{{ _('Sets the maximum allowed file size for media uploads.') }}"></v-text-field>

                                        </v-card-text>
                                    </v-card>
                                </v-window-item>


                                <v-window-item value="security">
                                    <v-card :disabled="loading" :loading="loading" >

                                        <h2 class="mt-1 subtitle-2 mb-2">{{ _('Password Policies') }}</h2>
                                        <v-card-text>

                                            <v-text-field class="mb-9" type="number"
                                                          label="{{ _('Password Minimum Length') }}"
                                                          persistent-hint
                                                          hint="{{ _('Minimum required length for passwords') }}"
                                                          suffix="charachters"
                                                          v-model.number="eitem.SECURITY_PASSWORD_LENGTH_MIN"></v-text-field>

                                            <h3 class="mt-1 subtitle-2 mb-2">{{ _('Password Strength') }}</h3>

                                            <p class="text-caption">{{ _('Bayanat uses zxcvbn password strength estimator to calculate a password score. \'Medium\' coresponds to a zxcvbn score of 2 and is suitable for offline Bayanat installation. \'Strong\' corresponds to a score of 3, we recommend this setting for online Bayanat installations. \'Very Strong\' corresponds to a zxcvbn score of 4 and offers the highest level of protection.') }}</p>

                                            <v-sheet width="400">
                                                <v-slider
                                                        v-model="eitem.SECURITY_ZXCVBN_MINIMUM_SCORE"
                                                        min="2"
                                                        max="4"
                                                        hint="{{ _('') }}"
                                                        persistent-hint
                                                        color="primary"
                                                        show-ticks="always"
                                                        :ticks="{
                                                            2: 'Medium',
                                                            3: 'Strong',
                                                            4: 'Very Strong'}"
                                                        :tick-size="4"
                                                        step="1"
                                                ></v-slider>
                                            </v-sheet>
                                        </v-card-text>

                                        <h2 class="mt-1 subtitle-2 mb-2">{{ _('Two Factor Authentication Policies') }}</h2>
                                        <v-card-text>
                                            <v-switch color="primary" class="mb-9" label="{{ _('Force 2FA Enrollment') }}"
                                                      persistent-hint
                                                      hint="{{ _('Force users to enroll in two factor authentication') }}"
                                                      v-model="eitem.SECURITY_TWO_FACTOR_REQUIRED"
                                            >
                                            </v-switch>
                                        </v-card-text>

                                        <h2 class="mt-1 subtitle-2 mb-2">{{ _('Session Policies') }}</h2>
                                        <v-card-text>
                                            <v-switch color="primary" class="mb-9"
                                                              label="{{ _('Disallow Multiple Concurrent Sessions') }}"
                                                              persistent-hint
                                                              hint="{{ _('Prevents users from logging in to multiple devices simultaneously') }}"
                                                              v-model="eitem.DISABLE_MULTIPLE_SESSIONS">
                                                    </v-switch>

                                            <v-text-field class="mb-9" type="number"
                                                          label="{{ _('Session Data Retention Period') }}" persistent-hint
                                                          hint="{{ _('Period after which session data will be deleted.') }}"
                                                          suffix="days"
                                                          v-model.number="eitem.SESSION_RETENTION_PERIOD"></v-text-field>
                                        </v-card-text>

                                        <h2 class="mt-1 subtitle-2 mb-2">{{ _('Additional Security Settings') }}</h2>
                                        <v-card-text>

                                            <v-switch color="primary" class="mb-9" label="{{ _('Recaptcha Enabled') }}"
                                                      persistent-hint
                                                      hint="{{ _('Add further security to Bayanat\'s by requiring Google Recaptcha on the login form.') }}"
                                                      v-model="eitem.RECAPTCHA_ENABLED"></v-switch>

                                            <v-slide-y-transition>
                                                <v-sheet v-show="eitem.RECAPTCHA_ENABLED"
                                                         class="pa-4 grey lighten-4">
                                                    <v-text-field label="{{ _('Recaptcha Public Key') }}"
                                                                  v-model="eitem.RECAPTCHA_PUBLIC_KEY"></v-text-field>

                                                    <v-text-field label="{{ _('Recaptcha Private Key') }}"
                                                                  v-model="eitem.RECAPTCHA_PRIVATE_KEY"></v-text-field>
                                                </v-sheet>
                                            </v-slide-y-transition>

                                            <v-switch color="primary" class="mb-9" label="{{ _('Enable Google OAuth') }}"
                                                      persistent-hint
                                                      hint="{{ _('Allow users to login using their Google account.') }}"
                                                      v-model="eitem.GOOGLE_OAUTH_ENABLED"></v-switch>

                                            <v-slide-y-transition>
                                                <v-sheet v-show="eitem.GOOGLE_OAUTH_ENABLED"
                                                         class="pa-4 grey lighten-4">
                                                    <v-text-field label="{{ _('Google Client ID') }}"
                                                                  v-model="eitem.GOOGLE_CLIENT_ID"></v-text-field>

                                                    <v-text-field label="{{ _('Google Client Secret') }}"
                                                                  v-model="eitem.GOOGLE_CLIENT_SECRET"></v-text-field>

                                                    <v-text-field label="{{ _('Google Discovery URL') }}"
                                                                  v-model="eitem.GOOGLE_DISCOVERY_URL"></v-text-field>
                                                </v-sheet>
                                            </v-slide-y-transition>

                                            <v-text-field class="mb-9" type="number"
                                                          label="{{ _('Security Freshness') }}"
                                                          persistent-hint
                                                          hint="{{ _('Secure pages will require re-authentication after this time expires.') }}"
                                                          suffix="minutes"
                                                          v-model.number="eitem.SECURITY_FRESHNESS"></v-text-field>
                                            <v-text-field class="mb-9" type="number"
                                                          label="{{ _('Security Freshness Grace Period') }}"
                                                          persistent-hint
                                                          hint="{{ _('Re-authentication will require a second factor after this period.') }}"
                                                          suffix="minutes"
                                                          v-model.number="eitem.SECURITY_FRESHNESS_GRACE_PERIOD"></v-text-field>
                                        </v-card-text>

                                    </v-card>
                                </v-window-item>

                                <v-window-item value="control">

                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>
                                            <p class="text-caption">{{ _('By default, users can access all items in the Bayanat database, except for items which are restricted from them. Administrators can restrict access to certain items by assigning Access Group(s) to these items. Additionally, only administrators can restrict items. This default behaviour can be changed with the following settings.') }}</p>

                                            <v-switch color="primary" class="mb-9" label="{{ _('Restrictive Access Control') }}"
                                                      persistent-hint
                                                      hint="{{ _('All items in the database will be restricted by default to all non-administrators, except when they are explicitly given access.') }}"
                                                      v-model="eitem.ACCESS_CONTROL_RESTRICTIVE"></v-switch>
                                            <v-switch color="primary" class="mb-9" label="{{ _('Allow Non-Admin Users to Restrict New Items') }}"
                                                      persistent-hint
                                                      hint="{{ _('Users with no administrative privileges will be allowed to restrict items they create. They can only restrict items to one or more of their own access groups.') }}"
                                                      v-model="eitem.AC_USERS_CAN_RESTRICT_NEW"></v-switch>
                                        </v-card-text>

                                    </v-card>
                                </v-window-item>

                                <v-window-item value="logging">
                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>
                                            <p class="caption">{{
                                                    _('Set users\' actions to be logged in the Activity Monitor.')
                                                }}</p>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Items created by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will log Actors, Bulletins, Incidents and all other secondary items created by users.') }}"
                                                    v-model="eitem.ACTIVITIES['CREATE']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Items viewed by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will log all Actors, Bulletins and Incidents viewed by users.') }}"
                                                    v-model="eitem.ACTIVITIES['VIEW']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Items edited by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will log Actors, Bulletins, Incidents and all other secondary items edited by users.') }}"
                                                    v-model="eitem.ACTIVITIES['UPDATE']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Items deleted by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all secondary items deleted by authorized users. Note: Actors, Bulletins and Incidents cannot be deleted.') }}"
                                                    v-model="eitem.ACTIVITIES['DELETE']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Items reviewed by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all items peer-viewed by authorized users.') }}"
                                                    v-model="eitem.ACTIVITIES['REVIEW']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Files uploaded by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all files uploaded users to media storage.') }}"
                                                    v-model="eitem.ACTIVITIES['UPLOAD']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Bulk operations queued by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all bulk operations initiated by authorized users on Actors, Bulletins and Incidents.') }}"
                                                    v-model="eitem.ACTIVITIES['BULK']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Export requests made by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all export requests submitted by authorized users.') }}"
                                                    v-model="eitem.ACTIVITIES['REQUEST']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Export requests approved by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all export requests approvals by administrators.') }}"
                                                    v-model="eitem.ACTIVITIES['APPROVE']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Export requests rejected by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all export requests rejections by administrators.') }}"
                                                    v-model="eitem.ACTIVITIES['REJECT']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Export requests downloaded by  users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all export requests downloads by authorized users.') }}"
                                                    v-model="eitem.ACTIVITIES['DOWNLOAD']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Search queries made by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all searches conducted by users on Actors, Bulletins and Incidents.') }}"
                                                    v-model="eitem.ACTIVITIES['SEARCH']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Items self-assigned by users') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all items self-assigned by users.') }}"
                                                    v-model="eitem.ACTIVITIES['SELF-ASSIGN']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Logins by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all user login activities.') }}"
                                                    v-model="eitem.ACTIVITIES['LOGIN']">
                                                </v-switch>

                                                <v-switch color="primary" class="mb-9" label="{{ _('Logouts by users.') }}"
                                                    persistent-hint
                                                    hint="{{ _('This setting will enable logging all user logout activities. Note: only explicit logout will be logged, users closing their browsers without logging out will not for example.') }}"
                                                    v-model="eitem.ACTIVITIES['LOGOUT']">
                                                </v-switch>

                                                <v-text-field class="mb-9" type="number"
                                                    label="{{ _('Activity Retention Period') }}"
                                                    persistent-hint
                                                    hint="{{ _('Period after which activities will be deleted.') }}"
                                                    suffix="days"
                                                    v-model.number="eitem.ACTIVITIES_RETENTION"></v-text-field>

                                        </v-card-text>
                                    </v-card>
                                </v-window-item>


                                <v-window-item value="import">
                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>

                                            <v-switch color="primary" class="mb-9" label="{{ _('Media Import Tool') }}"
                                                      persistent-hint
                                                      hint="{{ _('Enables importing and parsing media items in bulk into Bulletins.') }}"
                                                      v-model="eitem.ETL_TOOL"></v-switch>

                                            <v-slide-y-transition>
                                                <v-sheet v-show="eitem.ETL_TOOL" class=" pa-4 grey lighten-4">
                                                    <v-switch color="primary"
                                                            class="mb-9"
                                                            label="{{ _('Media Import Path Scanning') }}"
                                                            persistent-hint
                                                            hint="{{ _('Allow scanning of the import path for files in the Media Import Tool. The path needs to be set in the .env file for this setting to work. This is done for security purposes. WARNING: This is a DANGEROUS setting and should only be enabled on installation that can utilize this feature. It should be turned on only when it\'s needed.') }}"
                                                            v-model="eitem.ETL_PATH_IMPORT"></v-switch>

                                                    <v-combobox class="mb-9" multiple chips
                                                                persistent-hint
                                                                hint="{{ _('The file extensions for media, documents, and other files that are permitted for import using the Media Import Tool.') }}"
                                                                :items="eitem.ETL_VID_EXT"
                                                                label="{{ _('Allowed Media Import Extensions') }}"
                                                                v-model="eitem.ETL_VID_EXT"></v-combobox>

                                                    <v-switch color="primary" class="mb-9"
                                                              persistent-hint
                                                              hint="{{ _('Bayanat\'s Media Import tool can utilize Google\'s Tesseract OCR engine. This enables parsing and extracting text from images and scanned PDF files (requires Tesseract system package).') }}"
                                                              label="{{ _('Enable OCR') }}"
                                                              {% if not config.HAS_TESSERACT %}
                                                              disabled
                                                              :value="false"
                                                              {% else %}
                                                              v-model="eitem.OCR_ENABLED"
                                                              {% endif %}
                                                              ></v-switch>

                                                    <v-alert v-if="!{% if config.HAS_TESSERACT %}true{% else %}false{% endif %}" type="warning" class="mb-6" icon="mdi-alert">
                                                        {{ _('Tesseract is not installed. Please install it to enable OCR.') }}
                                                    </v-alert>
                                                    
                                                    <v-slide-y-transition>
                                                        <v-sheet v-show="eitem.OCR_ENABLED && {% if config.HAS_TESSERACT %}true{% else %}false{% endif %}"
                                                                    class=" pa-4 grey lighten-4">

                                                            <v-combobox class="mb-9" multiple chips
                                                                        persistent-hint
                                                                        hint="{{ _('File extensions which will be scanned using Tesseract OCR.') }}"
                                                                        :items="eitem.OCR_EXT"
                                                                        label="{{ _('OCR Extensions') }}"
                                                                        v-model="eitem.OCR_EXT"></v-combobox>
                                                        </v-sheet>

                                                    </v-slide-y-transition>

                                                    <v-switch color="primary" class="mb-9" 
                                                              label="{{ _('Enable Transcription') }}"
                                                              persistent-hint
                                                              hint="{{ _('Enables transcription of audio and video files using OpenAI\'s Whisper during import. Bayanat will need to download the specified model below from OpenAI\'s servers. However, the transcription will run locally on the Bayanat server. For more information about the models\' performance, required resources and available language please check:') }} https://github.com/openai/whisper#available-models-and-languages"
                                                              {% if not config.HAS_WHISPER %}
                                                              disabled
                                                              :value="false"
                                                              {% else %}
                                                              v-model="eitem.TRANSCRIPTION_ENABLED"
                                                              {% endif %}
                                                              ></v-switch>

                                                    <v-alert v-if="!{% if config.HAS_WHISPER %}true{% else %}false{% endif %}" type="warning" class="mb-6" icon="mdi-alert">
                                                        {{ _('OpenAI Whisper is not installed. Please install it to enable transcription.') }}
                                                    </v-alert>

                                                    <v-slide-y-transition>
                                                        <v-sheet v-show="eitem.TRANSCRIPTION_ENABLED && {% if config.HAS_WHISPER %}true{% else %}false{% endif %}"
                                                                 class=" pa-4 grey lighten-4">
                                                            <v-combobox class="mb-9" chips
                                                                        persistent-hint
                                                                        hint="{{ _('Whisper model to use for transcription.') }}"
                                                                        :items="whisperModelsCombo"
                                                                        item-value="model_name"
                                                                        item-title="title"
                                                                        :return-object="false"
                                                                        label="{{ _('Whisper Model') }}"
                                                                        v-model="eitem.WHISPER_MODEL"></v-combobox>                                                        
                                                        </v-sheet>
                                                    </v-slide-y-transition>
                                                </v-sheet>
                                            </v-slide-y-transition>

                                            <v-switch color="primary" class="mb-9" label="{{ _('Sheet Import') }}"
                                                      persistent-hint
                                                      hint="{{ _('Enables dynamic import of spreadsheets into Actors.') }}"
                                                      v-model="eitem.SHEET_IMPORT"></v-switch>

                                            <v-slide-y-transition>
                                                <v-sheet v-show="eitem.SHEET_IMPORT"
                                                         class=" pa-4 grey lighten-4">

                                                    <v-combobox class="mb-9" multiple chips
                                                                persistent-hint
                                                                hint="{{ _('Allowed spreadsheet extensions for Sheets Import Tool.') }}"
                                                                label="{{ _('Allowed Sheets Extensions') }}"
                                                                :items="eitem.SHEETS_ALLOWED_EXTENSIONS"
                                                                v-model="eitem.SHEETS_ALLOWED_EXTENSIONS"></v-combobox>

                                                </v-sheet>
                                            </v-slide-y-transition>

                                            <v-switch color="primary" class="mb-9" label="{{ _('Web Import') }}"
                                                      persistent-hint
                                                      hint="{{ _('Enables import of videos from online sources into Bulletins.') }}"
                                                      v-model="eitem.WEB_IMPORT"></v-switch>

                                            <v-slide-y-transition>
                                                <v-sheet v-show="eitem.WEB_IMPORT"
                                                         class=" pa-4 grey lighten-4">

                                                    <v-text-field class="mb-9" 
                                                                  label="{{ _('Web Import Proxy') }}"
                                                                  persistent-hint
                                                                  hint="{{ _('Proxy URL to use when importing media from web sources (e.g. socks5://user:pass@host:port).') }}"
                                                                  v-model="eitem.YTDLP_PROXY"></v-text-field>

                                                    <v-textarea class="mb-9" 
                                                                label="{{ _('Web Import Cookies') }}"
                                                                persistent-hint
                                                                hint="{{ _('Cookie data for authenticated web imports (in Netscape/Mozilla format).') }}"
                                                                auto-grow
                                                                rows="3"
                                                                v-model="eitem.YTDLP_COOKIES"></v-textarea>

                                                    <v-slide-y-transition>
                                                        <v-sheet>
                                                            <v-combobox class="mb-9" 
                                                                        multiple 
                                                                        chips
                                                                        label="{{ _('Allowed Domains') }}"
                                                                        persistent-hint
                                                                        hint="{{ _('List of domains from which media can be imported. Check yt-dlp\'s repository (https://github.com/yt-dlp/yt-dlp/blob/master/supportedsites.md) for a list of supported websites.') }}"
                                                                        :items="eitem.YTDLP_ALLOWED_DOMAINS"
                                                                        v-model="eitem.YTDLP_ALLOWED_DOMAINS">
                                                            </v-combobox>
                                                        </v-sheet>
                                                    </v-slide-y-transition>

                                                </v-sheet>
                                            </v-slide-y-transition>

                                        </v-card-text>

                                    </v-card>
                                </v-window-item>


                                <v-window-item value="export">
                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>
                                            <v-switch color="primary" class="mb-9" label="{{ _('Export System') }}"
                                                      v-model="eitem.EXPORT_TOOL"
                                                      persistent-hint
                                                      hint="{{ _('Enables exporting Actors, Bulletins and Incidents into various formats. Users with the correct permissions can request exports of items. Administrators can approve or reject these requests. Approved exports can be downloaded by the requesting user from the Exports dashboard.') }}"></v-switch>
                                            <v-slide-y-transition>
                                                <v-sheet v-show="eitem.EXPORT_TOOL">
                                                    <v-text-field class="mb-9" type="number"
                                                                  label="{{ _('Export Expiry Time') }}"
                                                                  persistent-hint
                                                                  hint="{{ _('Period after which exports will expired and be deleted.') }}"
                                                                  suffix="hours"
                                                                  v-model.number="eitem.EXPORT_DEFAULT_EXPIRY"></v-text-field>
                                                </v-sheet>
                                            </v-slide-y-transition>
                                        </v-card-text>
                                    </v-card>
                                </v-window-item>


                                <v-window-item value="maps">
                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>

                                            <v-text-field class="mb-9" label="{{ _('Maps API Endpoint') }}"
                                                          persistent-hint
                                                          hint="{{ _('API provider for Open Street Maps tiles. By default, Bayanat uses OpenStreetMaps tiles servers. This can be changed using this setting, for example to use an offline instance of OSM.') }}"
                                                          v-model="eitem.MAPS_API_ENDPOINT"></v-text-field>

                                            <h2 class="mt-3 subtitle-2 mb-2">{{ _('Satalite Imagery') }}</h2>
                                            <v-card-item class="text-caption my-2">{{ _('Bayanat uses OpenStreetMaps by default. Optionally, it is able to show satalite imagery using Google Maps, in addition to OSM. To enable, add a Google Maps API Key.') }}</v-card-item>

                                            <v-text-field class="mb-9" label="{{ _('Google Maps API Key') }}"
                                                          persistent-hint
                                                          hint="{{ _('API key for Google Maps. Adding a key enables satalite imagery in Bayanat\'s maps.') }}"
                                                          v-model="eitem.GOOGLE_MAPS_API_KEY"></v-text-field>

                                            <h4 class="mt-3 subtitle-2 mb-2">{{ _('Default Map Position') }}</h4>
                                            <span class="caption">{{ _('Changes default position for all maps in all components.') }}</span>

                                            <geo-map style="z-index:200" v-model="eitem.GEO_MAP_DEFAULT_CENTER"
                                                     :map-height="300"></geo-map>

                                        </v-card-text>
                                    </v-card>
                                </v-window-item>
                                <v-window-item value="locations">
                                    <v-card :disabled="loading" :loading="loading">
                                        <v-card-text>
                                            <h4 class="mt-3 subtitle-2 mb-2">{{ _('Full Location Generation Settings') }}</h4>
                                            <v-switch color="primary" label="{{ _('Include Postal Codes in Full Location Text Format') }}"
                                                      v-model="eitem.LOCATIONS_INCLUDE_POSTAL_CODE"
                                                      persistent-hint
                                                      hint="{{ _('Include postal codes in the format of full location text of all entries. Note: you must regenerate full locations from the Component Data dashboard for this change to take effect.') }}"></v-switch>
                                        </v-card-text>
                                    </v-card>
                                </v-window-item>
                            </v-window>



                        </v-card-text>
                    </v-card>

    </v-main>
    <v-navigation-drawer
            v-model="showRevisions"
            location="right"
            temporary
            width="500"
            clipped

    >

        <v-card :loading="revisionLoading">
            <v-card-title>{{ _('Revision History') }}</v-card-title>
            <v-card-text>
                <v-sheet  
                    v-for="(config, i) in revisions" 
                    :key="i"
                    class="ma-1 pa-2 d-flex align-center justify-lg-space-between">
                    
                    <span class="font-weight-bold">
                        {{ _('Version') }} ${config.id}
                    </span>
                    
                    <span class="caption ml-2 font-italic">
                        ${config.created_at}
                    </span>
                    
                    <span v-if="config.user?.name" class="ml-2 caption">
                        - {{ _('by') }} ${config.user.name}
                    </span>

                    <template v-if="i !== 0">
                        <v-tooltip location="top" text="{{ _('Revert to this version') }}">
                            <template #activator="{props}">
                                <v-btn 
                                    :="props" 
                                    icon="mdi-history" 
                                    variant="text" 
                                    size="small"
                                    @click.stop="revertVersion(config)">
                                </v-btn>
                            </template>
                        </v-tooltip>
                    </template>
                    
                    <template v-else>
                        <span  class="font-italic caption grey--text">{{ _('Current') }}</span>
                    </template>
                </v-sheet>
            </v-card-text>

            <v-card-actions class="justify-center">
                <v-pagination
                        v-model="page"
                        :length="totalPages"
                        rounded="circle"
                ></v-pagination>
            </v-card-actions>
        </v-card>


    </v-navigation-drawer>



    <v-dialog v-model="confirmDialog" max-width="900">
        <v-card>
            <v-card-title class="d-flex justify-space-between align-center">
                {{ _('Review and Confirm Changes') }}
                <v-btn icon="mdi-close" variant="text" @click="confirmDialog=false"></v-btn>
            </v-card-title>
            <v-card-text>
                <v-sheet class="pa-5" color="yellow lighten-5 d-flex">
                    <div class="d-flex align-center body-2">

                        <v-avatar class="mr-2" size="18" color="red lighten-3"></v-avatar>
                        {{ _('Removed') }}
                    </div>

                    <div class="d-flex align-center ml-4 body-2">
                        <v-avatar class="mr-2" size="18" color="green lighten-2"></v-avatar>
                        {{ _('Added') }}
                    </div>

                </v-sheet>
            </v-card-text>
            <v-card-text class="pa-4">
                <div v-if="configDiff">
                    <v-sheet class="change-item my-3 pa-2 d-flex align-center" v-for="change in configDiff">
                        <span class="body-2 font-weight-bold text--black mr-3">${change.label}</span>
                        <span v-html="change.diff"></span>

                    </v-sheet>
                </div>

                <v-sheet v-else class=" text-center mt-3 align-center">
                    <v-icon color="primary" left>mdi-alert</v-icon>
                    {{ _('No changes detected') }}
                </v-sheet>

            </v-card-text>
            <v-divider></v-divider>
            <v-card-actions class="pa-4 justify-center">
                <v-btn @click.stop="confirmDialog=false" class="grey lighten-4" elevation="0">{{ _('Cancel') }}
                </v-btn>
                <v-btn variant="elevated" :disabled="!configDiff" @click.stop="saveConfiguration" color="primary" class="ml-4">
                    {{ _('Confirm') }}
                </v-btn>
            </v-card-actions>

        </v-card>

    </v-dialog>

    <v-overlay v-model="overlay" class="align-center justify-center" z-index="1000000">
        <v-row class="align-center justify-center">
            <v-progress-circular
                    class="mr-3"
                    color="white"
                    indeterminate
                    size="32"
            ></v-progress-circular>
        </v-row>
        <v-row class="align-center justify-center">
            {{ _('Restarting Bayanat to new settings to take effect, please wait...') }}
        </v-row>
        <v-row class="align-center justify-center">
            {{ _('This can take up to a minute. If it takes longer, please restart Bayanat manually.') }}
        </v-row>

    </v-overlay>

{% endblock %}

{% block js %}

    <script src="/static/js/jsondiffpatch/jsondiffpatch.umd.slim.js"></script>
    <script src="/static/js/components/GeoMap.js"></script>
    <script>
        window.__GOOGLE_MAPS_API_KEY__ = '{{ config.GOOGLE_MAPS_API_KEY }}';
        const {createApp} = Vue;
        const {createVuetify} = Vuetify;
        const vuetify = createVuetify(vuetifyConfig);


        const app = createApp({
            delimiters: delimiters,
            mixins: [globalMixin],

            data: () => ({

                tab: null,
                drawer: drawer,
                eitem: {
                    ACTIVITIES:{},
                },

                // nav drawer
                showRevisions: false,

                page: 1,
                totalPages: 0,


                configLabels: [],

                // use this to perform diff operations and compare configurations
                diffPatch: null,

                //store current config before it is updated
                exconfig: {},
                configDiff: '',

                overlay: false,
                confirmDialog: false,

                loading: true,


                options: {},


                alHeaders: [
                    {text: "{{_('ID')}}", value: "id"},
                    {text: "{{_('Code')}}", value: "code"},
                    {text: "{{_('Title')}}", value: "title"},
                    {text: "{{_('Actions')}}", value: "actions"},

                ],
                alItems: [],


                ltHeaders: [
                    {text: "{{_('ID')}}", value: "id"},
                    {text: "{{_('Title')}}", value: "title"},
                    {text: "{{_('Actions')}}", value: "actions"},
                ],

                ltItems: [],

                items: [],


                alItem: {},

                ltItem: {},


                revisions: [],
                revisionLoading: null,
                translations: window.translations,
                whisperModels: [],


            }),


            watch: {
                page() {

                    this.loadRevisions();
                }

            },


            mounted() {

                //load configuration
                this.loadConfiguration();
                this.loadWhisperModels();
                this.loadRevisions()

            },

            computed: {
                whisperModelsCombo(){
                    return this.whisperModels.map(model => ({
                        title: translations.whisperModels.find(m => m.en === model.model_label)?.tr || model.model_label,
                        model_name: model.model_name
                    }));
                }
            },

            methods: {
                loadWhisperModels(){
                    axios.get('/import/api/whisper/models/').then(res => {
                        this.whisperModels = res.data.models;
                    }).catch(err => {
                        this.showSnack(err?.response?.data);
                        console.error(err);
                    })
                },

                loadDefaults() {
                    axios.get('/admin/api/configuration/defaults/').then(res => {
                        this.eitem = res.data.config;
                        this.configLabels = res.data.labels;
                        this.$root.showSnack(this.translations.defaultsLoaded_);
                    }).catch(err => {
                        this.$root.showSnack(err?.response?.data);
                        console.error(err);
                    }).finally(() => {
                        this.loading = false;
                    })
                },

                revertVersion(config) {
                    this.eitem = structuredClone(config.config);
                    this.showRevisions = false;
                    this.showConfigDiff();

                },

                friendlyDiff(html) {
                    let output = html.replace(/true/ig, 'On');
                    output = output.replace(/false/ig, 'Off');

                    return output;

                },
                generateConfigDiff(delta) {


                    // build a customized diff array to display to the user before saving
                    let diff = [];
                    for (const k of Object.keys(delta)) {


                        diff.push(
                            {
                                label: this.configLabels[k],
                                diff: this.friendlyDiff(jsondiffpatch.formatters.html.format(delta[k]))

                            }
                        )
                    }


                    return diff;


                },


                showConfigDiff() {

                    this.diffPatch = jsondiffpatch.create({});
                    const delta = this.diffPatch.diff(this.exconfig, this.eitem);

                    if (delta) {
                        this.configDiff = this.generateConfigDiff(delta);
                    } else {
                        this.configDiff = null;
                    }


                    this.confirmDialog = true;

                },

                adaptResponse(eitem) {
                    // unify types between javascript and python to improve diffs
                    return eitem;
                },
                preprocessConfig() {
                    // apply any additional fixes needed
                    this.eitem.ITEMS_PER_PAGE_OPTIONS = this.eitem.ITEMS_PER_PAGE_OPTIONS.map(x => Number(x))
                    this.eitem.VIDEO_RATES = this.eitem.VIDEO_RATES.map(x => Number(x))
                    if (this.eitem.FILESYSTEM_LOCAL) {

                        // unset s3 settings
                        this.eitem.AWS_ACCESS_KEY_ID = '';
                        this.eitem.AWS_SECRET_ACCESS_KEY = '';
                        this.eitem.S3_BUCKET = '';

                    }

                },


                loadConfiguration() {
                    this.loading = true;
                    axios.get('/admin/api/configuration/').then(res => {
                        this.eitem = res.data.config;
                        this.configLabels = res.data.labels;
                        // also store the configuration in a persistent var
                        this.exconfig = JSON.parse(JSON.stringify(this.eitem));


                    }).catch(e => {


                        this.showSnack(e.response?.data)
                        console.log(e)
                    }).finally(() => {
                        this.loading = false;
                    })


                },

                loadRevisions() {
                    this.revisionLoading = true;
                    const config = {
                        params: {
                            page: this.page,
                            per_page: 4
                        }
                    };

                    axios.get('/admin/api/appconfig/', config)
                        .then(res => {
                            this.revisions = res.data.items;

                            const items_per_page = 5;
                            this.totalPages = Math.ceil(res.data.total / items_per_page);

                        })
                        .catch(err => {
                            this.showSnack(err?.response?.data);
                            console.error(err.response.data)
                        }).finally(() => {
                        this.revisionLoading = false
                    })
                },

                waitForRelaod() {
                    setTimeout(() => {
                        axios.get('/').then(res => {
                            this.overlay = false;
                            this.loadConfiguration();
                            this.loadRevisions();
                            this.showSnack("{{_('Bayanat reloaded successfully.')}}");
                            // reset settings
                        }).catch(err => {
                            this.waitForRelaod();
                        });
                    }, 5000)
                },

                reloadApp() {
                    this.overlay = true;
                    axios.post('/admin/api/reload/')
                    this.waitForRelaod();
                },

                saveConfiguration() {
                    this.overlay = true
                    this.preprocessConfig();
                    axios.put('/admin/api/configuration/', {conf: this.eitem}).then(res => {
                        this.reloadApp();
                    }).catch(e => {
                        console.error(e);
                        this.overlay = false;
                        this.addToCallbackQueueIfReauthRequired(e, this.saveConfiguration);
                    }).finally(() => {
                        this.confirmDialog = false;
                    })
                },
            }
        });
        app.component('geo-map', GeoMap);

        app.use(vuetify).mount('#app');

    </script>


{% endblock %}