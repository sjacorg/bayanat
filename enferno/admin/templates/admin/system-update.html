{% extends 'layout.html' %}
{% block content %}

<v-main class="">
    <v-container fluid>
        <v-card class="pa-4 overflow-y-auto d-flex flex-column" height="calc(100vh - 93px)">

            <!-- Header Section -->
            <v-card-title class="d-flex align-center ga-3">
                <v-icon icon="mdi-package-up"></v-icon>
                System Update: Bayanat <strong class="ml-2">${ currentVersion }</strong>
                <v-spacer></v-spacer>

                <v-chip
                    v-if="isUpToDate"
                    label
                    color="success"
                    prepend-icon="mdi-check"
                    class="text-white">
                    Latest
                </v-chip>
                <v-chip
                    v-else
                    label
                    color="warning"
                    prepend-icon="mdi-alert"
                    class="text-white">
                    Update Available
                </v-chip>
            </v-card-title>

            <v-card-subtitle>
                <p v-if="isUpToDate">{{ _('Your system is up to date') }}</p>
                <p v-else>{{ _('A new version is available') }}</p>
            </v-card-subtitle>

            <v-card-text>
                <div class="mb-3">
                    <strong>{{ _('Current Version:') }}</strong> <span>${ currentVersion }</span>
                </div>

                <div class="mb-3">
                    <strong>{{ _('Latest Version:') }}</strong> <span>${ latestVersion }</span>
                </div>

                <div v-if="lastCheckTime" class="text-caption text-disabled">
                    {{ _('Last check for updates:') }} <strong>${ lastCheckTime }</strong>
                </div>
            </v-card-text>

            <!-- Update Progress Section -->
            <v-expand-transition>
                <v-card-text v-if="updating" class="bg-blue-lighten-5">
                    <v-row align="center">
                        <v-col cols="12" md="8">
                            <p class="text-subtitle-2 font-weight-bold">{{ _('System Update in Progress') }}</p>
                            <p class="text-caption">${ updateStatus }</p>
                            <v-progress-linear
                                v-model="updateProgress"
                                indeterminate
                                color="primary"
                                class="mt-2">
                            </v-progress-linear>
                            <p class="text-caption mt-2 text-disabled">
                                {{ _('This may take a few minutes. Please do not close this page or restart the system.') }}
                            </p>
                        </v-col>
                    </v-row>
                </v-card-text>
            </v-expand-transition>

            <!-- Action Buttons -->
            <v-card-actions>
                <v-btn
                    v-if="!updating"
                    @click="checkForUpdates"
                    :loading="checking"
                    prepend-icon="mdi-refresh"
                    variant="text"
                    color="primary">
                    {{ _('Check for Updates') }}
                </v-btn>

                <v-menu v-if="!isUpToDate && !updating">
                    <template v-slot:activator="{ props }">
                        <v-btn
                            v-bind="props"
                            prepend-icon="mdi-download"
                            append-icon="mdi-menu-down"
                            color="primary"
                            variant="elevated">
                            {{ _('Update System') }}
                        </v-btn>
                    </template>
                    <v-list>
                        <v-list-item @click="confirmScheduledUpdate">
                            <template v-slot:prepend>
                                <v-icon>mdi-clock-outline</v-icon>
                            </template>
                            <v-list-item-title>{{ _('Schedule Update') }}</v-list-item-title>
                            <v-list-item-subtitle>{{ _('In 15 minutes with user notification') }}</v-list-item-subtitle>
                        </v-list-item>

                        <v-list-item @click="confirmUpdate">
                            <template v-slot:prepend>
                                <v-icon>mdi-flash</v-icon>
                            </template>
                            <v-list-item-title>{{ _('Update Now') }}</v-list-item-title>
                            <v-list-item-subtitle>{{ _('Immediately (no grace period)') }}</v-list-item-subtitle>
                        </v-list-item>
                    </v-list>
                </v-menu>

                <v-spacer></v-spacer>

                <v-btn
                    @click="showHistory = true"
                    prepend-icon="mdi-history"
                    variant="text">
                    {{ _('Update History') }}
                </v-btn>
            </v-card-actions>

            <v-divider></v-divider>

            <!-- Tabs: UPDATE SETTINGS / RELEASE NOTES -->
            <v-tabs v-model="tab" class="mt-4">
                <v-tab value="settings" prepend-icon="mdi-cog">
                    {{ _('UPDATE SETTINGS') }}
                </v-tab>
                <v-tab value="notes" prepend-icon="mdi-note-text">
                    {{ _('RELEASE NOTES') }}
                </v-tab>
            </v-tabs>

            <v-divider></v-divider>

            <!-- TAB 1: UPDATE SETTINGS -->
            <v-window v-model="tab">
                <v-window-item value="settings">
                    <v-card flat>
                        <v-card-text class="py-6">
                            <v-switch
                                v-model="autoCheck"
                                label="Automatically check for updates"
                                hint="Bayanat will check for new versions every 12 hours"
                                persistent-hint
                                color="primary">
                            </v-switch>
                        </v-card-text>
                    </v-card>
                </v-window-item>

                <!-- TAB 2: RELEASE NOTES -->
                <v-window-item value="notes">
                    <v-card flat>
                        <v-card-text class="py-6">
                            <div v-if="releaseNotes" class="release-notes">
                                <h4 class="mb-3 text-h6">{{ _('Version') }} ${ currentVersion }</h4>
                                <div v-html="releaseNotes" class="text-body2"></div>
                            </div>
                            <div v-else class="text-center py-6">
                                <p class="text-caption text-disabled">
                                    {{ _('Release notes not yet available') }}
                                </p>
                            </div>
                        </v-card-text>
                    </v-card>
                </v-window-item>
            </v-window>

        </v-card>
    </v-container>
</v-main>

<!-- Update History Dialog -->
<v-dialog v-model="showHistory" max-width="600">
    <v-card>
        <v-card-title>{{ _('Update History') }}</v-card-title>
        <v-divider></v-divider>

        <v-card-text class="py-4">
            <div v-if="updateHistory.length" class="space-y-4">
                <div
                    v-for="update in updateHistory"
                    :key="update.id"
                    class="d-flex ga-3 pa-3 bg-surface">

                    <v-icon icon="mdi-check-circle" color="success"></v-icon>

                    <div class="flex-grow-1">
                        <div class="font-weight-bold">
                            Updated to version ${ update.version_to }
                        </div>
                        <div class="text-caption text-disabled">
                            ${ formatDate(update.created_at) }
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="text-center py-6">
                <p class="text-caption text-disabled">
                    {{ _('No updates found') }}
                </p>
            </div>
        </v-card-text>

        <v-divider></v-divider>
        <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn @click="showHistory = false" variant="text">
                {{ _('Close') }}
            </v-btn>
        </v-card-actions>
    </v-card>
</v-dialog>

<!-- Update Confirmation Dialog (Immediate) -->
<v-dialog v-model="showConfirm" max-width="500">
    <v-card>
        <v-card-title>{{ _('Confirm Immediate Update') }}</v-card-title>
        <v-divider></v-divider>

        <v-card-text class="py-6">
            <v-alert
                type="warning"
                icon="mdi-alert"
                class="mb-4">
                {{ _('The system will be immediately unavailable during the update.') }}
            </v-alert>

            <p>{{ _('Update from version') }} <strong>{{ currentVersion }}</strong> {{ _('to') }} <strong>{{ latestVersion }}</strong>?</p>
            <p class="text-caption text-disabled mt-4">{{ _('This process typically takes a few minutes.') }}</p>
        </v-card-text>

        <v-divider></v-divider>
        <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn @click="showConfirm = false" variant="text">
                {{ _('Cancel') }}
            </v-btn>
            <v-btn
                @click="triggerUpdate"
                color="primary"
                variant="elevated"
                :loading="updating">
                {{ _('Update Now') }}
            </v-btn>
        </v-card-actions>
    </v-card>
</v-dialog>

<!-- Scheduled Update Confirmation Dialog -->
<v-dialog v-model="showScheduledConfirm" max-width="500">
    <v-card>
        <v-card-title>{{ _('Schedule System Update') }}</v-card-title>
        <v-divider></v-divider>

        <v-card-text class="py-6">
            <v-alert
                type="info"
                icon="mdi-clock-outline"
                class="mb-4">
                {{ _('All users will be notified about the scheduled update.') }}
            </v-alert>

            <p>{{ _('Update from version') }} <strong>{{ currentVersion }}</strong> {{ _('to') }} <strong>{{ latestVersion }}</strong></p>
            <p class="mt-4">{{ _('The update will start in') }} <strong>15 {{ _('minutes') }}</strong>.</p>
            <p class="text-caption text-disabled mt-2">{{ _('Users will receive a notification to save their work and log out.') }}</p>
        </v-card-text>

        <v-divider></v-divider>
        <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn @click="showScheduledConfirm = false" variant="text">
                {{ _('Cancel') }}
            </v-btn>
            <v-btn
                @click="triggerScheduledUpdate"
                color="primary"
                variant="elevated"
                :loading="scheduling">
                {{ _('Schedule Update') }}
            </v-btn>
        </v-card-actions>
    </v-card>
</v-dialog>

{% endblock %}

{% block js %}
<script type="module">
    const { createApp } = Vue;
    const { createVuetify } = Vuetify;

    const vuetify = createVuetify(vuetifyConfig);

    const app = createApp({
        delimiters: delimiters,
        mixins: [globalMixin],

        data: () => ({
            drawer: drawer,
            tab: 'settings',
            currentVersion: '',
            latestVersion: '',
            isUpToDate: true,
            lastCheckTime: '',
            checking: false,
            updating: false,
            scheduling: false,
            updateProgress: 0,
            updateStatus: 'Initializing update...',
            showHistory: false,
            showConfirm: false,
            showScheduledConfirm: false,
            autoCheck: true,
            releaseNotes: null,
            updateHistory: [],
            updateTimer: null,
        }),

        methods: {
            applyVersionInfo(data) {
                this.currentVersion = data.current_version || '';
                this.latestVersion = data.latest_version || '';
                this.isUpToDate = !data.update_available;
                if (data.checked_at) {
                    const checkDate = new Date(data.checked_at);
                    this.lastCheckTime = checkDate.toLocaleString();
                }
            },

            checkForUpdates() {
                this.checking = true;
                api.get('/admin/api/system/version/check?fresh=true')
                    .then(response => {
                        this.applyVersionInfo(response.data);
                        this.showSnack('Version check completed', 'success');
                    })
                    .catch(error => {
                        this.showSnack(error.response?.data?.message || 'Failed to check versions', 'error');
                    })
                    .finally(() => {
                        this.checking = false;
                    });
            },

            confirmUpdate() {
                this.showConfirm = true;
            },

            confirmScheduledUpdate() {
                this.showScheduledConfirm = true;
            },

            triggerScheduledUpdate() {
                this.showScheduledConfirm = false;
                this.scheduling = true;

                // Call the new scheduled update endpoint
                api.post('/admin/api/system/update/schedule', {
                    skip_backup: false
                }).then(response => {
                    this.scheduling = false;
                    this.showSnack('Update scheduled successfully. Users have been notified.', 'success');

                    // Show update as in progress
                    this.updating = true;
                    this.updateStatus = `Update will start in 15 minutes at ${new Date(response.data.scheduled_at).toLocaleTimeString()}`;

                    // Start polling for when update actually starts
                    this.pollUpdateStatus();
                }).catch(error => {
                    this.scheduling = false;
                    const errorMsg = error.response?.data?.message || 'Failed to schedule update';
                    this.showSnack(errorMsg, 'error');
                });
            },

            triggerUpdate() {
                this.showConfirm = false;
                this.updating = true;
                this.updateProgress = 30;
                this.updateStatus = 'Starting system update...';

                // Trigger the update via existing API endpoint
                api.post('/admin/api/system/update', {
                    skip_backup: false
                }).then(response => {
                    // Start polling for update status
                    this.pollUpdateStatus();
                }).catch(error => {
                    this.showSnack(error.response?.data?.message || 'Update failed', 'error');
                    this.updating = false;
                    if (this.updateTimer) clearInterval(this.updateTimer);
                });
            },

            pollUpdateStatus() {
                // Poll every 2 seconds for update progress
                this.updateTimer = setInterval(() => {
                    api.get('/admin/api/system/update/status')
                        .then(response => {
                            if (response.data.running) {
                                this.updateProgress = 50;
                                this.updateStatus = response.data.status_message || 'System update in progress...';
                            } else {
                                // Update complete
                                clearInterval(this.updateTimer);
                                this.updateProgress = 100;
                                this.updateStatus = 'Update completed successfully!';
                                this.updating = false;

                                setTimeout(() => {
                                    this.showSnack('System update completed. Reloading page...', 'success');
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 2000);
                                }, 1000);
                            }
                        })
                        .catch(error => {
                            clearInterval(this.updateTimer);
                            this.updating = false;
                            this.showSnack(error.response?.data?.message || 'Failed to get update status', 'error');
                        });
                }, 2000);  // Poll every 2 seconds
            },

            formatDate(dateString) {
                if (!dateString) return 'Unknown';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleString();
                } catch (e) {
                    return dateString;
                }
            },

            formatDuration(seconds) {
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                if (minutes > 0) {
                    return `${minutes}m ${secs}s`;
                }
                return `${secs}s`;
            },

            loadUpdateHistory() {
                api.get('/admin/api/system/update-history')
                    .then(response => {
                        this.updateHistory = response.data.updates || [];
                    })
                    .catch(error => {
                        console.error('Failed to load update history', error);
                    });
            },
        },

        mounted() {
            // Fetch and populate update info
            this.fetchUpdateInfo().then(() => {
                if (this.updateInfo) {
                    this.applyVersionInfo(this.updateInfo);
                }
            }).catch(error => {
                console.error('Failed to fetch update info:', error);
            });

            // Load update history
            this.loadUpdateHistory();
        },

        beforeUnmount() {
            if (this.updateTimer) {
                clearInterval(this.updateTimer);
            }
        },
    });

    app.use(vuetify).mount('#app');
</script>
{% endblock %}
